---
phase: 02-x-platform-pipeline
plan: 02
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/core/utils/thread-splitter.ts
  - src/core/utils/thread-splitter.test.ts
  - src/core/utils/timezone.ts
  - src/core/utils/timezone.test.ts
autonomous: true
requirements:
  - PLAT-01

must_haves:
  truths:
    - "Long text is split into tweet-sized chunks respecting sentence and paragraph boundaries"
    - "Thread preview shows numbered tweets with character counts"
    - "User timezone converts correctly to UTC for storage and back for display"
    - "Warns when thread exceeds 7 tweets but does not block"
  artifacts:
    - path: "src/core/utils/thread-splitter.ts"
      provides: "Thread auto-split logic with sentence boundary respect"
      exports: ["splitIntoThread", "formatThreadPreview"]
      min_lines: 50
    - path: "src/core/utils/thread-splitter.test.ts"
      provides: "TDD tests for thread splitting edge cases"
      contains: "describe"
    - path: "src/core/utils/timezone.ts"
      provides: "Timezone conversion utilities"
      exports: ["userTimeToUtc", "utcToUserTime", "isValidTimezone"]
    - path: "src/core/utils/timezone.test.ts"
      provides: "TDD tests for timezone conversions"
      contains: "describe"
  key_links:
    - from: "src/core/utils/thread-splitter.ts"
      to: "280 char limit"
      via: "maxLen parameter default"
      pattern: "280"
---

<objective>
Implement and test the thread auto-splitter and timezone conversion utilities using TDD.

Purpose: These are pure logic modules with well-defined inputs and outputs — ideal TDD candidates. The thread splitter is critical for PLAT-01 (thread posting) and the timezone utils are needed for scheduling (user's configured timezone to UTC). Both are independent of the OAuth/API work in Plan 01.

Output: Tested thread-splitter and timezone modules ready for integration.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/phases/02-x-platform-pipeline/02-RESEARCH.md
@vitest.config.ts
</context>

<tasks>

<task type="auto">
  <name>Feature 1: Thread auto-splitter with sentence boundary respect</name>
  <files>src/core/utils/thread-splitter.ts, src/core/utils/thread-splitter.test.ts</files>
  <action>
TDD: Thread splitting rules (per user decision):
- Single text input, split at 280 chars max per tweet
- Respect paragraph boundaries first (\n\n), then sentence boundaries (.!?)
- Never split mid-word as last resort
- No hard limit on thread length, but warn above 7 tweets

`splitIntoThread(text: string, maxLen?: number): string[]`
- Short text (under 280 chars) -> returns single-element array
- Two paragraphs both under 280 -> two tweets (paragraph boundary)
- One long paragraph over 280 -> split at sentence boundaries
- Very long sentence over 280 -> split at word boundary (last resort)
- Empty/whitespace input -> returns empty array
- Exactly 280 chars -> single tweet, no split
- Multiple \n\n paragraphs -> each becomes a tweet if under limit

`formatThreadPreview(tweets: string[]): { preview: string; tweetCount: number; warning: string | null }`
- Returns numbered preview: "1/3 (142 chars)\nTweet content...\n\n2/3 (280 chars)\n..."
- tweetCount is tweets.length
- warning is "Thread has N tweets (recommended max: 7)" if count > 7, null otherwise

RED: Write test file with describe blocks for splitIntoThread and formatThreadPreview. Test cases: single short text -> [text], two paragraphs -> [para1, para2], long paragraph split at sentences, very long sentence split at words, empty input -> [], exactly 280 chars -> [text], 8+ tweets -> warning. Run tests — all must FAIL.

GREEN: Implement splitIntoThread: split by paragraphs (\n\n+), accumulate into current tweet until maxLen exceeded, split long paragraphs by sentences, split long sentences at word boundaries. Implement formatThreadPreview: numbered format with char counts, warning if > 7. Run tests — all must PASS.

REFACTOR: Clean up if needed. Ensure edge cases handled.
  </action>
  <verify>Run `bun test src/core/utils/thread-splitter.test.ts` — all tests pass. No tweet exceeds 280 chars in any test case.</verify>
  <done>Thread splitter correctly handles paragraph, sentence, and word boundaries. Preview shows numbered tweets with char counts. Warning present for 8+ tweets.</done>
</task>

<task type="auto">
  <name>Feature 2: Timezone conversion utilities</name>
  <files>src/core/utils/timezone.ts, src/core/utils/timezone.test.ts</files>
  <action>
TDD: Timezone conversion utilities. Per user decision: Config-based timezone. User sets timezone once. All times interpreted and displayed in that timezone. Stored as UTC internally.

`userTimeToUtc(dateStr: string, timeStr: string, timezone: string): Date`
- "2026-03-15", "09:00", "America/New_York" -> Date in UTC (14:00 UTC during EST)
- "2026-06-15", "09:00", "America/New_York" -> Date in UTC (13:00 UTC during EDT)
- Invalid timezone -> throws Error("Invalid timezone: ...")
- Invalid date/time format -> throws Error

`utcToUserTime(utcDate: Date, timezone: string): { date: string; time: string; full: string }`
- UTC Date -> { date: "2026-03-15", time: "09:00", full: "2026-03-15 09:00 EST" }
- Handles DST transitions

`isValidTimezone(tz: string): boolean`
- "America/New_York" -> true, "US/Eastern" -> true, "NotATimezone" -> false, "UTC" -> true

RED: Write tests for all three functions with DST and invalid input cases. Run — all FAIL.

GREEN: Implement using Intl.DateTimeFormat: isValidTimezone tries constructing DateTimeFormat (catch = false). userTimeToUtc parses date/time and calculates UTC via Intl offset comparison. utcToUserTime formats via toLocaleString with timeZone option. Run — all PASS.

REFACTOR if needed.
  </action>
  <verify>Run `bun test src/core/utils/timezone.test.ts` — all tests pass. DST transitions handled correctly.</verify>
  <done>Timezone utils correctly convert between user timezone and UTC, handle DST, and validate IANA timezone strings.</done>
</task>

</tasks>

<verification>
- `bun test` passes all tests for thread-splitter and timezone
- Thread splitter handles: short text, paragraphs, long paragraphs, long sentences, empty input
- Thread preview includes numbered format with char counts and 7+ warning
- Timezone utils handle DST transitions correctly
- No external dependencies added (uses built-in Intl API)
</verification>

<success_criteria>
- All TDD tests green
- Thread splitter correctly handles the auto-split per user decision (paragraph > sentence > word boundaries)
- Timezone conversion round-trips correctly (user time -> UTC -> user time = same)
- Both modules have zero dependencies beyond Node/Bun built-ins
</success_criteria>

<output>
After completion, create `.planning/phases/02-x-platform-pipeline/02-02-SUMMARY.md`
</output>
