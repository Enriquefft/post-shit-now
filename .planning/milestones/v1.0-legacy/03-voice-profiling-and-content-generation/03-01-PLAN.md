---
phase: 03-voice-profiling-and-content-generation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/voice/types.ts
  - src/voice/profile.ts
  - src/voice/profile.test.ts
  - content/voice/.gitkeep
autonomous: true
requirements:
  - VOICE-03
  - VOICE-09
  - CONFIG-02

must_haves:
  truths:
    - "Voice profile YAML schema is defined with Zod and covers all 4 data dimensions (pillars, boundaries, platform personas, reference voices)"
    - "Voice profiles support bilingual sections (en/es) with language-specific vocabulary, patterns, and idioms"
    - "Voice profile can be loaded from YAML, validated, saved atomically, and round-trips without data loss"
    - "Quick voice tweaks (add banned words, adjust formality) modify profile without rewriting the whole file"
    - "strategy.yaml can be auto-generated from a completed voice profile"
  artifacts:
    - path: "src/voice/types.ts"
      provides: "VoiceProfile, LanguageVoice, PlatformPersona, CalibrationState Zod schemas and TypeScript types"
      contains: "voiceProfileSchema"
    - path: "src/voice/profile.ts"
      provides: "loadProfile, saveProfile, validateProfile, applyTweak, generateStrategy functions"
      exports: ["loadProfile", "saveProfile", "validateProfile", "applyTweak", "generateStrategy"]
    - path: "src/voice/profile.test.ts"
      provides: "Unit tests for profile CRUD, validation, atomic write, tweak operations"
  key_links:
    - from: "src/voice/profile.ts"
      to: "content/voice/personal.yaml"
      via: "fs read/write with atomic rename"
      pattern: "readFile.*personal\\.yaml"
    - from: "src/voice/types.ts"
      to: "src/voice/profile.ts"
      via: "Zod schema import for validation"
      pattern: "import.*voiceProfileSchema"
---

<objective>
Define the voice profile data model, YAML schema, and all CRUD operations for voice profiles.

Purpose: The voice profile is the foundation of Phase 3. Every other subsystem (interview, import, generation, calibration) reads or writes voice profiles. This plan establishes the data model and file operations that all subsequent plans depend on.

Output: Typed voice profile schema (Zod), YAML read/write/validate utilities, quick tweak operations, strategy.yaml generation, and unit tests.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-voice-profiling-and-content-generation/03-RESEARCH.md
@.planning/phases/03-voice-profiling-and-content-generation/03-CONTEXT.md
@src/core/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Voice profile Zod schema and TypeScript types</name>
  <files>src/voice/types.ts</files>
  <action>
Create comprehensive Zod schemas and inferred TypeScript types for the voice profile system:

**VoiceProfile schema** (top-level):
- `version`: string (schema version, start at "1.0")
- `createdAt`: ISO date string
- `updatedAt`: ISO date string
- `calibration`: CalibrationState object
- `identity`: Identity object
- `style`: StyleTraits object (language-agnostic numeric traits)
- `languages`: object with optional `en` and `es` keys, each a LanguageVoice
- `platforms`: object with optional `x`, `linkedin`, `instagram`, `tiktok` keys, each a PlatformPersona

**CalibrationState schema**:
- `status`: enum "uncalibrated" | "calibrating" | "calibrated"
- `confidence`: number 0-1
- `postsReviewed`: number
- `avgEditDistance`: number
- `lastCalibrationAt`: optional ISO date string

**Identity schema**:
- `pillars`: array of strings (3-5 content pillars)
- `boundaries`: object with `avoid` (string array) and `cautious` (string array)
- `referenceVoices`: array of objects with `name`, `platform`, `whatToEmulate` strings

**StyleTraits schema** (language-agnostic, 1-10 scales):
- `formality`, `humor`, `technicalDepth`, `storytelling`, `controversy`: all number 1-10

**LanguageVoice schema** (per-language):
- `vocabulary`: string array (characteristic words/phrases)
- `sentencePatterns`: string array (e.g., "short punchy sentences")
- `openingStyles`: string array
- `closingStyles`: string array
- `idioms`: string array

**PlatformPersona schema** (per-platform):
- `tone`: string (e.g., "casual-professional")
- `formatPreferences`: string array (e.g., ["threads", "short-takes"])
- `hashtagStyle`: enum "none" | "minimal" | "strategic" | "heavy"
- `emojiUsage`: enum "none" | "rare" | "moderate" | "heavy"
- `maxLength`: optional number (platform-specific character/length preferences)

**StrategyConfig schema** (for strategy.yaml auto-generation):
- `pillars`: array of objects with `name`, `weight` (0-1), `description`
- `platforms`: object keyed by Platform with `enabled`, `frequency` (posts/week), `bestTimes` (string array)
- `languages`: object with `primary` and optional `secondary`
- `postingFrequency`: object with `min` and `max` posts per week

Also export:
- `createDefaultProfile()`: factory function returning a minimal valid VoiceProfile with sensible defaults
- `createBlankSlateProfile()`: factory for users with no content history (uncalibrated, empty language sections)

Use Zod v4 syntax (already in dependencies). Import Platform type from `src/core/types/index.ts`.
  </action>
  <verify>Run `bun run typecheck` — no type errors. Run `bun run lint` — passes.</verify>
  <done>VoiceProfile Zod schema validates correctly, TypeScript types are inferred, factory functions produce valid profiles.</done>
</task>

<task type="auto">
  <name>Task 2: Voice profile CRUD operations and strategy generation</name>
  <files>src/voice/profile.ts, src/voice/profile.test.ts, content/voice/.gitkeep</files>
  <action>
**src/voice/profile.ts** — Voice profile file operations:

1. `loadProfile(profilePath?: string): Promise<VoiceProfile>` — Read YAML file, parse with `yaml` package, validate with Zod schema, return typed profile. Default path: `content/voice/personal.yaml`. Throw descriptive error if file missing or invalid.

2. `saveProfile(profile: VoiceProfile, profilePath?: string): Promise<void>` — Validate with Zod first, serialize to YAML with `yaml` package (use `stringify` with default options for readable output), write atomically (write to `.tmp` file then `rename`). Update `updatedAt` timestamp automatically.

3. `validateProfile(profile: unknown): { valid: boolean; errors: string[] }` — Run Zod parse, return structured validation result (not throw). Useful for Claude to validate on next use per user decision.

4. `applyTweak(profilePath: string, tweaks: VoiceTweak[]): Promise<VoiceProfile>` — Load profile, apply tweaks, save. VoiceTweak is a union type:
   - `{ type: "add_banned_word"; word: string }` — adds to identity.boundaries.avoid
   - `{ type: "remove_banned_word"; word: string }` — removes from identity.boundaries.avoid
   - `{ type: "adjust_formality"; value: number }` — sets style.formality (clamp 1-10)
   - `{ type: "adjust_humor"; value: number }` — sets style.humor (clamp 1-10)
   - `{ type: "add_pillar"; pillar: string }` — adds to identity.pillars
   - `{ type: "remove_pillar"; pillar: string }` — removes from identity.pillars
   - `{ type: "set_platform_tone"; platform: Platform; tone: string }` — sets platforms[platform].tone
   Export VoiceTweak type.

5. `generateStrategy(profile: VoiceProfile): StrategyConfig` — Auto-generate strategy.yaml content from a completed voice profile. Map pillars to weighted categories (equal weight by default), set platform frequency based on which platforms have personas defined, set primary language based on which language sections exist.

6. `saveStrategy(strategy: StrategyConfig, strategyPath?: string): Promise<void>` — Write strategy.yaml atomically. Default path: `content/voice/strategy.yaml`.

**content/voice/.gitkeep** — Create directory for voice profile storage.

**src/voice/profile.test.ts** — Unit tests using Vitest:
- Test loadProfile with valid YAML file (use tmp file)
- Test loadProfile throws on missing file
- Test loadProfile throws on invalid YAML (missing required fields)
- Test saveProfile writes valid YAML that round-trips
- Test saveProfile atomic write (tmp file created then renamed)
- Test validateProfile returns structured errors for invalid data
- Test applyTweak for each tweak type
- Test applyTweak clamps formality/humor to 1-10
- Test generateStrategy produces valid StrategyConfig from profile
- Test createDefaultProfile returns valid profile
- Test createBlankSlateProfile returns valid profile

Use `import { describe, it, expect, beforeEach, afterEach } from "vitest"` and temp directories for file operations.
  </action>
  <verify>Run `bun run test -- src/voice/profile.test.ts` — all tests pass. Run `bun run typecheck` — no errors.</verify>
  <done>Voice profiles can be loaded, saved atomically, validated, tweaked incrementally, and used to generate strategy.yaml. All operations are tested.</done>
</task>

</tasks>

<verification>
- `bun run typecheck` passes with no errors
- `bun run test -- src/voice/profile.test.ts` passes all tests
- `bun run lint` passes
- YAML round-trip: save a profile, load it back, assert deep equality
- Factory functions produce Zod-valid profiles
</verification>

<success_criteria>
- VoiceProfile schema covers all 4 data dimensions from CONTEXT.md (pillars, boundaries, platform personas, reference voices)
- Bilingual support with language-specific sections (en/es)
- YAML is the source of truth (file-based, not DB)
- Atomic writes prevent corruption
- Quick tweaks modify specific fields without full rewrite
- strategy.yaml auto-generation works from voice profile data
</success_criteria>

<output>
After completion, create `.planning/phases/03-voice-profiling-and-content-generation/03-01-SUMMARY.md`
</output>
