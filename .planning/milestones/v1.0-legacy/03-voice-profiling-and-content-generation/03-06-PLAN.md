---
phase: 03-voice-profiling-and-content-generation
plan: 06
type: execute
wave: 2
depends_on: [03-01]
files_modified:
  - src/voice/calibration.ts
  - src/voice/calibration.test.ts
  - src/core/db/schema.ts
autonomous: true
requirements:
  - VOICE-04
  - VOICE-07
  - VOICE-08
  - POST-10

must_haves:
  truths:
    - "Every edit to a generated post is tracked with edit distance and edit patterns"
    - "Calibration mode tracks edit rates over first 10-15 posts"
    - "After N posts with consistently low edit distance, profile is marked calibrated with confidence score"
    - "Brand-operator voice profiles can be created per connected company"
    - "Brand-ambassador profiles inherit from personal with company guardrails"
  artifacts:
    - path: "src/voice/calibration.ts"
      provides: "Edit tracking, distance calculation, calibration scoring, brand profile management"
      exports: ["trackEdit", "computeEditDistance", "updateCalibration", "CalibrationReport", "createBrandOperatorProfile", "createBrandAmbassadorProfile"]
    - path: "src/voice/calibration.test.ts"
      provides: "Tests for edit distance, calibration convergence, brand profile creation"
    - path: "src/core/db/schema.ts"
      provides: "edit_history table for tracking post edits"
  key_links:
    - from: "src/voice/calibration.ts"
      to: "src/voice/profile.ts"
      via: "Updates calibration state in voice profile"
      pattern: "loadProfile|saveProfile"
    - from: "src/voice/calibration.ts"
      to: "src/core/db/schema.ts"
      via: "Stores edit history in DB"
      pattern: "editHistory"
---

<objective>
Build the calibration system for voice profile refinement and brand voice profile management.

Purpose: Calibration is what makes the voice profile actually converge on the user's authentic voice. By tracking every edit and computing confidence scores, the system continuously improves. Brand profiles extend this to company contexts.

Output: Edit tracking and distance calculation, calibration scoring with convergence detection, calibration reports, brand-operator and brand-ambassador profile creation.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-voice-profiling-and-content-generation/03-RESEARCH.md
@.planning/phases/03-voice-profiling-and-content-generation/03-CONTEXT.md
@.planning/phases/03-voice-profiling-and-content-generation/03-01-SUMMARY.md
@src/voice/types.ts
@src/voice/profile.ts
@src/core/db/schema.ts
@src/core/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Edit tracking and calibration engine</name>
  <files>src/voice/calibration.ts, src/voice/calibration.test.ts, src/core/db/schema.ts</files>
  <action>
**src/core/db/schema.ts** — Add edit_history table:

Add a new `editHistory` table to the existing schema (DO NOT modify existing tables):
```typescript
export const editHistory = pgTable(
  "edit_history",
  {
    id: uuid("id").defaultRandom().primaryKey(),
    userId: text("user_id").notNull(),
    postId: text("post_id").notNull(),
    originalContent: text("original_content").notNull(),
    editedContent: text("edited_content").notNull(),
    editDistance: integer("edit_distance").notNull(), // word-level diff count
    editRatio: integer("edit_ratio").notNull(), // percentage 0-100
    editPatterns: jsonb("edit_patterns").$type<EditPattern[]>(),
    createdAt: timestamp("created_at", { withTimezone: true }).defaultNow().notNull(),
  },
  (table) => [
    pgPolicy("edit_history_isolation", {
      as: "permissive",
      to: hubUser,
      for: "all",
      using: sql`${table.userId} = current_setting('app.current_user_id')`,
      withCheck: sql`${table.userId} = current_setting('app.current_user_id')`,
    }),
  ],
);
```

**src/voice/calibration.ts** — Calibration engine:

**Types:**
```typescript
interface EditPattern {
  type: "tone-adjustment" | "word-choice" | "structure-change" | "length-change" | "addition" | "removal" | "rewrite";
  description: string;
  count: number;
}

interface CalibrationReport {
  postsReviewed: number;
  avgEditDistance: number;
  editDistanceTrend: "improving" | "stable" | "worsening";
  topEditPatterns: EditPattern[];
  calibrationStatus: "uncalibrated" | "calibrating" | "calibrated";
  confidence: number;
  recommendation: string;
}
```

**Functions:**

1. `computeEditDistance(original: string, edited: string): { distance: number; ratio: number; patterns: EditPattern[] }`:
   - Use the `diff` npm package for word-level diffing: `import { diffWords } from "diff"`
   - Count word-level changes (additions + removals + modifications)
   - Compute ratio: (changes / totalOriginalWords) as percentage 0-100
   - Detect edit patterns:
     - "tone-adjustment": formality-related word swaps
     - "word-choice": individual word replacements
     - "structure-change": paragraph reordering or sentence restructuring
     - "length-change": significant content addition or removal
     - "addition": new content added
     - "removal": content deleted
     - "rewrite": >50% changed in a section
   - For thread content (JSON string arrays per Phase 2 decision): parse JSON, join tweets with newlines, then diff the joined text. This avoids inflated scores from JSON structure.

2. `trackEdit(params: { postId: string; originalContent: string; editedContent: string; databaseUrl: string }): Promise<{ distance: number; ratio: number; patterns: EditPattern[] }>`:
   - Compute edit distance
   - Insert record into edit_history table
   - Return the computed metrics

3. `updateCalibration(params: { profilePath: string; databaseUrl: string }): Promise<CalibrationReport>`:
   - Load voice profile
   - Query edit_history for user's last 15 posts (most recent)
   - Compute rolling average edit distance
   - Determine trend: compare last 5 avg vs previous 5 avg
   - Check convergence: if last 10 consecutive posts have edit ratio < 15% (configurable), mark as "calibrated"
   - Set confidence: 1.0 - (avgEditRatio / 100), clamped to 0-1
   - Update profile calibration state
   - Save profile
   - Return CalibrationReport

4. `getCalibrationReport(params: { profilePath: string; databaseUrl: string }): Promise<CalibrationReport>`:
   - Read-only version of updateCalibration (no profile save)
   - For presenting to user during periodic review

**src/voice/calibration.test.ts** — Tests:
- Test computeEditDistance with identical strings (distance 0, ratio 0)
- Test computeEditDistance with minor edits (low distance)
- Test computeEditDistance with major rewrite (high distance)
- Test computeEditDistance with thread content (JSON array format)
- Test pattern detection: tone adjustment, word choice, length change
- Test calibration convergence: 10 posts with <15% edit ratio -> calibrated
- Test calibration trend detection: improving, stable, worsening

For DB tests: mock the database connection (similar to existing test patterns).
  </action>
  <verify>Run `bun run test -- src/voice/calibration.test.ts` — all tests pass. Run `bun run typecheck`. Run `bun run lint`.</verify>
  <done>Edit tracking captures every change with distance, ratio, and patterns. Calibration engine converges profile to calibrated state after consistent low edits. Edit patterns provide actionable feedback.</done>
</task>

<task type="auto">
  <name>Task 2: Brand voice profiles (operator and ambassador)</name>
  <files>src/voice/calibration.ts</files>
  <action>
Add brand profile management functions to `src/voice/calibration.ts` (append to existing file):

1. `createBrandOperatorProfile(params: { companyName: string; brandGuidelines?: string; tone?: string; pillars?: string[]; boundaries?: string[]; outputDir?: string }): Promise<{ profilePath: string; profile: VoiceProfile }>`:
   - Create a new VoiceProfile with brand-specific settings
   - Identity pillars from company's focus areas
   - Boundaries from brand guidelines (e.g., "never discuss competitors by name")
   - Style traits calibrated for professional brand voice (higher formality, lower controversy)
   - Save to `content/voice/{companyName}-operator.yaml` (or custom outputDir)
   - This is a standalone profile — not inherited from personal (VOICE-07)

2. `createBrandAmbassadorProfile(params: { personalProfilePath: string; companyName: string; guardrails?: { maxControversy?: number; requiredTopics?: string[]; bannedTopics?: string[]; toneOverride?: string } }): Promise<{ profilePath: string; profile: VoiceProfile }>`:
   - Load personal profile as base
   - Apply company guardrails on top:
     - Clamp controversy to guardrails.maxControversy (default: 3)
     - Add requiredTopics to pillars
     - Add bannedTopics to boundaries.avoid
     - Override tone if toneOverride specified
   - Preserve personal voice characteristics (vocabulary, sentence patterns, opening/closing styles)
   - Save to `content/voice/{companyName}-ambassador.yaml`
   - This inherits from personal with company restrictions (VOICE-08)

3. `listVoiceProfiles(voiceDir?: string): Promise<Array<{ path: string; type: "personal" | "brand-operator" | "brand-ambassador"; name: string }>>`:
   - Scan content/voice/ for .yaml files
   - Detect type from filename pattern or profile content
   - Return sorted list

Export all functions and types.
  </action>
  <verify>Run `bun run typecheck` — no errors. Run `bun run lint` — passes.</verify>
  <done>Brand-operator profiles created per company with standalone brand voice. Brand-ambassador profiles inherit from personal with company guardrails applied. Profile listing shows all available voice profiles.</done>
</task>

</tasks>

<verification>
- `bun run typecheck` passes
- `bun run test -- src/voice/calibration.test.ts` passes
- `bun run lint` passes
- edit_history schema has RLS policy matching existing tables
- Edit distance correctly handles thread content (JSON arrays)
- Calibration converges after consistent low edits
- Brand profiles maintain proper inheritance
</verification>

<success_criteria>
- VOICE-04: Calibration tracks edit rates over 10-15 posts with reports
- VOICE-07: Brand-operator profiles created per company
- VOICE-08: Brand-ambassador profiles inherit from personal with guardrails
- POST-10: Every edit tracked with edit distance and patterns
- Dual calibration signals: edits tracked silently + periodic explicit feedback (per CONTEXT.md)
- Convergence at <15% edit ratio over 10 consecutive posts
</success_criteria>

<output>
After completion, create `.planning/phases/03-voice-profiling-and-content-generation/03-06-SUMMARY.md`
</output>
