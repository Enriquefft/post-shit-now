---
phase: 03-voice-profiling-and-content-generation
plan: 07
type: execute
wave: 3
depends_on: [03-04, 03-05, 03-06]
files_modified:
  - .claude/commands/psn/post.md
  - .claude/commands/psn/voice.md
  - src/cli/voice-config.ts
autonomous: true
requirements:
  - CONFIG-03
  - VOICE-09

must_haves:
  truths:
    - "/psn:post slash command drives the full post generation workflow with voice-matched content"
    - "/psn:voice slash command provides guided voice profile management (interview, edit, recalibrate)"
    - "/psn:config voice allows quick tweaks (banned words, formality, pillars) without full interview"
    - "All slash commands use JSON CLI output pattern established in Phase 1"
    - "Post generation includes human review before scheduling (POST-09)"
    - "Media generation shows image/video to user for approval before attaching (never auto-attach)"
  artifacts:
    - path: ".claude/commands/psn/post.md"
      provides: "Slash command for AI-powered post generation with voice matching"
    - path: ".claude/commands/psn/voice.md"
      provides: "Slash command for voice profile management"
    - path: "src/cli/voice-config.ts"
      provides: "CLI for quick voice profile tweaks"
      exports: ["applyConfigTweaks"]
  key_links:
    - from: ".claude/commands/psn/post.md"
      to: "src/content/generate.ts"
      via: "Claude calls generatePost for context assembly"
      pattern: "generatePost"
    - from: ".claude/commands/psn/post.md"
      to: "src/media/image-gen.ts"
      via: "Claude calls generateImage for media generation"
      pattern: "generateImage"
    - from: ".claude/commands/psn/voice.md"
      to: "src/cli/voice-interview.ts"
      via: "Claude drives voice interview via CLI functions"
      pattern: "startInterview|completeInterview"
---

<objective>
Create the user-facing slash commands that tie together all Phase 3 subsystems into cohesive workflows.

Purpose: All the subsystems (voice profiling, content generation, media generation, calibration, drafts) need to be exposed through intuitive slash commands. This plan creates the `/psn:post` and `/psn:voice` commands that Claude uses to drive the full experience.

Output: Updated `/psn:post` slash command with voice-matched generation, new `/psn:voice` command for profile management, and `/psn:config voice` CLI for quick tweaks.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-voice-profiling-and-content-generation/03-CONTEXT.md
@.planning/phases/03-voice-profiling-and-content-generation/03-05-SUMMARY.md
@.planning/phases/03-voice-profiling-and-content-generation/03-04-SUMMARY.md
@.planning/phases/03-voice-profiling-and-content-generation/03-06-SUMMARY.md
@.claude/commands/psn/post.md
@src/content/generate.ts
@src/voice/profile.ts
@src/voice/calibration.ts
@src/media/image-gen.ts
@src/media/video-gen.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhanced /psn:post slash command with voice-matched generation</name>
  <files>.claude/commands/psn/post.md</files>
  <action>
Update the existing `/psn:post` slash command to integrate voice-matched content generation, media generation, and the full Phase 3 experience. The command file is a markdown file that instructs Claude on how to drive the workflow.

**Enhanced workflow:**

1. **Preamble** (keep existing: check for failed posts, surface them)

2. **Voice profile check**: Run `bun run src/voice/profile.ts validate` (or equivalent). If no voice profile exists, suggest `/psn:voice` first. If profile exists but uncalibrated, mention it.

3. **Topic gathering**:
   - If user provides topic/idea: use it
   - If not: Run `bun run src/content/generate.ts check-ideas` to check idea bank (POST-11)
   - If no ready ideas: Run `bun run src/content/generate.ts suggest-topics --platform {platform}` to get 3 suggestions (POST-12)
   - Present suggestions, let user pick or provide their own

4. **Persona selection** (POST-06):
   - If multiple voice profiles exist (personal + brand), ask which persona
   - Default to personal if only one exists
   - Load appropriate profile path

5. **Format suggestion** (POST-05):
   - Run format picker based on topic + platform
   - Present recommended format with alternatives
   - User can accept or choose different format

6. **Content generation**:
   - Run `bun run src/content/generate.ts build-context` to assemble voice-matched generation context
   - Claude generates the actual post content using the voice context
   - Accept anything from single word to detailed brief (per CONTEXT.md — flexible input)
   - If user requested multiple variations: generate N variations
   - Default: 1 best draft

7. **Human review** (POST-09):
   - Present generated content inline
   - If visual format (carousel, infographic, image post): generate high-fidelity visual preview
   - User can: approve, edit, regenerate, or change format
   - Track edits via `bun run src/voice/calibration.ts track-edit` (POST-10)

8. **Media generation** (if applicable):
   - Ask if user wants an image or video
   - If yes: select provider based on content hints
   - Generate media, show to user for approval (NEVER auto-attach per CONTEXT.md)
   - If rejected: regenerate (max 3 attempts per CONTEXT.md)
   - Process image via sharp for platform compliance

9. **Save draft**:
   - Save to content/drafts/ with frontmatter
   - Present inline AND save to file (both modes per CONTEXT.md)

10. **Schedule or post**:
    - Use existing scheduling flow from Phase 2
    - Thread splitting for X (existing functionality)
    - Support immediate posting or scheduled

**Format:** This is a Claude Code slash command file (.md). Write it as markdown instructions that tell Claude how to execute each step, which CLI commands to run, and how to present results to the user. Follow the pattern established by the existing post.md command.

**Important:** The command should feel natural and conversational, not like a rigid form. Claude adapts to what the user provides.
  </action>
  <verify>Verify the file is valid markdown. Check that it references all the correct CLI scripts and functions.</verify>
  <done>/psn:post integrates voice-matched generation, format picking, media generation with approval, edit tracking, and the full post creation experience.</done>
</task>

<task type="auto">
  <name>Task 2: /psn:voice command and voice config CLI</name>
  <files>.claude/commands/psn/voice.md, src/cli/voice-config.ts</files>
  <action>
**.claude/commands/psn/voice.md** — New slash command for voice profile management:

Create a Claude Code slash command that provides these sub-workflows:

**`/psn:voice` (no args)** — Show current voice profile status:
- Load profile, show calibration status, confidence score, pillar summary
- Show available profiles (personal, brand-operator, brand-ambassador)

**`/psn:voice interview`** — Run full voice interview:
- Call `bun run src/cli/voice-interview.ts start`
- Drive the interview conversationally (ask questions one at a time, adapt based on answers)
- Feel like a conversation with a social media strategist (per CONTEXT.md specifics)
- At end: save profile, optionally generate strategy.yaml
- Show calibration status

**`/psn:voice import`** — Import existing content:
- Ask which sources: X history, blog URLs, raw text
- For X history: use existing OAuth token
- For blogs: ask for URLs
- For raw text: ask user to paste
- Run analysis, show patterns detected
- Offer to update voice profile with imported patterns

**`/psn:voice edit`** — Guided profile editing:
- Show current profile sections one by one
- For each section: show current values, ask if user wants to change
- Validate profile after each change
- Save atomically

**`/psn:voice calibrate`** — Show calibration report:
- Run calibration analysis
- Show edit distance trends, pattern analysis
- Show confidence score and status
- Recommend actions if needed

**`/psn:voice recalibrate`** — Full recalibration (VOICE-10):
- Re-run interview preserving existing data
- Option to re-import content
- Reset calibration tracking

**src/cli/voice-config.ts** — CLI for quick tweaks:

Export function `applyConfigTweaks(tweaks: string[]): Promise<{ applied: VoiceTweak[]; profile: VoiceProfile }>`:
- Parse tweak strings like: "add-banned:slang", "formality:7", "add-pillar:AI", "remove-pillar:crypto", "tone-x:casual"
- Map to VoiceTweak objects
- Call applyTweak from profile.ts
- Return applied tweaks and updated profile

Standard CLI entry point with `import.meta.main` and JSON output.

This satisfies CONFIG-03 (/psn:config allows manual overrides) for voice-related config. Other config areas (notifications, engagement, frequency) are in later phases.
  </action>
  <verify>Verify both files are valid. Run `bun run typecheck` on voice-config.ts. Check that voice.md references correct CLI scripts.</verify>
  <done>/psn:voice provides full voice profile management. /psn:config voice allows quick tweaks. Voice interview drives conversationally through Claude. All voice requirements have user-facing commands.</done>
</task>

</tasks>

<verification>
- Slash command files exist and are valid markdown
- `bun run typecheck` passes for voice-config.ts
- `bun run lint` passes
- /psn:post references all Phase 3 subsystems (voice, content, media, calibration, drafts)
- /psn:voice covers all voice management workflows
</verification>

<success_criteria>
- CONFIG-03: /psn:config voice allows manual overrides for voice settings
- VOICE-09: Quick voice tweaks via config (banned words, formality, pillars)
- /psn:post integrates: voice loading, format picking, topic suggestions, content generation, media generation with approval, edit tracking, draft saving, scheduling
- /psn:voice integrates: interview, import, edit, calibrate, recalibrate
- All interactions feel conversational, not form-like
- Human-in-the-loop: every post reviewed, every media approved
</success_criteria>

<output>
After completion, create `.planning/phases/03-voice-profiling-and-content-generation/03-07-SUMMARY.md`
</output>
