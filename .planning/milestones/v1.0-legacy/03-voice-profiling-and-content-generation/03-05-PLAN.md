---
phase: 03-voice-profiling-and-content-generation
plan: 05
type: execute
wave: 2
depends_on: [03-01, 03-02, 03-03]
files_modified:
  - src/content/generate.ts
  - src/content/format-picker.ts
  - src/content/topic-suggest.ts
  - src/content/drafts.ts
  - content/drafts/.gitkeep
  - content/media/.gitkeep
autonomous: true
requirements:
  - POST-01
  - POST-05
  - POST-06
  - POST-09
  - POST-11
  - POST-12
  - POST-14
  - CONTENT-01
  - CONTENT-02

must_haves:
  truths:
    - "User can generate a post for X in their voice using the content brain"
    - "Content brain picks optimal format per platform (thread, carousel, short post, reel script)"
    - "User can choose posting persona (personal, brand operator, brand ambassador)"
    - "System checks idea bank for ready ideas before asking for a topic (stub for Phase 5)"
    - "System offers 3 quick topic suggestions when no topic provided"
    - "Generated content reflects learnings from preference model (stub for Phase 4)"
    - "Drafts are stored in content/drafts/ with frontmatter and auto-pruning"
    - "Generated media stored in content/media/ with auto-pruning"
  artifacts:
    - path: "src/content/generate.ts"
      provides: "Post generation orchestrator (content brain)"
      exports: ["generatePost", "GeneratePostOptions", "GeneratedDraft"]
    - path: "src/content/format-picker.ts"
      provides: "Smart format selection per platform"
      exports: ["pickFormat", "FormatSuggestion"]
    - path: "src/content/topic-suggest.ts"
      provides: "Topic suggestion from voice profile pillars"
      exports: ["suggestTopics"]
    - path: "src/content/drafts.ts"
      provides: "Draft lifecycle management with auto-pruning"
      exports: ["saveDraft", "loadDraft", "listDrafts", "pruneDrafts", "saveMedia", "pruneMedia"]
  key_links:
    - from: "src/content/generate.ts"
      to: "src/voice/profile.ts"
      via: "Loads voice profile for generation context"
      pattern: "loadProfile"
    - from: "src/content/generate.ts"
      to: "src/media/image-gen.ts"
      via: "Generates images when media is needed"
      pattern: "generateImage"
    - from: "src/content/generate.ts"
      to: "src/media/video-gen.ts"
      via: "Generates video when media is needed"
      pattern: "generateVideo"
    - from: "src/content/drafts.ts"
      to: "content/drafts/"
      via: "File-based draft storage with YAML frontmatter"
      pattern: "content/drafts"
---

<objective>
Build the content generation brain, format picker, topic suggestions, and draft lifecycle management.

Purpose: This is the core user experience — generating posts that sound like the user, not like generic AI. The content brain loads the voice profile, picks the optimal format, generates content, and manages the draft lifecycle.

Output: Post generation orchestrator, smart format picker, topic suggestion engine, draft file management with auto-pruning, and media storage with auto-pruning.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-voice-profiling-and-content-generation/03-RESEARCH.md
@.planning/phases/03-voice-profiling-and-content-generation/03-CONTEXT.md
@.planning/phases/03-voice-profiling-and-content-generation/03-01-SUMMARY.md
@.planning/phases/03-voice-profiling-and-content-generation/03-02-SUMMARY.md
@src/voice/types.ts
@src/voice/profile.ts
@src/media/image-gen.ts
@src/media/video-gen.ts
@src/core/types/index.ts
@src/cli/post.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Format picker, topic suggestions, and draft management</name>
  <files>src/content/format-picker.ts, src/content/topic-suggest.ts, src/content/drafts.ts, content/drafts/.gitkeep, content/media/.gitkeep</files>
  <action>
**src/content/format-picker.ts** — Smart format selection:

Define format types:
```typescript
type PostFormat = "short-post" | "thread" | "carousel" | "image-post" | "reel-script" | "video-post" | "quote-image" | "infographic";

interface FormatSuggestion {
  recommended: PostFormat;
  alternatives: Array<{ format: PostFormat; reason: string }>;
  reasoning: string;
}
```

`pickFormat(params: { platform: Platform; contentLength?: number; contentType?: string; hasMedia?: boolean; voicePreferences?: string[] }): FormatSuggestion`:
- X: short content (<280) -> "short-post"; longer content -> "thread"; data/lists -> "infographic"; quote -> "quote-image"
- LinkedIn: data/insights -> "carousel" (11.2x impressions per research); story/opinion -> "short-post"; how-to -> "carousel"
- Instagram: visual content -> "image-post"; tutorial/education -> "carousel"; engagement/trend -> "reel-script"
- TikTok: everything -> "video-post" or "reel-script" (video-first platform)
- Consider voice profile formatPreferences for the platform
- Always return at least 1 alternative with reasoning

**src/content/topic-suggest.ts** — Topic suggestions:

`suggestTopics(params: { profile: VoiceProfile; platform: Platform; count?: number }): TopicSuggestion[]`:
- Default count: 3
- Draw from content pillars in the voice profile
- Generate topic ideas by combining pillars with angles: "hot take on [pillar]", "how-to about [pillar]", "story about [pillar]", "trend in [pillar]", "myth-busting [pillar]"
- Rotate angles to avoid repetition
- Return `{ topic: string; pillar: string; angle: string; suggestedFormat: PostFormat }`
- This is a deterministic suggestion engine — Claude adds creativity on top

`checkIdeaBank(): Promise<{ hasReadyIdeas: boolean; readyCount: number }>`:
- Stub for Phase 5. Check if idea bank table exists in DB, if so query for status=ready ideas.
- If table doesn't exist or no ready ideas, return `{ hasReadyIdeas: false, readyCount: 0 }`
- This satisfies POST-11 (check idea bank before asking for topic) as a forward-compatible stub

**src/content/drafts.ts** — Draft lifecycle:

`saveDraft(params: { content: string; platform: Platform; format: PostFormat; persona?: string; language?: string; metadata?: Record<string, unknown> }): Promise<{ draftPath: string; draftId: string }>`:
- Generate UUID for draftId
- Write to `content/drafts/{draftId}.md` with YAML frontmatter:
  ```yaml
  ---
  id: {uuid}
  platform: x
  format: thread
  persona: personal
  language: en
  status: draft
  createdAt: 2026-02-19T10:00:00Z
  publishedAt: null
  ---
  {content}
  ```

`loadDraft(draftId: string): Promise<{ frontmatter: DraftFrontmatter; content: string }>`:
- Read file, parse YAML frontmatter, return both parts

`listDrafts(filter?: { platform?: Platform; status?: string }): Promise<DraftSummary[]>`:
- Read all .md files in content/drafts/, parse frontmatter, return sorted by createdAt desc
- Apply filters if provided

`pruneDrafts(options?: { maxAgeDays?: number }): Promise<{ pruned: number; remaining: number }>`:
- Default: 14 days after publishing (CONTENT-01)
- Only prune drafts with `status: published` and `publishedAt` older than maxAgeDays
- Never prune active drafts
- Return count of pruned and remaining

`saveMedia(buffer: Buffer, filename: string): Promise<string>`:
- Write to `content/media/{filename}`
- Return full path

`pruneMedia(options?: { maxAgeDays?: number }): Promise<{ pruned: number }>`:
- Default: 7 days (CONTENT-02)
- Prune files in content/media/ older than maxAgeDays
- Return count pruned

Create `content/drafts/.gitkeep` and `content/media/.gitkeep` directories.
  </action>
  <verify>Run `bun run typecheck` — no errors. Run `bun run lint` — passes.</verify>
  <done>Format picker suggests optimal format per platform. Topic suggestions draw from voice profile pillars. Drafts are stored with YAML frontmatter and auto-pruned. Media storage with auto-pruning.</done>
</task>

<task type="auto">
  <name>Task 2: Content generation orchestrator (content brain)</name>
  <files>src/content/generate.ts</files>
  <action>
**src/content/generate.ts** — The content brain:

```typescript
interface GeneratePostOptions {
  topic?: string;          // User's topic/idea (can be a single word or detailed brief)
  platform: Platform;
  persona?: "personal" | "brand-operator" | "brand-ambassador";
  language?: "en" | "es";
  format?: PostFormat;     // User override, otherwise auto-picked
  variations?: number;     // Default 1, user can request more
  mediaType?: "image" | "video" | "none";
  mediaHints?: string[];   // Content hints for media provider selection
  profilePath?: string;    // Custom profile path (for brand profiles)
}

interface GeneratedDraft {
  content: string;
  format: PostFormat;
  formatSuggestion: FormatSuggestion;
  platform: Platform;
  persona: string;
  language: string;
  draftId: string;
  draftPath: string;
  topicSuggestions?: TopicSuggestion[];  // If no topic provided
  mediaGenerated?: boolean;
  mediaPath?: string;
}
```

1. `generatePost(options: GeneratePostOptions): Promise<GeneratedDraft>`:
   This function prepares the generation context — it does NOT call an LLM directly (Claude IS the LLM). Instead, it:

   a. **Load voice profile**: Call `loadProfile(options.profilePath)`. If persona is "brand-operator" or "brand-ambassador", load appropriate profile. Throw if profile not found.

   b. **Check idea bank**: Call `checkIdeaBank()`. If ready ideas exist, return them as suggestions (POST-11 stub).

   c. **Topic suggestions**: If no topic provided AND no ready ideas, call `suggestTopics()` to get 3 suggestions (POST-12). Set `topicSuggestions` on result.

   d. **Pick format**: If format not specified, call `pickFormat()` with content analysis. Set `formatSuggestion` on result.

   e. **Build generation context**: Assemble a structured prompt context that includes:
      - Voice profile traits (style, language-specific patterns, platform persona)
      - Format constraints (character limits, thread structure, carousel slide count)
      - Topic/angle
      - Persona context
      - Preference model learnings (POST-14 stub — check if preference data exists in metadata, otherwise skip)

   f. **Save draft shell**: Call `saveDraft()` with initial metadata. The actual content gets filled in by Claude during the slash command interaction.

   g. **Return**: GeneratedDraft with all context needed for Claude to generate the actual content.

   **KEY DESIGN INSIGHT**: This function is NOT a black box that generates content. It's a CONTEXT ASSEMBLER that gives Claude everything needed to generate voice-matched content. The slash command `/psn:post` calls this, gets the context, then Claude generates the actual text using this context.

2. `buildVoicePromptContext(profile: VoiceProfile, platform: Platform, language: "en" | "es"): string`:
   - Extract relevant voice traits for the platform
   - Extract language-specific patterns
   - Format as structured text that can be injected into Claude's generation context
   - Include: tone, formality level, vocabulary preferences, sentence patterns, opening/closing styles, hashtag/emoji usage, boundaries (what to avoid)

3. `getPreferenceModelLearnings(platform: Platform): Promise<{ hooks: string[]; formats: string[]; fatiguedTopics: string[] } | null>`:
   - Stub for Phase 4 (POST-14). Query posts table for metadata with preference learnings.
   - If no data exists, return null (no learnings yet).

Export all types and functions.
  </action>
  <verify>Run `bun run typecheck` — no errors. Run `bun run lint` — passes.</verify>
  <done>Content brain assembles voice-matched generation context from profile, format, and platform. Topic suggestions provided when no topic given. Preference model and idea bank stubs ready for Phase 4/5 integration.</done>
</task>

</tasks>

<verification>
- `bun run typecheck` passes
- `bun run lint` passes
- generatePost loads voice profile and assembles generation context
- Format picker returns platform-appropriate format suggestions
- Topic suggestions draw from voice profile pillars
- Draft files use YAML frontmatter format
- Auto-pruning only removes published drafts older than 14 days
</verification>

<success_criteria>
- POST-01: Generate post for X in user's voice (context assembler provides voice-matched prompting)
- POST-05: Format picker selects optimal format per platform
- POST-06: Persona parameter loads correct voice profile
- POST-09: Human review is inherent — content brain provides context, Claude presents for review
- POST-11: Idea bank check stub (forward-compatible for Phase 5)
- POST-12: 3 topic suggestions when no topic provided
- POST-14: Preference model stub (forward-compatible for Phase 4)
- CONTENT-01: Drafts in content/drafts/ with 14-day auto-pruning
- CONTENT-02: Media in content/media/ with 7-day auto-pruning
</success_criteria>

<output>
After completion, create `.planning/phases/03-voice-profiling-and-content-generation/03-05-SUMMARY.md`
</output>
