---
phase: 12-solo-founder-experience
plan: 02
type: execute
wave: 1
depends_on:
  - 12-01
files_modified:
  - src/cli/setup.ts
  - src/cli/setup-voice.ts
  - .claude/commands/psn/setup.md
  - .claude/commands/psn/voice.md
autonomous: true
requirements:
  - SETUP-01

must_haves:
  truths:
    - "/psn:setup detects existing configuration and shows status screen"
    - "/psn:setup voice triggers voice interview as subcommand"
    - "First-run wizard infers defaults for faster setup"
    - "Returning users see checkmarks for completed steps and gaps highlighted"
    - "Entity creation mini-wizard: name -> voice interview -> platform connection"
    - "Smart defaults: if one entity has X connected, suggest X for new entity"
  artifacts:
    - path: "src/cli/setup.ts"
      provides: "Unified setup orchestrator with status detection"
      changes: "Add voice interview step, status detection, entity creation flow"
    - path: "src/cli/setup-voice.ts"
      provides: "Voice setup subcommand implementation"
      exports: ["setupVoice", "getSetupStatus"]
  key_links:
    - from: "src/cli/setup.ts"
      to: "src/cli/setup-voice.ts"
      via: "import { setupVoice, getSetupStatus } from './setup-voice'"
      pattern: "setupVoice\\(.*userId.*entitySlug"
    - from: "src/cli/setup.ts"
      to: "src/voice/entity-profiles.ts"
      via: "import { listEntities, createEntity } from '../voice/entity-profiles'"
      pattern: "listEntities\\(db.*userId"
---

<objective>
Merge /psn:voice functionality into /psn:setup for unified configuration flow. First-run users get full wizard with smart inference; returning users see status screen with what's configured and what's missing.

Purpose: Single entry point for all configuration (SETUP-01).
Output: Extended /psn:setup with voice interview integration, status detection, entity creation.
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/12-solo-founder-experience/12-CONTEXT.md
@.planning/phases/12-solo-founder-experience/12-RESEARCH.md
@src/cli/setup.ts
@src/voice/interview.ts
@src/voice/entity-profiles.ts
</context>

<tasks>

<task type="auto">
  <name>Create setup-voice.ts for voice subcommand</name>
  <files>src/cli/setup-voice.ts</files>
  <action>
Create src/cli/setup-voice.ts with voice setup functionality:

1. SetupStatus interface:
   export interface SetupStatus {
     hasHub: boolean;
     hasVoiceProfile: boolean;
     hasEntities: boolean;
     hasPlatforms: boolean;
     entityCount: number;
     platformList: string[];
     incompleteSteps: string[];
     recommendedAction: string;
   }

2. getSetupStatus(configDir, db?, userId?): Promise<SetupStatus>
   - Check config/hub.env exists -> hasHub
   - Check content/voice/personal.yaml OR entities in DB -> hasVoiceProfile
   - If db provided: query voice_profiles count -> entityCount, hasEntities
   - If db provided: query oauth_tokens -> platformList, hasPlatforms
   - Build incompleteSteps array from missing items
   - Determine recommendedAction: first incomplete step
   - Return SetupStatus

3. setupVoice(options: { userId: string; entitySlug?: string; db: Database; configDir: string }): Promise<SetupResult>
   - If entitySlug provided: create/update entity profile
   - If no entitySlug and no profiles exist: start first-run interview
   - If profiles exist: return list for picker
   - Return interview state for Claude to render

4. createEntityWithInterview(db, userId, displayName, description?): Promise<SetupResult>
   - Call createEntity() to create profile stub
   - Return interview state for new entity
   - Claude guides through interview, then calls completeInterview()

5. Export functions for setup.ts integration
  </action>
  <verify>
grep -n "export.*interface.*SetupStatus" src/cli/setup-voice.ts returns 1
grep -n "export.*function.*getSetupStatus" src/cli/setup-voice.ts returns 1
grep -n "export.*function.*setupVoice" src/cli/setup-voice.ts returns 1
grep -n "export.*function.*createEntityWithInterview" src/cli/setup-voice.ts returns 1
  </verify>
  <done>
Setup status detection implemented
Voice subcommand handler created
Entity creation with interview integration
All functions return JSON for Claude rendering
  </done>
</task>

<task type="auto">
  <name>Add status detection to setup.ts</name>
  <files>src/cli/setup.ts</files>
  <action>
Update src/cli/setup.ts with status detection and voice integration:

1. Add import:
   import { getSetupStatus, setupVoice, type SetupStatus } from "./setup-voice";
   import { listEntities, createEntity } from "../voice/entity-profiles";

2. Add "voice" to SetupSubcommand type:
   type SetupSubcommand = ... | "voice" | "entity" | "status";

3. Add voice subcommand handler in runSetupSubcommand():
   case "voice": {
     const result = await setupVoice({
       userId: params.userId ?? "default",
       entitySlug: params.entity,
       db, // from hub connection
       configDir,
     });
     return { steps: [result], validation: null, completed: result.status === "success" };
   }

4. Add entity subcommand handler:
   case "entity": {
     if (params.list) {
       const entities = await listEntities(db, params.userId ?? "default");
       return {
         steps: [{
           step: "entity",
           status: "success",
           message: `${entities.length} entities found`,
           data: { entities },
         }],
         validation: null,
         completed: true,
       };
     }
     if (params.create) {
       const slug = await createEntity(db, params.userId ?? "default", params.create, params.description);
       return {
         steps: [{
           step: "entity",
           status: "success",
           message: `Entity created: ${slug}`,
           data: { entitySlug: slug },
         }],
         validation: null,
         completed: true,
       };
     }
     // Return need_input for entity creation prompt
     return {
       steps: [{
         step: "entity",
         status: "need_input",
         message: "Entity name required",
         data: { hint: "e.g., 'My Side Project' or 'PSN Founder'" },
       }],
       validation: null,
       completed: false,
     };
   }

5. Add status subcommand handler:
   case "status": {
     const status = await getSetupStatus(configDir, db, params.userId ?? "default");
     return {
       steps: [{
         step: "status",
         status: "success",
         message: status.incompleteSteps.length === 0
           ? "Setup complete"
           : `${status.incompleteSteps.length} steps remaining`,
         data: status,
       }],
       validation: null,
       completed: status.incompleteSteps.length === 0,
     };
   }

6. Update parseCliArgs for new subcommands and flags:
   - voice: --entity flag
   - entity: --list, --create, --description flags
   - status: no flags
  </action>
  <verify>
grep -n "case.*voice" src/cli/setup.ts returns 1
grep -n "case.*entity" src/cli/setup.ts returns 1
grep -n "case.*status" src/cli/setup.ts returns 1
grep -n "getSetupStatus" src/cli/setup.ts returns 1
grep -n "listEntities" src/cli/setup.ts returns 1
  </verify>
  <done>
voice, entity, status subcommands added to setup.ts
Status detection shows what's configured and what's missing
Entity creation flow integrated
  </done>
</task>

<task type="auto">
  <name>Update /psn:setup slash command spec</name>
  <files>.claude/commands/psn/setup.md</files>
  <action>
Update .claude/commands/psn/setup.md with new subcommands and flow:

1. Add new usage section at top:
   ## Usage
   - `/psn:setup` -- Personal Hub setup wizard (default)
   - `/psn:setup status` -- show what's configured and recommended next action
   - `/psn:setup voice` -- voice profile setup (absorbs /psn:voice interview)
   - `/psn:setup voice --entity <slug>` -- update specific entity voice
   - `/psn:setup entity` -- list entities or create new one
   - `/psn:setup entity --create "My Project"` -- create new entity
   - ... (existing subcommands)

2. Add "Returning User Flow" section:
   ### Returning User Flow
   When user runs `/psn:setup status`:
   - Show checkmarks for completed steps
   - Highlight gaps (missing steps)
   - Recommend next action
   - Offer shortcuts: "Want to [add voice] / [connect platform] / [create entity]?"

3. Add "Entity Creation Flow" section:
   ### Entity Creation Flow
   `/psn:setup entity --create "My Side Project"`:
   1. Create entity with auto-slugified name
   2. Start voice interview for new entity
   3. After interview: suggest platform connections
   4. Smart defaults: if existing entity has X connected, suggest X

4. Add "Voice Setup Flow" section:
   ### Voice Setup Flow
   `/psn:setup voice`:
   - If no entities: first-run interview creates default entity
   - If entities exist: show picker
   - After selection: start/update voice interview
   - Preserves existing /psn:voice interview functionality

5. Note deprecation of /psn:voice interview:
   > Note: `/psn:voice interview` is now accessible via `/psn:setup voice`.
   > `/psn:voice` still works for voice-only operations (tweak, calibrate, import).
  </action>
  <verify>
grep -n "psn:setup voice" .claude/commands/psn/setup.md returns at least 2
grep -n "psn:setup entity" .claude/commands/psn/setup.md returns at least 2
grep -n "psn:setup status" .claude/commands/psn/setup.md returns at least 2
  </verify>
  <done>
/psn:setup slash command spec updated with new flows
Voice interview absorbed into setup
Status detection documented
  </done>
</task>

<task type="auto">
  <name>Update /psn:voice slash command for absorbed functionality</name>
  <files>.claude/commands/psn/voice.md</files>
  <action>
Update .claude/commands/psn/voice.md to reflect absorbed interview:

1. Update description line:
   description: Voice profile management â€” tweaks, calibration, and imports

2. Add deprecation note for interview subcommand:
   > **Note:** Voice interviews are now managed via `/psn:setup voice`.
   > Use `/psn:setup voice` to create or update your voice profile.
   > This command remains for quick tweaks, calibration reports, and content imports.

3. Update "no args" section to mention setup integration:
   If no profile exists, suggest: "Run `/psn:setup voice` to create your voice profile."

4. Update interview section to redirect:
   ### /psn:voice interview
   > **Moved to `/psn:setup voice`**
   >
   > The interview flow is now part of the unified setup. Run:
   > ```
   > /psn:setup voice
   > ```
   >
   > For a specific entity: `/psn:setup voice --entity my-project`

5. Keep tweak, calibrate, import, edit, recalibrate sections unchanged.
  </action>
  <verify>
grep -n "psn:setup voice" .claude/commands/psn/voice.md returns at least 3
grep -n "Moved to" .claude/commands/psn/voice.md returns 1
  </verify>
  <done>
/psn:voice slash command updated
Interview redirected to /psn:setup voice
Other voice commands unchanged
  </done>
</task>

</tasks>

<verification>
1. getSetupStatus() correctly detects hub, voice profile, entities, platforms
2. /psn:setup status shows checkmarks and gaps
3. /psn:setup voice triggers interview flow
4. /psn:setup entity --create starts entity creation + interview
5. Entity creation suggests platform connections based on existing entities
6. /psn:voice redirects interview to /psn:setup voice
7. All slash command specs updated with new flows
</verification>

<success_criteria>
/psn:setup is the single entry point for all configuration.
Returning users see status screen with gaps and recommendations.
Voice interview absorbed into setup with entity support.
Smart defaults accelerate first-run setup.
</success_criteria>

<output>
After completion, create `.planning/phases/12-solo-founder-experience/12-02-SUMMARY.md`
</output>
