---
phase: 01-critical-setup-fixes
plan: 02
type: execute
wave: 1
depends_on: [01-01]
files_modified:
  - src/cli/setup-db.ts
  - src/core/utils/env.ts
autonomous: true
requirements: [C4]

must_haves:
  truths:
    - "Neon API key is validated before database creation"
    - "Project-scoped keys (napi_re4y...) are rejected with clear error"
    - "Organization-scoped keys (napi_k...) are accepted"
    - "Error messages explain how to generate correct key type"
  artifacts:
    - path: "src/core/utils/env.ts"
      provides: "API key validation utilities"
      exports: ["validateNeonApiKey"]
      min_lines: 40
    - path: "src/cli/setup-db.ts"
      provides: "Database setup with key validation"
      contains: "validateNeonApiKey"
  key_links:
    - from: "src/cli/setup-db.ts"
      to: "src/core/utils/env.ts"
      via: "import validateNeonApiKey"
      pattern: "import.*validateNeonApiKey"
    - from: "src/core/utils/env.ts"
      to: "https://console.neon.tech/api/v1/projects"
      via: "fetch API call"
      pattern: "fetch.*neon"
---

<objective>
Add Neon API key validation to detect project-scoped keys (which cannot create projects) and guide users to generate organization-scoped keys. This resolves C4 (Neon API key permission error).

Purpose: Project-scoped keys (starting with napi_re4y...) cannot create projects, but the setup wizard only discovers this after attempting database creation. Validate the key type early and provide clear guidance.

Output: validateNeonApiKey function in env.ts, integrated into setup-db.ts before neonctl project creation.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-critical-setup-fixes/01-CONTEXT.md
@.planning/phases/01-critical-setup-fixes/01-RESEARCH.md
@src/cli/setup-db.ts
@src/core/utils/env.ts

# Reference validation patterns
@.planning/research/error-validation-patterns.md
</context>

<tasks>

<task type="auto">
  <name>Add validateNeonApiKey function to env.ts</name>
  <files>src/core/utils/env.ts</files>
  <action>
Add validateNeonApiKey function to src/core/utils/env.ts that combines prefix detection with API validation:

```typescript
export interface ValidationResult {
  valid: boolean;
  error?: string;
  suggestion?: string;
  warning?: string;
}

export async function validateNeonApiKey(apiKey: string): Promise<ValidationResult> {
  // Step 1: Fast prefix check (immediate feedback)
  const projectScopedPrefix = "napi_re4yoevqpuf8oeafwmr5f984pnkf3wv8o652xhadd9f66w7sibutphyf0l0c0t09";
  if (apiKey.startsWith(projectScopedPrefix)) {
    return {
      valid: false,
      error: "Project-scoped API key detected",
      suggestion: "Generate an organization-scoped API key from Neon Console → Account → API Keys. Organization keys start with: napi_k..."
    };
  }

  // Step 2: API validation (actual verification via minimal API call)
  try {
    const response = await fetch("https://console.neon.tech/api/v1/projects", {
      method: "GET",
      headers: {
        "Authorization": `Bearer ${apiKey}`,
        "Accept": "application/json",
      },
    });

    if (response.status === 401) {
      return {
        valid: false,
        error: "API key invalid or expired",
        suggestion: "Regenerate API key from Neon Console."
      };
    }

    if (response.status === 403) {
      return {
        valid: false,
        error: "API key lacks project creation permissions",
        suggestion: "Use an organization-scoped API key with project creation permissions."
      };
    }

    // Success: can list projects, key is valid
    return { valid: true };
  } catch (error) {
    // Network failure - don't fail hard, just warn
    return {
      valid: true, // Assume valid if can't verify
      warning: `Could not validate API key with Neon API: ${error instanceof Error ? error.message : String(error)}`
    };
  }
}
```

This follows CONTEXT.md decisions: "Detect proactively AND show clear errors" and "Validate via API call".
</action>
  <verify>
Run: `grep -A 30 "export async function validateNeonApiKey" src/core/utils/env.ts` to verify function exists.
</verify>
  <done>
validateNeonApiKey function exists in src/core/utils/env.ts with prefix check and API validation.
</done>
</task>

<task type="auto">
  <name>Integrate key validation into setup-db.ts</name>
  <files>src/cli/setup-db.ts</files>
  <action>
In setup-db.ts, after loading NEON_API_KEY and before creating the Neon project, call validateNeonApiKey:

```typescript
// After loading neonApiKey (around line 40):
const neonApiKey = keysResult.data.NEON_API_KEY;
if (!neonApiKey) {
  return {
    step: "database",
    status: "error",
    message: "NEON_API_KEY not found in keys.env. Run key setup first.",
  };
}

// NEW: Validate API key before attempting database creation
const { validateNeonApiKey } = await import("../core/utils/env.ts");
const keyValidation = await validateNeonApiKey(neonApiKey);
if (!keyValidation.valid) {
  return {
    step: "database",
    status: "error",
    message: `API key validation failed: ${keyValidation.error}`,
    data: {
      error: keyValidation.error,
      suggestion: keyValidation.suggestion,
    },
  };
}

if (keyValidation.warning) {
  console.warn(`Warning: ${keyValidation.warning}`);
}
```

This catches incorrect key types early and provides actionable guidance.
</action>
  <verify>
Run: `grep -B 5 -A 10 "validateNeonApiKey" src/cli/setup-db.ts` to verify integration.
</verify>
  <done>
setup-db.ts validates NEON_API_KEY before neonctl project creation, with clear error messages for invalid key types.
</done>
</task>

</tasks>

<verification>
After completing all tasks, verify:
1. validateNeonApiKey function exists in src/core/utils/env.ts
2. Function checks for project-scoped key prefix (napi_re4y...)
3. Function makes API call to validate key can list projects
4. setup-db.ts calls validateNeonApiKey before creating Neon project
5. Error messages include both error description and actionable suggestion
</verification>

<success_criteria>
- Neon API key validation occurs before database creation
- Project-scoped keys are rejected with clear error and suggestion
- Organization-scoped keys pass validation
- API call validation catches expired/invalid keys
- Setup fails fast with helpful guidance for incorrect key types
</success_criteria>

<output>
After completion, create `.planning/phases/01-critical-setup-fixes/01-02-SUMMARY.md`
</output>
