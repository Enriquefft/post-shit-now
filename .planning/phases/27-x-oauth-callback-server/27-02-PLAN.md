---
phase: 27-x-oauth-callback-server
plan: 02
type: execute
wave: 2
depends_on:
  - 27-01
files_modified:
  - src/cli/setup-x-oauth.ts
  - src/platforms/handlers/x.handler.ts
  - src/trigger/analytics-collector.ts
  - src/trigger/token-refresher.ts
autonomous: true
requirements:
  - OAUTH-02
  - OAUTH-04

must_haves:
  truths:
    - "Running X OAuth setup auto-opens browser and captures code without manual paste"
    - "If port 18923 is unavailable, user is prompted to manually paste the authorization code"
    - "grep -r finds zero hardcoded X callback URLs -- all use the X_CALLBACK_URL constant"
    - "Developer Portal instructions show http://127.0.0.1:18923/callback as the callback URL"
  artifacts:
    - path: "src/cli/setup-x-oauth.ts"
      provides: "Integrated OAuth flow with auto-capture and manual fallback"
      contains: "captureOAuthCallback"
    - path: "src/platforms/handlers/x.handler.ts"
      provides: "X handler using X_CALLBACK_URL constant"
      contains: "X_CALLBACK_URL"
    - path: "src/trigger/analytics-collector.ts"
      provides: "Analytics collector using X_CALLBACK_URL constant"
      contains: "X_CALLBACK_URL"
    - path: "src/trigger/token-refresher.ts"
      provides: "Token refresher using X_CALLBACK_URL constant"
      contains: "X_CALLBACK_URL"
  key_links:
    - from: "src/cli/setup-x-oauth.ts"
      to: "src/cli/oauth-callback-server.ts"
      via: "import captureOAuthCallback"
      pattern: "import.*captureOAuthCallback"
    - from: "src/cli/setup-x-oauth.ts"
      to: "src/platforms/x/oauth.ts"
      via: "import X_CALLBACK_URL"
      pattern: "import.*X_CALLBACK_URL"
    - from: "src/platforms/handlers/x.handler.ts"
      to: "src/platforms/x/oauth.ts"
      via: "import X_CALLBACK_URL"
      pattern: "import.*X_CALLBACK_URL"
---

<objective>
Integrate the callback server into the X OAuth setup flow and eliminate all hardcoded X callback URL duplicates.

Purpose: Completes the automatic OAuth capture UX (browser opens, code captured, flow continues) with graceful fallback to manual paste when the port is unavailable. Also ensures OAUTH-02 compliance by replacing every hardcoded `https://example.com/callback` for X with the `X_CALLBACK_URL` constant.

Output: Modified setup-x-oauth.ts with auto-capture flow, and 3 files updated to use the constant.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/27-x-oauth-callback-server/27-CONTEXT.md
@.planning/phases/27-x-oauth-callback-server/27-RESEARCH.md
@.planning/phases/27-x-oauth-callback-server/27-01-SUMMARY.md

@src/cli/setup-x-oauth.ts
@src/cli/oauth-callback-server.ts
@src/platforms/x/oauth.ts
@src/platforms/handlers/x.handler.ts
@src/trigger/analytics-collector.ts
@src/trigger/token-refresher.ts

<interfaces>
<!-- From Plan 01 outputs -->

From src/platforms/x/oauth.ts (after Plan 01):
```typescript
export const X_CALLBACK_URL = "http://127.0.0.1:18923/callback";
export const OAUTH_CALLBACK_PORT = 18923;
export const OAUTH_CALLBACK_HOSTNAME = "127.0.0.1";

export function createXOAuthClient(config: XOAuthConfig): Twitter;
export function generateAuthUrl(client: Twitter): { url: string; state: string; codeVerifier: string };
export function exchangeCode(client: Twitter, code: string, codeVerifier: string): Promise<...>;
```

From src/cli/oauth-callback-server.ts (from Plan 01):
```typescript
export type CallbackOutcome =
  | { ok: true; result: { code: string; state: string } }
  | { ok: false; error: { error: "timeout" | "state_mismatch" | "port_unavailable" | "missing_params"; message: string } };

export function captureOAuthCallback(expectedState: string, options: { authUrl: string; timeoutMs: number }): Promise<CallbackOutcome>;
export function startCallbackServer(expectedState: string, options: { port: number; hostname: string; timeoutMs: number }): Promise<CallbackOutcome>;
export function openBrowser(url: string): boolean;
export function canOpenBrowser(): boolean;
```

From src/core/types/index.ts:
```typescript
export interface SetupResult {
  step: string;
  status: "success" | "skipped" | "error" | "need_input";
  message: string;
  data?: Record<string, unknown>;
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate callback server into setup-x-oauth.ts with manual fallback</name>
  <files>src/cli/setup-x-oauth.ts</files>
  <action>
Rewrite `src/cli/setup-x-oauth.ts` to use the callback server for automatic code capture.

**Changes:**

1. **Remove** the local `const X_CALLBACK_URL = "https://example.com/callback";` (line 9).

2. **Add imports:**
   ```typescript
   import { createXOAuthClient, exchangeCode, generateAuthUrl, X_CALLBACK_URL } from "../platforms/x/oauth.ts";
   import { captureOAuthCallback } from "./oauth-callback-server.ts";
   ```

3. **Update Developer Portal instructions** (the `need_input` block when credentials are missing, around line 42-67): Change the callback URL instruction from `https://example.com/callback` to reference `X_CALLBACK_URL`:
   ```
   "   - Set Callback URL to: http://127.0.0.1:18923/callback",
   ```
   Use the string literal here since this is user-facing instructional text (not a code reference).

4. **Replace the auth flow** (lines 101-121) where it currently returns `need_input` with the auth URL. New flow:

   ```typescript
   // No valid token -- initiate OAuth flow
   const client = createXOAuthClient({
     clientId,
     clientSecret,
     callbackUrl: X_CALLBACK_URL,
   });
   const { url, state, codeVerifier } = generateAuthUrl(client);

   // Try automatic capture via callback server
   const outcome = await captureOAuthCallback(state, {
     authUrl: url,
     timeoutMs: 120_000,
   });

   if (outcome.ok) {
     // Auto-captured -- proceed directly to token exchange
     return completeXOAuth(configDir, outcome.result.code, outcome.result.state, codeVerifier);
   }

   // Fallback: manual code entry (OAUTH-04)
   return {
     step: "x-oauth",
     status: "need_input",
     message: `${outcome.error.message} Paste the authorization code from the redirect URL:`,
     data: {
       authUrl: url,
       state,
       codeVerifier,
       instructions: "Open the URL above in your browser, authorize the app, then paste the authorization code (the 'code' query parameter from the redirect URL)",
     },
   };
   ```

5. **Update `completeXOAuth`** (line 165-168): Replace the local `X_CALLBACK_URL` reference with the imported constant. The `callbackUrl: X_CALLBACK_URL` on line 168 should now use the imported constant automatically since the local const was removed.

**Keep unchanged:** All token exchange logic, DB operations, and the `completeXOAuth` function signature. The function is still called by the setup wizard with the code (either auto-captured or manually pasted).
  </action>
  <verify>
    <automated>cd /home/hybridz/Projects/post-shit-now && bun run typecheck 2>&1 | tail -5 && grep -c "example.com" src/cli/setup-x-oauth.ts | grep -q "0" && grep -c "captureOAuthCallback" src/cli/setup-x-oauth.ts</automated>
  </verify>
  <done>
    - setup-x-oauth.ts imports X_CALLBACK_URL from platforms/x/oauth.ts (not local const)
    - setup-x-oauth.ts imports and calls captureOAuthCallback
    - On successful callback: proceeds directly to completeXOAuth (no manual paste needed)
    - On failure (timeout/port unavailable): falls back to need_input with manual paste prompt
    - Zero instances of "example.com" in setup-x-oauth.ts
    - Developer Portal instructions show http://127.0.0.1:18923/callback
    - Typecheck passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Replace hardcoded X callback URLs in handlers and trigger tasks</name>
  <files>
    src/platforms/handlers/x.handler.ts
    src/trigger/analytics-collector.ts
    src/trigger/token-refresher.ts
  </files>
  <action>
Replace all hardcoded `"https://example.com/callback"` strings used for X OAuth clients with the `X_CALLBACK_URL` constant. Only change X-specific instances -- leave LinkedIn, TikTok, and Instagram callback URLs untouched (they are out of scope per OAUTH-05 deferral).

**src/platforms/handlers/x.handler.ts:**
- Add import: `import { X_CALLBACK_URL } from "../x/oauth.ts";` (relative path from handlers/)
- Line 55: Replace `callbackUrl: "https://example.com/callback"` with `callbackUrl: X_CALLBACK_URL`

**src/trigger/analytics-collector.ts:**
- Add import: `import { X_CALLBACK_URL } from "../platforms/x/oauth.ts";`
- Line 150: Replace `callbackUrl: "https://example.com/callback"` with `callbackUrl: X_CALLBACK_URL`
- Only change the X-specific createXOAuthClient call. Leave other platform callbackUrl strings as-is.

**src/trigger/token-refresher.ts:**
- Add import: `import { X_CALLBACK_URL } from "../platforms/x/oauth.ts";`
- Line 117: Replace `callbackUrl: "https://example.com/callback"` with `callbackUrl: X_CALLBACK_URL` (this is inside the X token refresh block)
- Leave LinkedIn (line 131) and TikTok (line 148) callback URLs unchanged.

**Verification command to confirm no X-specific hardcoded duplicates remain:**
```bash
# After changes, this should return 0 matches in X-related contexts
grep -n "example.com/callback" src/platforms/handlers/x.handler.ts src/trigger/analytics-collector.ts src/trigger/token-refresher.ts
```
Note: The grep will still find matches in analytics-collector.ts and token-refresher.ts for non-X platforms (LinkedIn, TikTok). That is expected and correct.
  </action>
  <verify>
    <automated>cd /home/hybridz/Projects/post-shit-now && bun run typecheck 2>&1 | tail -5 && grep -c "X_CALLBACK_URL" src/platforms/handlers/x.handler.ts src/trigger/analytics-collector.ts src/trigger/token-refresher.ts</automated>
  </verify>
  <done>
    - x.handler.ts uses X_CALLBACK_URL constant (1 usage)
    - analytics-collector.ts uses X_CALLBACK_URL for X OAuth client (1 usage, other platforms unchanged)
    - token-refresher.ts uses X_CALLBACK_URL for X OAuth client (1 usage, LinkedIn/TikTok unchanged)
    - `grep -r "example.com/callback" src/cli/setup-x-oauth.ts src/platforms/handlers/x.handler.ts` returns 0 matches
    - Typecheck passes
  </done>
</task>

</tasks>

<verification>
- `bun run typecheck` passes with no new errors
- `grep -rn "X_CALLBACK_URL" src/` shows constant defined once in oauth.ts, imported in setup-x-oauth.ts, x.handler.ts, analytics-collector.ts, token-refresher.ts
- `grep -n "example.com/callback" src/cli/setup-x-oauth.ts src/platforms/handlers/x.handler.ts` returns zero matches
- `grep -c "captureOAuthCallback" src/cli/setup-x-oauth.ts` returns at least 1
- setup-x-oauth.ts has both auto-capture path and manual fallback path
</verification>

<success_criteria>
- X OAuth setup opens browser and auto-captures code (OAUTH-01 complete UX)
- Manual fallback works when port unavailable (OAUTH-04)
- Zero hardcoded X callback URL duplicates (OAUTH-02 fully satisfied)
- Developer Portal instructions updated to show 127.0.0.1:18923 callback URL
</success_criteria>

<output>
After completion, create `.planning/phases/27-x-oauth-callback-server/27-02-SUMMARY.md`
</output>
