---
phase: 06-linkedin-and-multi-platform
plan: 02
type: execute
wave: 2
depends_on: [06-01]
files_modified:
  - src/trigger/publish-post.ts
  - src/content/format-picker.ts
  - src/analytics/collector.ts
  - src/trigger/analytics-collector.ts
  - src/analytics/types.ts
  - src/content/generate.ts
  - src/cli/post.ts
  - src/core/types/index.ts
  - src/planning/types.ts
autonomous: true
requirements: [PLAT-02, PLAT-06, PLAT-07, ANLYT-02, POST-02]

must_haves:
  truths:
    - "User can generate and post LinkedIn content (text, image, carousel) adapted to LinkedIn format strengths"
    - "Multi-platform posting dispatches independently per platform with partial failure isolation"
    - "LinkedIn failure does not block X posting — each platform publishes independently"
    - "Analytics collector pulls LinkedIn metrics (impressions, reactions, comments, reshares) daily"
    - "Format picker recommends LinkedIn-appropriate formats (carousel for lists, long-form for stories)"
    - "Per-platform publish status is visible on each post record"
  artifacts:
    - path: "src/trigger/publish-post.ts"
      provides: "Multi-platform dispatch with partial failure isolation"
      contains: "publishToPlatform"
    - path: "src/content/format-picker.ts"
      provides: "LinkedIn format recommendations (carousel, article, image-post, long-post)"
      contains: "linkedin"
    - path: "src/analytics/collector.ts"
      provides: "LinkedIn analytics collection alongside X analytics"
      exports: ["collectLinkedInAnalytics"]
    - path: "src/analytics/types.ts"
      provides: "LinkedIn metric types"
      contains: "LinkedInMetrics"
  key_links:
    - from: "src/trigger/publish-post.ts"
      to: "src/platforms/linkedin/client.ts"
      via: "LinkedIn publish path"
      pattern: "LinkedInClient"
    - from: "src/analytics/collector.ts"
      to: "src/platforms/linkedin/client.ts"
      via: "LinkedIn analytics fetch"
      pattern: "getPostAnalytics"
    - from: "src/trigger/publish-post.ts"
      to: "post.metadata.platformStatus"
      via: "per-platform status tracking"
      pattern: "platformStatus"
---

<objective>
Extend the posting pipeline, format picker, and analytics collector for multi-platform support with LinkedIn as the second platform.

Purpose: Complete Phase 6 by wiring LinkedIn into the existing content pipeline — format picker suggests LinkedIn formats, publish-post dispatches to multiple platforms with partial failure isolation, and analytics collector pulls LinkedIn metrics.
Output: Multi-platform publish-post task, extended format picker, LinkedIn analytics collection, and updated CLI/commands.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-linkedin-and-multi-platform/06-RESEARCH.md
@.planning/phases/06-linkedin-and-multi-platform/06-CONTEXT.md
@.planning/phases/06-linkedin-and-multi-platform/06-01-SUMMARY.md

# Files to extend
@src/trigger/publish-post.ts
@src/content/format-picker.ts
@src/analytics/collector.ts
@src/trigger/analytics-collector.ts
@src/analytics/types.ts
@src/content/generate.ts
@src/cli/post.ts
@src/core/types/index.ts
@src/planning/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Multi-platform publish-post with partial failure isolation</name>
  <files>
    src/trigger/publish-post.ts
    src/core/types/index.ts
  </files>
  <action>
    Refactor the publish-post Trigger.dev task from single-platform (X only) to multi-platform dispatch:

    1. Add `PlatformPublishResult` type to core types:
       ```typescript
       interface PlatformPublishResult {
         platform: Platform;
         status: "published" | "failed" | "skipped";
         externalPostId?: string;
         error?: string;
       }
       ```

    2. Add `platformStatus` to PostMetadata type in core/types:
       ```typescript
       platformStatus?: Record<Platform, { status: string; externalPostId?: string; error?: string; retryCount?: number }>;
       ```

    3. Refactor publish-post.ts:
       - Keep the existing PublishPostPayload interface
       - Add `targetPlatforms` field to payload (optional, defaults to [post.platform] for backward compatibility)
       - Extract current X publishing logic into a `publishToX(db, post, encKey)` function
       - Create a new `publishToLinkedIn(db, post, encKey)` function:
         - Load LinkedIn OAuth token (platform = 'linkedin')
         - Decrypt access token
         - Create LinkedInClient instance
         - Determine content type from post metadata (text, image, document/carousel)
         - For image posts: initializeImageUpload → uploadImageBinary → waitForMediaReady → createImagePost
         - For document/carousel posts: load or generate PDF → initializeDocumentUpload → uploadDocumentBinary → waitForMediaReady → createDocumentPost
         - For text posts: createTextPost
         - Handle LinkedInRateLimitError with wait.until() (same pattern as X)
         - Handle LinkedInApiError with retry tracking
         - Return PlatformPublishResult
       - Create `publishToPlatform(db, post, platform, encKey)` dispatcher that routes to publishToX or publishToLinkedIn
       - Main task logic:
         - Determine target platforms from payload or post metadata
         - For each platform, call publishToPlatform in a try/catch
         - Collect PlatformPublishResult[] for all platforms
         - Update post.metadata.platformStatus with per-platform results
         - Overall post status: "published" if ANY platform succeeded, "failed" if ALL failed
         - If partial failure (some succeeded, some failed): status = "published", subStatus = "partial_failure"
         - Log each platform result independently

    4. LinkedIn-specific publishing considerations:
       - Author URN: Read personUrn from oauth_tokens metadata (stored during setup)
       - Visibility: Default "PUBLIC", allow "CONNECTIONS" override via post metadata
       - Content type detection: Check post.metadata.linkedinFormat or post.metadata.format:
         - "carousel" → document post (needs PDF in media)
         - "image-post" → image post
         - "article" → article post
         - default → text post
       - LinkedIn commentary field supports hashtags (#coding) and mentions (@[Name](urn:li:organization:xxx))

    5. Backward compatibility: When targetPlatforms is not provided, publish to post.platform only (single platform, existing behavior)
  </action>
  <verify>
    Run `pnpm exec tsc --noEmit` to verify compile. Check that existing X-only paths still work by verifying the publishToX function is called when platform='x'. Verify platformStatus metadata structure by reading the type definitions.
  </verify>
  <done>
    publish-post task dispatches to X and LinkedIn independently. Partial failure isolation works — X success is not rolled back if LinkedIn fails. Per-platform status tracked in post metadata. Backward compatible with single-platform posts.
  </done>
</task>

<task type="auto">
  <name>Task 2: LinkedIn format picker, content adaptation, and post generation</name>
  <files>
    src/content/format-picker.ts
    src/content/generate.ts
    src/cli/post.ts
    src/planning/types.ts
  </files>
  <action>
    1. Extend `src/content/format-picker.ts`:
       - Add LinkedIn-specific formats to PostFormat type: `"long-post"` (1000-1300 char LinkedIn text), `"linkedin-article"` (article with URL)
       - Add LinkedIn format constraints:
         - "long-post": { maxChars: 3000, description: "Long-form LinkedIn text post (optimal 1000-1300 chars)" }
         - "linkedin-article": { description: "LinkedIn article with URL, title, and description" }
         - "carousel" already exists — add note: "Multi-slide visual content (LinkedIn document post, Instagram)"
       - Add `LINKEDIN_FORMAT_MAP` mapping content signals to LinkedIn-appropriate formats:
         - Lists, steps, frameworks, how-tos, comparisons → "carousel" (auto-suggested per CONTEXT.md)
         - Stories, experiences, lessons learned → "long-post"
         - Data-heavy, statistics → "carousel" or "infographic"
         - Quotes, inspiration → "quote-image"
         - External reference with commentary → "linkedin-article"
         - Short hot takes → "short-post" (but recommend expanding for LinkedIn)
       - Extend the `pickFormat(topic, platform, preferences?)` function:
         - When platform is 'linkedin', use LINKEDIN_FORMAT_MAP for scoring
         - Include reasoning about why format was chosen
         - If content fits carousel pattern, auto-suggest carousel per CONTEXT.md decision
       - Add `PLATFORM_FORMAT_SUPPORT` map showing which formats work on which platforms:
         - x: short-post, thread, image-post, video-post, quote-image
         - linkedin: short-post, long-post, carousel, image-post, linkedin-article, video-post, quote-image, infographic

    2. Update `src/content/generate.ts` (content generation):
       - Add LinkedIn-specific generation guidance:
         - LinkedIn posts should be 1000-1300 chars (not 280 like X)
         - Use hooks with line breaks (common LinkedIn pattern)
         - Include CTAs where appropriate
         - Professional but authentic tone
         - Hashtags at end (3-5 relevant hashtags)
       - Add `adaptContentForPlatform(content, fromPlatform, toPlatform)` function:
         - X→LinkedIn: Expand short content, add hook + line breaks, add CTA, add hashtags
         - LinkedIn→X: Condense to key point, split to thread if needed
         - Returns adapted content string
       - Add `generateLinkedInContent(topic, format, voiceContext)` guidance constants for the content brain

    3. Update `src/cli/post.ts`:
       - Add platform selection step when multiple platforms are enabled:
         - Read strategy.yaml for default platforms per pillar/format
         - Present platform options: "Which platforms? [x] X [x] LinkedIn" (defaults from strategy)
         - User can add/remove platforms
       - Add generate-then-branch flow per CONTEXT.md:
         - Generate core content first
         - For each target platform, show adapted preview
         - User reviews each platform version independently
         - Can approve some, reject others, edit individually
       - When scheduling multi-platform posts:
         - Create one post record per platform (existing model: one row per platform)
         - Link them via metadata.multiPlatformGroupId (UUID to group related cross-platform posts)
         - Apply platform-optimal stagger: schedule each platform at its optimal time within posting window

    4. Update `src/planning/types.ts`:
       - Add `targetPlatforms: Platform[]` to PlanSlot type
       - This enables weekly plan slots to target multiple platforms per CONTEXT.md decision ("one slot, multiple platforms")
  </action>
  <verify>
    Run `pnpm exec tsc --noEmit` to verify. Check format picker returns LinkedIn-specific recommendations when platform='linkedin'. Verify post CLI handles multi-platform flow by reviewing the updated code paths.
  </verify>
  <done>
    Format picker recommends LinkedIn-appropriate formats with carousel auto-suggestion for list/step content. Content adaptation works X↔LinkedIn. Post CLI supports multi-platform selection with generate-then-branch previews. Weekly plan slots support multi-platform targeting.
  </done>
</task>

<task type="auto">
  <name>Task 3: LinkedIn analytics collection and review integration</name>
  <files>
    src/analytics/collector.ts
    src/analytics/types.ts
    src/trigger/analytics-collector.ts
  </files>
  <action>
    1. Update `src/analytics/types.ts`:
       - Add LinkedIn-specific metric types:
         ```typescript
         interface LinkedInMetrics {
           impressions: number;
           membersReached: number;
           reactions: number;
           comments: number;
           reshares: number;
         }
         ```
       - Update TweetPublicMetrics or create a platform-agnostic PlatformMetrics union:
         ```typescript
         type PlatformMetrics = XMetrics | LinkedInMetrics;
         ```
       - Add metric type discriminator (platform field)

    2. Update `src/analytics/collector.ts`:
       - Add `collectLinkedInAnalytics(db, client: LinkedInClient, userId: string)` function:
         - Query published LinkedIn posts from last 30 days (same as X collector pattern)
         - For each post, fetch per-metric analytics using memberCreatorPostAnalytics API:
           - IMPRESSION (total)
           - REACTION (total)
           - COMMENT (total)
           - RESHARE (total)
           - MEMBERS_REACHED (total, not daily — daily not supported per API docs)
         - Map to postMetrics table (same schema, different platform value)
         - Use `computeEngagementScore()` with LinkedIn-weighted metrics:
           - LinkedIn weighting: reshares (saves equivalent) > comments > reactions > impressions
           - Reuse existing scoring but with LinkedIn-specific weights
         - Per-post error isolation (catch, log, continue) — same pattern as X collector
         - Track apiCallsMade: 5 API calls per post (one per metric type)
         - Return CollectionSummary

       - Add LinkedIn rate limit awareness:
         - LinkedIn API rate limits are per-endpoint, extracted from response headers
         - If rate limited, log and skip remaining posts (don't crash collection)
         - Track rate limit info in collection summary

    3. Update `src/trigger/analytics-collector.ts`:
       - Extend the Trigger.dev cron task to collect LinkedIn analytics alongside X:
         - After X collection, check if LinkedIn token exists for user
         - If yes: create LinkedInClient, call collectLinkedInAnalytics
         - If no: skip LinkedIn collection silently
         - Combine results into single summary
         - LinkedIn collection failure should NOT prevent X collection from completing (partial failure isolation applies to analytics too)
       - Add LinkedIn token loading logic:
         - Query oauth_tokens WHERE platform='linkedin' for the user
         - Decrypt access token
         - Create LinkedInClient
         - If token is expired or missing, log warning and skip

    4. Engagement scoring for LinkedIn:
       - LinkedIn uses "reactions" (like, celebrate, love, insightful, funny, curious) as a single count — different from X likes
       - Reshares on LinkedIn = reposts, equivalent importance to X retweets
       - Comments on LinkedIn tend to be higher quality/longer — weight slightly higher than X
       - Suggested LinkedIn engagement weights for computeEngagementScore:
         - reshares: 4 (high signal, like X retweets)
         - comments: 3 (high quality on LinkedIn)
         - reactions: 1 (engagement but lower signal)
         - Use existing basis points (bps) pattern for rate calculation
       - impressions and membersReached used for rate denominators
  </action>
  <verify>
    Run `pnpm exec tsc --noEmit` to verify all analytics files compile with LinkedIn types. Verify the collector function signature accepts LinkedInClient. Check the analytics-collector task handles both platforms independently.
  </verify>
  <done>
    LinkedIn analytics collector pulls daily metrics (impressions, reactions, comments, reshares, members reached) and writes to postMetrics with LinkedIn-weighted engagement scores. Collection failure on one platform doesn't affect the other. Analytics task handles both X and LinkedIn tokens.
  </done>
</task>

</tasks>

<verification>
- [ ] `pnpm exec tsc --noEmit` passes with all changes
- [ ] publish-post dispatches to X and LinkedIn independently
- [ ] Partial failure: X publishes even if LinkedIn fails (and vice versa)
- [ ] Per-platform status tracked in post metadata
- [ ] Format picker recommends carousel for LinkedIn list/step content
- [ ] LinkedIn posts target 1000-1300 chars (not 280)
- [ ] Content adaptation works between X and LinkedIn
- [ ] Post CLI supports multi-platform selection and generate-then-branch preview
- [ ] Analytics collector pulls LinkedIn metrics (5 types) per post
- [ ] LinkedIn analytics failure doesn't crash X analytics collection
- [ ] Engagement scoring uses LinkedIn-appropriate weights
</verification>

<success_criteria>
- Multi-platform posting works end-to-end with partial failure isolation
- LinkedIn content is adapted to LinkedIn norms (length, hooks, hashtags, CTAs)
- Format picker makes LinkedIn-specific recommendations
- Analytics collection covers both X and LinkedIn daily
- Post CLI supports multi-platform selection with per-platform previews
- All changes backward-compatible with X-only posting
- TypeScript compiles without errors
</success_criteria>

<output>
After completion, create `.planning/phases/06-linkedin-and-multi-platform/06-02-SUMMARY.md`
</output>
