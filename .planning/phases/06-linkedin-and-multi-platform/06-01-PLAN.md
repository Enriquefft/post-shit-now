---
phase: 06-linkedin-and-multi-platform
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/platforms/linkedin/oauth.ts
  - src/platforms/linkedin/types.ts
  - src/platforms/linkedin/client.ts
  - src/platforms/linkedin/media.ts
  - src/platforms/linkedin/carousel.ts
  - src/cli/setup-linkedin-oauth.ts
  - src/cli/setup.ts
  - src/trigger/token-refresher.ts
autonomous: true
requirements: [AUTH-02, PLAT-02]
user_setup:
  - service: linkedin
    why: "LinkedIn API access for posting and analytics"
    env_vars:
      - name: LINKEDIN_CLIENT_ID
        source: "LinkedIn Developer Portal -> My Apps -> Your App -> Auth tab"
      - name: LINKEDIN_CLIENT_SECRET
        source: "LinkedIn Developer Portal -> My Apps -> Your App -> Auth tab"
    dashboard_config:
      - task: "Create LinkedIn Developer App"
        location: "https://www.linkedin.com/developers/apps -> Create App"
      - task: "Enable 'Share on LinkedIn' product (self-serve)"
        location: "LinkedIn Developer Portal -> Products tab -> Share on LinkedIn"
      - task: "Set OAuth redirect URL to https://example.com/callback"
        location: "LinkedIn Developer Portal -> Auth tab -> Redirect URLs"

must_haves:
  truths:
    - "User can authenticate with LinkedIn via OAuth 2.0 and receive encrypted tokens stored in Hub DB"
    - "LinkedIn tokens auto-refresh before 60-day expiry via existing token-refresher cron"
    - "User can create text posts, image posts, and document/carousel posts on LinkedIn via API"
    - "LinkedIn image and document upload follows initialize-then-upload two-step flow"
  artifacts:
    - path: "src/platforms/linkedin/oauth.ts"
      provides: "LinkedIn OAuth 2.0 flow using Arctic LinkedIn provider"
      exports: ["createLinkedInOAuthClient", "generateAuthUrl", "exchangeCode", "refreshAccessToken"]
    - path: "src/platforms/linkedin/client.ts"
      provides: "Typed LinkedIn REST API client with versioned headers and rate limit tracking"
      exports: ["LinkedInClient"]
    - path: "src/platforms/linkedin/media.ts"
      provides: "LinkedIn image and document upload via two-step flow"
      exports: ["initializeImageUpload", "uploadImage", "initializeDocumentUpload", "uploadDocument"]
    - path: "src/platforms/linkedin/carousel.ts"
      provides: "PDF generation for LinkedIn organic carousel/document posts"
      exports: ["generateCarouselPdf"]
    - path: "src/platforms/linkedin/types.ts"
      provides: "LinkedIn API types, Zod schemas, error classes"
      exports: ["LinkedInApiError", "LinkedInRateLimitError", "LinkedInPostSchema"]
    - path: "src/cli/setup-linkedin-oauth.ts"
      provides: "LinkedIn OAuth setup step for /psn:setup flow"
      exports: ["setupLinkedInOAuth"]
  key_links:
    - from: "src/platforms/linkedin/oauth.ts"
      to: "arctic"
      via: "LinkedIn provider constructor"
      pattern: "new LinkedIn\\("
    - from: "src/platforms/linkedin/client.ts"
      to: "https://api.linkedin.com"
      via: "fetch with versioned headers"
      pattern: "LinkedIn-Version.*X-Restli-Protocol-Version"
    - from: "src/trigger/token-refresher.ts"
      to: "src/platforms/linkedin/oauth.ts"
      via: "LinkedIn token refresh path"
      pattern: "platform.*linkedin"
---

<objective>
Build the LinkedIn platform module: OAuth 2.0 authentication, typed API client, image/document media upload, and PDF carousel generation.

Purpose: Establish the complete LinkedIn API integration layer that Plan 06-02 will use for multi-platform dispatch, content adaptation, and analytics collection.
Output: LinkedIn OAuth flow, LinkedInClient class, media upload helpers, carousel PDF generator, and token-refresher extension.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-linkedin-and-multi-platform/06-RESEARCH.md
@.planning/phases/06-linkedin-and-multi-platform/06-CONTEXT.md

# X platform module (pattern to mirror)
@src/platforms/x/oauth.ts
@src/platforms/x/client.ts
@src/platforms/x/media.ts
@src/platforms/x/types.ts
@src/trigger/token-refresher.ts
@src/cli/setup-x-oauth.ts
@src/cli/setup.ts
@src/core/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: LinkedIn types, OAuth module, and setup integration</name>
  <files>
    src/platforms/linkedin/types.ts
    src/platforms/linkedin/oauth.ts
    src/cli/setup-linkedin-oauth.ts
    src/cli/setup.ts
    src/core/types/index.ts
  </files>
  <action>
    Create `src/platforms/linkedin/types.ts`:
    - Define `LinkedInOAuthConfig` interface (clientId, clientSecret, callbackUrl) matching XOAuthConfig pattern
    - Define LinkedIn API response types with Zod schemas:
      - `LinkedInPostCreateResponse` (postId from x-restli-id header)
      - `LinkedInImageUploadResponse` (uploadUrl, image URN, expiresAt)
      - `LinkedInDocumentUploadResponse` (uploadUrl, document URN, expiresAt)
      - `LinkedInPostAnalytics` (elements array with count, metricType, dateRange)
      - `LinkedInUserInfo` (sub, name, email from OpenID Connect userinfo)
    - Define `LinkedInApiError` and `LinkedInRateLimitError` error classes mirroring X error pattern
    - Define `LinkedInRateLimitInfo` interface

    Add `LinkedInOAuthConfig` export to `src/core/types/index.ts`.

    Create `src/platforms/linkedin/oauth.ts`:
    - Import `LinkedIn` from arctic (NOT Twitter — different provider class)
    - `createLinkedInOAuthClient(config: LinkedInOAuthConfig): LinkedIn` — instantiate Arctic LinkedIn client
    - `generateAuthUrl(client: LinkedIn)` — generate auth URL with scopes: `openid`, `profile`, `w_member_social`, `r_member_postAnalytics`. LinkedIn does NOT use PKCE (unlike X) — use state param only, no codeVerifier
    - `exchangeCode(client, code)` — validate authorization code, return { accessToken, refreshToken, expiresAt }
    - `refreshAccessToken(client, refreshToken)` — refresh tokens, return new token set
    - Note: LinkedIn tokens expire in 60 days (not 2 hours like X). Refresh tokens also expire (refresh_token_expires_in from response)

    Create `src/cli/setup-linkedin-oauth.ts`:
    - Mirror `setup-x-oauth.ts` pattern exactly
    - Check for LINKEDIN_CLIENT_ID and LINKEDIN_CLIENT_SECRET env vars
    - Check if LinkedIn token already exists in oauth_tokens table (platform = 'linkedin')
    - Generate auth URL, display to user, wait for callback code
    - Exchange code, encrypt tokens, store in oauth_tokens with platform = 'linkedin'
    - Fetch and store person URN via `GET https://api.linkedin.com/v2/userinfo` (requires `openid` scope) — store personUrn in token metadata for post authoring
    - Return SetupResult

    Update `src/cli/setup.ts`:
    - Import setupLinkedInOAuth
    - Add LinkedIn OAuth as a setup step after X OAuth (conditional on LINKEDIN_CLIENT_ID being set)
    - LinkedIn setup is optional — skip gracefully if no credentials provided
  </action>
  <verify>
    Run `pnpm exec tsc --noEmit` to verify types compile. Verify the Arctic `LinkedIn` import exists by checking: `node -e "import('arctic').then(m => console.log(typeof m.LinkedIn))"` returns 'function'.
  </verify>
  <done>
    LinkedIn OAuth module compiles, mirrors X OAuth pattern, uses Arctic LinkedIn provider with correct scopes. Setup flow integrates into /psn:setup. LinkedInOAuthConfig type exported from core.
  </done>
</task>

<task type="auto">
  <name>Task 2: LinkedIn API client, media upload, and carousel PDF generation</name>
  <files>
    src/platforms/linkedin/client.ts
    src/platforms/linkedin/media.ts
    src/platforms/linkedin/carousel.ts
  </files>
  <action>
    Create `src/platforms/linkedin/client.ts`:
    - `LinkedInClient` class mirroring `XClient` pattern:
      - Constructor takes accessToken and optional version (default: "202602")
      - Private `request<T>(endpoint, options, schema?)` method:
        - Sets `Authorization: Bearer {token}`
        - Sets `LinkedIn-Version: {version}` (YYYYMM format)
        - Sets `X-Restli-Protocol-Version: 2.0.0`
        - Sets `Content-Type: application/json` for POST requests with body
        - Extracts rate limit info from response headers
        - Throws `LinkedInRateLimitError` on 429
        - Throws `LinkedInApiError` on non-2xx
        - Validates response with Zod schema if provided
      - `createTextPost(author, commentary, visibility?)` — POST /rest/posts with text only
      - `createImagePost(author, commentary, imageUrn, altText?, visibility?)` — POST /rest/posts with image content
      - `createDocumentPost(author, commentary, documentUrn, title?, visibility?)` — POST /rest/posts with document content
      - `createMultiImagePost(author, commentary, imageUrns, visibility?)` — POST /rest/posts with multiImage content (max 20 images)
      - `createArticlePost(author, commentary, articleUrl, title, description, thumbnailUrn?, visibility?)` — POST /rest/posts with article content
      - `getPost(postUrn)` — GET /rest/posts/{encoded URN}
      - `getPostsByAuthor(authorUrn, count?, sortBy?)` — GET /rest/posts?author={encoded}&q=author
      - `deletePost(postUrn)` — DELETE /rest/posts/{encoded URN}
      - `getPostAnalytics(postUrn, queryType, aggregation?, dateRange?)` — GET /rest/memberCreatorPostAnalytics with entity finder
      - `getAggregatedAnalytics(queryType, aggregation?, dateRange?)` — GET /rest/memberCreatorPostAnalytics with me finder
      - `getUserInfo()` — GET /v2/userinfo (OpenID Connect)
      - Helper: `encodeUrn(urn)` — URL-encode LinkedIn URNs for query params
      - All POST /rest/posts methods return the post ID from the `x-restli-id` response header
      - Post body structure: { author, commentary, visibility: "PUBLIC", distribution: { feedDistribution: "MAIN_FEED", targetEntities: [], thirdPartyDistributionChannels: [] }, lifecycleState: "PUBLISHED", isReshareDisabledByAuthor: false, content?: {...} }

    Create `src/platforms/linkedin/media.ts`:
    - `initializeImageUpload(client, ownerUrn)` — POST /rest/images?action=initializeUpload with owner. Returns { uploadUrl, imageUrn, expiresAt }
    - `uploadImageBinary(uploadUrl, accessToken, imageBuffer)` — PUT binary data to uploadUrl with auth header
    - `initializeDocumentUpload(client, ownerUrn)` — POST /rest/documents?action=initializeUpload. Returns { uploadUrl, documentUrn, expiresAt }
    - `uploadDocumentBinary(uploadUrl, accessToken, documentBuffer)` — PUT binary to uploadUrl
    - `getImageStatus(client, imageUrn)` — GET /rest/images/{imageUrn} to check AVAILABLE status
    - `getDocumentStatus(client, documentUrn)` — GET /rest/documents/{documentUrn} to check AVAILABLE status
    - `waitForMediaReady(client, urn, type, maxWaitMs?)` — Poll status until AVAILABLE (processing can take time). Default max 60s with 2s intervals

    Create `src/platforms/linkedin/carousel.ts`:
    - Install `pdf-lib` as dependency: `pnpm add pdf-lib`
    - `generateCarouselPdf(slides: CarouselSlide[])` — Creates a multi-page PDF from slide content
    - `CarouselSlide` interface: { title?: string; body: string; imageBuffer?: Buffer; backgroundColor?: string; slideNumber?: number }
    - PDF page size: 1080x1080 (square, optimal for LinkedIn carousel viewing)
    - Each slide = one PDF page with:
      - Optional title (larger font, top area)
      - Body text (medium font, center area with wrapping)
      - Optional embedded image (scaled to fit)
      - Slide number in corner if provided
    - Use pdf-lib's PDFDocument.create(), addPage(), drawText(), drawImage()
    - For embedded images: use pdf-lib's embedPng/embedJpg based on image format
    - Returns Uint8Array of the PDF bytes
    - Max 300 pages per LinkedIn Documents API limit; in practice carousels are 5-15 slides
    - File size limit: 100MB per Documents API
  </action>
  <verify>
    Run `pnpm exec tsc --noEmit` to verify all LinkedIn platform files compile. Run `node -e "import('pdf-lib').then(m => console.log('pdf-lib loaded', typeof m.PDFDocument))"` to verify pdf-lib installed. Verify no circular imports between linkedin/ files.
  </verify>
  <done>
    LinkedInClient class handles all content types (text, image, document, multiimage, article), media upload follows two-step initialize-then-upload flow, carousel generator creates valid PDFs from slide content. All methods use versioned headers and Zod-validated responses.
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend token-refresher for LinkedIn 60-day token lifecycle</name>
  <files>
    src/trigger/token-refresher.ts
  </files>
  <action>
    Extend the existing token-refresher cron task to handle LinkedIn tokens:

    1. Change the SQL query from `WHERE platform = 'x'` to `WHERE platform IN ('x', 'linkedin')` to include LinkedIn tokens in the refresh sweep

    2. Add platform-specific refresh logic:
       - For platform='x': Use existing X refresh path (createXOAuthClient + refreshAccessToken)
       - For platform='linkedin': Import createLinkedInOAuthClient and refreshAccessToken from linkedin/oauth.ts. Require LINKEDIN_CLIENT_ID and LINKEDIN_CLIENT_SECRET env vars (skip LinkedIn tokens gracefully if not set)

    3. LinkedIn-specific considerations:
       - LinkedIn tokens expire in 60 days (vs 2 hours for X)
       - The existing query uses `expires_at < NOW() + INTERVAL '1 day'` — this is fine for X (2hr tokens need 1-day window) but for LinkedIn, change to check platform-specific windows:
         - X: `expires_at < NOW() + INTERVAL '1 day'`
         - LinkedIn: `expires_at < NOW() + INTERVAL '7 days'` (7-day warning per CONTEXT.md decision)
       - Update the SQL to: `WHERE refresh_token IS NOT NULL AND ((platform = 'x' AND expires_at < NOW() + INTERVAL '1 day') OR (platform = 'linkedin' AND expires_at < NOW() + INTERVAL '7 days'))`

    4. Add LinkedIn token metadata tracking:
       - On successful refresh, store `lastRefreshed` timestamp in metadata
       - Store `refreshTokenExpiresAt` if provided by LinkedIn (refresh tokens can expire too)

    5. Add progressive warning logging for LinkedIn tokens:
       - 7 days before expiry: logger.info("LinkedIn token expiring in 7 days")
       - 3 days: logger.warn("LinkedIn token expiring in 3 days — refresh recommended")
       - 1 day: logger.error("LinkedIn token expiring tomorrow — re-auth may be needed")
       - These log levels match the notification tier expectations (info/warn/error)

    6. Keep the overall return type (TokenRefresherResult) unchanged — just include LinkedIn tokens in the counts
  </action>
  <verify>
    Run `pnpm exec tsc --noEmit` to verify token-refresher compiles with LinkedIn imports. Verify the SQL handles both platform filters correctly by reading the updated query.
  </verify>
  <done>
    Token refresher handles both X and LinkedIn tokens with platform-specific refresh windows (1 day for X, 7 days for LinkedIn). LinkedIn tokens refresh silently via cron. Progressive warning logs at 7/3/1 days before LinkedIn token expiry.
  </done>
</task>

</tasks>

<verification>
- [ ] `pnpm exec tsc --noEmit` passes with all new LinkedIn files
- [ ] Arctic `LinkedIn` provider imported and used correctly (not Twitter)
- [ ] All LinkedIn API calls include `LinkedIn-Version` and `X-Restli-Protocol-Version` headers
- [ ] Media upload follows two-step flow (initialize → upload binary)
- [ ] Document/carousel uses PDF via pdf-lib (not the sponsored Carousel API)
- [ ] Token refresher handles both X and LinkedIn with correct expiry windows
- [ ] Setup flow includes optional LinkedIn OAuth step
- [ ] Person URN fetched and stored during OAuth for post authoring
</verification>

<success_criteria>
- LinkedIn OAuth module compiles and mirrors X pattern using Arctic LinkedIn provider
- LinkedInClient class provides typed methods for all content types with versioned headers
- Media upload helpers handle both images and documents with two-step flow
- Carousel PDF generator creates valid multi-page PDFs from slide content
- Token refresher extends to LinkedIn with 7-day warning window
- Setup flow includes conditional LinkedIn OAuth step
- All code compiles with TypeScript strict mode
</success_criteria>

<output>
After completion, create `.planning/phases/06-linkedin-and-multi-platform/06-01-SUMMARY.md`
</output>
