---
phase: 19-voice-profile-and-interview-refinements-p3
plan: 03
type: execute
wave: 1
depends_on: []
files_modified: [src/core/utils/timezone.ts, src/voice/types.ts, src/voice/profile.ts, src/cli/voice-interview.ts]
autonomous: true
requirements: [m8]

must_haves:
  truths:
    - "Users can configure their timezone for accurate scheduling"
    - "Timezone is validated against IANA timezone database"
    - "Default timezone can be set and persists across sessions"
  artifacts:
    - path: "src/voice/types.ts"
      provides: "Timezone field in VoiceProfile schema"
      contains: "timezone"
    - path: "src/voice/interview.ts"
      provides: "Timezone configuration question in interview"
      exports: ["generateQuestions"]
    - path: "src/cli/voice-interview.ts"
      provides: "CLI entry point for timezone configuration"
  key_links:
    - from: "src/voice/interview.ts"
      to: "src/voice/types.ts"
      via: "VoiceProfile type with timezone field"
      pattern: "timezone.*string"
    - from: "src/cli/voice-interview.ts"
      to: "src/core/utils/timezone.ts"
      via: "isValidTimezone validation"
      pattern: "isValidTimezone\\("
---

<objective>
Add timezone configuration to voice profiles for accurate content scheduling and time-based operations.

Purpose: Ensure all time-based features (scheduling, analytics collection) use the user's correct timezone.
Output: Timezone field in voice profile with interview question and validation
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/core/utils/timezone.ts (isValidTimezone, userTimeToUtc, utcToUserTime functions)
@src/voice/types.ts (VoiceProfile schema definition)
@src/voice/interview.ts (question generation and interview state)
@src/voice/profile.ts (profile creation and strategy generation)
</context>

<tasks>

<task type="auto">
  <name>Add timezone field to VoiceProfile schema</name>
  <files>src/voice/types.ts</files>
  <action>
    Add timezone field to voiceProfileSchema:

    1. Add optional string field at top level of voiceProfileSchema
    2. Field should accept IANA timezone strings (e.g., "America/New_York", "Europe/London")
    3. Mark as optional for backward compatibility with existing profiles
    4. Add to exported VoiceProfile type via Zod inference

    Add to voiceProfileSchema object:
    ```typescript
    timezone: z.string().optional(),
    ```

    This field stores user's preferred timezone for:
    - Scheduling posts at optimal times
    - Displaying analytics in user's local time
    - Converting times between UTC and user timezone

    Follow existing optional field pattern in VoiceProfile (entitySlug, entityDisplayName, etc.).
  </action>
  <verify>grep -q "timezone.*z.string()" src/voice/types.ts</verify>
  <done>Timezone field added to VoiceProfile schema as optional string</done>
</task>

<task type="auto">
  <name>Add timezone question to interview</name>
  <files>src/voice/interview.ts</files>
  <action>
    Add timezone configuration question to interview question banks:

    1. Add to IDENTITY_QUESTIONS array (appropriate phase for core configuration)
    2. Create question with id="timezone", type="choice"
    3. Provide common timezone options with "other" option for manual input
    4. Add hint explaining IANA timezone format

    Question structure:
    ```typescript
    {
      id: "timezone",
      phase: "identity",
      text: "What's your timezone?",
      hint: "Used for accurate scheduling and analytics display",
      type: "choice",
      required: false,
      options: [
        "America/New_York",
        "America/Los_Angeles",
        "Europe/London",
        "Europe/Paris",
        "Asia/Tokyo",
        "Australia/Sydney",
        "UTC",
        "Other (I'll specify)"
      ]
    }
    ```

    Follow existing question pattern in IDENTITY_QUESTIONS array (pillars, boundaries questions).
    Use required: false to allow skipping and use system default.
  </action>
  <verify>grep -A5 'id: "timezone"' src/voice/interview.ts</verify>
  <done>Timezone question added to interview with common options</done>
</task>

<task type="auto">
  <name>Integrate timezone into profile generation</name>
  <files>src/voice/interview.ts</files>
  <action>
    Update finalizeProfile function to include timezone from interview answers:

    1. Extract timezone answer from state.answers.get("timezone")
    2. If answer is "Other (I'll specify)", handle as manual input (future enhancement)
    3. Validate timezone using isValidTimezone from src/core/utils/timezone.ts
    4. Include timezone in generated VoiceProfile object
    5. Skip if not provided (optional field)

    Integration point:
    - In finalizeProfile, when building profile object from interview answers
    - Add: timezone: timezoneAnswer || undefined
    - Only add if valid via isValidTimezone() check

    Follow existing answer extraction pattern (pillars, boundaries from state.answers).
    Gracefully handle missing/invalid values (don't fail profile creation).
  </action>
  <verify>grep -A3 "export function finalizeProfile" src/voice/interview.ts | grep -q "timezone"</verify>
  <done>Timezone from interview integrated into profile generation with validation</done>
</task>

<task type="auto">
  <name>Pass timezone to strategy generation</name>
  <files>src/voice/profile.ts</files>
  <action>
    Update generateStrategy function to incorporate timezone:

    1. Accept profile.timezone value
    2. Include timezone in generated StrategyConfig
    3. Add to strategyConfigSchema if needed (check if timezone already exists)

    Add timezone field to StrategyConfig:
    ```typescript
    export interface StrategyConfig {
      // existing fields...
      timezone?: string;
    }
    ```

    This allows scheduling algorithms to use timezone for optimal posting times.

    Follow existing pattern of extending strategy from profile data (pillars, platforms, languages).
    Keep timezone optional for backward compatibility.
  </action>
  <verify>grep -q "timezone" src/voice/profile.ts | grep -q "StrategyConfig"</verify>
  <done>Timezone included in strategy configuration for scheduling</done>
</task>

<task type="auto">
  <name>Add timezone setup subcommand</name>
  <files>src/cli/voice-interview.ts</files>
  <action>
    Add CLI subcommand for standalone timezone configuration:

    Add new case to CLI entry point (import.meta.main section):
    ```typescript
    case "timezone": {
      const tz = args[1];
      if (!tz) {
        console.log(JSON.stringify({error: "Missing timezone argument"}));
        process.exit(1);
      }
      if (!isValidTimezone(tz)) {
        console.log(JSON.stringify({
          error: `Invalid timezone: ${tz}`,
          hint: "Use IANA timezone format (e.g., America/New_York)"
        }));
        process.exit(1);
      }
      console.log(JSON.stringify({
        valid: true,
        timezone: tz
      }));
      break;
    }
    ```

    Import isValidTimezone from src/core/utils/timezone.ts.

    This allows quick timezone validation without full interview:
    ```
    bun run src/cli/voice-interview.ts timezone America/New_York
    ```

    Follow existing CLI pattern (start, import, submit, complete cases).
  </action>
  <verify>grep -q 'case "timezone":' src/cli/voice-interview.ts</verify>
  <done>CLI timezone subcommand added for standalone validation</done>
</task>

</tasks>

<verification>
1. Run interview with timezone question: bun run src/cli/voice-interview.ts start
2. Test valid timezone: bun run src/cli/voice-interview.ts timezone America/New_York
3. Test invalid timezone: bun run src/cli/voice-interview.ts timezone Invalid/Timezone
4. Verify generated profile includes timezone field
5. Confirm strategy.yaml generation includes timezone
</verification>

<success_criteria>
- Timezone field added to VoiceProfile schema as optional
- Interview includes timezone question with common options
- Timezone validated using isValidTimezone before saving
- Strategy generation includes timezone for scheduling
- CLI subcommand available for standalone timezone validation
</success_criteria>

<output>
After completion, create `.planning/phases/19-voice-profile-and-interview-refinements-p3/19-03-SUMMARY.md`
</output>
