---
phase: 19-voice-profile-and-interview-refinements-p3
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/voice/import.ts, src/cli/voice-interview.ts, .claude/commands/psn/voice.md]
autonomous: true
requirements: [m3]

must_haves:
  truths:
    - "Content import URLs are validated before processing"
    - "Invalid URLs return clear error messages without crashing"
    - "URL validation includes HTTP/HTTPS requirement and basic format checks"
  artifacts:
    - path: "src/voice/import.ts"
      provides: "Content import functions with URL validation"
      exports: ["validateUrl", "importBlogContent"]
      min_lines: 200
  key_links:
    - from: "src/cli/voice-interview.ts"
      to: "src/voice/import.ts"
      via: "importBlogContent function call with validation"
      pattern: "importBlogContent\\(urls\\)"
---

<objective>
Implement content import URL validation to prevent processing invalid URLs and provide clear error messages.

Purpose: Fail fast with actionable errors instead of attempting to fetch invalid URLs.
Output: URL validation function with integrated error handling for import flows
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@src/voice/import.ts (importBlogContent, importXHistory, importRawText functions)
@src/cli/voice-interview.ts (importContent function and CLI entry point)
@.claude/commands/psn/voice.md
</context>

<tasks>

<task type="auto">
  <name>Add URL validation function to import.ts</name>
  <files>src/voice/import.ts</files>
  <action>
    Add validateUrl function to src/voice/import.ts:

    1. Accept string URL parameter
    2. Check for HTTP/HTTPS protocol required (no file://, javascript:, etc.)
    3. Validate basic URL format using URL constructor
    4. Return {valid: boolean, error: string | null} result

    Validation rules:
    - Must start with http:// or https://
    - Must have a valid hostname (no empty or whitespace)
    - Must not contain dangerous protocols (javascript:, data:, file:)
    - Must not be localhost/127.0.0.1 (security check for remote execution)

    Error messages should be actionable:
    - "Invalid URL protocol. URL must start with http:// or https://"
    - "Invalid URL format. Could not parse hostname."
    - "Localhost URLs are not allowed. Use a publicly accessible URL."

    Pattern from src/core/utils/timezone.ts isValidTimezone function:
    - Use try/catch with URL constructor for validation
    - Return boolean/null signature for easy consumption
  </action>
  <verify>grep -q "validateUrl" src/voice/import.ts</verify>
  <done>URL validation function added with HTTP/HTTPS requirement and format checks</done>
</task>

<task type="auto">
  <name>Integrate validation into importBlogContent</name>
  <files>src/voice/import.ts</files>
  <action>
    Update importBlogContent function to validate URLs before processing:

    1. Accept array of URL strings
    2. For each URL, call validateUrl() first
    3. If invalid, throw descriptive error with URL and validation reason
    4. Only proceed with fetching valid URLs

    Error format:
    "Invalid URL 'https://example.com/blog': Invalid URL format. Could not parse hostname."

    This prevents fetch attempts on invalid URLs and provides immediate feedback.
    Graceful degradation: continue processing other URLs if some are valid, unless all are invalid.

    Follow existing error pattern from src/voice/import.ts:
    - Throw Error with descriptive messages
    - Let caller handle catch/reporting
  </action>
  <verify>grep -A5 "export function importBlogContent" src/voice/import.ts | grep -q validateUrl</verify>
  <done>importBlogContent validates all URLs before attempting fetch operations</done>
</task>

<task type="auto">
  <name>Add validation to CLI import command</name>
  <files>src/cli/voice-interview.ts</files>
  <action>
    Update the import CLI command in src/cli/voice-interview.ts to validate URLs from command line:

    1. In CLI entry point (import.meta.main section), when "import" command detected
    2. Parse blog URLs from args.filter((a) => a.startsWith("http"))
    3. For each URL, validate before passing to importContent
    4. Print validation errors in user-friendly format

    Output format for CLI:
    ```
    Error: Invalid URL 'https://example.com/blog'
    Reason: Invalid URL format. Could not parse hostname.

    No valid URLs to import. Please check your URLs and try again.
    ```

    Follow existing JSON output pattern in voice-interview.ts:
    - On success: JSON.stringify result
    - On error: console.error(JSON.stringify({error}))
  </action>
  <verify>grep -A10 'case "import":' src/cli/voice-interview.ts | grep -q "validateUrl"</verify>
  <done>CLI import command validates URLs before processing</done>
</task>

<task type="auto">
  <name>Update voice.md documentation</name>
  <files>.claude/commands/psn/voice.md</files>
  <action>
    Update /psn:voice import section in .claude/commands/psn/voice.md to mention URL validation:

    Add note under "For blog URLs":
    "Note: URLs are validated before processing. Only http:// and https:// URLs are accepted.
    Invalid URLs will show clear error messages describing the issue."

    This sets user expectations and explains validation behavior.
  </action>
  <verify>grep -q "URLs are validated" .claude/commands/psn/voice.md</verify>
  <done>Documentation updated to explain URL validation behavior</done>
</task>

</tasks>

<verification>
1. Test valid URL: bun run src/cli/voice-interview.ts import https://example.com/blog
2. Test invalid protocol: bun run src/cli/voice-interview.ts import file:///path/to/file
3. Test malformed URL: bun run src/cli/voice-interview.ts import not-a-url
4. Test localhost rejection: bun run src/cli/voice-interview.ts import http://localhost/blog
5. Verify error messages are clear and actionable
</verification>

<success_criteria>
- URL validation prevents invalid URLs from being processed
- Error messages include the problematic URL and specific validation failure reason
- CLI import command provides clear feedback for URL validation errors
- Documentation updated to explain URL validation behavior
</success_criteria>

<output>
After completion, create `.planning/phases/19-voice-profile-and-interview-refinements-p3/19-02-SUMMARY.md`
</output>
