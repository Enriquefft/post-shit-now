---
phase: 05-intelligence-ideation-and-planning
plan: 04
type: execute
wave: 2
depends_on:
  - 05-01
  - 05-02
  - 05-03
files_modified:
  - src/trigger/trend-collector.ts
  - src/trigger/trend-poller.ts
  - src/trigger/idea-expiry.ts
autonomous: true
requirements:
  - INTEL-01
  - INTEL-02
  - INTEL-06
  - IDEA-04

must_haves:
  truths:
    - "Trend collector runs daily at 6 AM pulling from all available sources"
    - "Lighter poller runs every 2-4 hours for breaking news (HN + X trending)"
    - "Collected trends are scored and stored in Hub DB with 30-day expiry"
    - "High-scoring trends (70+) get suggested angles stored in DB"
    - "Timely ideas that expire are auto-killed by scheduled task"
    - "Old trends (30+ days) are pruned during collection runs"
  artifacts:
    - path: "src/trigger/trend-collector.ts"
      provides: "Daily 6 AM trend collection Trigger.dev cron task"
      exports: ["trendCollector"]
    - path: "src/trigger/trend-poller.ts"
      provides: "2-4 hour breaking news poller Trigger.dev cron task"
      exports: ["trendPoller"]
    - path: "src/trigger/idea-expiry.ts"
      provides: "Daily idea expiry checker Trigger.dev cron task"
      exports: ["ideaExpiry"]
  key_links:
    - from: "src/trigger/trend-collector.ts"
      to: "src/intelligence/collector.ts"
      via: "import collectTrends"
      pattern: "collectTrends"
    - from: "src/trigger/trend-collector.ts"
      to: "src/intelligence/scoring.ts"
      via: "import scoreTrends, generateAngleStubs"
      pattern: "scoreTrends|generateAngleStubs"
    - from: "src/trigger/trend-collector.ts"
      to: "src/core/db/schema.ts"
      via: "insert into trends table"
      pattern: "db\\.insert.*trends"
    - from: "src/trigger/idea-expiry.ts"
      to: "src/ideas/lifecycle.ts"
      via: "import expireTimelyIdeas"
      pattern: "expireTimelyIdeas"
---

<objective>
Create three Trigger.dev scheduled tasks: daily trend collector, breaking news poller, and idea expiry checker.

Purpose: Automated intelligence gathering runs in the background so trend data is fresh when the user runs /psn:plan. Idea expiry prevents stale timely ideas from cluttering the bank.
Output: Three new Trigger.dev tasks following the established cron task pattern from analytics-collector.ts.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/trigger/analytics-collector.ts
@.planning/phases/05-intelligence-ideation-and-planning/05-01-SUMMARY.md
@.planning/phases/05-intelligence-ideation-and-planning/05-02-SUMMARY.md
@.planning/phases/05-intelligence-ideation-and-planning/05-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create trend collector and breaking news poller Trigger.dev tasks</name>
  <files>
    src/trigger/trend-collector.ts
    src/trigger/trend-poller.ts
  </files>
  <action>
Follow the exact pattern from src/trigger/analytics-collector.ts for both tasks.

**src/trigger/trend-collector.ts** - `trendCollector`:
- `schedules.task` with id "trend-collector", cron "0 6 * * *" (daily 6 AM UTC), maxDuration 300
- Load DATABASE_URL from env, create hub connection
- Load pillars from strategy.yaml (read file, parse YAML, extract pillars array with names and weights). If strategy.yaml not found, log warning and use empty pillars (still collect trends, just no relevance scoring).
- Call `collectTrends(pillars)` from src/intelligence/collector.ts
- Call `scoreTrends(rawTrends, pillars)` from src/intelligence/scoring.ts
- For scored trends with overallScore >= 70, call `generateAngleStubs(trend.title)` and attach to suggestedAngles field (INTEL-06)
- Insert scored trends into the trends table via db.insert(). Use ON CONFLICT on (title, source) to avoid duplicates -- if trend already exists, update overallScore if new score is higher.
- Prune old trends: DELETE from trends WHERE expiresAt < NOW() to clean up 30+ day old entries
- Log summary: { totalCollected, stored, highScore, pruned, errors }
- Return structured result matching the existing task pattern

**src/trigger/trend-poller.ts** - `trendPoller`:
- `schedules.task` with id "trend-poller", cron "0 8-20/3 * * *" (every 3 hours from 8 AM to 8 PM UTC -- business hours), maxDuration 120
- Lighter version: only calls collectBreakingNews() which fetches HN top 10 + X trending
- Score and store in trends table same as collector
- For high-score trends (70+), generate angle stubs
- Do NOT prune old trends (collector handles that)
- Log summary
  </action>
  <verify>Run `bun run check` to confirm both files compile. Grep for "schedules.task" in both files. Verify cron expressions are valid.</verify>
  <done>Daily trend collector runs at 6 AM collecting from all sources. Breaking news poller runs every 3 hours during business hours. Both score trends, store to DB, and generate angles for high-scoring items.</done>
</task>

<task type="auto">
  <name>Task 2: Create idea expiry Trigger.dev task</name>
  <files>src/trigger/idea-expiry.ts</files>
  <action>
**src/trigger/idea-expiry.ts** - `ideaExpiry`:
- `schedules.task` with id "idea-expiry", cron "0 7 * * *" (daily at 7 AM UTC, 1 hour after trend collector), maxDuration 60
- Load DATABASE_URL, create hub connection
- Call `expireTimelyIdeas(db, userId)` from src/ideas/lifecycle.ts with userId "default"
- Log count of expired ideas
- Return { status: "success", expired: count }

This is a simple task -- the heavy logic is in lifecycle.ts. The task just schedules the daily run.
  </action>
  <verify>Run `bun run check` to confirm file compiles. Grep for "idea-expiry" in the file.</verify>
  <done>Idea expiry task runs daily at 7 AM and auto-kills expired timely ideas.</done>
</task>

</tasks>

<verification>
- `bun run check` passes
- Three new files in src/trigger/: trend-collector.ts, trend-poller.ts, idea-expiry.ts
- Each uses schedules.task with appropriate cron expression
- Trend collector stores trends with 30-day expiry and prunes old entries
- Breaking news poller is lighter (HN + X only)
- Idea expiry delegates to lifecycle.ts
</verification>

<success_criteria>
Three automated background tasks that keep trend data fresh and idea bank clean. Trend data accumulates daily, breaking news captured every 3 hours, and expired ideas auto-killed daily.
</success_criteria>

<output>
After completion, create `.planning/phases/05-intelligence-ideation-and-planning/05-04-SUMMARY.md`
</output>
