---
phase: 05-intelligence-ideation-and-planning
plan: 06
type: execute
wave: 3
depends_on:
  - 05-01
  - 05-02
  - 05-03
  - 05-04
  - 05-05
files_modified:
  - src/planning/types.ts
  - src/planning/calendar.ts
  - src/planning/ideation.ts
  - src/planning/slotting.ts
  - src/planning/language.ts
  - src/planning/recycling.ts
  - src/cli/plan.ts
  - .claude/commands/psn/plan.md
  - src/content/topic-suggest.ts
autonomous: true
requirements:
  - PLAN-01
  - PLAN-02
  - PLAN-03
  - PLAN-04
  - PLAN-05
  - PLAN-06
  - PLAN-07
  - PLAN-08
  - PLAN-09
  - PLAN-10
  - POST-07
  - POST-08
  - ANLYT-10
  - CONTENT-03
  - CONTENT-04

must_haves:
  truths:
    - "User can run /psn:plan for weekly batch ideation + generation + scheduling"
    - "Planning shows current week's calendar state (scheduled posts, series due dates, gaps)"
    - "Ideation checks stored trend data, fires real-time searches, reviews analytics, checks idea bank"
    - "System generates 10-15 ideas mixed with ready ideas from the bank"
    - "User rates ideas: love it (ready) / maybe later (seed) / kill it (killed with reason)"
    - "Series installments auto-slotted first, ready ideas fill gaps, new posts for remaining"
    - "Each slot gets a language suggestion based on platform config and recent language mix"
    - "User can bail at any phase (just ideate, just generate, or full plan+schedule)"
    - "Pillar distribution balances across categories per strategy.yaml weights"
    - "Content archetype balancing prevents monotonous patterns"
    - "User can choose language per post (en/es/both) with bilingual posts independently crafted"
    - "Per-language performance tracking enabled in analytics"
    - "Content remixing suggests re-angling top performers for different platforms"
    - "Content recycling surfaces past top performers with fresh angles"
  artifacts:
    - path: "src/planning/types.ts"
      provides: "WeeklyPlan, PlanSlot, PlanPhase types"
    - path: "src/planning/calendar.ts"
      provides: "Current week calendar state builder"
      exports: ["getCalendarState"]
    - path: "src/planning/ideation.ts"
      provides: "Idea generation mixing trends, bank, pillars, and on-demand search"
      exports: ["generatePlanIdeas"]
    - path: "src/planning/slotting.ts"
      provides: "Series-first slot allocation with pillar and archetype balancing"
      exports: ["allocateSlots"]
    - path: "src/planning/language.ts"
      provides: "Per-slot language suggestion"
      exports: ["suggestLanguages"]
    - path: "src/planning/recycling.ts"
      provides: "Content remixing and recycling suggestions"
      exports: ["getRemixSuggestions", "getRecycleSuggestions"]
    - path: "src/cli/plan.ts"
      provides: "CLI entry point for /psn:plan"
    - path: ".claude/commands/psn/plan.md"
      provides: "Multi-phase slash command for weekly planning"
  key_links:
    - from: "src/planning/ideation.ts"
      to: "src/intelligence/collector.ts"
      via: "import trend data and on-demand search"
      pattern: "searchAll|trends"
    - from: "src/planning/ideation.ts"
      to: "src/ideas/bank.ts"
      via: "import getReadyIdeas"
      pattern: "getReadyIdeas"
    - from: "src/planning/slotting.ts"
      to: "src/series/episodes.ts"
      via: "import getDueEpisodes for series-first allocation"
      pattern: "getDueEpisodes"
    - from: "src/planning/calendar.ts"
      to: "src/core/db/schema.ts"
      via: "query posts table for scheduled posts"
      pattern: "db\\.select.*posts.*scheduledAt"
    - from: "src/content/topic-suggest.ts"
      to: "src/ideas/bank.ts"
      via: "wire checkIdeaBank stub to real implementation"
      pattern: "checkIdeaBank|getReadyIdeas"
---

<objective>
Build the weekly planning engine: calendar state visualization, trend-informed ideation mixed with idea bank, series-first slot allocation with pillar/archetype balancing, per-slot language suggestions, content remixing/recycling, and the /psn:plan multi-phase slash command. Also wire bilingual support and per-language analytics.

Purpose: This is the capstone of Phase 5 -- the planning command that ties intelligence, ideas, series, and content generation into a coherent weekly workflow. Users go from zero to a fully planned and partially drafted week in one session.
Output: Complete src/planning/ directory, plan CLI, /psn:plan slash command, and wired bilingual + analytics extensions.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/content/generate.ts
@src/content/topic-suggest.ts
@src/content/format-picker.ts
@.planning/phases/05-intelligence-ideation-and-planning/05-CONTEXT.md
@.planning/phases/05-intelligence-ideation-and-planning/05-01-SUMMARY.md
@.planning/phases/05-intelligence-ideation-and-planning/05-02-SUMMARY.md
@.planning/phases/05-intelligence-ideation-and-planning/05-03-SUMMARY.md
@.planning/phases/05-intelligence-ideation-and-planning/05-04-SUMMARY.md
@.planning/phases/05-intelligence-ideation-and-planning/05-05-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create planning engine modules (calendar, ideation, slotting, language, recycling)</name>
  <files>
    src/planning/types.ts
    src/planning/calendar.ts
    src/planning/ideation.ts
    src/planning/slotting.ts
    src/planning/language.ts
    src/planning/recycling.ts
  </files>
  <action>
**src/planning/types.ts:**
- `PlanSlotStatus` type: "outlined" | "drafted" | "approved" | "scheduled" | "published" | "skipped"
- `PlanSlot` interface: { day: string (ISO), platform: string, topic: string, format: string, pillar: string, language: string, seriesId?: string, seriesEpisode?: string, ideaId?: string, postId?: string, status: PlanSlotStatus }
- `WeeklyPlan` interface matching DB schema
- `CalendarState` interface: { weekStart, weekEnd, scheduledPosts: existing posts, seriesDue: due episodes, gaps: empty days, totalCapacity: number (from strategy.yaml frequency config) }
- `PlanIdea` interface: { topic, pillar, angle, format, source: "trend" | "bank" | "generated" | "remix" | "recycle", sourceId?, language? }
- `PlanPhase` type: "calendar" | "ideation" | "slotting" | "drafting" | "scheduling"

**src/planning/calendar.ts** - `getCalendarState(db, userId, weekStart: Date)`:
- Calculate weekEnd from weekStart + 7 days
- Query posts table for scheduled/published posts within the date range (PLAN-02)
- Query due series episodes via getDueEpisodes (SERIES-03)
- Load strategy.yaml for per-platform posting frequency to compute total weekly capacity (e.g., x: 7/week, linkedin: 3/week = 10 total slots)
- Identify gap days where no content is scheduled
- Return CalendarState

**src/planning/ideation.ts** - `generatePlanIdeas(db, userId, pillars, opts)`:
- PLAN-03: Check stored trend data from trends table (last 7 days, overallScore > 30)
- PLAN-03: Check idea bank for ready ideas via getReadyIdeas
- PLAN-03: If on-demand search keys are available, fire searchAll for each pillar to supplement
- PLAN-03: Review analytics -- load preference model for top formats, fatigued topics
- PLAN-04: Generate 10-15 PlanIdea objects mixing: trending topics with angles, ready ideas from bank, and newly generated topics using the existing suggestTopics from topic-suggest.ts
- Mix ratio: ~30% trend-based, ~30% from idea bank, ~20% generated, ~10% remix, ~10% recycle
- Each idea tagged with its source for transparency
- Filter out fatigued topics using isTopicFatigued from analytics/fatigue.ts
- Return PlanIdea[]

**src/planning/slotting.ts** - `allocateSlots(calendarState, ideas, series, options)`:
- PLAN-06: Auto-slot series episodes first -- lock due series into their platform's next available day
- PLAN-09: Distribute remaining slots across pillars weighted by strategy.yaml pillar weights. Use round-robin weighted selection.
- PLAN-10: Archetype/angle balancing -- track angles used in the week, prefer unused angles. Use the ANGLES list from topic-suggest.ts as the archetype taxonomy. No more than 2 of the same angle per week.
- Fill remaining gaps with ideas sorted by score/relevance
- Return PlanSlot[] for the full week

**src/planning/language.ts** - `suggestLanguages(slots: PlanSlot[], strategyConfig, recentPosts)`:
- PLAN-07: For each slot, suggest a language based on:
  - Strategy.yaml language config (primary/secondary language, default)
  - Recent language mix (query last 14 days of posts for language distribution)
  - Platform conventions (e.g., LinkedIn may favor one language)
- If user has both en and es configured, aim for a balanced mix across the week
- Return slots with language field populated
- POST-07: Language choice per post. POST-08: When language is "both", the /psn:plan command will instruct Claude to generate two independent versions (not translations).

**src/planning/recycling.ts:**
- `getRemixSuggestions(db, userId, limit = 3)` (CONTENT-03): Query top-performing posts (by engagementScore) from the last 90 days. For each, suggest adapting to a different platform. E.g., a high-performing X thread could become a LinkedIn carousel. Return: { originalPostId, originalPlatform, suggestedPlatform, topic, suggestedFormat }[]
- `getRecycleSuggestions(db, userId, limit = 3)` (CONTENT-04): Query top performers older than 60 days. Suggest posting the same core idea with a fresh angle. Return: { originalPostId, topic, originalAngle, suggestedAngle, daysSincePublished }[]
  </action>
  <verify>Run `bun run check` to confirm all files compile. Grep for getCalendarState, generatePlanIdeas, allocateSlots, suggestLanguages, getRemixSuggestions, getRecycleSuggestions exports.</verify>
  <done>Planning engine modules work: calendar shows week state, ideation mixes multiple sources, slotting prioritizes series then balances pillars/archetypes, language suggestions respect config and history, remixing/recycling surface top content.</done>
</task>

<task type="auto">
  <name>Task 2: Create plan CLI, /psn:plan slash command, and wire topic-suggest checkIdeaBank stub</name>
  <files>
    src/cli/plan.ts
    .claude/commands/psn/plan.md
    src/content/topic-suggest.ts
  </files>
  <action>
**src/cli/plan.ts:**
Follow established CLI pattern:
- Export functions + import.meta.main entry point
- Subcommands:
  - `calendar` -- runs getCalendarState for current week, outputs JSON
  - `ideate` -- runs generatePlanIdeas, outputs JSON array of 10-15 PlanIdeas
  - `rate <ideaId> <rating>` -- rating is "love" | "maybe" | "kill". Love: transition idea to ready. Maybe: transition to seed. Kill: transition to killed with reason prompt. (PLAN-05)
  - `slot` -- runs allocateSlots with current state, outputs JSON plan
  - `languages` -- runs suggestLanguages on current plan, outputs updated plan
  - `remix` -- runs getRemixSuggestions, outputs JSON
  - `recycle` -- runs getRecycleSuggestions, outputs JSON
  - `save <planJson>` -- inserts/updates weekly_plans table with the plan
  - `status` -- shows current plan state (if one exists for this week)
- All output JSON to stdout

**Wire src/content/topic-suggest.ts:**
- The existing `checkIdeaBank()` is a stub returning empty array. Replace it with a real implementation:
  - Import getReadyIdeas from src/ideas/bank.ts
  - Accept db and userId parameters (add to function signature)
  - Query ready ideas and return them as TopicSuggestion[] format
  - Keep backward compatibility: if no db provided, return empty array (fallback for non-DB contexts)

**.claude/commands/psn/plan.md:**
Multi-phase slash command following RESEARCH.md Pattern 3. Instruct Claude to:

**Phase 1 (Calendar):** Run `bun run src/cli/plan.ts calendar`. Show the user their current week: what's scheduled, what series are due, where the gaps are. Ask if they want to continue to ideation or stop here (PLAN-08).

**Phase 2 (Ideation):** Run `bun run src/cli/plan.ts ideate`. Present 10-15 ideas grouped by source (trending, from bank, generated, remix, recycle). For each, show topic, pillar, angle, source. Ask user to rate each: love it / maybe later / kill it (PLAN-05). Run `rate` CLI for each rated idea. Ask if they want to continue to slot allocation or stop here.

**Phase 3 (Slot Allocation):** Run `bun run src/cli/plan.ts slot`. Show the proposed week calendar with:
- Series episodes locked in first
- Pillar distribution noted
- Language suggestions per slot
- Format variety shown
Let user swap, reorder, or remove slots. Ask if they want to continue to drafting or stop here.

**Phase 4 (Drafting):** For each slot marked for drafting, use the existing /psn:post workflow to generate content. Generate 2-3 key drafts (per CONTEXT.md: "hybrid: calendar outline + key drafts"). Remaining slots stay as outlines for later `/psn:post` calls.

**Phase 5 (Scheduling):** For approved/finished drafts, schedule via Trigger.dev delayed runs (existing publish-post flow). Save the final plan to DB via `save` CLI subcommand.

For bilingual "both" slots (POST-08): instruct Claude to generate two independent versions using language-specific voice context. NOT a translation -- two separate generation passes. Suggest approach per CONTEXT.md: two separate posts (X, TikTok) or one combined (LinkedIn). User confirms.

For ANLYT-10: when creating posts, include the `language` field in the post record so analytics can track per-language performance.
  </action>
  <verify>Run `bun run check` to confirm all files compile. Verify .claude/commands/psn/plan.md exists. Grep for the checkIdeaBank implementation in topic-suggest.ts to confirm it's no longer a stub.</verify>
  <done>Plan CLI supports all phases of weekly planning. /psn:plan slash command guides users through calendar -> ideation -> slotting -> drafting -> scheduling with bail-at-any-phase support. topic-suggest.ts checkIdeaBank wired to real idea bank. Bilingual and per-language analytics integrated.</done>
</task>

</tasks>

<verification>
- `bun run check` passes
- src/planning/ directory has types.ts, calendar.ts, ideation.ts, slotting.ts, language.ts, recycling.ts
- src/cli/plan.ts has import.meta.main entry point with all subcommands
- .claude/commands/psn/plan.md exists with multi-phase structure
- src/content/topic-suggest.ts checkIdeaBank is wired to real idea bank (not stub)
- Pillar distribution uses strategy.yaml weights
- Series episodes auto-slotted first
- Language suggestions based on config + recent mix
- Remix and recycle suggestions query top-performing content
</verification>

<success_criteria>
Complete weekly planning system where /psn:plan guides the user from seeing their calendar state through ideation, slot allocation, drafting key posts, and scheduling. Series auto-slot first. Pillar and archetype balancing prevents monotony. Bilingual posts are independently crafted. Content remixing and recycling surface past winners. Per-language analytics enabled.
</success_criteria>

<output>
After completion, create `.planning/phases/05-intelligence-ideation-and-planning/05-06-SUMMARY.md`
</output>
