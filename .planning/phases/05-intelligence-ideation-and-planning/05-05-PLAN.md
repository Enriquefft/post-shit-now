---
phase: 05-intelligence-ideation-and-planning
plan: 05
type: execute
wave: 2
depends_on:
  - 05-01
files_modified:
  - src/series/types.ts
  - src/series/manager.ts
  - src/series/episodes.ts
  - src/series/detection.ts
  - src/cli/series.ts
  - .claude/commands/psn/series.md
autonomous: true
requirements:
  - SERIES-01
  - SERIES-02
  - SERIES-03
  - SERIES-04
  - SERIES-05
  - SERIES-06

must_haves:
  truths:
    - "User can create a content series with name, cadence, format template, and branding via /psn:series create"
    - "Series config stored in DB with jsonb template including format structure, sections, intro/outro patterns, visual style, hashtags"
    - "Series installments have due dates calculated from lastPublishedAt + cadence"
    - "User can pause, resume, and retire series"
    - "Per-series analytics are queryable by joining posts with series_id"
    - "System can detect recurring patterns that suggest formalizing as a series"
    - "Episode tracking is customizable: none, auto-increment, or custom format string"
  artifacts:
    - path: "src/series/types.ts"
      provides: "Series, SeriesTemplate, EpisodeTracking, SeriesStatus types"
    - path: "src/series/manager.ts"
      provides: "CRUD operations for series"
      exports: ["createSeries", "updateSeries", "pauseSeries", "resumeSeries", "retireSeries", "getSeries", "listSeries"]
    - path: "src/series/episodes.ts"
      provides: "Episode tracking, due date calculation, next episode formatting"
      exports: ["getDueEpisodes", "getNextEpisodeLabel", "recordEpisodePublished"]
    - path: "src/series/detection.ts"
      provides: "Pattern detection for recurring content"
      exports: ["detectSeriesPatterns"]
    - path: "src/cli/series.ts"
      provides: "CLI entry point for /psn:series"
    - path: ".claude/commands/psn/series.md"
      provides: "Slash command for series management"
  key_links:
    - from: "src/series/manager.ts"
      to: "src/core/db/schema.ts"
      via: "CRUD on series table"
      pattern: "db\\.(insert|update|select).*series"
    - from: "src/series/episodes.ts"
      to: "src/series/types.ts"
      via: "cadence calculation logic"
      pattern: "cadence.*days|lastPublishedAt"
    - from: "src/series/detection.ts"
      to: "src/core/db/schema.ts"
      via: "query postMetrics for recurring patterns"
      pattern: "postMetrics.*postPillar.*postFormat"
---

<objective>
Build the content series system: series CRUD with template/branding config, episode tracking with customizable numbering, due date calculation, pattern detection, and the /psn:series slash command.

Purpose: Series provide structure and consistency to content output. Auto-slotting series into weekly plans ensures recurring content never falls through the cracks.
Output: Complete src/series/ directory with types, manager, episodes, and detection modules. CLI script and slash command for /psn:series.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/cli/post.ts
@.planning/phases/05-intelligence-ideation-and-planning/05-CONTEXT.md
@.planning/phases/05-intelligence-ideation-and-planning/05-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create series types, CRUD manager, and episode tracking</name>
  <files>
    src/series/types.ts
    src/series/manager.ts
    src/series/episodes.ts
  </files>
  <action>
**src/series/types.ts:**
- `SeriesStatus` type: "active" | "paused" | "retired"
- `SeriesCadence` type: "weekly" | "biweekly" | "monthly" | "custom"
- `TrackingMode` type: "none" | "auto-increment" | "custom"
- `SeriesTemplate` interface: { formatStructure: string, sections: string[], introPattern?: string, outroPattern?: string, visualStyle?: string, hashtags?: string[] }
- `CreateSeriesInput` interface: { name, description?, platform, template, cadence, cadenceCustomDays?, trackingMode?, trackingFormat?, pillar?, hubId? }
- `Series` interface matching the DB schema columns
- `SeriesWithAnalytics` extends Series with: { totalEpisodes: number, avgEngagement: number, lastEpisodeDate?: Date }
- `CADENCE_DAYS` constant: { weekly: 7, biweekly: 14, monthly: 30 }

**src/series/manager.ts:**
- `createSeries(db, userId, input: CreateSeriesInput)`: Insert into series table with defaults (status: active, episodeCount: 0). Return created series.
- `updateSeries(db, seriesId, updates: Partial<CreateSeriesInput>)`: Update name, description, template, cadence, pillar fields. Set updatedAt. Return updated series.
- `pauseSeries(db, seriesId)`: Set status to "paused", set updatedAt. Throw if already paused or retired.
- `resumeSeries(db, seriesId)`: Set status to "active", set updatedAt. Throw if not paused.
- `retireSeries(db, seriesId)`: Set status to "retired", set updatedAt. Retired is terminal -- cannot un-retire.
- `getSeries(db, seriesId)`: Get single series by id.
- `listSeries(db, userId, opts?: { status?, platform?, hubId? })`: List series with optional filters. Default: active only.
- `getSeriesAnalytics(db, seriesId)`: Join posts (where seriesId matches) with postMetrics to compute per-series analytics. Return SeriesWithAnalytics. Uses the posts.seriesId column added in Plan 01.

**src/series/episodes.ts:**
- `getDueEpisodes(db, userId, asOfDate?: Date)`: Query active series. For each, compute next due date from lastPublishedAt + cadence days (use CADENCE_DAYS, or cadenceCustomDays for custom). If no lastPublishedAt, use createdAt. Return series where nextDueDate <= asOfDate. Per RESEARCH.md pitfall 4: calculate from lastPublishedAt, not creation date.
- `getNextEpisodeLabel(series: Series)`: Based on trackingMode:
  - "none": return undefined (no episode label)
  - "auto-increment": return `#${series.episodeCount + 1}`
  - "custom": parse trackingFormat string, replace {e} with episodeCount + 1. If format contains {s}, assume season tracking (store season in template metadata).
- `recordEpisodePublished(db, seriesId)`: Increment episodeCount, set lastPublishedAt to now, set updatedAt. Called when a series post is published.
  </action>
  <verify>Run `bun run check` to confirm all files compile. Grep for createSeries, getDueEpisodes, getNextEpisodeLabel exports.</verify>
  <done>Series CRUD works with pause/resume/retire. Episode tracking calculates due dates from last published date. Episode labels support none, auto-increment, and custom format strings.</done>
</task>

<task type="auto">
  <name>Task 2: Create pattern detection, series CLI, and /psn:series slash command</name>
  <files>
    src/series/detection.ts
    src/cli/series.ts
    .claude/commands/psn/series.md
  </files>
  <action>
**src/series/detection.ts:**
- `detectSeriesPatterns(db, userId)`: Query postMetrics for the last 30 days. Group by (postPillar, postFormat) combinations. If any combination appears 3+ times, flag it as a potential series candidate. Return: { pillar, format, count, recentTopics: string[] }[]. This feeds SERIES-06: "System suggests formalizing as series when it detects recurring post patterns."
- Keep it simple: pure SQL aggregation + JS processing. No ML needed.

**src/cli/series.ts:**
Follow the established CLI pattern from src/cli/post.ts:
- Export functions + import.meta.main entry point
- Subcommands:
  - `create` -- accepts JSON input via stdin or argv with --name, --platform, --cadence, --pillar, --template (JSON string). Calls createSeries.
  - `list` -- optional --status, --platform filters. Calls listSeries.
  - `pause <seriesId>` -- calls pauseSeries
  - `resume <seriesId>` -- calls resumeSeries
  - `retire <seriesId>` -- calls retireSeries
  - `analytics <seriesId>` -- calls getSeriesAnalytics
  - `due` -- calls getDueEpisodes for current date
  - `detect` -- calls detectSeriesPatterns
- All output JSON to stdout

**.claude/commands/psn/series.md:**
Slash command that instructs Claude to:
1. Parse user intent (create, list, manage, check due, etc.)
2. For `create`: Walk user through defining series name, platform, cadence, format template, branding elements (hashtags, intro/outro patterns, visual style). Then run CLI create with assembled input.
3. For `list`: Show active series with episode count and next due date
4. For management (pause/resume/retire): Confirm action then run CLI
5. For analytics: Show per-series performance summary
6. Surface pattern detection suggestions: "I noticed you've posted 4 threads about AI in the last month. Want to formalize this as a series?"
  </action>
  <verify>Run `bun run check` to confirm all files compile. Verify .claude/commands/psn/series.md exists. Grep for detectSeriesPatterns export.</verify>
  <done>Pattern detection identifies recurring content for series suggestions. CLI supports all series lifecycle operations. /psn:series slash command provides full series management UX.</done>
</task>

</tasks>

<verification>
- `bun run check` passes
- src/series/ directory has types.ts, manager.ts, episodes.ts, detection.ts
- src/cli/series.ts has import.meta.main entry point
- .claude/commands/psn/series.md exists
- Series CRUD includes create, update, pause, resume, retire
- Due episodes calculated from lastPublishedAt (not creation date)
- Pattern detection flags pillar+format combos with 3+ occurrences
</verification>

<success_criteria>
Complete series system where users can create, manage, and track content series. Episode due dates drive weekly planning slots. Pattern detection surfaces opportunities to formalize recurring content.
</success_criteria>

<output>
After completion, create `.planning/phases/05-intelligence-ideation-and-planning/05-05-SUMMARY.md`
</output>
