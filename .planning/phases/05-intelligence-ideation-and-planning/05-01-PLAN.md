---
phase: 05-intelligence-ideation-and-planning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/db/schema.ts
autonomous: true
requirements:
  - IDEA-02
  - IDEA-03
  - IDEA-05
  - SERIES-02
  - INTEL-03
  - ANLYT-10
  - POST-07

must_haves:
  truths:
    - "Ideas table exists with maturity pipeline status enum and urgency classification"
    - "Series table exists with jsonb template, cadence, episode tracking config"
    - "Trends table exists with pillar relevance scoring and 30-day expiry"
    - "Weekly plans table exists with jsonb slots array"
    - "Monitored accounts table exists for competitive intelligence"
    - "Posts table has seriesId and language columns"
    - "Post metrics table has language column for per-language tracking"
    - "All new tables have RLS policies using current_setting pattern"
  artifacts:
    - path: "src/core/db/schema.ts"
      provides: "ideas, series, trends, weeklyPlans, monitoredAccounts tables + posts/postMetrics extensions"
      contains: "pgTable.*ideas"
  key_links:
    - from: "src/core/db/schema.ts"
      to: "drizzle-orm/pg-core"
      via: "pgTable, pgPolicy imports"
      pattern: "pgPolicy.*isolation"
---

<objective>
Add all Phase 5 database tables (ideas, series, trends, weekly_plans, monitored_accounts) and extend the posts and postMetrics tables with seriesId and language columns.

Purpose: Foundation schema for intelligence gathering, idea management, series tracking, weekly planning, and bilingual analytics -- all downstream plans depend on these tables.
Output: Updated schema.ts with all new tables and columns, ready for migration generation.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/core/db/schema.ts
@.planning/phases/05-intelligence-ideation-and-planning/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ideas, series, trends, weeklyPlans, and monitoredAccounts tables to schema.ts</name>
  <files>src/core/db/schema.ts</files>
  <action>
Add five new tables to src/core/db/schema.ts following the exact same patterns as existing tables (pgTable, pgPolicy with hubUser role, current_setting('app.current_user_id')):

1. **ideas** table:
   - id (uuid, defaultRandom, primaryKey)
   - userId (text, notNull)
   - hubId (text, nullable -- null = personal hub)
   - title (text, notNull)
   - notes (text, nullable)
   - tags (jsonb string array, nullable)
   - status (text, notNull, default "spark") -- spark | seed | ready | claimed | developed | used | killed
   - urgency (text, notNull, default "evergreen") -- timely | seasonal | evergreen
   - pillar (text, nullable)
   - platform (text, nullable)
   - format (text, nullable)
   - claimedBy (text, nullable)
   - killReason (text, nullable)
   - expiresAt (timestamp with timezone, nullable)
   - lastTouchedAt (timestamp with timezone, defaultNow, notNull)
   - sourceType (text, nullable) -- trend | capture | plan | remix | recycle
   - sourceId (text, nullable)
   - createdAt, updatedAt (standard timestamps)
   - RLS policy "ideas_isolation"

2. **series** table:
   - id (uuid, defaultRandom, primaryKey)
   - userId (text, notNull)
   - hubId (text, nullable)
   - name (text, notNull)
   - description (text, nullable)
   - platform (text, notNull)
   - template (jsonb with typed shape: { formatStructure, sections, introPattern?, outroPattern?, visualStyle?, hashtags? })
   - cadence (text, notNull) -- weekly | biweekly | monthly | custom
   - cadenceCustomDays (integer, nullable)
   - trackingMode (text, notNull, default "auto-increment") -- none | auto-increment | custom
   - trackingFormat (text, nullable) -- e.g., "Season {s}, Ep {e}"
   - episodeCount (integer, notNull, default 0)
   - status (text, notNull, default "active") -- active | paused | retired
   - lastPublishedAt (timestamp with timezone, nullable)
   - pillar (text, nullable)
   - createdAt, updatedAt (standard timestamps)
   - RLS policy "series_isolation"

3. **trends** table:
   - id (uuid, defaultRandom, primaryKey)
   - userId (text, notNull)
   - title (text, notNull)
   - url (text, nullable)
   - source (text, notNull) -- hackernews | reddit | producthunt | google-trends | rss | x
   - sourceScore (integer, nullable)
   - pillarRelevance (jsonb Record<string, number>, nullable)
   - overallScore (integer, notNull, default 0)
   - suggestedAngles (jsonb string array, nullable)
   - detectedAt (timestamp with timezone, defaultNow, notNull)
   - expiresAt (timestamp with timezone, nullable)
   - usedInIdeaId (text, nullable)
   - createdAt (timestamp with timezone, defaultNow, notNull)
   - RLS policy "trends_isolation"

4. **weeklyPlans** table:
   - id (uuid, defaultRandom, primaryKey)
   - userId (text, notNull)
   - weekStart (timestamp with timezone, notNull)
   - weekEnd (timestamp with timezone, notNull)
   - slots (jsonb typed array of { day, platform, topic, format, pillar, language, seriesId?, seriesEpisode?, ideaId?, postId?, status })
   - totalSlots (integer, notNull, default 0)
   - completedSlots (integer, notNull, default 0)
   - createdAt, updatedAt (standard timestamps)
   - RLS policy "weekly_plans_isolation"

5. **monitoredAccounts** table:
   - id (uuid, defaultRandom, primaryKey)
   - userId (text, notNull)
   - platform (text, notNull)
   - accountHandle (text, notNull)
   - accountName (text, nullable)
   - lastCheckedAt (timestamp with timezone, nullable)
   - lastPostCount (integer, nullable)
   - createdAt (timestamp with timezone, defaultNow, notNull)
   - RLS policy "monitored_accounts_isolation"

Use the exact same import style and patterns already in schema.ts. Export all new tables. Follow the research RESEARCH.md schema examples exactly for type shapes.
  </action>
  <verify>Run `bun run check` (TypeScript type check) to confirm schema.ts compiles without errors. Grep for all 5 new table names in schema.ts.</verify>
  <done>All 5 tables defined in schema.ts with correct column types, defaults, and RLS policies matching existing patterns.</done>
</task>

<task type="auto">
  <name>Task 2: Extend posts and postMetrics tables with seriesId and language columns</name>
  <files>src/core/db/schema.ts</files>
  <action>
Add two new columns to the existing `posts` table:
- `seriesId` (text, nullable) -- references series.id when post is part of a series
- `language` (text, nullable) -- "en" | "es" | "both" for bilingual tracking (POST-07)

Add one new column to the existing `postMetrics` table:
- `language` (text, nullable) -- for per-language performance tracking (ANLYT-10)

These are additive columns only (nullable, no default required). Place them logically near related existing columns in each table definition. The `seriesId` should go after `metadata` in posts. The `language` should go after `platform` in both tables.

NOTE: Do NOT touch any existing column definitions. Only add new columns.
  </action>
  <verify>Run `bun run check` to confirm no type errors. Grep for "seriesId" and "language" in schema.ts to confirm both columns are present in both tables.</verify>
  <done>Posts table has seriesId and language columns. PostMetrics table has language column. All nullable, no breaking changes.</done>
</task>

</tasks>

<verification>
- `bun run check` passes with no errors
- schema.ts exports: ideas, series, trends, weeklyPlans, monitoredAccounts
- All 5 new tables have RLS policies with the hubUser role pattern
- posts table has seriesId and language columns
- postMetrics table has language column
- No existing table definitions were modified (only new columns added to posts and postMetrics)
</verification>

<success_criteria>
All Phase 5 database tables are defined and the schema compiles. Downstream plans can import table definitions for queries and inserts.
</success_criteria>

<output>
After completion, create `.planning/phases/05-intelligence-ideation-and-planning/05-01-SUMMARY.md`
</output>
