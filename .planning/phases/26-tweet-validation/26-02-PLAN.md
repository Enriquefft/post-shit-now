---
phase: 26-tweet-validation
plan: 02
type: execute
wave: 2
depends_on:
  - "26-01"
files_modified:
  - src/platforms/handlers/x.handler.ts
autonomous: true
requirements:
  - TVAL-02

must_haves:
  truths:
    - "An oversized single tweet is blocked before any X API call with error showing actual count vs 280"
    - "An oversized tweet in a thread is blocked before any X API call with error identifying which tweet"
    - "Soft warnings (mentions, hashtags) are logged but do not block publishing"
    - "Validation runs at publish time as a final safety net"
  artifacts:
    - path: "src/platforms/handlers/x.handler.ts"
      provides: "Pre-flight tweet validation before API calls"
      contains: "validateTweet"
  key_links:
    - from: "src/platforms/handlers/x.handler.ts"
      to: "src/core/utils/tweet-validator.ts"
      via: "import { validateTweet, countTweetChars }"
      pattern: "import.*validateTweet.*tweet-validator"
    - from: "src/platforms/handlers/x.handler.ts"
      to: "X API createTweet call"
      via: "validation gate before createTweet"
      pattern: "validateTweet.*\n.*valid.*\n.*createTweet"
---

<objective>
Wire tweet validation into the X handler as a pre-flight safety net before API calls.

Purpose: Currently the X handler sends tweets directly to the API and catches errors after the fact, producing misleading 403 errors for oversized tweets. This plan adds pre-flight validation that blocks oversized tweets with clear error messages showing actual vs max character count (TVAL-02). Soft warnings for excess mentions/hashtags are logged but do not block publishing.

Output: Modified `x.handler.ts` with pre-flight validation before all `createTweet()` calls.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/26-tweet-validation/26-CONTEXT.md
@.planning/phases/26-tweet-validation/26-01-SUMMARY.md
@src/platforms/handlers/x.handler.ts
@src/core/utils/tweet-validator.ts

<interfaces>
<!-- From Plan 01 outputs -->

From src/core/utils/tweet-validator.ts (created in Plan 01):
```typescript
export interface TweetValidation {
  valid: boolean;
  charCount: number;
  maxChars: number;
  errors: string[];
  warnings: string[];
}
export function countTweetChars(text: string): number;
export function validateTweet(text: string): TweetValidation;
```

From src/core/types/publisher.ts:
```typescript
export interface PlatformPublisher {
  publish(db: DbConnection, post: PostRow, encKey: Buffer): Promise<PlatformPublishResult>;
  validateCredentials(): Promise<boolean>;
  getRateLimitInfo(): RateLimitInfo | null;
  refreshCredentials(db: DbConnection, encKey: Buffer): Promise<void>;
  isRateLimited(): boolean;
  getRetryAfter(): number;
}
```

From src/core/types/index.ts:
```typescript
export interface PlatformPublishResult {
  platform: Platform;
  status: "published" | "failed" | "skipped";
  externalPostId?: string;
  error?: string;
}
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add pre-flight validation to X handler publish method</name>
  <files>src/platforms/handlers/x.handler.ts</files>
  <action>
Modify `src/platforms/handlers/x.handler.ts` to validate tweets before making any X API calls.

**Changes:**

1. Add import at top:
   ```typescript
   import { validateTweet, countTweetChars } from "../../core/utils/tweet-validator.ts";
   ```

2. In the `publish()` method, after the tweet/thread determination block (after line ~108, after `tweets` array is finalized), add pre-flight validation:

   **For single tweets (when `!isThread`):**
   ```typescript
   const validation = validateTweet(tweets[0] ?? content);
   if (!validation.valid) {
     return {
       platform: "x",
       status: "failed",
       error: validation.errors.join('; ') + '. Consider splitting into a thread',
     };
   }
   if (validation.warnings.length > 0) {
     logger.warn("Tweet validation warnings", { postId, warnings: validation.warnings });
   }
   ```

   **For threads (when `isThread`):**
   ```typescript
   for (const [i, tweet] of tweets.entries()) {
     const v = validateTweet(tweet);
     if (!v.valid) {
       return {
         platform: "x",
         status: "failed",
         error: `Thread tweet ${i + 1}: ${v.errors.join('; ')}`,
       };
     }
     if (v.warnings.length > 0) {
       logger.warn("Thread tweet validation warnings", { postId, tweetIndex: i + 1, warnings: v.warnings });
     }
   }
   ```

3. Fix the thread detection to use weighted counting (line ~102):
   ```typescript
   // BEFORE:
   if (content.length > 280) {
   // AFTER:
   if (countTweetChars(content) > 280) {
   ```

4. Per user decision: error message format is "Tweet is N/280 characters" (produced by validateTweet). The handler appends ". Consider splitting into a thread" for single oversized tweets only (not for thread tweets, since they're already in a thread).

5. Soft warnings (mentions >10, hashtags >5) are logged via `logger.warn` but do NOT block publishing (per user decision).

**What NOT to change:**
- Do not modify the `postThread()` method internals (thread resilience is Phase 28)
- Do not add notification dispatch here (that's a separate concern; the `failed` status return will be handled by the existing publish-post trigger task which already handles failure notifications)
- Do not add duplicate detection in this task (see Task 2)
  </action>
  <verify>
    <automated>cd /home/hybridz/Projects/post-shit-now && bun run typecheck 2>&1 | tail -5</automated>
  </verify>
  <done>
- `x.handler.ts` imports `validateTweet` and `countTweetChars` from tweet-validator.ts
- Pre-flight validation runs before any `createTweet()` call for both single tweets and threads
- Oversized single tweet returns `{ status: 'failed', error: 'Tweet is N/280 characters. Consider splitting into a thread' }`
- Oversized thread tweet returns `{ status: 'failed', error: 'Thread tweet N: Tweet is M/280 characters' }`
- Soft warnings are logged via logger.warn, not blocking
- Thread detection uses `countTweetChars(content) > 280` instead of `content.length > 280`
- `bun run typecheck` passes
  </done>
</task>

<task type="auto">
  <name>Task 2: Add duplicate detection as soft warning</name>
  <files>src/platforms/handlers/x.handler.ts</files>
  <action>
Add duplicate content detection as a soft warning in the X handler's publish method.

**Implementation:**

1. Add a private helper method to XHandler class:
   ```typescript
   private async checkDuplicates(
     db: DbConnection,
     userId: string,
     content: string
   ): Promise<string | null> {
     // Query recent X posts from last 7 days
     const recentPosts = await db
       .select({ content: posts.content })
       .from(posts)
       .where(
         sql`${posts.userId} = ${userId}
           AND ${posts.platform} = 'x'
           AND ${posts.status} = 'published'
           AND ${posts.publishedAt} > NOW() - INTERVAL '7 days'`
       )
       .limit(50);

     // Jaccard similarity on word sets
     const inputWords = new Set(content.toLowerCase().split(/\s+/).filter(Boolean));
     for (const post of recentPosts) {
       const postWords = new Set(post.content.toLowerCase().split(/\s+/).filter(Boolean));
       const intersection = new Set([...inputWords].filter(w => postWords.has(w)));
       const union = new Set([...inputWords, ...postWords]);
       const similarity = union.size > 0 ? intersection.size / union.size : 0;
       if (similarity >= 0.8) {
         return `Content is 80%+ similar to a post published within the last 7 days`;
       }
     }
     return null;
   }
   ```

2. In the `publish()` method, after the pre-flight validation block (added in Task 1), before the `try` block that calls `createTweet`:
   ```typescript
   // Duplicate detection (soft warning only, does not block)
   const duplicateWarning = await this.checkDuplicates(db, userId, content);
   if (duplicateWarning) {
     logger.warn("Duplicate content detected", { postId, warning: duplicateWarning });
   }
   ```

3. This is a soft warning per user decision -- it logs but does NOT block publishing.

**Import needed:** `posts` is already imported from `../../core/db/schema.ts` at line 4.

**Note:** The `sql` template tag from drizzle-orm is already imported at line 2.
  </action>
  <verify>
    <automated>cd /home/hybridz/Projects/post-shit-now && bun run typecheck 2>&1 | tail -5</automated>
  </verify>
  <done>
- `checkDuplicates` private method exists on XHandler class
- Duplicate check queries posts from last 7 days with Jaccard similarity >= 0.8 threshold
- Duplicate detection is a soft warning (logged, does not block publish)
- No new imports needed (posts and sql already imported)
- `bun run typecheck` passes
  </done>
</task>

</tasks>

<verification>
- `bun run typecheck` passes with no new errors
- `grep 'validateTweet\|countTweetChars' src/platforms/handlers/x.handler.ts` confirms both functions imported and used
- `grep 'content\.length' src/platforms/handlers/x.handler.ts` returns NO matches (all .length comparisons replaced with weighted counting)
- `grep 'checkDuplicates' src/platforms/handlers/x.handler.ts` confirms duplicate detection method exists
</verification>

<success_criteria>
1. Oversized tweets are blocked BEFORE any X API call (no more misleading 403s) (TVAL-02)
2. Error messages show "Tweet is N/280 characters" format per user decision
3. Soft warnings (mentions, hashtags, duplicates) logged but never block publishing
4. Thread detection uses weighted counting, not `.length`
5. `bun run typecheck` passes
</success_criteria>

<output>
After completion, create `.planning/phases/26-tweet-validation/26-02-SUMMARY.md`
</output>
