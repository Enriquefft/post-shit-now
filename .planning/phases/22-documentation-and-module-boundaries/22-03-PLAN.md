---
phase: 22-documentation-and-module-boundaries
plan: "03"
type: execute
wave: 2
depends_on: ["22-01", "22-02"]
files_modified:
  - src/platforms/index.ts
  - src/core/index.ts
autonomous: true
requirements: [ARCH-08, ARCH-09, ARCH-10]

must_haves:
  truths:
    - "Consumers can import PlatformPublisher, all four handler classes, and factory functions from a single '@psn/platforms' import"
    - "Consumers can import Platform, PlatformPublishResult, PostMetadata, DbConnection, PostRow, createHubConnection, and crypto utils from '@psn/core'"
    - "Platform clients (XClient, LinkedInClient, etc.), media helpers, and oauth functions are NOT exported from either top-level barrel"
    - "bun run check:circular passes with no cycles introduced by the barrels"
    - "bun run typecheck passes after barrel creation"
  artifacts:
    - path: "src/platforms/index.ts"
      provides: "Public API barrel for platforms module"
      exports: ["PlatformPublisher", "XHandler", "LinkedInHandler", "InstagramHandler", "TikTokHandler", "createHandler", "registerHandler"]
    - path: "src/core/index.ts"
      provides: "Public API barrel for core module"
      exports: ["Platform", "PlatformPublishResult", "PostMetadata", "DbConnection", "PostRow", "createHubConnection", "encrypt", "decrypt", "keyFromHex"]
  key_links:
    - from: "src/platforms/index.ts"
      to: "src/core/types/publisher.ts"
      via: "direct import for PlatformPublisher, DbConnection, PostRow, RateLimitInfo"
      pattern: "from.*core/types/publisher"
    - from: "src/core/index.ts"
      to: "src/core/types/index.ts (selective re-export)"
      via: "named type exports only — no cross-module re-exports like LinkedInOAuthConfig"
      pattern: "export type.*Platform.*from.*types/index"
---

<objective>
Create two top-level public API barrel files: `src/platforms/index.ts` and `src/core/index.ts`. These define the module boundaries — what is public API versus internal implementation detail.

Purpose: Consumers (Trigger.dev tasks, CLI commands, tests) get a single import path per module. Internal implementation details (clients, media helpers, oauth, migration scripts) are excluded — internal by convention.

Output: `src/platforms/index.ts` and `src/core/index.ts`
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/22-documentation-and-module-boundaries/CONTEXT.md
@.planning/phases/22-documentation-and-module-boundaries/22-RESEARCH.md
@.planning/phases/22-documentation-and-module-boundaries/22-01-SUMMARY.md
@.planning/phases/22-documentation-and-module-boundaries/22-02-SUMMARY.md

<interfaces>
<!-- Key files these barrels will re-export from: -->

From src/core/types/publisher.ts:
```typescript
export interface PlatformPublisher { publish(...), validateCredentials(), getRateLimitInfo(), refreshCredentials(...), isRateLimited(), getRetryAfter() }
export type DbConnection = ReturnType<typeof createHubConnection>
export type PostRow = typeof posts.$inferSelect
export interface RateLimitInfo { limit, remaining, resetAt }
export type { Platform }  // re-exported from types/index.ts
```

From src/core/types/index.ts (SELECTIVE — do NOT re-export the cross-module types):
```typescript
// These are SAFE to re-export (genuinely core):
export type Platform = "x" | "linkedin" | "instagram" | "tiktok"
export interface PlatformPublishResult { platform, status, externalPostId?, error? }
export interface PostMetadata { triggerRunId?, scheduledTimezone?, ... }
export type PostStatus = "draft" | "scheduled" | "publishing" | "published" | "failed" | "retry"
export type PostSubStatus = "retry_1" | ... | null
export interface HubConfig { databaseUrl, triggerProjectRef, encryptionKey, apiKeys }
export interface SetupResult { step, status, message, data? }
export interface ValidationResult { check, status, message }
export interface ValidationSummary { allPassed, results }
export interface PlatformStatus { status, externalPostId?, error?, retryCount? }
export interface ThreadTweet { position, content, charCount, ... }
export interface XOAuthConfig { clientId, clientSecret, callbackUrl }

// These MUST NOT be re-exported from src/core/index.ts (cross-module re-exports = circular risk):
// export type { ApprovalAction, ApprovalStatus } from "../../approval/types.ts"
// export type { MessageResult, ... } from "../../notifications/types.ts"
// export type { LinkedInOAuthConfig } from "../../platforms/linkedin/types.ts"  <-- CIRCULAR RISK
// export type { HubConnection, ... } from "../../team/types.ts"
```

From src/core/utils/publisher-factory.ts:
```typescript
export type HandlerConstructor
export function registerHandler(platform: Platform, handler: HandlerConstructor): void
export function createHandler(platform: Platform, ...args: unknown[]): PlatformPublisher
export function hasHandler(platform: Platform): boolean
export function registeredPlatforms(): Platform[]
export function unregisterHandler(platform: Platform): void
```

From src/core/db/connection.ts:
```typescript
export function createHubConnection(databaseUrl: string): DbClient
// DbClient type may be exported — check actual file before referencing
```

From src/core/utils/crypto.ts:
```typescript
// Check actual file for exports — expect: encrypt, decrypt, keyFromHex
```

From src/platforms/handlers/ (all four handlers):
```typescript
// src/platforms/handlers/index.ts already exports:
export { XHandler } from "./x.handler.ts"
export { LinkedInHandler } from "./linkedin.handler.ts"
export { InstagramHandler } from "./instagram.handler.ts"
export { TikTokHandler } from "./tiktok.handler.ts"
```

CRITICAL: src/platforms/handlers/index.ts is the INTERNAL barrel for auto-registration side-effects.
src/platforms/index.ts is the NEW PUBLIC API barrel — separate concern, separate file.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create src/platforms/index.ts public API barrel</name>
  <files>src/platforms/index.ts</files>
  <action>
Create `/home/hybridz/Projects/post-shit-now/src/platforms/index.ts`. This is the PUBLIC API barrel for the platforms module — a new file, distinct from `src/platforms/handlers/index.ts` (which is the internal auto-registration barrel).

Read `src/platforms/handlers/x.handler.ts` to confirm the exact export names of XHandler before writing.
Read `src/core/types/publisher.ts` to confirm the exported type names.
Read `src/core/utils/publisher-factory.ts` to confirm the exported function names.

The barrel must export:

1. **Publish contract types** — import directly from `../core/types/publisher.ts` (not from a handler file, to avoid indirection):
   - `PlatformPublisher` (type)
   - `DbConnection` (type)
   - `PostRow` (type)
   - `RateLimitInfo` (interface)

2. **Handler classes** — import from individual handler files (NOT from `./handlers/index.ts` — that file causes side-effect registration; the public barrel should not trigger registration as a side-effect):
   - `XHandler` from `./handlers/x.handler.ts`
   - `LinkedInHandler` from `./handlers/linkedin.handler.ts`
   - `InstagramHandler` from `./handlers/instagram.handler.ts`
   - `TikTokHandler` from `./handlers/tiktok.handler.ts`

   IMPORTANT: Check whether importing individual handler files triggers `registerHandler()` as a side-effect. If yes, that is acceptable — the handler classes are valid public exports and consumers who import them via the barrel expect them to be registered. If you are unsure, check the handler file top-level code.

3. **Factory functions** — import from `../core/utils/publisher-factory.ts`:
   - `createHandler`
   - `registerHandler`
   - `hasHandler`
   - `registeredPlatforms`
   - `unregisterHandler`

Do NOT export: platform clients (XClient, LinkedInClient, etc.), media helpers, oauth functions. These stay internal — not referenced in this barrel at all.

Add a file-level doc comment explaining what is and is not exported:
```typescript
/**
 * Public API for src/platforms/
 *
 * Exports the PlatformPublisher contract, all handler classes, and the factory.
 * Internal: platform clients (XClient, etc.), media helpers, oauth functions.
 */
```
  </action>
  <verify>
    <automated>cd /home/hybridz/Projects/post-shit-now && bun run typecheck 2>&1 | tail -5</automated>
  </verify>
  <done>src/platforms/index.ts exists, exports PlatformPublisher, all four handler classes, and all five factory functions. bun run typecheck passes.</done>
</task>

<task type="auto">
  <name>Task 2: Create src/core/index.ts public API barrel and verify no circular deps</name>
  <files>src/core/index.ts</files>
  <action>
Create `/home/hybridz/Projects/post-shit-now/src/core/index.ts`. This is the top-level PUBLIC API barrel for the core module.

Before writing: read `src/core/db/connection.ts` and `src/core/utils/crypto.ts` to confirm exact export names.

The barrel must export:

1. **Core types** — import SELECTIVELY from `./types/index.ts`. Only the types that are genuinely "core" shared API. DO NOT re-export the cross-module types at lines 91-102 of types/index.ts (ApprovalAction, NotificationEvent, LinkedInOAuthConfig, HubConnection, etc.) — those create circular dependencies when src/core/index.ts is imported by src/platforms/:

Export from `./types/index.ts`:
- `Platform` (type)
- `PlatformPublishResult` (interface)
- `PostMetadata` (interface)
- `PostStatus` (type)
- `PostSubStatus` (type)
- `PlatformStatus` (interface)
- `HubConfig` (interface)
- `SetupResult` (interface)
- `ValidationResult` (interface)
- `ValidationSummary` (interface)
- `ThreadTweet` (interface)
- `XOAuthConfig` (interface)

2. **Publisher contract types** — import from `./types/publisher.ts`:
- `PlatformPublisher` (interface)
- `DbConnection` (type)
- `PostRow` (type)
- `RateLimitInfo` (interface)

3. **Database** — import from `./db/connection.ts`:
- `createHubConnection` (function)
- Export `DbClient` type if it is exported from connection.ts (check the file first)

4. **Utilities** — import from `./utils/crypto.ts`:
- `encrypt`, `decrypt`, `keyFromHex` (check actual export names in the file)

Do NOT export: schema internals (schema.ts, schema-zod.ts), migration scripts (migrate.ts), api-keys.ts internals, env.ts internals, nanoid.ts, thread-splitter.ts (internal utility), timezone.ts (internal utility).

Add a file-level doc comment:
```typescript
/**
 * Public API for src/core/
 *
 * Shared types, DB connection, and utilities used across Trigger.dev tasks,
 * platform handlers, and CLI commands.
 * Internal: schema, migration scripts, env utils, thread-splitter, timezone.
 */
```

After creating both barrels, run:
1. `bun run typecheck` — must pass with zero errors
2. `bun run check:circular` — must show NO new circular dependency cycles involving `core/index.ts` or `platforms/index.ts`

If check:circular reports a cycle involving `core/index.ts` → `platforms/` (due to any transitive import through types/index.ts), fix by removing the offending type from the barrel's exports.
  </action>
  <verify>
    <automated>cd /home/hybridz/Projects/post-shit-now && bun run typecheck 2>&1 | tail -5 && bun run check:circular 2>&1 | tail -10</automated>
  </verify>
  <done>src/core/index.ts exists with selective exports (no cross-module re-exports). bun run typecheck passes. bun run check:circular shows no new cycles.</done>
</task>

</tasks>

<verification>
- `src/platforms/index.ts` exists and exports PlatformPublisher, XHandler, LinkedInHandler, InstagramHandler, TikTokHandler, createHandler, registerHandler, hasHandler, registeredPlatforms, unregisterHandler
- `src/core/index.ts` exists and exports Platform, PlatformPublishResult, PostMetadata, PostStatus, DbConnection, PostRow, createHubConnection, encrypt, decrypt, keyFromHex
- Neither barrel exports: XClient, LinkedInClient, media helpers, oauth functions, schema, migrations
- `bun run typecheck` passes
- `bun run check:circular` shows no cycles involving core/index.ts or platforms/index.ts
- `grep "LinkedInOAuthConfig\|ApprovalAction\|NotificationEvent\|HubConnection" src/core/index.ts` returns no matches (cross-module types excluded)
</verification>

<success_criteria>
- Two top-level barrels define clear public API boundaries for @psn/platforms and @psn/core
- Platform clients, media helpers, and oauth functions are internal by convention (absent from barrels)
- No circular dependencies introduced
- Both typecheck and circular-check pass
- ARCH-10 (file size limits) is satisfied: the existing Biome maxSize config (204800 bytes) already enforces the <200 line convention; both new barrel files should themselves be well under 200 lines
</success_criteria>

<output>
After completion, create `.planning/phases/22-documentation-and-module-boundaries/22-03-SUMMARY.md`
</output>
