---
phase: 02-database-stability
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/team/hub.ts, src/cli/setup-db.ts]
autonomous: true
requirements: [M2]

must_haves:
  truths:
    - "Personal Hub includes auto-generated hubId in connection file"
    - "Company Hub includes hubId in connection file"
    - "Hub IDs are generated deterministically for existing setups"
    - "All hub connections have hubId field populated"
  artifacts:
    - path: "src/team/hub.ts"
      provides: "Hub creation with hubId generation"
      exports: ["createCompanyHub", "getHubConnection"]
    - path: "src/cli/setup-db.ts"
      provides: "Personal hub setup with hubId"
      min_lines: 50
  key_links:
    - from: "src/team/hub.ts"
      to: ".hubs/*.json"
      via: "writeFile() call"
      pattern: "writeFile.*connectionFile"
    - from: "src/cli/setup-db.ts"
      to: ".hubs/personal.json"
      via: "connection file write"
      pattern: "personal\\.json"
---

<objective>
Ensure hub IDs are consistently available across all hub types by auto-generating hubId for new hubs and migrating existing Personal Hubs. This addresses issue M2 (Hub ID missing) by making hubId a required field in all hub connections.

Purpose: Hub IDs are required for multi-hub scenarios, team coordination, and API key scoping. Every hub connection must have a unique hubId that persists across setup operations.

Output: Auto-generated hubIds in all hub connection files, migration path for existing setups.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

# Current hub implementation
@src/team/hub.ts
@src/cli/setup-db.ts
@src/core/utils/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add hubId generation to createCompanyHub</name>
  <files>src/team/hub.ts</files>
  <action>
    Ensure hubId is auto-generated and stored in Company Hub connections:

    1. Verify createCompanyHub() already generates hubId:
       - Check line 35: `const hubId = hub_${crypto.randomUUID().slice(0, 12)};`
       - This should already exist from Phase 01

    2. Verify hubId is included in connection object:
       - Check connection object (lines 138-147) includes hubId field
       - Ensure schema validation (HubConnectionSchema) requires hubId

    3. If missing, add to connection object:
       ```typescript
       const connection: HubConnection = {
         hubId,
         slug,
         displayName,
         databaseUrl,
         triggerProjectId,
         role: "admin",
         joinedAt: new Date().toISOString(),
         encryptionKey,
       };
       ```

    4. Verify HubConnectionSchema in src/team/types.ts requires hubId
       - Check Zod schema: hubId: z.string().min(10).max(50)
       - Ensure connection file validates hubId presence

    Current implementation should already include hubId generation.
    Task is verification-only unless hubId is missing.
  </action>
  <verify>
    1. Run `bun run typecheck` - should pass
    2. Run `bun run lint` - should pass
    3. Create test Company Hub - hubId should be in connection file
  </verify>
  <done>
    createCompanyHub() generates hubId using crypto.randomUUID(), includes hubId in connection object, and HubConnectionSchema validates hubId as required field.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add hubId generation to Personal Hub setup</name>
  <files>src/cli/setup-db.ts</files>
  <action>
    Ensure Personal Hub setup generates and stores hubId in .hubs/personal.json:

    1. Read setup-db.ts to understand Personal Hub creation flow
    2. Add hubId generation if not present:
       ```typescript
       // After getting database URL, before creating connection file
       const hubId = `hub_${crypto.randomUUID().slice(0, 12)}`;
       ```

    3. Ensure connection file write includes hubId:
       ```typescript
       const connection = {
         hubId,
         slug: "personal",
         displayName: "Personal Hub",
         databaseUrl,
         triggerProjectId,
         encryptionKey,
         role: "admin",
         joinedAt: new Date().toISOString(),
       };
       ```

    4. Write to .hubs/personal.json:
       - Ensure directory exists: .hubs/
       - File path: projectRoot/.hubs/personal.json
       - Use HubConnectionSchema validation before write

    5. Add migration for existing setups (if hub.env exists):
       - Read config/hub.env for HUB_ID if present
       - If no HUB_ID, generate new hubId
       - Write .hubs/personal.json with existing config + hubId
       - Delete config/hub.env after migration (cleanup)

    Pattern:
    ```typescript
    // Hub ID generation
    const hubId = existingHubEnv?.HUB_ID ?? `hub_${crypto.randomUUID().slice(0, 12)}`;

    // Connection object with hubId
    const personalHubConnection = {
       hubId,
       slug: "personal",
       displayName: "Personal Hub",
       databaseUrl: dbUrl,
       triggerProjectId: triggerRef,
       encryptionKey: encryptionKey,
       role: "admin",
       joinedAt: new Date().toISOString(),
    };

    // Write to .hubs/personal.json
    await mkdir(join(projectRoot, ".hubs"), { recursive: true });
    await writeFile(join(projectRoot, ".hubs", "personal.json"),
       JSON.stringify(personalHubConnection, null, 2), "utf-8");
    ```
  </action>
  <verify>
    1. Run `bun run typecheck` - should pass
    2. Run `bun run lint` - should pass
    3. Run /psn:setup - .hubs/personal.json should include hubId
    4. Run with existing config/hub.env - should migrate to .hubs/personal.json with hubId
  </verify>
  <done>
    Personal Hub setup generates hubId using crypto.randomUUID() or reuses existing HUB_ID from hub.env, writes .hubs/personal.json with hubId field, and migrates existing config/hub.env to new format.
  </done>
</task>

</tasks>

<verification>
Overall phase verification:
1. Personal Hub .hubs/personal.json includes hubId field
2. Company Hub .hubs/company-{slug}.json includes hubId field
3. HubConnectionSchema validates hubId as required field
4. Existing hub.env setups migrate to .hubs/personal.json with hubId
5. Hub IDs are unique across all hubs (UUID-based)
</verification>

<success_criteria>
- All new hub connections include auto-generated hubId (UUID-based)
- HubConnectionSchema requires hubId field with validation
- Personal Hub writes .hubs/personal.json with hubId populated
- Company Hub writes .hubs/company-{slug}.json with hubId populated
- Migration path exists for existing config/hub.env setups
</success_criteria>

<output>
After completion, create `.planning/phases/02-database-stability/02-02-SUMMARY.md`
</output>
