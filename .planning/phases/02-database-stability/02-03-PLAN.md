---
phase: 02-database-stability
plan: 03
type: execute
wave: 2
depends_on: [02-02]
files_modified: [src/team/hub.ts, src/core/utils/env.ts]
autonomous: true
requirements: [M5, C11, C12]

must_haves:
  truths:
    - "getHubConnection() works for both Personal and Company hubs"
    - "Personal Hub uses .hubs/personal.json (same format as Company)"
    - "Empty .hubs/ directory returns graceful empty array"
    - "Hub discovery loads both personal.json and company-*.json files"
  artifacts:
    - path: "src/team/hub.ts"
      provides: "Unified hub discovery and connection"
      exports: ["discoverCompanyHubs", "getHubConnection", "getHubDb"]
    - path: "src/core/utils/env.ts"
      provides: "Hub connection loading utilities"
      exports: ["loadHubEnv"]
  key_links:
    - from: "src/team/hub.ts"
      to: ".hubs/*.json"
      via: "readdir() and readFile()"
      pattern: "readdir.*hubsDir"
    - from: "src/team/hub.ts"
      to: "src/core/db/connection.ts"
      via: "createHubConnection() call"
      pattern: "createHubConnection.*databaseUrl"
---

<objective>
Unify hub connection mechanisms to work identically for Personal and Company hubs. This addresses issues M5 (empty .hubs confusion), C11 (Personal Hub inconsistency), and C12 (dual-path confusion) by using .hubs/personal.json for all hub types.

Purpose: Single, consistent hub storage mechanism (.hubs/*.json) and single API (getHubConnection()) for all hub types. No special cases for Personal vs Company hubs.

Output: Unified hub discovery that loads .hubs/personal.json and .hubs/company-*.json into single getHubConnection() API.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

# Current hub implementation (should be unified already)
@src/team/hub.ts
@src/core/utils/env.ts
@.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Verify discoverCompanyHubs loads personal.json</name>
  <files>src/team/hub.ts</files>
  <action>
    Ensure discoverCompanyHubs() loads both Personal and Company hub files:

    1. Current implementation check (line 164):
       - Function is named discoverCompanyHubs but should load ALL .hubs/*.json files
       - Should load: personal.json AND company-*.json files
       - Name is legacy, should behave as discoverAllHubs()

    2. Verify readdir pattern (line 167-189):
       - Reads all entries in .hubs/ directory
       - Filters for .json files only
       - Parses and validates each with HubConnectionSchema
       - Returns all valid connections in single array

    3. Ensure no special handling for personal vs company:
       - Both file types use same HubConnectionSchema
       - Both return via same connection array
       - Caller uses same getHubConnection() for both

    4. If discoverCompanyHubs only loads company-*.json, fix to include personal.json:
       ```typescript
       // Load all .json files (personal.json + company-*.json)
       for (const entry of entries) {
         if (!entry.endsWith(".json")) continue;

         // Include personal.json and company-*.json
         if (entry === "personal.json" || entry.startsWith("company-")) {
           // Load and validate
         }
       }
       ```

    5. Ensure graceful handling of missing .hubs/ directory (line 170-172):
       - readdir() catch returns empty array
       - No error thrown for missing directory
       - Document behavior in JSDoc

    Current implementation should already support this pattern.
    Task is verification-only unless discoverCompanyHubs filters out personal.json.
  </action>
  <verify>
    1. Run `bun run typecheck` - should pass
    2. Run `bun run lint` - should pass
    3. Create .hubs/personal.json - discoverCompanyHubs() should include it
    4. Create .hubs/company-test.json - discoverCompanyHubs() should include it
    5. Call discoverCompanyHubs() on empty directory - should return []
  </verify>
  <done>
    discoverCompanyHubs() loads both .hubs/personal.json and .hubs/company-*.json files, validates all with HubConnectionSchema, returns unified connection array, and handles missing .hubs/ gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Verify getHubConnection works for all hub types</name>
  <files>src/team/hub.ts</files>
  <action>
    Ensure getHubConnection() handles both Personal and Company hubs:

    1. Current implementation check (line 198-204):
       ```typescript
       export async function getHubConnection(
         projectRoot: string,
         slugOrId: string,
       ): Promise<HubConnection | null> {
         const hubs = await discoverCompanyHubs(projectRoot);
         return hubs.find(h => h.slug === slugOrId || h.hubId === slugOrId) ?? null;
       }
       ```

    2. Verify this works for:
       - slug="personal" → returns .hubs/personal.json
       - hubId="hub_abc123" → returns matching hub regardless of type
       - slug="company-test" → returns .hubs/company-test.json

    3. Ensure no special cases or type checks:
       - No if statements checking hub type
       - No separate functions for Personal vs Company
       - Single code path for all lookups

    4. Update loadHubEnv() to deprecate config/hub.env:
       - Add warning if config/hub.env exists but .hubs/personal.json does not
       - Suggest migration: "Personal Hub should be in .hubs/personal.json"
       - Eventually remove loadHubEnv() after migration period

    5. Update JSDoc comments to clarify unified behavior:
       ```typescript
       /**
        * Find a hub connection by slug or hubId.
        * Works for both Personal Hub (.hubs/personal.json) and Company Hubs (.hubs/company-*.json).
        * Returns null if not found or if .hubs/ directory doesn't exist.
        */
       ```

    6. Document migration from config/hub.env in comment:
       - Old: config/hub.env (env file format)
       - New: .hubs/personal.json (unified JSON format)
       - Migration: plan 02-02 handles conversion

    Current implementation should already be unified.
    Task is verification and documentation updates.
  </action>
  <verify>
    1. Run `bun run typecheck` - should pass
    2. Run `bun run lint` - should pass
    3. getHubConnection(".", "personal") → returns Personal Hub
    4. getHubConnection(".", "company-test") → returns Company Hub
    5. getHubConnection(".", "nonexistent") → returns null
    6. getHubConnection(".", "hub_abc123") → returns hub with matching ID
  </verify>
  <done>
    getHubConnection() works identically for Personal and Company hubs, accepts both slug and hubId lookups, returns null for missing hubs, and JSDoc documents unified behavior with migration notes.
  </done>
</task>

</tasks>

<verification>
Overall phase verification:
1. discoverCompanyHubs() loads .hubs/personal.json and .hubs/company-*.json
2. getHubConnection() finds hubs by slug or hubId for all hub types
3. No special handling required for Personal vs Company hubs
4. Missing .hubs/ directory returns empty array (graceful degradation)
5. JSDoc documents unified behavior and migration from hub.env
</verification>

<success_criteria>
- All hub storage uses .hubs/*.json format (unified)
- discoverCompanyHubs() returns array with Personal + Company hubs
- getHubConnection() works for "personal", "company-slug", and hubId lookups
- No config/hub.env special cases (deprecation warning only)
- Empty .hubs/ handled gracefully without errors
</success_criteria>

<output>
After completion, create `.planning/phases/02-database-stability/02-03-SUMMARY.md`
</output>
