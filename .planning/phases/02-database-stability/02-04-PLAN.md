---
phase: 02-database-stability
plan: 04
type: execute
wave: 2
depends_on: [02-01]
files_modified: [src/cli/setup.ts, src/cli/setup-db.ts]
autonomous: true
requirements: [M14]

must_haves:
  truths:
    - "Reset command clears partial setup state (files + DB)"
    - "Users can retry /psn:setup after reset without conflicts"
    - "Reset command confirms destructive action before executing"
    - "Reset preserves user choices (stored for re-setup)"
  artifacts:
    - path: "src/cli/setup-reset.ts"
      provides: "Setup reset functionality"
      min_lines: 60
    - path: "src/cli/setup.ts"
      provides: "Reset subcommand routing"
      exports: ["runSetupSubcommand"]
  key_links:
    - from: "src/cli/setup-reset.ts"
      to: ".hubs/*.json"
      via: "rm() for cleanup"
      pattern: "rm.*hubsDir"
    - from: "src/cli/setup-reset.ts"
      to: "config/*"
      via: "rm() for config cleanup"
      pattern: "rm.*configDir"
    - from: "src/cli/setup.ts"
      to: "src/cli/setup-reset.ts"
      via: "import and function call"
      pattern: "import.*setup-reset"
---

<objective>
Add setup reset and recovery flow to clear partial setup state and enable clean retries. This addresses issue M14 (recovery flow) by providing /psn:setup reset command that removes config files and database resources, allowing users to start fresh.

Purpose: Setup failures can leave partial state (incomplete DB, bad config files). Users need a reset command to clean up and retry setup without manual file cleanup.

Output: /psn:setup reset subcommand that clears .hubs/, config/, and optionally Neon database, with confirmation prompt.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/ROADMAP.md

# Current setup implementation
@src/cli/setup.ts
@src/cli/setup-db.ts
@src/core/utils/env.ts
@src/team/hub.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create setup reset functionality</name>
  <files>src/cli/setup-reset.ts</files>
  <action>
    Create setup-reset.ts with reset cleanup logic:

    1. Import dependencies:
       ```typescript
       import { rm } from "node:fs/promises";
       import { join } from "node:path";
       import type { SetupResult } from "../core/types/index.ts";
       import { loadKeysEnv } from "../core/utils/env.ts";
       ```

    2. Create resetHub() function:
       - Parameters: { projectRoot, confirm, options }
       - Options: { deleteDb: boolean, deleteKeys: boolean }
       - Returns: SetupResult

    3. Reset logic:
       ```typescript
       export async function resetHub(params: {
         projectRoot?: string;
         confirm?: boolean;
         deleteDb?: boolean;
         deleteKeys?: boolean;
       }): Promise<SetupResult> {
         const { projectRoot = ".", confirm = false, deleteDb = false, deleteKeys = false } = params;

         if (!confirm) {
           return {
             step: "reset",
             status: "need_confirmation",
             message: "Reset will delete .hubs/, config/hub.env, and optionally Neon DB. Add --confirm to proceed.",
             data: {
               willDelete: [".hubs/", "config/hub.env"],
               optional: { deleteDb: "Neon database", deleteKeys: "config/keys.env" },
             },
           };
         }

         const deleted: string[] = [];
         const errors: string[] = [];

         // Delete .hubs/ directory
         try {
           await rm(join(projectRoot, ".hubs"), { recursive: true, force: true });
           deleted.push(".hubs/");
         } catch (err) {
           errors.push(`Failed to delete .hubs/: ${err instanceof Error ? err.message : String(err)}`);
         }

         // Delete config/hub.env
         try {
           await rm(join(projectRoot, "config", "hub.env"), { force: true });
           deleted.push("config/hub.env");
         } catch (err) {
           // File doesn't exist - OK
         }

         // Delete config/keys.env if requested
         if (deleteKeys) {
           try {
             await rm(join(projectRoot, "config", "keys.env"), { force: true });
             deleted.push("config/keys.env");
           } catch (err) {
             errors.push(`Failed to delete keys.env: ${err instanceof Error ? err.message : String(err)}`);
           }
         }

         // Delete Neon database if requested
         if (deleteDb) {
           const dbDeleteResult = await deleteNeonDatabase(projectRoot);
           if (dbDeleteResult.success) {
             deleted.push("Neon database");
           } else {
             errors.push(dbDeleteResult.error || "Failed to delete Neon database");
           }
         }

         if (errors.length > 0) {
           return {
             step: "reset",
             status: "partial_failure",
             message: `Reset completed with ${errors.length} errors`,
             data: { deleted, errors },
           };
         }

         return {
           step: "reset",
           status: "success",
           message: "Setup reset complete. Run /psn:setup to start fresh.",
           data: { deleted },
         };
       }
       ```

    4. Create deleteNeonDatabase() helper:
       - Load NEON_API_KEY from config/keys.env
       - List Neon projects to find PSN database
       - Delete database via neonctl
       - Return { success, error }

    5. Export functions and add CLI entry point:
       ```typescript
       if (import.meta.main) {
         // Parse args: --confirm, --delete-db, --delete-keys
         // Call resetHub()
         // Output JSON
       }
       ```
  </action>
  <verify>
    1. Run `bun run typecheck` - should pass
    2. Run `bun run lint` - should pass
    3. Run without --confirm - should return need_confirmation
    4. Run with --confirm - should delete .hubs/ and config/hub.env
    5. Run with --delete-db - should delete Neon database
  </verify>
  <done>
    setup-reset.ts provides resetHub() function, deletes .hubs/, config/hub.env, optionally Neon DB and keys.env, requires --confirm flag, and returns SetupResult with deleted/error lists.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add reset subcommand to setup.ts</name>
  <files>src/cli/setup.ts</files>
  <action>
    Add "reset" subcommand to runSetupSubcommand():

    1. Import reset function:
       ```typescript
       import { resetHub } from "./setup-reset.ts";
       ```

    2. Add "reset" case to runSetupSubcommand() switch:
       ```typescript
       case "reset": {
         const result = await resetHub({
           projectRoot,
           confirm: params.confirm === "true",
           deleteDb: params.deleteDb === "true",
           deleteKeys: params.deleteKeys === "true",
         });
         return { steps: [result], validation: null, completed: result.status === "success" };
       }
       ```

    3. Update parseCliArgs() to handle reset flags:
       - --confirm: boolean (requires for destructive action)
       - --delete-db: boolean (optional, deletes Neon database)
       - --delete-keys: boolean (optional, deletes API keys)

    4. Update slash command documentation (.claude/commands/psn/setup.md):
       - Document /psn:setup reset subcommand
       - Explain flags: --confirm, --delete-db, --delete-keys
       - Add warning about destructive nature

    Slash command example:
       ```
       ## Reset Setup

       Clear partial setup state and start fresh.

       \`\`\`bash
       /psn:setup reset --confirm
       # Add --delete-db to also remove Neon database
       # Add --delete-keys to also remove API keys
       \`\`\`

       **WARNING:** This is destructive. Back up any important data before resetting.
       ```
  </action>
  <verify>
    1. Run `bun run typecheck` - should pass
    2. Run `bun run lint` - should pass
    3. Run /psn:setup reset - should prompt for confirmation
    4. Run /psn:setup reset --confirm - should execute reset
    5. Run /psn:setup after reset - should start fresh setup
  </verify>
  <done>
    setup.ts routes "reset" subcommand to resetHub(), passes --confirm, --delete-db, --delete-keys flags, and slash command documents destructive warning with usage examples.
  </done>
</task>

</tasks>

<verification>
Overall phase verification:
1. /psn:setup reset without --confirm returns need_confirmation
2. /psn:setup reset --confirm deletes .hubs/ and config/hub.env
3. /psn:setup reset --delete-db deletes Neon database
4. /psn:setup reset --delete-keys deletes config/keys.env
5. Setup can run successfully after reset (no conflicts)
</verification>

<success_criteria>
- resetHub() function clears .hubs/ directory
- resetHub() clears config/hub.env (legacy format)
- resetHub() optionally deletes Neon database with --delete-db flag
- resetHub() optionally deletes API keys with --delete-keys flag
- --confirm flag required for destructive action
- runSetupSubcommand() routes "reset" to resetHub()
- Slash command documents reset with clear warnings
</success_criteria>

<output>
After completion, create `.planning/phases/02-database-stability/02-04-SUMMARY.md`
</output>
