---
phase: 02-x-platform-pipeline
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/db/schema.ts
  - src/core/types/index.ts
  - src/platforms/x/oauth.ts
  - src/platforms/x/types.ts
  - src/cli/setup.ts
  - src/cli/setup-x-oauth.ts
autonomous: false
requirements:
  - AUTH-01
  - AUTH-08
user_setup:
  - service: x-developer-portal
    why: "X OAuth 2.0 PKCE requires a Developer Portal app with OAuth 2.0 enabled"
    env_vars:
      - name: X_CLIENT_ID
        source: "X Developer Portal -> Project -> App -> Keys and tokens -> OAuth 2.0 Client ID"
      - name: X_CLIENT_SECRET
        source: "X Developer Portal -> Project -> App -> Keys and tokens -> OAuth 2.0 Client Secret"
    dashboard_config:
      - task: "Create a project and app at developer.x.com"
        location: "X Developer Portal -> Dashboard -> Create Project"
      - task: "Enable OAuth 2.0 with Type: Confidential client, PKCE enabled"
        location: "X Developer Portal -> App -> Settings -> User authentication settings"
      - task: "Set callback URL to https://example.com/callback"
        location: "X Developer Portal -> App -> Settings -> User authentication settings -> Callback URL"

must_haves:
  truths:
    - "User can run X OAuth flow and receive encrypted tokens stored in DB"
    - "OAuth tokens table has metadata column for refresh tracking and failure info"
    - "Setup flow includes X OAuth as a step after API keys, skipping if valid token exists"
  artifacts:
    - path: "src/platforms/x/oauth.ts"
      provides: "Arctic-based X OAuth 2.0 PKCE flow (authorize URL generation, code exchange, token refresh)"
      exports: ["createXOAuthClient", "generateAuthUrl", "exchangeCode", "refreshAccessToken"]
    - path: "src/platforms/x/types.ts"
      provides: "Zod schemas for X API requests/responses, rate limit types"
      exports: ["TweetCreateSchema", "TweetResponseSchema", "RateLimitInfo", "XApiError"]
    - path: "src/cli/setup-x-oauth.ts"
      provides: "X OAuth setup step for CLI (check existing token, guide through auth, store encrypted)"
      exports: ["setupXOAuth"]
    - path: "src/core/db/schema.ts"
      provides: "Expanded posts table with thread tracking columns, oauth_tokens with metadata"
      contains: "parentPostId"
    - path: "src/core/types/index.ts"
      provides: "Expanded PostStatus with sub-statuses, PostMetadata type, ThreadTweet type"
      contains: "PostSubStatus"
  key_links:
    - from: "src/platforms/x/oauth.ts"
      to: "arctic"
      via: "Twitter constructor"
      pattern: "new Twitter"
    - from: "src/cli/setup-x-oauth.ts"
      to: "src/core/utils/crypto.ts"
      via: "encrypt tokens before DB storage"
      pattern: "encrypt\\("
    - from: "src/cli/setup.ts"
      to: "src/cli/setup-x-oauth.ts"
      via: "import and call setupXOAuth in setup flow"
      pattern: "setupXOAuth"
---

<objective>
Expand the DB schema for thread tracking and token metadata, create the X OAuth 2.0 PKCE module using Arctic, define typed X API schemas, and integrate OAuth into the `/psn:setup` flow.

Purpose: Lay the data and auth foundation that all other Phase 2 plans depend on. Without schema expansion, thread tracking is impossible. Without OAuth, no X API calls can be made. Without types, the API client has no contracts.

Output: Expanded schema with thread columns, X OAuth module, X API type definitions, setup flow with OAuth step.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-x-platform-pipeline/02-RESEARCH.md

@src/core/db/schema.ts
@src/core/types/index.ts
@src/core/utils/crypto.ts
@src/core/utils/env.ts
@src/cli/setup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Expand DB schema and types for Phase 2</name>
  <files>src/core/db/schema.ts, src/core/types/index.ts</files>
  <action>
**Schema expansion (src/core/db/schema.ts):**

1. Add columns to `posts` table:
   - `parentPostId: text("parent_post_id")` — references the parent post for thread tweets (nullable)
   - `threadPosition: text("thread_position").$type<number>()` — use integer type: position in thread (0-indexed, nullable). Actually use `import { integer } from "drizzle-orm/pg-core"` and `threadPosition: integer("thread_position")`
   - `triggerRunId: text("trigger_run_id")` — Trigger.dev run ID for cancel/reschedule (nullable)
   - `subStatus: text("sub_status")` — detailed sub-status like retry_1, rate_limited, media_uploading (nullable)
   - `failReason: text("fail_reason")` — human-readable failure reason (nullable)
   - `platformPostIds: jsonb("platform_post_ids").$type<string[]>()` — array of platform-side post IDs (for threads, each tweet ID)

2. Add `metadata` column to `oauth_tokens` table:
   - `metadata: jsonb("metadata").$type<Record<string, unknown>>()` — for refresh failure tracking, last refresh time, etc.

**Types expansion (src/core/types/index.ts):**

1. Expand `PostStatus` to include all statuses: `"draft" | "scheduled" | "publishing" | "published" | "failed" | "retry"`
2. Add `PostSubStatus` type: `"retry_1" | "retry_2" | "retry_3" | "rate_limited" | "media_uploading" | "media_uploaded" | "thread_partial" | null`
3. Add `PostMetadata` interface with optional fields: `triggerRunId`, `scheduledTimezone`, `threadTweetIds`, `failReason`, `retryCount`, `rateLimitResetAt`, `watchdogRetryAt`
4. Add `ThreadTweet` interface: `{ position: number; content: string; charCount: number; mediaIds?: string[]; platformPostId?: string; status: "pending" | "posted" | "failed" }`
5. Add `XOAuthConfig` interface: `{ clientId: string; clientSecret: string; callbackUrl: string }`
6. Export all new types.
  </action>
  <verify>Run `bun run check` (Biome + TypeScript) — no type errors, no lint violations. Verify the new columns exist by inspecting the schema file.</verify>
  <done>Posts table has parentPostId, threadPosition, triggerRunId, subStatus, failReason, platformPostIds columns. oauth_tokens has metadata column. Types file exports PostSubStatus, PostMetadata, ThreadTweet, XOAuthConfig.</done>
</task>

<task type="auto">
  <name>Task 2: Create X OAuth module and API type schemas</name>
  <files>src/platforms/x/oauth.ts, src/platforms/x/types.ts</files>
  <action>
**X OAuth module (src/platforms/x/oauth.ts):**

**Install arctic dependency first:**
Run `bun add arctic` and verify it appears in package.json dependencies.

**Create the Arctic-based OAuth 2.0 PKCE module.** Import from `arctic` package.

1. `createXOAuthClient(config: XOAuthConfig)` — returns an `Arctic.Twitter` instance: `new Twitter(config.clientId, config.clientSecret, config.callbackUrl)`
2. `generateAuthUrl(client: Twitter)` — generates state + codeVerifier using `generateState()` and `generateCodeVerifier()` from arctic, builds authorization URL with scopes: `["tweet.read", "tweet.write", "users.read", "media.write", "offline.access"]`. Returns `{ url: string; state: string; codeVerifier: string }`.
3. `exchangeCode(client: Twitter, code: string, codeVerifier: string)` — calls `client.validateAuthorizationCode(code, codeVerifier)`, returns `{ accessToken: string; refreshToken: string; expiresAt: Date }`. Extract using `tokens.accessToken()`, `tokens.refreshToken()`, `tokens.accessTokenExpiresAt()`.
4. `refreshAccessToken(client: Twitter, refreshToken: string)` — calls `client.refreshAccessToken(refreshToken)`, returns same shape. CRITICAL: X refresh tokens are ONE-TIME USE — caller must store the new refresh token.

Each function should have JSDoc comments. Export all functions. Do NOT catch errors — let callers handle.

**X API types (src/platforms/x/types.ts):**

Define Zod schemas and TypeScript types for X API interactions:

1. `TweetCreateSchema` — Zod schema for POST /2/tweets request body: `{ text: string, reply?: { in_reply_to_tweet_id: string }, media?: { media_ids: string[] } }`
2. `TweetResponseSchema` — Zod schema for tweet response: `{ data: { id: string, text: string } }`
3. `MediaUploadResponseSchema` — Zod schema: `{ media_id: string, media_key: string }`
4. `RateLimitInfo` interface: `{ limit: number; remaining: number; resetAt: Date }`
5. `XApiError` class extending Error: constructor takes `statusCode: number, message: string, rateLimit?: RateLimitInfo`. Has `isRateLimit` getter returning `this.statusCode === 429`.
6. `RateLimitError` class extending XApiError: constructor takes `rateLimit: RateLimitInfo`, calls super with 429.
7. Export all schemas, types, and error classes.
  </action>
  <verify>Run `bun run check` — no type errors. Verify `arctic` is listed in package.json dependencies. Verify arctic imports resolve.</verify>
  <done>src/platforms/x/oauth.ts exports createXOAuthClient, generateAuthUrl, exchangeCode, refreshAccessToken using Arctic Twitter provider. src/platforms/x/types.ts exports Zod schemas for tweet creation/response, media upload, and typed error classes with rate limit awareness.</done>
</task>

<task type="auto">
  <name>Task 3: Integrate X OAuth into /psn:setup flow</name>
  <files>src/cli/setup-x-oauth.ts, src/cli/setup.ts</files>
  <action>
**X OAuth setup step (src/cli/setup-x-oauth.ts):**

Create a new setup step following the existing pattern (see setup-db.ts, setup-keys.ts). The function returns `SetupResult`.

`setupXOAuth(configDir: string)`:
1. Load hub.env to get encryption key (via `loadHubEnv`)
2. Load keys.env to check for X_CLIENT_ID and X_CLIENT_SECRET
3. If X credentials not found: return `{ step: "x-oauth", status: "need_input", message: "X Developer Portal credentials needed", data: { instructions: "..." } }` with step-by-step instructions for creating an X Developer Portal app (per user decision: guide through app creation)
4. If X credentials found: create Arctic Twitter client with callback URL `https://example.com/callback`
5. Check if existing valid token exists in DB (query oauth_tokens for platform='x'). If token exists and not expired, decrypt and return `{ step: "x-oauth", status: "skipped", message: "X OAuth token is still valid" }` (per user decision: skip if valid)
6. If no valid token: generate auth URL, return `{ step: "x-oauth", status: "need_input", message: "X authorization required", data: { authUrl: "...", state: "...", codeVerifier: "...", instructions: "Open the URL above in your browser, authorize the app, then paste the authorization code from the redirect page" } }`
7. Add a second function `completeXOAuth(configDir: string, code: string, state: string, codeVerifier: string)` that:
   - Creates the Arctic client
   - Calls exchangeCode
   - Encrypts both tokens using crypto.ts encrypt()
   - Stores in oauth_tokens table (upsert — update if platform='x' row exists for user)
   - Returns `{ step: "x-oauth", status: "success", message: "X OAuth configured — token expires in 2 hours, auto-refresh handles renewal" }`

**Setup integration (src/cli/setup.ts):**

Add X OAuth as Step 5 (before validation, after Trigger.dev setup). Per user decision: OAuth is a step within /psn:setup, not a separate command.

1. Import `setupXOAuth` from `./setup-x-oauth.ts`
2. After the Trigger.dev step and before validation, call `setupXOAuth(configDir)`
3. If it returns `need_input`, include in steps and return `completed: false` (Claude will handle prompting user)
4. If it returns `skipped` or `success`, add to steps and continue to validation
  </action>
  <verify>Run `bun run check` — no type errors. Verify setup.ts imports and calls setupXOAuth. Verify setup-x-oauth.ts exports both setupXOAuth and completeXOAuth.</verify>
  <done>Setup flow includes X OAuth as a step. First run: guides user through X Developer Portal app creation, then OAuth authorization. Re-run: checks existing token validity, skips if still valid. Tokens stored encrypted in DB.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 4: Verify schema, OAuth, and setup integration</name>
  <files>src/core/db/schema.ts, src/platforms/x/oauth.ts, src/platforms/x/types.ts, src/cli/setup.ts</files>
  <action>Human verifies the automated work from Tasks 1-3.</action>
  <verify>
    1. Run `bun run check` — should pass with no errors
    2. Inspect src/core/db/schema.ts — posts table should have parentPostId, threadPosition, triggerRunId, subStatus, failReason, platformPostIds columns
    3. Inspect src/platforms/x/oauth.ts — should export createXOAuthClient, generateAuthUrl, exchangeCode, refreshAccessToken
    4. Inspect src/platforms/x/types.ts — should export TweetCreateSchema, TweetResponseSchema, XApiError, RateLimitError
    5. Inspect src/cli/setup.ts — should include X OAuth step between Trigger.dev and validation
  </verify>
  <done>All schema, OAuth, types, and setup integration verified by human.</done>
</task>

</tasks>

<verification>
- `bun run check` passes (TypeScript + Biome)
- Schema file has all new columns on posts table and metadata on oauth_tokens
- Types file exports PostSubStatus, PostMetadata, ThreadTweet, XOAuthConfig
- OAuth module uses Arctic Twitter provider with PKCE scopes including media.write
- Setup flow calls setupXOAuth between Trigger.dev and validation steps
- X OAuth setup returns need_input for both missing credentials and authorization
</verification>

<success_criteria>
- DB schema ready for thread tracking and token metadata
- X OAuth module functional with Arctic v3
- Setup flow guides user through X Developer Portal + OAuth
- All new code passes type checking and linting
</success_criteria>

<output>
After completion, create `.planning/phases/02-x-platform-pipeline/02-01-SUMMARY.md`
</output>
