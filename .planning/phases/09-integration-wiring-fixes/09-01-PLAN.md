---
phase: 09-integration-wiring-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/trigger/publish-post.ts
  - src/trigger/token-refresher.ts
  - src/trigger/engagement-monitor.ts
  - src/approval/workflow.ts
autonomous: true
requirements:
  - NOTIF-01
  - NOTIF-02
  - NOTIF-03
  - NOTIF-04
  - NOTIF-05
  - NOTIF-06
  - NOTIF-07
  - NOTIF-08
  - TEAM-05
  - AUTH-07
  - ENGAGE-03
  - TEAM-07

must_haves:
  truths:
    - "Publish-post failure triggers notificationDispatcherTask with event type post.failed"
    - "Token refresher failure triggers notificationDispatcherTask with event type token.expiring"
    - "Approval workflow submit/approve/reject each trigger notificationDispatcherTask with approval.requested or approval.result"
    - "Engagement monitor triggers notificationDispatcherTask for score 70+ opportunities instead of raw notification_log INSERT"
    - "Team member disconnect still works via removeHubConnection (already wired, verified)"
  artifacts:
    - path: "src/trigger/publish-post.ts"
      provides: "Notification dispatch on post failure"
      contains: "notificationDispatcherTask.trigger"
    - path: "src/trigger/token-refresher.ts"
      provides: "Notification dispatch on token refresh failure"
      contains: "notificationDispatcherTask.trigger"
    - path: "src/trigger/engagement-monitor.ts"
      provides: "Notification dispatch for high-score engagement opportunities"
      contains: "notificationDispatcherTask.trigger"
    - path: "src/approval/workflow.ts"
      provides: "Notification dispatch on approval events"
      contains: "notificationDispatcherTask.trigger"
  key_links:
    - from: "src/trigger/publish-post.ts"
      to: "src/trigger/notification-dispatcher.ts"
      via: "import + .trigger() call"
      pattern: "notificationDispatcherTask\\.trigger.*post\\.failed"
    - from: "src/trigger/token-refresher.ts"
      to: "src/trigger/notification-dispatcher.ts"
      via: "import + .trigger() call"
      pattern: "notificationDispatcherTask\\.trigger.*token\\.expiring"
    - from: "src/trigger/engagement-monitor.ts"
      to: "src/trigger/notification-dispatcher.ts"
      via: "import + .trigger() call replacing raw INSERT"
      pattern: "notificationDispatcherTask\\.trigger.*post\\.viral"
    - from: "src/approval/workflow.ts"
      to: "src/trigger/notification-dispatcher.ts"
      via: "import + .trigger() call"
      pattern: "notificationDispatcherTask\\.trigger.*approval"
---

<objective>
Wire notificationDispatcherTask into all callers that should trigger notifications: publish-post failure, token-refresher failure, approval workflow events, and engagement monitor high-score opportunities.

Purpose: All notification events fire through the dispatcher pipeline (with fatigue prevention, quiet hours, provider abstraction) instead of being silently dropped or written directly to notification_log.

Output: Four modified files with notificationDispatcherTask.trigger() calls at the correct integration points.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-integration-wiring-fixes/09-RESEARCH.md
@src/trigger/notification-dispatcher.ts
@src/notifications/types.ts
@src/trigger/publish-post.ts
@src/trigger/token-refresher.ts
@src/trigger/engagement-monitor.ts
@src/approval/workflow.ts
@src/trigger/watchdog.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire notification dispatcher into publish-post, token-refresher, and approval workflow</name>
  <files>
    src/trigger/publish-post.ts
    src/trigger/token-refresher.ts
    src/approval/workflow.ts
  </files>
  <action>
    In each of these three files, add the import and fire-and-forget trigger call:

    **publish-post.ts:**
    - Add import: `import { notificationDispatcherTask } from "./notification-dispatcher.ts";`
    - After the "all platforms failed" error path (where `markFailed` is called), add a try/catch block that triggers `notificationDispatcherTask.trigger()` with `eventType: "post.failed"`, `userId` from the post record, `hubId` from post metadata, and payload containing `postId`, `platform`, `error`, and `title` (first 60 chars of content).
    - Use the exact pattern from `src/trigger/watchdog.ts` for the `.trigger()` call pattern.
    - Wrap in try/catch with `logger.warn` on failure (notification failure must never crash the publish task).

    **token-refresher.ts:**
    - Add import: `import { notificationDispatcherTask } from "./notification-dispatcher.ts";`
    - In the error handler where `requiresReauth` is set to true in metadata, add a try/catch block that triggers `notificationDispatcherTask.trigger()` with `eventType: "token.expiring"`, `userId` from the token record, and payload containing `platform`, `tokenId`, and error message.
    - Use `token.expiring` event type per research recommendation (message formatting already says "Re-authenticate to keep posting").

    **workflow.ts:**
    - Add import: `import { notificationDispatcherTask } from "../trigger/notification-dispatcher.ts";`
    - After each state transition (submitForApproval, approvePost, rejectPost), add a try/catch block that triggers `notificationDispatcherTask.trigger()`:
      - Submit: `eventType: "approval.requested"`, `userId` (submitter), `hubId`, payload with `postId` and `title`
      - Approve: `eventType: "approval.result"`, `userId` (author), `hubId`, payload with `postId`, `result: "approved"`, `approvedBy`
      - Reject: `eventType: "approval.result"`, `userId` (author), `hubId`, payload with `postId`, `result: "rejected"`, `rejectedBy`, `reason`
    - Each trigger wrapped in its own try/catch with logger.warn (approval flow must never fail due to notification issues).

    **CRITICAL:** All `.trigger()` calls are fire-and-forget (await the trigger API call but don't await task completion). Notification failure must NEVER roll back or crash the calling function.

    **TEAM-07 verification:** Confirm `src/cli/setup-disconnect.ts` calls `removeHubConnection()` from `src/team/hub.ts`. This is already wired -- no code change needed, just verify and note in summary.
  </action>
  <verify>
    Run `bun run check` (or `bunx tsc --noEmit`) to verify no TypeScript errors.
    Grep for `notificationDispatcherTask.trigger` in all three files to confirm the wiring exists.
    Grep for `removeHubConnection` in `src/cli/setup-disconnect.ts` to confirm TEAM-07 is wired.
  </verify>
  <done>
    publish-post.ts triggers notification on post failure.
    token-refresher.ts triggers notification on refresh failure.
    workflow.ts triggers notification on submit, approve, and reject.
    All trigger calls wrapped in try/catch with logger.warn.
    TEAM-07 verified as already wired.
  </done>
</task>

<task type="auto">
  <name>Task 2: Wire engagement monitor to notification dispatcher for 70+ scores</name>
  <files>
    src/trigger/engagement-monitor.ts
  </files>
  <action>
    In `src/trigger/engagement-monitor.ts`:

    - Add import: `import { notificationDispatcherTask } from "./notification-dispatcher.ts";`
    - Find the block that handles high-score opportunities (score 70+) where it currently does a raw INSERT into `notification_log`.
    - Replace the raw INSERT for high-score items with a loop that calls `notificationDispatcherTask.trigger()` for each high-score opportunity:
      - `eventType: "post.viral"` (maps to Tier 1 push in NOTIFICATION_ROUTES)
      - `userId` from the monitoring context
      - Payload: `postId` (external post ID), `platform`, `score` (composite), `authorHandle`, `postSnippet` (first 100 chars)
    - Keep the medium-score (60-69) notification_log INSERT intact -- digest compilation reads from notification_log, and the dispatcher also writes there, so medium-score items should continue their current flow.
    - Wrap each trigger in try/catch with logger.warn (monitor must continue processing remaining opportunities even if one notification fails).

    **Per research open question #1:** Remove the raw INSERT for high-score only (the dispatcher itself writes to notification_log, so keeping both would create duplicates). Keep medium-score INSERT as-is.
  </action>
  <verify>
    Run `bun run check` (or `bunx tsc --noEmit`) to verify no TypeScript errors.
    Grep for `notificationDispatcherTask.trigger` in engagement-monitor.ts.
    Verify the medium-score notification_log INSERT is still present (not accidentally removed).
  </verify>
  <done>
    Engagement monitor triggers notificationDispatcherTask for 70+ score opportunities with event type "post.viral".
    Medium-score (60-69) items still write to notification_log for digest compilation.
    Raw high-score INSERT replaced (no duplicate entries).
  </done>
</task>

</tasks>

<verification>
1. `bun run check` passes with no TypeScript errors across all modified files
2. `grep -r "notificationDispatcherTask.trigger" src/trigger/publish-post.ts src/trigger/token-refresher.ts src/trigger/engagement-monitor.ts src/approval/workflow.ts` shows triggers in all four files
3. `grep -r "removeHubConnection" src/cli/setup-disconnect.ts` confirms TEAM-07 wiring
4. No circular imports introduced (notification-dispatcher.ts does not import from publish-post, token-refresher, engagement-monitor, or workflow)
</verification>

<success_criteria>
- notificationDispatcherTask.trigger() called in publish-post.ts on failure path
- notificationDispatcherTask.trigger() called in token-refresher.ts on refresh failure
- notificationDispatcherTask.trigger() called in workflow.ts on submit, approve, reject
- notificationDispatcherTask.trigger() called in engagement-monitor.ts for 70+ scores (replacing raw INSERT)
- All trigger calls wrapped in try/catch (never crash caller)
- TEAM-07 verified as already wired
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/09-integration-wiring-fixes/09-01-SUMMARY.md`
</output>
