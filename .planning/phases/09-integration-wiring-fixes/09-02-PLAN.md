---
phase: 09-integration-wiring-fixes
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/content/generate.ts
  - src/cli/plan.ts
autonomous: true
requirements:
  - POST-11
  - TEAM-08
  - LEARN-07

must_haves:
  truths:
    - "checkIdeaBank() in generate.ts receives db and userId so ready ideas surface during /psn:post"
    - "calendarCommand() in plan.ts calls getUnifiedCalendar with hub discovery so company posts are visible"
    - "generate.ts checks lockedSettings from locks.ts before applying preference model adjustments"
  artifacts:
    - path: "src/content/generate.ts"
      provides: "Idea bank integration and locked settings enforcement"
      contains: "checkIdeaBank(db, "
    - path: "src/content/generate.ts"
      provides: "Locked settings check before preference application"
      contains: "isSettingLocked"
    - path: "src/cli/plan.ts"
      provides: "Unified calendar with multi-hub support"
      contains: "getUnifiedCalendar"
  key_links:
    - from: "src/content/generate.ts"
      to: "src/content/topic-suggest.ts"
      via: "checkIdeaBank(db, userId) call with DB connection"
      pattern: "checkIdeaBank\\(db"
    - from: "src/content/generate.ts"
      to: "src/learning/locks.ts"
      via: "getLockedSettings + isSettingLocked import"
      pattern: "isSettingLocked\\(lockedSettings"
    - from: "src/cli/plan.ts"
      to: "src/approval/calendar.ts"
      via: "getUnifiedCalendar import replacing getCalendarState"
      pattern: "getUnifiedCalendar"
    - from: "src/cli/plan.ts"
      to: "src/team/hub.ts"
      via: "discoverCompanyHubs + getHubDb for multi-hub calendar"
      pattern: "discoverCompanyHubs"
---

<objective>
Fix three content flow integration gaps: pass db+userId to checkIdeaBank in generate.ts, switch calendarCommand to use getUnifiedCalendar with hub discovery, and add locked settings checks before applying preference model adjustments.

Purpose: Ready ideas from the idea bank surface during `/psn:post`, `/psn:calendar` shows company hub posts, and user overrides are permanently respected by the content generator.

Output: Two modified files with correct function arguments and import wiring.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-integration-wiring-fixes/09-RESEARCH.md
@src/content/generate.ts
@src/content/topic-suggest.ts
@src/cli/plan.ts
@src/approval/calendar.ts
@src/team/hub.ts
@src/learning/locks.ts
@src/learning/adjustments.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix checkIdeaBank arguments and add locked settings checks in generate.ts</name>
  <files>
    src/content/generate.ts
  </files>
  <action>
    **Fix 1: checkIdeaBank arguments (POST-11)**
    - Find the `checkIdeaBank()` call (line ~370 per research).
    - The function signature is `checkIdeaBank(db?: HubDb, userId?: string)` -- it's already backward-compatible.
    - Create a DB connection from `options.databaseUrl` if available: `const db = options.databaseUrl ? createHubConnection(options.databaseUrl) : undefined;`
    - If `createHubConnection` is not already imported, add the import from the connection factory module.
    - Pass both arguments: `checkIdeaBank(db, options.userId)`.
    - This is a 3-line change. The function already returns empty results when no DB is provided, so no behavior change for users without DB.

    **Fix 2: Locked settings checks (LEARN-07)**
    - Add imports: `import { getLockedSettings, isSettingLocked } from "../learning/locks.ts";`
    - After fetching preference model learnings (earlyLearnings), add a block to load locked settings:
      ```
      let lockedSettings = null;
      if (options.databaseUrl && options.userId) {
        try {
          const lockDb = createHubConnection(options.databaseUrl);
          lockedSettings = await getLockedSettings(lockDb, options.userId);
        } catch { /* graceful fallback */ }
      }
      ```
    - When applying earlyLearnings to content generation, filter out locked fields:
      - If `isSettingLocked(lockedSettings, "hooks")` is true, skip hook pattern suggestions
      - If `isSettingLocked(lockedSettings, "formats.preferences")` is true, skip format suggestions
      - Fatigue topics are never locked (always apply)
    - Reference `src/learning/adjustments.ts` for the existing `isSettingLocked` usage pattern (line ~100).
    - Wrap the locked settings fetch in try/catch -- if DB is unavailable, all learnings apply normally (graceful degradation).

    **CRITICAL:** Do NOT create a new DB connection if one already exists in scope. Reuse the `db` variable created for checkIdeaBank if available.
  </action>
  <verify>
    Run `bun run check` (or `bunx tsc --noEmit`) to verify no TypeScript errors.
    Grep for `checkIdeaBank(db` in generate.ts to confirm arguments are passed.
    Grep for `isSettingLocked` in generate.ts to confirm lock checks exist.
  </verify>
  <done>
    checkIdeaBank receives db and userId from generate.ts options.
    Locked settings are loaded and checked before applying preference model learnings.
    Both changes have graceful fallback when DB is unavailable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Switch calendarCommand to use getUnifiedCalendar with hub discovery</name>
  <files>
    src/cli/plan.ts
  </files>
  <action>
    **Fix: Unified calendar (TEAM-08)**
    - In `src/cli/plan.ts`, find `calendarCommand()` (line ~41 per research).
    - Replace the import of `getCalendarState` with `getUnifiedCalendar` from `../approval/calendar.ts`.
    - Add imports for `discoverCompanyHubs` and `getHubDb` from `../team/hub.ts`.
    - Rewrite calendarCommand internals:
      1. Get the personal DB connection (existing pattern in the file)
      2. Call `discoverCompanyHubs()` to find all connected company hubs
      3. Map company hubs to `{ connection, db: getHubDb(connection) }` objects
      4. Call `getUnifiedCalendar({ personalDb, companyHubs: companyHubDbs, userId: "default", startDate: weekStart, endDate: weekEnd })`
      5. Return the unified calendar result
    - The `getUnifiedCalendar` return type is `UnifiedCalendar` (not `CalendarState`). Check if any callers of `calendarCommand()` depend on the `CalendarState` shape and update them.
    - Per research: `slotCommand()` and `languagesCommand()` call `getCalendarState()` directly (not via `calendarCommand()`), so they are unaffected.
    - Keep the zero-argument interface for `calendarCommand()` -- all parameters loaded internally.
    - Wrap hub discovery in try/catch -- if company hub discovery fails, fall back to personal-only calendar (pass empty array for companyHubs).

    **Per research open question #2:** Check all callers of calendarCommand() in the file and in slash command definitions to ensure they handle the new return type.
  </action>
  <verify>
    Run `bun run check` (or `bunx tsc --noEmit`) to verify no TypeScript errors.
    Grep for `getUnifiedCalendar` in plan.ts to confirm the import swap.
    Grep for `discoverCompanyHubs` in plan.ts to confirm hub discovery is wired.
    Grep for `getCalendarState` in plan.ts to confirm old call is removed from calendarCommand (may still exist in other functions).
  </verify>
  <done>
    calendarCommand() calls getUnifiedCalendar with hub discovery.
    Company hub posts are visible during weekly planning via /psn:calendar.
    Graceful fallback to personal-only if hub discovery fails.
    No breaking changes to other functions in plan.ts.
  </done>
</task>

</tasks>

<verification>
1. `bun run check` passes with no TypeScript errors
2. `grep -n "checkIdeaBank(db" src/content/generate.ts` shows db argument passed
3. `grep -n "isSettingLocked" src/content/generate.ts` shows lock checks
4. `grep -n "getUnifiedCalendar" src/cli/plan.ts` shows unified calendar call
5. `grep -n "discoverCompanyHubs" src/cli/plan.ts` shows hub discovery
</verification>

<success_criteria>
- checkIdeaBank() receives db and userId in generate.ts
- generate.ts checks lockedSettings before applying preference model adjustments
- calendarCommand() uses getUnifiedCalendar with hub discovery
- All changes have graceful fallback (try/catch, optional parameters)
- TypeScript compilation succeeds
</success_criteria>

<output>
After completion, create `.planning/phases/09-integration-wiring-fixes/09-02-SUMMARY.md`
</output>
