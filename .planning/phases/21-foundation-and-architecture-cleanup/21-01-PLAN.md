---
phase: 21-foundation-and-architecture-cleanup
plan: 01
type: execute
wave: 0
depends_on: []
files_modified: []
autonomous: true
requirements: [ARCH-01, ARCH-03, TOOL-01, TOOL-02]
user_setup: []
must_haves:
  truths:
    - "PlatformPublisher interface defines publish contract with clear behavioral specifications"
    - "Handler factory creates correct platform handlers based on platform enum"
    - "TypeScript configured with noUnusedLocals: false (as per roadmap)"
    - "Circular dependency detection configured"
    - "Test infrastructure in place for critical components"
  artifacts:
    - path: "src/core/types/publisher.ts"
      provides: "PlatformPublisher interface definition"
      min_lines: 50
    - path: "src/core/utils/publisher-factory.ts"
      provides: "Handler factory for platform selection"
      min_lines: 30
    - path: "src/core/types/publisher.test.ts"
      provides: "Interface compliance tests"
      min_lines: 20
    - path: "src/core/utils/publisher-factory.test.ts"
      provides: "Factory functionality tests"
      min_lines: 20
    - path: "tsconfig.json"
      provides: "TypeScript configuration with noUnusedLocals: false"
      contains: "noUnusedLocals: false"
    - path: "package.json"
      provides: "Madge dependency for circular dependency detection"
      contains: "madge"
  key_links:
    - from: "src/core/types/publisher.ts"
      to: "src/core/types/publisher.test.ts"
      via: "interface compliance testing"
      pattern: "PlatformPublisher"
    - from: "src/core/utils/publisher-factory.ts"
      to: "src/core/types/publisher.ts"
      via: "import PlatformPublisher"
      pattern: "PlatformPublisher"
    - from: "tsconfig.json"
      to: "src/**/*.ts"
      via: "TypeScript compilation"
      pattern: "noUnusedLocals"
---
<objective>
Create PlatformPublisher interface and handler factory with test infrastructure

Purpose: Define interface contracts and factory pattern for platform handlers with proper testing
Output: PlatformPublisher interface, handler factory, and test infrastructure
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/21-foundation-and-architecture-cleanup/21-RESEARCH.md
@src/core/types/index.ts
@tsconfig.json
@package.json
</context>

<interfaces>
<!-- Key types from existing codebase -->

From src/core/types/index.ts:
```typescript
export type Platform = "x" | "linkedin" | "instagram" | "tiktok";
export interface PlatformPublishResult {
  platform: Platform;
  status: "published" | "failed" | "skipped";
  externalPostId?: string;
  error?: string;
}
export interface PostMetadata {
  triggerRunId?: string;
  scheduledTimezone?: string;
  threadTweetIds?: string[];
  failReason?: string;
  retryCount?: number;
  rateLimitResetAt?: string;
  watchdogRetryAt?: string;
  platformStatus?: Record<string, PlatformStatus>;
  multiPlatformGroupId?: string;
  linkedinFormat?: string;
  format?: string;
  topic?: string;
  pillar?: string;
}
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Create PlatformPublisher interface and extract behavioral contracts</name>
  <files>src/core/types/publisher.ts</files>
  <action>
    Create the PlatformPublisher interface that defines the core contract for all platform handlers. The interface should include:
    - publish() method with database connection, post data, encryption key, and metadata
    - validateCredentials() method for authentication
    - getRateLimitInfo() method for rate limiting
    - refreshCredentials() method for token refresh
    - isRateLimited() method for rate limit checking
    - getRetryAfter() method for retry timing

    Include JSDoc comments with behavioral contracts documenting preconditions, postconditions, and error handling expectations. This interface will be the foundation for all platform handlers.
  </action>
  <verify>File exists with properly defined interface, all methods have JSDoc behavioral contracts</verify>
  <done>PlatformPublisher interface defines clear contracts with behavioral documentation</done>
</task>

<task type="auto">
  <name>Task 2: Create handler factory for platform selection</name>
  <files>src/core/utils/publisher-factory.ts</files>
  <action>
    Implement the handler factory pattern that maps platform enum values to handler implementations. Create:
    - Type alias for handler constructors
    - Registry object mapping platforms to handler classes
    - Factory function that instantiates handlers with proper dependency injection
    - Error handling for invalid platform requests

    The factory should support all platforms: "x", "linkedin", "instagram", "tiktok" and return handlers that implement PlatformPublisher interface.
  </action>
  <verify>Factory can create handlers for all platforms, type-safe interface compliance</verify>
  <done>Handler factory creates correct platform handlers with dependency injection</done>
</task>

<task type="auto">
  <name>Task 3: Create test infrastructure for PlatformPublisher interface</name>
  <files>src/core/types/publisher.test.ts</files>
  <action>
    Create test infrastructure for the PlatformPublisher interface:
    - Test mock implementation that validates interface compliance
    - Test cases for all interface methods with various scenarios
    - Test behavioral contracts and error handling expectations
    - Test parameter validation and return type compliance

    Use Jest or similar testing framework to ensure interface contracts are properly enforced.
  </action>
  <verify>Test file exists with comprehensive interface compliance tests</verify>
  <done>PlatformPublisher interface test infrastructure in place</done>
</task>

<task type="auto">
  <name>Task 4: Create test infrastructure for handler factory</name>
  <files>src/core/utils/publisher-factory.test.ts</files>
  <action>
    Create test infrastructure for the handler factory:
    - Test cases for all platform handler creation
    - Test error handling for invalid platform requests
    - Test dependency injection patterns
    - Test handler registration and lookup

    Ensure the factory properly creates handlers for all supported platforms.
  </action>
  <verify>Test file exists with comprehensive factory functionality tests</verify>
  <done>Handler factory test infrastructure in place</done>
</task>

<task type="auto">
  <name>Task 5: Configure TypeScript with noUnusedLocals: false</name>
  <files>tsconfig.json</files>
  <action>
    Update TypeScript configuration to enable AI-friendly settings as specified in roadmap success criteria:
    - Set noUnusedLocals: false to allow for exploration and development
    - Keep other TypeScript settings appropriate for the project
    - Ensure the configuration allows for unused locals during development

    This change aligns with the roadmap requirement for AI-friendly TypeScript configuration.
  </action>
  <verify>TypeScript configuration updated with noUnusedLocals: false</verify>
  <done>TypeScript configured with noUnusedLocals: false per roadmap requirements</done>
</task>

<task type="auto">
  <name>Task 6: Install circular dependency checker</name>
  <files>package.json, .gitignore</files>
  <action>
    Install madge as a development dependency for circular dependency detection:
    - Run npm install -g madge to install globally
    - Update package.json to include madge as dev dependency
    - Add .gitignore entry for madge output files

    This sets up circular dependency detection for the architecture.
  </action>
  <verify>Madge installed and configured, .gitignore updated</verify>
  <done>Madge configured for circular dependency detection</done>
</task>

</tasks>

<verification>
Validate the infrastructure setup by running:
- `madge --circular src/` to check for circular dependencies
- `npm run typecheck` to ensure TypeScript compilation passes with noUnusedLocals: false
- Review that interface definitions are complete and test infrastructure is in place
</verification>

<success_criteria>
Infrastructure complete when:
1. PlatformPublisher interface defines clear behavioral contracts
2. Handler factory creates correct platform handlers
3. TypeScript configured with noUnusedLocals: false as per roadmap
4. Circular dependency detection configured
5. Test infrastructure in place for critical components
</success_criteria>

<output>
After completion, create `.planning/phases/21-foundation-and-architecture-cleanup/{21-01}-SUMMARY.md`
</output>