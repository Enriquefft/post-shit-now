---
phase: 21-foundation-and-architecture-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: []
autonomous: true
requirements: [ARCH-01, ARCH-02, ARCH-03, ARCH-04, TOOL-01, TOOL-02, TOOL-03]
user_setup: []
must_haves:
  truths:
    - "PlatformPublisher interface defines publish contract with clear behavioral specifications"
    - "publish-post.ts refactored to under 200 lines as pure orchestration layer"
    - "Each platform handler (x, linkedin, instagram, tiktok) implements interface and stays under 200 lines"
    - "Handler factory creates correct platform handlers based on platform enum"
    - "Platform clients wrapped with interface pattern for consistent behavior"
    - "TypeScript strict mode enabled with noUnusedLocals and noUnusedParameters"
    - "Circular dependencies detected and prevented automatically"
    - "File size limits enforced with Biome configuration"
  artifacts:
    - path: "src/core/types/publisher.ts"
      provides: "PlatformPublisher interface definition"
      min_lines: 50
    - path: "src/core/utils/publisher-factory.ts"
      provides: "Handler factory for platform selection"
      min_lines: 30
    - path: "src/trigger/publish-post.ts"
      provides: "Orchestration layer (under 200 lines)"
      max_lines: 200
    - path: "src/platforms/handlers/x.handler.ts"
      provides: "X platform handler implementation"
      max_lines: 200
    - path: "src/platforms/handlers/linkedin.handler.ts"
      provides: "LinkedIn platform handler implementation"
      max_lines: 200
    - path: "src/platforms/handlers/instagram.handler.ts"
      provides: "Instagram platform handler implementation"
      max_lines: 200
    - path: "src/platforms/handlers/tiktok.handler.ts"
      provides: "TikTok platform handler implementation"
      max_lines: 200
    - path: "src/platforms/handlers/index.ts"
      provides: "Handler barrel exports"
      min_lines: 10
    - path: "src/platforms/x/client-wrapper.ts"
      provides: "X client wrapped with interface pattern"
      max_lines: 100
    - path: "src/platforms/linkedin/client-wrapper.ts"
      provides: "LinkedIn client wrapped with interface pattern"
      max_lines: 100
    - path: "tsconfig.json"
      provides: "TypeScript configuration with strict options"
      contains: "noUnusedLocals: true"
    - path: "biome.json"
      provides: "Biome configuration with file size limits"
      contains: "maxSize"
    - path: "package.json"
      provides: "Dependencies for madge circular dependency checker"
      contains: "madge"
  key_links:
    - from: "src/trigger/publish-post.ts"
      to: "src/core/types/publisher.ts"
      via: "implements PlatformPublisher"
      pattern: "PlatformPublisher"
    - from: "src/core/utils/publisher-factory.ts"
      to: "src/platforms/handlers/index.ts"
      via: "import handler classes"
      pattern: "handlerRegistry"
    - from: "src/platforms/handlers/x.handler.ts"
      to: "src/platforms/x/client-wrapper.ts"
      via: "dependency injection"
      pattern: "new XClientWrapper"
    - from: "tsconfig.json"
      to: "src/**/*.ts"
      via: "TypeScript compilation"
      pattern: "noUnusedLocals"
    - from: "biome.json"
      to: "src/platforms/handlers/"
      via: "file size enforcement"
      pattern: "maxSize"
---

<objective>
Create PlatformPublisher interface and refactor publish-post.ts into interface-based platform handlers

Purpose: Transform monolithic 1,238-line publish-post.ts into AI-friendly, testable architecture with clear contracts and strict file size limits
Output: PlatformPublisher interface, handler factory, platform-specific handlers, and configured tooling
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/21-foundation-and-architecture-cleanup/21-RESEARCH.md
@src/trigger/publish-post.ts
@src/core/types/index.ts
@src/platforms/x/client.ts
@tsconfig.json
@package.json
</context>

<interfaces>
<!-- Key types and contracts extracted from existing codebase -->

From src/core/types/index.ts:
```typescript
export type Platform = "x" | "linkedin" | "instagram" | "tiktok";
export interface PlatformPublishResult {
  platform: Platform;
  status: "published" | "failed" | "skipped";
  externalPostId?: string;
  error?: string;
}
export interface PostMetadata {
  triggerRunId?: string;
  scheduledTimezone?: string;
  threadTweetIds?: string[];
  failReason?: string;
  retryCount?: number;
  rateLimitResetAt?: string;
  watchdogRetryAt?: string;
  platformStatus?: Record<string, PlatformStatus>;
  multiPlatformGroupId?: string;
  linkedinFormat?: string;
  format?: string;
  topic?: string;
  pillar?: string;
}
```

From src/trigger/publish-post.ts (extracted patterns):
```typescript
import { createHubConnection } from "../core/db/connection.ts";
import type { PostRow } from "../core/db/schema.ts";
import { splitIntoThread } from "../core/utils/thread-splitter.ts";

// Core publish workflow pattern:
// 1. Validate credentials
// 2. Handle thread splitting
// 3. Upload media
// 4. Create post
// 5. Handle rate limiting and retries
// 6. Update metadata
```

From src/platforms/x/client.ts:
```typescript
export class XClient {
  private accessToken: string;
  private rateLimits: Map<string, RateLimitInfo> = new Map();

  constructor(accessToken: string) {
    this.accessToken = accessToken;
  }

  async createTweet(params: { text: string; replyToId?: string; mediaIds?: string[] }): Promise<{ id: string; text: string; rateLimit: RateLimitInfo }>;
  async postThread(tweets: string[], mediaIdsPerTweet?: (string[] | undefined)[]): Promise<{ tweetIds: string[]; rateLimits: RateLimitInfo[] }>;
  // Other platform-specific methods...
}
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Create PlatformPublisher interface and extract behavioral contracts</name>
  <files>src/core/types/publisher.ts</files>
  <action>
    Create the PlatformPublisher interface that defines the core contract for all platform handlers. The interface should include:
    - publish() method with database connection, post data, encryption key, and metadata
    - validateCredentials() method for authentication
    - getRateLimitInfo() method for rate limiting
    - refreshCredentials() method for token refresh
    - isRateLimited() method for rate limit checking
    - getRetryAfter() method for retry timing

    Include JSDoc comments with behavioral contracts documenting preconditions, postconditions, and error handling expectations. This interface will be the foundation for all platform handlers.
  </action>
  <verify>File exists with properly defined interface, all methods have JSDoc behavioral contracts</verify>
  <done>PlatformPublisher interface defines clear contracts with behavioral documentation</done>
</task>

<task type="auto">
  <name>Task 2: Create handler factory for platform selection</name>
  <files>src/core/utils/publisher-factory.ts</files>
  <action>
    Implement the handler factory pattern that maps platform enum values to handler implementations. Create:
    - Type alias for handler constructors
    - Registry object mapping platforms to handler classes
    - Factory function that instantiates handlers with proper dependency injection
    - Error handling for invalid platform requests

    The factory should support all platforms: "x", "linkedin", "instagram", "tiktok" and return handlers that implement PlatformPublisher interface.
  </action>
  <verify>Factory can create handlers for all platforms, type-safe interface compliance</verify>
  <done>Handler factory creates correct platform handlers with dependency injection</done>
</task>

<task type="auto">
  <name>Task 3: Create X platform handler</name>
  <files>src/platforms/handlers/x.handler.ts</files>
  <action>
    Create the X platform handler that implements PlatformPublisher interface. This handler should:
    - Wrap XClient with PlatformPublisher interface compliance
    - Implement publish() method for thread creation and single posts
    - Implement validateCredentials() using existing X methods
    - Implement rate limiting methods using X's rate limit tracking
    - Handle media uploads using existing uploadMedia function
    - Implement thread splitting using existing splitIntoThread utility
    - Stay under 200 lines by extracting platform-specific logic

    Move platform-specific logic from publish-post.ts into this handler, maintaining all existing functionality.
  </action>
  <verify>Handler implements PlatformPublisher interface, under 200 lines, maintains X-specific functionality</verify>
  <done>X handler implements PlatformPublisher interface with X-specific logic under 200 lines</done>
</task>

<task type="auto">
  <name>Task 4: Create LinkedIn platform handler</name>
  <files>src/platforms/handlers/linkedin.handler.ts</files>
  <action>
    Create the LinkedIn platform handler that implements PlatformPublisher interface. This handler should:
    - Wrap LinkedInClient with PlatformPublisher interface compliance
    - Implement publish() method for document and image uploads
    - Implement validateCredentials() using existing LinkedIn methods
    - Handle LinkedIn-specific media upload workflow
    - Stay under 200 lines by extracting platform-specific logic

    Move LinkedIn-specific publishing logic from publish-post.ts into this handler, including document upload, image upload, and platform-specific formatting.
  </action>
  <verify>Handler implements PlatformPublisher interface, under 200 lines, maintains LinkedIn-specific functionality</verify>
  <done>LinkedIn handler implements PlatformPublisher interface with LinkedIn-specific logic under 200 lines</done>
</task>

<task type="auto">
  <name>Task 5: Create Instagram and TikTok platform handlers</name>
  <files>src/platforms/handlers/instagram.handler.ts, src/platforms/handlers/tiktok.handler.ts</files>
  <action>
    Create the Instagram and TikTok platform handlers that implement PlatformPublisher interface:

    For Instagram:
    - Wrap InstagramClient with PlatformPublisher interface
    - Implement publish() for carousel, image, and reels containers
    - Handle Instagram media upload workflow
    - Stay under 200 lines

    For TikTok:
    - Wrap TikTokClient with PlatformPublisher interface
    - Implement publish() for video and photo posts
    - Handle TikTok upload workflow
    - Stay under 200 lines

    Extract platform-specific logic from publish-post.ts into separate handlers, maintaining existing functionality.
  </action>
  <verify>Both handlers implement PlatformPublisher interface, each under 200 lines, maintain platform-specific functionality</verify>
  <done>Instagram and TikTok handlers implement PlatformPublisher interface with platform-specific logic under 200 lines each</done>
</task>

<task type="auto">
  <name>Task 6: Create handler barrel exports and refactor publish-post.ts</name>
  <files>src/platforms/handlers/index.ts, src/trigger/publish-post.ts</files>
  <action>
    First, create handler barrel exports in index.ts to export all platform handlers.

    Then, refactor publish-post.ts to use the new interface-based architecture:
    - Replace all platform-specific logic with PlatformPublisher interface usage
    - Use handler factory to create appropriate platform handlers
    - Simplify to pure orchestration (under 200 lines)
    - Handle common publish workflow: validation, threading, rate limiting, retries
    - Remove platform-specific implementation details
    - Keep only shared logic and orchestration responsibilities

    Ensure all existing functionality is preserved while achieving clean separation of concerns.
  </action>
  <verify>publish-post.ts under 200 lines, uses PlatformPublisher interface, maintains all existing functionality</verify>
  <done>publish-post.ts refactored to pure orchestration under 200 lines using interface-based handlers</done>
</task>

<task type="auto">
  <name>Task 7: Configure TypeScript strict mode and file size limits</name>
  <files>tsconfig.json, biome.json</files>
  <action>
    Update TypeScript configuration to enable strict compiler options:
    - Set noUnusedLocals: true to eliminate dead code
    - Set noUnusedParameters: true to ensure all parameters are used
    - Keep other strict settings for comprehensive type safety

    Update Biome configuration to enforce file size limits:
    - Set files.maxSize to 204800 bytes (200KB for source files)
    - Include src/**/*.{ts,js} files
    - Exclude node_modules and dist directories

    These changes maintain AI-friendly code structure while eliminating unused code.
  </action>
  <verify>TypeScript strict mode enabled, Biome file size limits configured, no unused parameters or locals</verify>
  <done>TypeScript strict mode enabled with noUnusedLocals/noUnusedParameters, Biome file size limits enforced</done>
</task>

<task type="auto">
  <name>Task 8: Install circular dependency checker and validate architecture</name>
  <files>package.json, .gitignore</files>
  <action>
    Install madge as a development dependency for circular dependency detection:
    - Run npm install -g madge to install globally
    - Update package.json to include madge as dev dependency
    - Add .gitignore entry for madge output files

    Validate the new architecture by running:
    - madge --circular src/ to check for circular dependencies
    - biome check --files-only src/ to verify file size limits
    - npm run typecheck to ensure TypeScript compilation passes

    Report any issues found during validation.
  </action>
  <verify>Madge installed and runs without circular dependencies, file size limits enforced, TypeScript compilation passes</verify>
  <done>Madge configured for circular dependency detection, architecture validated, file size limits enforced</done>
</task>

</tasks>

<verification>
Validate the entire refactoring by running:
- `madge --circular src/` — ensures no circular dependencies in new architecture
- `biome check --files-only src/platforms/handlers/` — verifies all handlers under 200 lines
- `npm run typecheck` — confirms TypeScript compilation with strict options
- Review that publish-post.ts is under 200 lines and uses only PlatformPublisher interface
</verification>

<success_criteria>
Refactoring complete when:
1. PlatformPublisher interface defines clear behavioral contracts
2. publish-post.ts refactored to under 200 lines as pure orchestration
3. Each platform handler implements interface and stays under 200 lines
4. Handler factory creates correct platform handlers
5. Platform clients wrapped with interface pattern
6. TypeScript strict mode enabled with noUnusedLocals and noUnusedParameters
7. Circular dependencies prevented by madge
8. File size limits enforced by Biome configuration
</success_criteria>

<output>
After completion, create `.planning/phases/21-foundation-and-architecture-cleanup/{21-01}-SUMMARY.md`
</output>