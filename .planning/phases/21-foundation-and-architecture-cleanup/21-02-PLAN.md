---
phase: 21-foundation-and-architecture-cleanup
plan: 02
type: execute
wave: 1
depends_on: [21-01]
files_modified: []
autonomous: true
requirements: [ARCH-02, ARCH-04, ARCH-05, TOOL-03]
user_setup: []
must_haves:
  truths:
    - "publish-post.ts refactored to under 200 lines as pure orchestration layer"
    - "Each platform handler implements PlatformPublisher interface and stays under 200 lines"
    - "Platform clients wrapped with interface pattern for consistent behavior"
    - "File size limits enforced with Biome configuration"
    - "All existing functionality preserved"
  artifacts:
    - path: "src/trigger/publish-post.ts"
      provides: "Orchestration layer (under 200 lines)"
      max_lines: 200
    - path: "src/platforms/handlers/x.handler.ts"
      provides: "X platform handler implementation"
      max_lines: 200
    - path: "src/platforms/handlers/linkedin.handler.ts"
      provides: "LinkedIn platform handler implementation"
      max_lines: 200
    - path: "src/platforms/handlers/instagram.handler.ts"
      provides: "Instagram platform handler implementation"
      max_lines: 200
    - path: "src/platforms/handlers/tiktok.handler.ts"
      provides: "TikTok platform handler implementation"
      max_lines: 200
    - path: "src/platforms/handlers/index.ts"
      provides: "Handler barrel exports"
      min_lines: 10
    - path: "src/platforms/x/client-wrapper.ts"
      provides: "X client wrapped with interface pattern"
      max_lines: 100
    - path: "src/platforms/linkedin/client-wrapper.ts"
      provides: "LinkedIn client wrapped with interface pattern"
      max_lines: 100
    - path: "biome.json"
      provides: "Biome configuration with file size limits"
      contains: "maxSize"
    - path: "src/trigger/publish-post.test.ts"
      provides: "Integration tests for refactored publish-post"
      min_lines: 20
  key_links:
    - from: "src/trigger/publish-post.ts"
      to: "src/core/types/publisher.ts"
      via: "implements PlatformPublisher"
      pattern: "PlatformPublisher"
    - from: "src/core/utils/publisher-factory.ts"
      to: "src/platforms/handlers/index.ts"
      via: "import handler classes"
      pattern: "handlerRegistry"
    - from: "src/platforms/handlers/x.handler.ts"
      to: "src/platforms/x/client-wrapper.ts"
      via: "dependency injection"
      pattern: "new XClientWrapper"
    - from: "biome.json"
      to: "src/platforms/handlers/"
      via: "file size enforcement"
      pattern: "maxSize"
---
<objective>
Create platform handlers and refactor publish-post.ts into orchestration layer

Purpose: Transform monolithic publish-post.ts into AI-friendly architecture with interface-based handlers
Output: Platform-specific handlers, refactored orchestration layer, and file size enforcement
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/21-foundation-and-architecture-cleanup/21-RESEARCH.md
@.planning/phases/21-foundation-and-architecture-cleanup/21-01-PLAN.md
@src/trigger/publish-post.ts
@src/core/types/index.ts
@src/core/types/publisher.ts
@src/core/utils/publisher-factory.ts
@src/platforms/x/client.ts
@src/platforms/linkedin/client.ts
@src/platforms/instagram/client.ts
@src/platforms/tiktok/client.ts
@tsconfig.json
@package.json
</context>

<interfaces>
<!-- Key types and contracts from existing codebase -->

From src/core/types/publisher.ts (interface contract):
```typescript
interface PlatformPublisher {
  publish(db: DatabaseConnection, postData: PostData, encryptionKey: string, metadata: PostMetadata): Promise<PlatformPublishResult>;
  validateCredentials(): Promise<boolean>;
  getRateLimitInfo(): Promise<RateLimitInfo>;
  refreshCredentials(): Promise<void>;
  isRateLimited(): Promise<boolean>;
  getRetryAfter(): Promise<number>;
}
```

From src/core/utils/publisher-factory.ts (factory pattern):
```typescript
type HandlerConstructor = new (...args: any[]) => PlatformPublisher;
const handlerRegistry: Record<Platform, HandlerConstructor> = {
  x: XHandler,
  linkedin: LinkedInHandler,
  instagram: InstagramHandler,
  tiktok: TikTokHandler,
};
```

From existing client implementations:
```typescript
// X client with rate limiting
export class XClient {
  private accessToken: string;
  private rateLimits: Map<string, RateLimitInfo> = new Map();
  // Platform-specific methods...
}

// LinkedIn client with media upload
export class LinkedInClient {
  // Platform-specific methods...
}

// Instagram client with container types
export class InstagramClient {
  // Platform-specific methods...
}

// TikTok client with video/photo upload
export class TikTokClient {
  // Platform-specific methods...
}
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Create X platform handler and client wrapper</name>
  <files>src/platforms/handlers/x.handler.ts, src/platforms/x/client-wrapper.ts</files>
  <action>
    Create the X platform handler that implements PlatformPublisher interface:
    - Create XClientWrapper that wraps XClient with interface compliance
    - Create XHandler that implements PlatformPublisher using the wrapped client
    - Implement publish() method for thread creation and single posts
    - Implement validateCredentials() using existing X methods
    - Implement rate limiting methods using X's rate limit tracking
    - Handle media uploads using existing uploadMedia function
    - Implement thread splitting using existing splitIntoThread utility
    - Stay under 200 lines by extracting platform-specific logic

    Move X-specific logic from publish-post.ts into this handler, maintaining all existing functionality.
  </action>
  <verify>X handler implements PlatformPublisher interface, under 200 lines, maintains X-specific functionality</verify>
  <done>X handler implements PlatformPublisher interface with X-specific logic under 200 lines</done>
</task>

<task type="auto">
  <name>Task 2: Create LinkedIn platform handler and client wrapper</name>
  <files>src/platforms/handlers/linkedin.handler.ts, src/platforms/linkedin/client-wrapper.ts</files>
  <action>
    Create the LinkedIn platform handler that implements PlatformPublisher interface:
    - Create LinkedInClientWrapper that wraps LinkedInClient with interface compliance
    - Create LinkedInHandler that implements PlatformPublisher using the wrapped client
    - Implement publish() method for document and image uploads
    - Implement validateCredentials() using existing LinkedIn methods
    - Handle LinkedIn-specific media upload workflow
    - Stay under 200 lines by extracting platform-specific logic

    Move LinkedIn-specific publishing logic from publish-post.ts into this handler, including document upload, image upload, and platform-specific formatting.
  </action>
  <verify>LinkedIn handler implements PlatformPublisher interface, under 200 lines, maintains LinkedIn-specific functionality</verify>
  <done>LinkedIn handler implements PlatformPublisher interface with LinkedIn-specific logic under 200 lines</done>
</task>

<task type="auto">
  <name>Task 3: Create Instagram and TikTok platform handlers</name>
  <files>src/platforms/handlers/instagram.handler.ts, src/platforms/handlers/tiktok.handler.ts</files>
  <action>
    Create the Instagram and TikTok platform handlers that implement PlatformPublisher interface:

    For Instagram:
    - Create InstagramClientWrapper that wraps InstagramClient with interface compliance
    - Create InstagramHandler that implements PlatformPublisher using the wrapped client
    - Implement publish() for carousel, image, and reels containers
    - Handle Instagram media upload workflow
    - Stay under 200 lines

    For TikTok:
    - Create TikTokClientWrapper that wraps TikTokClient with interface compliance
    - Create TikTokHandler that implements PlatformPublisher using the wrapped client
    - Implement publish() for video and photo posts
    - Handle TikTok upload workflow
    - Stay under 200 lines

    Extract platform-specific logic from publish-post.ts into separate handlers, maintaining existing functionality.
  </action>
  <verify>Both handlers implement PlatformPublisher interface, each under 200 lines, maintain platform-specific functionality</verify>
  <done>Instagram and TikTok handlers implement PlatformPublisher interface with platform-specific logic under 200 lines each</done>
</task>

<task type="auto">
  <name>Task 4: Create handler barrel exports</name>
  <files>src/platforms/handlers/index.ts</files>
  <action>
    Create handler barrel exports in index.ts to export all platform handlers:
    - Export all handler classes (XHandler, LinkedInHandler, InstagramHandler, TikTokHandler)
    - Export all client wrappers (XClientWrapper, LinkedInClientWrapper, InstagramClientWrapper, TikTokClientWrapper)
    - Include JSDoc comments explaining the export structure
    - Keep the export clean and organized for easy imports

    This makes handlers easily accessible for the factory and other components.
  </action>
  <verify>Handler barrel exports exist, clean and organized structure</verify>
  <done>Handler barrel exports created for easy imports</done>
</task>

<task type="auto">
  <name>Task 5: Refactor publish-post.ts to use interface-based architecture</name>
  <files>src/trigger/publish-post.ts</files>
  <action>
    Refactor publish-post.ts to use the new interface-based architecture:
    - Replace all platform-specific logic with PlatformPublisher interface usage
    - Use handler factory to create appropriate platform handlers
    - Simplify to pure orchestration (under 200 lines)
    - Handle common publish workflow: validation, threading, rate limiting, retries
    - Remove platform-specific implementation details
    - Keep only shared logic and orchestration responsibilities
    - Import and use publisher-factory for handler creation

    Ensure all existing functionality is preserved while achieving clean separation of concerns.
  </action>
  <verify>publish-post.ts under 200 lines, uses PlatformPublisher interface, maintains all existing functionality</verify>
  <done>publish-post.ts refactored to pure orchestration under 200 lines using interface-based handlers</done>
</task>

<task type="auto">
  <name>Task 6: Configure Biome file size limits</name>
  <files>biome.json</files>
  <action>
    Update Biome configuration to enforce file size limits:
    - Set files.maxSize to 204800 bytes (200KB for source files)
    - Include src/**/*.{ts,js} files
    - Exclude node_modules and dist directories
    - Add rule for maximum file size enforcement

    This maintains AI-friendly code structure while preventing oversized files.
  </action>
  <verify>Biome configuration with file size limits configured, src/**/*.{ts,js} included</verify>
  <done>Biome file size limits configured for AI-friendly code structure</done>
</task>

<task type="auto">
  <name>Task 7: Create integration tests for refactored publish-post</name>
  <files>src/trigger/publish-post.test.ts</files>
  <action>
    Create integration tests for the refactored publish-post.ts:
    - Test that it uses PlatformPublisher interface correctly
    - Test handler factory integration with platform handlers
    - Test orchestration layer behavior with mock handlers
    - Test error handling and edge cases
    - Verify that all existing functionality is preserved

    Use Jest or similar testing framework to ensure the refactoring maintains all expected behaviors.
  </action>
  <verify>Integration tests exist, verify refactored functionality maintains all expected behaviors</verify>
  <done>Integration tests for refactored publish-post in place</done>
</task>

<task type="auto">
  <name>Task 8: Validate architecture and enforce limits</name>
  <files>src/</files>
  <action>
    Validate the new architecture by running:
    - madge --circular src/ to check for circular dependencies
    - biome check --files-only src/ to verify file size limits
    - npm run typecheck to ensure TypeScript compilation passes
    - Run integration tests to verify functionality
    - Check that publish-post.ts is under 200 lines

    Report any issues found during validation and fix them.
  </action>
  <verify>Madge runs without circular dependencies, file size limits enforced, TypeScript compilation passes, integration tests pass</verify>
  <done>Architecture validated, file size limits enforced, all tests passing</done>
</task>

</tasks>

<verification>
Validate the entire refactoring by running:
- `madge --circular src/` — ensures no circular dependencies in new architecture
- `biome check --files-only src/platforms/handlers/` — verifies all handlers under 200 lines
- `npm run typecheck` — confirms TypeScript compilation with noUnusedLocals: false
- Review that publish-post.ts is under 200 lines and uses only PlatformPublisher interface
</verification>

<success_criteria>
Refactoring complete when:
1. publish-post.ts refactored to under 200 lines as pure orchestration
2. Each platform handler implements PlatformPublisher interface and stays under 200 lines
3. Platform clients wrapped with interface pattern for consistent behavior
4. File size limits enforced with Biome configuration
5. All existing functionality preserved
</success_criteria>

<output>
After completion, create `.planning/phases/21-foundation-and-architecture-cleanup/{21-02}-SUMMARY.md`
</output>