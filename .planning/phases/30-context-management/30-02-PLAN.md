---
phase: 30-context-management
plan: 02
type: execute
wave: 2
depends_on: ["30-01"]
files_modified:
  - lefthook.yml
  - tsconfig.json
  - package.json
  - CLAUDE.md
autonomous: true
requirements:
  - CTX-01
  - CTX-02
  - CTX-03
  - CTX-04
must_haves:
  truths:
    - "git commit with a staged src/*.ts file triggers biome, typecheck, and madge hooks in parallel"
    - "biome auto-fixes are automatically re-staged by lefthook stage_fixed"
    - "typecheck uses --incremental flag for cached builds under 3.5 seconds"
    - "circular dependency check uses --extensions ts and scans src/"
    - "hooks only trigger when src/ files are staged (planning docs, configs, markdown excluded)"
    - "CLAUDE.md contains a State Consolidation section with a checklist"
    - "bun install runs lefthook install automatically via prepare script"
  artifacts:
    - path: "lefthook.yml"
      provides: "Pre-commit hook configuration with 3 parallel jobs"
      contains: "parallel: true"
    - path: "CLAUDE.md"
      provides: "State Consolidation checklist section"
      contains: "State Consolidation"
    - path: "tsconfig.json"
      provides: "Incremental TypeScript compilation"
      contains: "incremental"
    - path: "package.json"
      provides: "prepare script for automatic hook installation"
      contains: "lefthook install"
  key_links:
    - from: "lefthook.yml"
      to: ".git/hooks/pre-commit"
      via: "lefthook install"
      pattern: "pre-commit"
    - from: "lefthook.yml"
      to: "biome.json"
      via: "biome check command"
      pattern: "biome check"
    - from: "lefthook.yml"
      to: "tsconfig.json"
      via: "tsc --noEmit --incremental"
      pattern: "tsc.*incremental"
---

<objective>
Install lefthook and configure pre-commit hooks with three parallel quality gates (biome, typecheck, madge), enable incremental TypeScript compilation, and add a state consolidation checklist to CLAUDE.md.

Purpose: Automate code quality enforcement at commit time so broken code never lands, and establish a documented process for keeping project documentation in sync.
Output: Working pre-commit hooks, incremental typecheck, and state consolidation documentation.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/30-context-management/30-RESEARCH.md
@.planning/phases/30-context-management/30-01-SUMMARY.md

@tsconfig.json
@package.json
@CLAUDE.md
@biome.json
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install lefthook and configure pre-commit hooks</name>
  <files>lefthook.yml, tsconfig.json, package.json</files>
  <action>
    **Step 1: Install lefthook:**
    ```bash
    bun add -d lefthook
    ```

    **Step 2: Create `lefthook.yml`** in project root with three parallel pre-commit jobs:

    ```yaml
    # Source: https://biomejs.dev/recipes/git-hooks/ + lefthook v2 docs
    pre-commit:
      parallel: true
      jobs:
        - name: biome
          glob: "src/**/*.{js,ts,cjs,mjs,jsx,tsx,json,jsonc}"
          run: bunx biome check --write --no-errors-on-unmatched --files-ignore-unknown=true --colors=off {staged_files}
          stage_fixed: true

        - name: typecheck
          glob: "src/**/*.{ts,tsx}"
          run: bunx tsc --noEmit --incremental

        - name: circular
          glob: "src/**/*.{ts,tsx}"
          run: bunx madge --circular --extensions ts src/
    ```

    Key configuration details per user decisions:
    - `parallel: true` — all three jobs run concurrently
    - `glob: "src/**/*"` — hooks only trigger when src/ files are staged (planning docs, configs, markdown excluded)
    - `stage_fixed: true` on biome — auto-restages fixed files (deterministic, safe)
    - `--colors=off` on biome — prevents ANSI escape codes in hook output
    - No timeout — hooks always run to completion (per user decision)
    - Blocks commits on ANY error (no warn-and-pass mode, per user decision)

    **Step 3: Add `"incremental": true`** to tsconfig.json compilerOptions. This enables cached typecheck builds (~3.5s incremental vs ~10.7s cold). The `.tsbuildinfo` file is already in `.gitignore`.

    **Step 4: Update package.json scripts:**
    - Add `"prepare": "lefthook install"` — ensures hooks are installed for every developer after `bun install`
    - The `check:circular` script was already fixed in Plan 01

    **Step 5: Install hooks:**
    ```bash
    bunx lefthook install
    ```

    **Step 6: Verify hooks work** by making a trivial change to a src/ file, staging it, and committing. All three hooks should run and pass.
  </action>
  <verify>
    <automated>test -f lefthook.yml && grep -q "parallel: true" lefthook.yml && grep -q "incremental" tsconfig.json && grep -q "prepare" package.json && echo "PASS"</automated>
  </verify>
  <done>lefthook.yml exists with 3 parallel pre-commit jobs (biome, typecheck, circular). tsconfig.json has incremental: true. package.json has prepare script. Hooks are installed in .git/hooks/. A test commit triggers all three hooks.</done>
</task>

<task type="auto">
  <name>Task 2: Add State Consolidation section to CLAUDE.md</name>
  <files>CLAUDE.md</files>
  <action>
    Add a "State Consolidation" section to the end of CLAUDE.md. This section documents the process for keeping PROJECT.md, MEMORY.md, and CLAUDE.md in sync.

    Per user decisions:
    - PROJECT.md is the single source of truth — MEMORY.md and CLAUDE.md are updated to match when conflicts exist
    - Triggered at milestone boundaries (when running /gsd:complete-milestone)
    - All three files are part of the consolidation process
    - Checklist always visible to Claude Code sessions (in CLAUDE.md)

    Add this section after the existing content in CLAUDE.md:

    ```markdown
    ## State Consolidation

    At milestone boundaries (triggered by `/gsd:complete-milestone`), synchronize these three files. PROJECT.md is the single source of truth -- when conflicts exist, update the others to match.

    **Checklist:**

    1. Review `.planning/PROJECT.md` for current architecture, key decisions, and module map
    2. Update `MEMORY.md` to match PROJECT.md:
       - Remove stale entries (completed phases, resolved concerns)
       - Add new architectural decisions
       - Update platform API notes if changed
    3. Update `CLAUDE.md` to match PROJECT.md:
       - Module Map table reflects current aliases and paths
       - Dev Commands table reflects current scripts
       - Architecture diagram reflects current flow
       - Slash Commands table reflects current commands
    4. Verify all three files agree on: module aliases, dev commands, architecture flow
    ```
  </action>
  <verify>
    <automated>grep -q "State Consolidation" CLAUDE.md && grep -q "single source of truth" CLAUDE.md && echo "PASS"</automated>
  </verify>
  <done>CLAUDE.md contains a State Consolidation section with a milestone-boundary checklist. PROJECT.md is documented as the single source of truth. All three files (PROJECT.md, MEMORY.md, CLAUDE.md) are covered by the consolidation process.</done>
</task>

</tasks>

<verification>
1. `lefthook.yml` exists in project root with 3 parallel jobs
2. `git commit` on staged src/ file triggers biome, typecheck, and circular hooks
3. `git commit` on non-src/ file (e.g., CLAUDE.md) does NOT trigger hooks
4. `tsconfig.json` has `"incremental": true`
5. `package.json` has `"prepare": "lefthook install"`
6. `CLAUDE.md` has a State Consolidation section
7. `.tsbuildinfo` is in `.gitignore` (already present)
</verification>

<success_criteria>
- lefthook pre-commit hooks run biome, typecheck, and madge in parallel on every commit with src/ changes
- Biome auto-fixes are re-staged automatically (stage_fixed: true)
- Typecheck uses --incremental for cached builds
- Circular dependency detection uses --extensions ts
- Hooks do NOT trigger for non-src/ files (planning docs, markdown, configs)
- CLAUDE.md has State Consolidation section with PROJECT.md as single source of truth
- bun install automatically installs hooks via prepare script
</success_criteria>

<output>
After completion, create `.planning/phases/30-context-management/30-02-SUMMARY.md`
</output>
