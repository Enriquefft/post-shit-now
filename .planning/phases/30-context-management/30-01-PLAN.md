---
phase: 30-context-management
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/media/types.ts
  - src/media/image-gen.ts
  - src/media/video-gen.ts
  - src/media/providers/flux.ts
  - src/media/providers/gpt-image.ts
  - src/media/providers/ideogram.ts
  - src/media/providers/kling.ts
  - src/media/providers/pika.ts
  - src/media/providers/runway.ts
  - src/cli/setup-health.ts
  - src/cli/setup-trigger.ts
  - src/cli/setup-voice.ts
  - src/cli/setup.ts
  - src/cli/utils/masking.ts
  - src/cli/validate.ts
  - src/cli/voice-interview.ts
  - src/core/db/migrate.ts
  - src/core/utils/nanoid.ts
  - src/platforms/handlers/x.handler.ts
  - src/voice/interview.ts
  - package.json
autonomous: true
requirements:
  - CTX-03
must_haves:
  truths:
    - "bunx madge --circular --extensions ts src/ reports zero circular dependencies"
    - "bun run typecheck reports zero errors"
    - "bunx biome check src/ reports zero errors"
    - "check:circular script in package.json uses --extensions ts flag"
  artifacts:
    - path: "src/media/types.ts"
      provides: "Shared media types extracted from image-gen.ts and video-gen.ts"
      exports: ["ImageProvider", "ImageGenOptions", "GeneratedImage", "VideoProvider", "VideoGenParams", "GeneratedVideo", "VideoMode"]
    - path: "package.json"
      provides: "Fixed check:circular script with --extensions ts"
      contains: "madge --circular --extensions ts src/"
  key_links:
    - from: "src/media/providers/*.ts"
      to: "src/media/types.ts"
      via: "type imports"
      pattern: "import type.*from.*types"
    - from: "src/media/image-gen.ts"
      to: "src/media/types.ts"
      via: "re-export shared types"
      pattern: "export.*from.*types"
---

<objective>
Fix all pre-existing code quality issues that would block strict pre-commit hooks: 6 circular dependencies in src/media/, 25 TypeScript errors across src/, and biome lint violations.

Purpose: Hooks that block commits on any error require a clean baseline. Without fixing these first, no commits can land after hooks are activated.
Output: A codebase where `bun run typecheck`, `biome check src/`, and `madge --circular --extensions ts src/` all pass cleanly.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/30-context-management/30-RESEARCH.md

@src/media/image-gen.ts
@src/media/video-gen.ts
@src/media/providers/flux.ts
@src/media/providers/gpt-image.ts
@src/media/providers/ideogram.ts
@src/media/providers/kling.ts
@src/media/providers/pika.ts
@src/media/providers/runway.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Break circular dependencies in src/media/</name>
  <files>src/media/types.ts, src/media/image-gen.ts, src/media/video-gen.ts, src/media/providers/flux.ts, src/media/providers/gpt-image.ts, src/media/providers/ideogram.ts, src/media/providers/kling.ts, src/media/providers/pika.ts, src/media/providers/runway.ts</files>
  <action>
    Break all 6 circular dependencies using the dependency inversion pattern (extract shared types to a separate file).

    **Step 1: Create `src/media/types.ts`** with types extracted from image-gen.ts and video-gen.ts:
    - From image-gen.ts: `ImageProvider`, `ImageGenOptions`, `GeneratedImage`
    - From video-gen.ts: `VideoMode`, `VideoProvider`, `VideoGenParams`, `GeneratedVideo`

    **Step 2: Update image-gen.ts:**
    - Remove the type definitions that were moved to types.ts
    - Import them from `./types.ts` instead
    - Re-export them from image-gen.ts for backward compatibility: `export type { ImageProvider, ImageGenOptions, GeneratedImage } from "./types.ts";`
    - Keep all non-type exports (functions, constants) in image-gen.ts

    **Step 3: Update video-gen.ts:**
    - Same pattern as image-gen.ts — move type defs to types.ts, import from types.ts, re-export for backward compatibility

    **Step 4: Update all 6 provider files** to import types from `../types.ts` instead of `../image-gen.ts` or `../video-gen.ts`:
    - providers/flux.ts: `import type { ... } from "../types.ts"`
    - providers/gpt-image.ts: same
    - providers/ideogram.ts: same
    - providers/kling.ts: `import type { ... } from "../types.ts"`
    - providers/pika.ts: same
    - providers/runway.ts: same

    **Step 5: Fix check:circular script** in package.json:
    - Change `"check:circular": "madge --circular src/"` to `"check:circular": "madge --circular --extensions ts src/"`
    - Without `--extensions ts`, madge processes 0 files in this TS-only project

    **Step 6: Verify** with `bunx madge --circular --extensions ts src/` — should report 0 circular dependencies.
  </action>
  <verify>
    <automated>bunx madge --circular --extensions ts src/ 2>&1 | grep -E "No circular|Found [0-9]+ circular"</automated>
  </verify>
  <done>All 6 circular dependencies resolved. `madge --circular --extensions ts src/` reports no cycles. Provider files import types from types.ts, not from gen files. Backward-compatible re-exports preserved in image-gen.ts and video-gen.ts. check:circular script in package.json includes --extensions ts.</done>
</task>

<task type="auto">
  <name>Task 2: Fix all TypeScript errors and biome violations</name>
  <files>src/cli/setup-health.ts, src/cli/setup-trigger.ts, src/cli/setup-voice.ts, src/cli/setup.ts, src/cli/utils/masking.ts, src/cli/validate.ts, src/cli/voice-interview.ts, src/core/db/migrate.ts, src/core/utils/nanoid.ts, src/platforms/handlers/x.handler.ts, src/voice/interview.ts</files>
  <action>
    Fix all 25 TypeScript errors. These are genuine type safety issues (not false positives). Fix each by category:

    **Null/undefined safety (most errors):**
    - `setup-health.ts:257,266,284` — `hub` possibly undefined → add null guard or non-null assertion after validation check
    - `setup-health.ts:392` — `displayName` missing on type → add to type definition or use `name` instead
    - `setup-voice.ts:91` — object possibly undefined → add null check
    - `voice-interview.ts:162` — `state` possibly null → add null check
    - `voice-interview.ts:213,216` — `answer` used before assigned → initialize with empty string or restructure
    - `voice-interview.ts:458` — `selected` possibly undefined → add null check
    - `core/utils/nanoid.ts:19` — object possibly undefined → add null check

    **Type mismatches:**
    - `setup-trigger.ts:261,273,288` — `suggestedAction` not in `SetupResult` type → add `suggestedAction?: string` to SetupResult interface OR remove the property
    - `setup.ts:499` — `HealthCheckSummary` not assignable to `Record<string, unknown>` → use type assertion or fix the type
    - `masking.ts:56` — property types don't match index signature → make properties non-optional or adjust index signature
    - `validate.ts:113` — `suggestedAction` not in `ValidationResult` → same pattern as setup-trigger.ts
    - `migrate.ts:200,204` — `string | undefined` not assignable to `string | null` → use `?? null` to convert undefined to null
    - `x.handler.ts:35` — missing `override` modifier → add `override` keyword to the method
    - `interview.ts:54` — wrong argument count → add missing arguments
    - `interview.ts:1024` — `Map<string, unknown>` to `Map<string, string>` → use proper type or cast
    - `interview.ts:1059` — implicit any from index → add proper type guard

    **After TS fixes, run biome auto-fix:**
    ```bash
    bunx biome check --write src/
    ```
    This handles all auto-fixable lint/format violations. Then manually fix any remaining biome errors that auto-fix can't resolve.

    **Final verification:** Both `bun run typecheck` and `bunx biome check src/` must pass with zero errors.
  </action>
  <verify>
    <automated>bun run typecheck 2>&1 && bunx biome check src/ 2>&1</automated>
  </verify>
  <done>Zero TypeScript errors from `bun run typecheck`. Zero biome errors from `biome check src/`. Codebase is ready for strict pre-commit hooks.</done>
</task>

</tasks>

<verification>
All three quality gates pass on the current codebase:
1. `bun run typecheck` — 0 errors
2. `bunx biome check src/` — 0 errors
3. `bunx madge --circular --extensions ts src/` — 0 circular dependencies
4. `bun run check:circular` — uses --extensions ts flag and reports 0 cycles
</verification>

<success_criteria>
- Zero circular dependencies detected by madge (with --extensions ts)
- Zero TypeScript errors from tsc --noEmit
- Zero biome lint/format errors in src/
- check:circular script in package.json includes --extensions ts
- All provider files import types from src/media/types.ts (not from gen files)
- Backward-compatible re-exports preserved in image-gen.ts and video-gen.ts
</success_criteria>

<output>
After completion, create `.planning/phases/30-context-management/30-01-SUMMARY.md`
</output>
