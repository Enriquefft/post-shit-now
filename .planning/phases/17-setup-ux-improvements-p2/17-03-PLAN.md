---
phase: 17-setup-ux-improvements-p2
plan: 03
type: execute
wave: 2
depends_on: [17-01, 17-02]
files_modified: [src/cli/setup.ts]
autonomous: true
requirements: [M11]

must_haves:
  truths:
    - "Users can preview setup changes before execution with --dry-run or --preview flag"
    - "Dry-run validates all steps without creating/modifying resources"
    - "Preview output shows what would be executed"
    - "User confirms with 'Proceed with setup? [y/N]' prompt before actual execution"
  artifacts:
    - path: "src/cli/setup.ts"
      provides: "Dry-run and preview mode for setup"
      contains: '"dry-run"', '"preview"'
  key_links:
    - from: "src/cli/setup.ts"
      to: "src/cli/utils/progress.ts"
      via: "import for dry-run validation"
      pattern: "import.*progress"
    - from: "src/cli/setup.ts"
      to: "src/cli/utils/masking.ts"
      via: "import for error formatting"
      pattern: "import.*masking"
    - from: "src/cli/setup.ts"
      to: "CLI argument parser"
      via: "parseCliArgs function"
      pattern: "parseCliArgs"
---

<objective>
Add dry-run and preview modes to setup command for safer execution with user confirmation.

Purpose: Allow users to preview what setup will do before executing, validating all checks without creating or modifying resources, and requiring explicit confirmation before proceeding.

Output: Enhanced runSetup function with --dry-run/--preview flag support, validation-only mode, and confirmation prompt.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@planning/ROADMAP.md
@planning/STATE.md
@planning/phases/17-setup-ux-improvements-p2/17-CONTEXT.md
@planning/phases/17-setup-ux-improvements-p2/17-RESEARCH.md

@src/cli/setup.ts
@src/cli/utils/progress.ts
@src/cli/utils/masking.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add dry-run/preview flag support to CLI parser</name>
  <files>src/cli/setup.ts</files>
  <action>
Per user constraint from 17-CONTEXT.md: Dry-run and preview are the same feature (different names). User can choose either --dry-run or --preview flag (both accepted).

Update parseCliArgs function (lines 615-684) to:
1. Add dryRun and preview flags detection in the params object
2. Set a combined flag: const isPreview = params['dry-run'] === 'true' || params.preview === 'true';

Add to flag parsing:
```typescript
// Handle --dry-run and --preview flags
if (flagArgs.includes('--dry-run')) {
  params['dry-run'] = 'true';
}
if (flagArgs.includes('--preview')) {
  params.preview = 'true';
}
```

No change to existing flag parsing logic - just add these two new flags.

Per user constraint: Both flags are accepted and treated identically. The CLI parser already handles boolean-style flags correctly.
  </action>
  <verify>
1. grep "dry-run.*preview" src/cli/setup.ts confirms both flags handled
2. grep "isPreview" src/cli/setup.ts confirms combined flag detection
  </verify>
  <done>
CLI argument parser updated to recognize --dry-run and --preview flags, treating both as the same preview mode.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add dry-run validation mode to runSetup</name>
  <files>src/cli/setup.ts</files>
  <action>
Per user constraint from 17-CONTEXT.md: After preview, always confirm with user: "Proceed with setup? [y/N]"

Update runSetup function (lines 511-611) to:
1. Add dryRun parameter: export async function runSetup(configDir = "config", dryRun = false): Promise<SetupOutput>
2. Import readline-sync for user prompt (already installed from Phase 16)
3. Add dry-run logic at the start of the function:

```typescript
// Dry-run or preview mode
if (dryRun) {
  console.log('\n=== Dry Run / Preview Mode ===');
  console.log('Validating setup configuration...\n');

  // Run all validations without executing
  // Validate NEON_API_KEY format (prefix check)
  const keysResult = await setupKeys(configDir);
  if (Array.isArray(keysResult)) {
    console.log('\nValidation failed: Missing required keys');
    keysResult.forEach(r => console.log(`  ✗ ${r.message}`));
    return { steps: keysResult, validation: null, completed: false };
  }

  // Validate TRIGGER_SECRET_KEY format
  const triggerValidation = await validateTriggerArgs();
  if (!triggerValidation.valid) {
    console.log('\nValidation failed: Invalid Trigger.dev arguments');
    console.log(`  ✗ ${triggerValidation.error}`);
    return { steps: [...steps, keysResult], validation: null, completed: false };
  }

  // Show what would happen
  console.log('\n=== What would be executed ===');
  console.log('Step 1: Collect API keys (NEON_API_KEY, TRIGGER_SECRET_KEY)');
  console.log('Step 2: Create Neon database project');
  console.log('Step 3: Run database migrations');
  console.log('Step 4: Configure Trigger.dev project');
  console.log('Step 5: Set up platform OAuth (X, LinkedIn, Instagram, TikTok)');
  console.log('Step 6: Validate all connections');

  // Ask for confirmation
  const prompt = require('readline-sync');
  const proceed = prompt.question('\nProceed with setup? [y/N]: ', {
    hideEchoBack: false,
    limit: 1,
  });

  if (proceed.toLowerCase() !== 'y') {
    console.log('Setup cancelled.');
    return { steps: [], validation: null, completed: false };
  }

  // Fall through to actual execution
  console.log('\n=== Executing Setup ===\n');
}
```

Reference: 17-RESEARCH.md Pattern 3 code example for exact implementation.

Note: validateTriggerArgs is a placeholder - create a simple validation that checks TRIGGER_SECRET_KEY format (starts with tr_dev_ or tr_prod_).

Per user constraint: Output style for preview is Claude's discretion on what level of detail to show. The above provides a clear summary without over-detailing.
  </action>
  <verify>
1. grep "dryRun.*boolean" src/cli/setup.ts confirms parameter added
2. grep "Dry Run / Preview Mode" src/cli/setup.ts confirms preview header
3. grep "Proceed with setup" src/cli/setup.ts confirms confirmation prompt
4. grep "readline-sync" src/cli/setup.ts confirms prompt library
  </verify>
  <done>
runSetup function supports dry-run mode with validation, preview summary, and user confirmation before execution.
  </done>
</task>

<task type="auto">
  <name>Task 3: Wire dry-run flag to main entry point</name>
  <files>src/cli/setup.ts</files>
  <action>
Update the main entry point (lines 687-720) to pass dryRun flag to runSetup:

1. After parseCliArgs, extract dry-run flag:
   const isPreview = params['dry-run'] === 'true' || params.preview === 'true';

2. Pass to runSetup call:
   return runSetup(configDir, isPreview);

The CLI already exports runSetup for direct calling, so update both:
- The fallthrough runSetup() call (line 696)
- The runSetup(configDir) call (line 699 - may already use configDir variable)

Update to:
```typescript
const isPreview = params['dry-run'] === 'true' || params.preview === 'true';

const run = async () => {
  if (subcommand) {
    const result = await runSetupSubcommand(subcommand, params);
    if (result) return result;
  }
  return runSetup(configDir, isPreview);
};
```

This ensures the dry-run flag flows from CLI parsing to the setup execution.
  </action>
  <verify>
1. grep "isPreview.*dry-run.*preview" src/cli/setup.ts confirms flag extraction
2. grep "runSetup.*isPreview" src/cli/setup.ts confirms flag passed to runSetup
  </verify>
  <done>
Dry-run flag correctly wired from CLI arguments through to runSetup execution, enabling preview mode with user confirmation.
  </done>
</task>

</tasks>

<verification>
Test dry-run mode by:
1. Running: bun run setup --dry-run
2. Running: bun run setup --preview (both should work identically)
3. Verifying output shows:
   - "Dry Run / Preview Mode" header
   - Validation of API keys
   - Summary of what would be executed
   - "Proceed with setup? [y/N]" prompt
4. Testing:
   - Entering 'n' → setup cancels
   - Entering 'y' → setup proceeds normally
5. Testing invalid keys → validation fails before preview shows
</verification>

<success_criteria>
- --dry-run and --preview flags both recognized
- Preview mode validates API keys without execution
- Summary shows what steps would be executed
- Confirmation prompt "Proceed with setup? [y/N]" displayed
- Entering 'n' cancels setup
- Entering 'y' proceeds with actual setup
</success_criteria>

<output>
After completion, create `.planning/phases/17-setup-ux-improvements-p2/17-03-SUMMARY.md`
</output>
