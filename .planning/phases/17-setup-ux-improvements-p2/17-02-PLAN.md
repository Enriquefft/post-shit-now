---
phase: 17-setup-ux-improvements-p2
plan: 02
type: execute
wave: 1
depends_on: []
files_modified: [src/cli/utils/masking.ts, src/cli/setup-db.ts, src/cli/setup-trigger.ts]
autonomous: true
requirements: [M12]

must_haves:
  truths:
    - "Database URLs masked in error messages with user and host hidden"
    - "API keys masked in error messages showing prefix + suffix only"
    - "Info/warn logs show raw unmasked data"
    - "Debug mode reveals unmasked values for troubleshooting"
  artifacts:
    - path: "src/cli/utils/masking.ts"
      provides: "Sensitive data masking utilities"
      exports: ["maskDatabaseUrl", "maskApiKey", "formatErrorWithMasking"]
    - path: "src/cli/setup-db.ts"
      provides: "Database setup with error masking"
      contains: "maskDatabaseUrl"
    - path: "src/cli/setup-trigger.ts"
      provides: "Trigger.dev setup with error masking"
      contains: "maskApiKey"
  key_links:
    - from: "src/cli/setup-db.ts"
      to: "src/cli/utils/masking.ts"
      via: "import maskDatabaseUrl, formatErrorWithMasking"
      pattern: "import.*masking"
    - from: "src/cli/setup-trigger.ts"
      to: "src/cli/utils/masking.ts"
      via: "import maskApiKey, formatErrorWithMasking"
      pattern: "import.*masking"
---

<objective>
Mask sensitive data (database URLs and API keys) in error messages while preserving raw data in info/warn logs.

Purpose: Improve security by preventing credential leakage in error output while maintaining debugging capability through unmasked logs and debug mode.

Output: Data masking utilities (src/cli/utils/masking.ts) applied to error messages in database and Trigger.dev setup.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/17-setup-ux-improvements-p2/17-CONTEXT.md
@.planning/phases/17-setup-ux-improvements-p2/17-RESEARCH.md

@src/cli/setup-db.ts
@src/cli/setup-trigger.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create masking utilities</name>
  <files>src/cli/utils/masking.ts</files>
  <action>
Create src/cli/utils/masking.ts with three functions:

1. maskDatabaseUrl(url: string): string
   - Parse URL, mask username and host to "***"
   - Keep protocol and database name visible
   - Return format: `postgres://***@***/dbname`
   - Handle parsing errors with fallback "***masked***"

2. maskApiKey(key: string): string
   - Show prefix (first 3 chars) + asterisks + suffix (last 3 chars)
   - Example: "tr_dev_abc123def456" → "tr_***456"
   - Return "***" for keys < 6 chars

3. formatErrorWithMasking(message: string, context?: {databaseUrl?: string, apiKey?: string, [key: string]: any}): string
   - Replace databaseUrl in message with maskDatabaseUrl(databaseUrl)
   - Replace apiKey in message with maskApiKey(apiKey)
   - Return formatted message

Per user constraint from 17-CONTEXT.md:
- Database URLs: Mask user and host: `postgres://***@***` (middle ground - preserves structure, hides identity)
- API Keys: Show prefix + suffix format: `tr_********xyz`
- Scope: Mask in errors only (info/warn logs show raw data)
- Debug mode: Debug logging reveals unmasked values for troubleshooting

Reference: 17-RESEARCH.md Pattern 2 code example for exact implementation. Note: maskUrl already exists in setup-db.ts line 197 - extend it to also mask username and host per user constraint.
  </action>
  <verify>
1. ls src/cli/utils/masking.ts confirms file exists
2. grep "export function maskDatabaseUrl" src/cli/utils/masking.ts confirms export
3. grep "export function maskApiKey" src/cli/utils/masking.ts confirms export
4. grep "export function formatErrorWithMasking" src/cli/utils/masking.ts confirms export
  </verify>
  <done>
masking.ts file created with maskDatabaseUrl, maskApiKey, and formatErrorWithMasking functions per user-specified masking patterns.
  </done>
</task>

<task type="auto">
  <name>Task 2: Apply error masking to database setup</name>
  <files>src/cli/setup-db.ts</files>
  <action>
1. Import maskDatabaseUrl and formatErrorWithMasking from utils/masking.ts
2. Replace existing maskUrl function with new maskDatabaseUrl that also masks username and host
3. Update error returns to use formatErrorWithMasking:

   - Line 24-25: migrateResult.error → formatErrorWithMasking(migrateResult.error, {databaseUrl: connectionUri})
   - Line 52-53: keysResult.error → formatErrorWithMasking(keysResult.error)
   - Line 61-62: message with databaseUrl → formatErrorWithMasking(message, {databaseUrl: connectionUri})
   - Line 71-72: keyValidation.error → formatErrorWithMasking(message, {error: keyValidation.error})
   - Line 125: message with neonctl output → keep raw (not sensitive)
   - Line 125-126: message with connectionUri → formatErrorWithMasking(message, {databaseUrl: connectionUri})
   - Line 144-145: message with stdout → keep raw (not sensitive)
   - Line 152: message with stdout → keep raw (not sensitive)
   - Line 184-185: message with connectionUri → formatErrorWithMasking(message, {databaseUrl: connectionUri})

Per user constraint: Mask in errors only. Info/warn logs (like line 80 console.warn) show raw data.

Note: The existing maskUrl function at line 197-205 only masks password. Extend it to also mask username and hostname to match `postgres://***@***` format.
  </action>
  <verify>
1. grep "import.*maskDatabaseUrl.*masking" src/cli/setup-db.ts confirms import
2. grep "import.*formatErrorWithMasking.*masking" src/cli/setup-db.ts confirms import
3. grep "username.*\*\*\*" src/cli/setup-db.ts confirms username masking
4. grep "hostname.*\*\*\*" src/cli/setup-db.ts confirms host masking
  </verify>
  <done>
Database setup errors show masked database URLs with user and host hidden while preserving structure for debugging.
  </done>
</task>

<task type="auto">
  <name>Task 3: Apply error masking to Trigger.dev setup</name>
  <files>src/cli/setup-trigger.ts</files>
  <action>
1. Import maskApiKey and formatErrorWithMasking from utils/masking.ts
2. Update error returns to use formatErrorWithMasking:

   - Line 30: keysResult.error → formatErrorWithMasking(keysResult.error)
   - Line 39: message with secretKey → formatErrorWithMasking(message, {apiKey: secretKey})
   - Line 70: message with stderr and projectRef → formatErrorWithMasking(message, {apiKey: secretKey, projectRef})
   - Line 81: message with project ref → keep raw (not sensitive)

Per user constraint: Mask in errors only. Info/warn logs show raw data.

Secret key should be masked using prefix+suffix pattern: `tr_***xyz`.
  </action>
  <verify>
1. grep "import.*maskApiKey.*masking" src/cli/setup-trigger.ts confirms import
2. grep "import.*formatErrorWithMasking.*masking" src/cli/setup-trigger.ts confirms import
3. grep "formatErrorWithMasking.*apiKey" src/cli/setup-trigger.ts confirms API key masking in errors
  </verify>
  <done>
Trigger.dev setup errors show masked API keys with prefix+suffix pattern while preserving raw data in info/warn logs.
  </done>
</task>

</tasks>

<verification>
Test error masking by:
1. Triggering an error with invalid Neon API key → verify database URL masked in error
2. Triggering an error with invalid Trigger.dev secret key → verify API key masked in error
3. Verify info/warn logs (console.warn) still show raw unmasked data
4. Verify debug mode (when added) reveals unmasked values
</verification>

<success_criteria>
- src/cli/utils/masking.ts created with three masking functions
- Database URL masking: `postgres://***@***` format
- API key masking: `tr_***xyz` format
- Errors in setup-db.ts use masked values
- Errors in setup-trigger.ts use masked values
- Info/warn logs preserve raw data
</success_criteria>

<output>
After completion, create `.planning/phases/17-setup-ux-improvements-p2/17-02-SUMMARY.md`
</output>
