---
phase: 11-tech-debt-remediation
plan: 06
type: execute
wave: 2
depends_on:
  - 11-02
  - 11-03
files_modified:
  - src/intelligence/search/aggregate.ts
  - src/content/generate.ts
autonomous: true
requirements:
  - CONFIG-04
  - IMG-01
  - IMG-02
  - IMG-03
  - IMG-04
  - IMG-05
  - VID-01
  - VID-02
  - VID-03
  - VID-04
  - VID-05

must_haves:
  truths:
    - "Search provider calls pass db + hubId from caller context"
    - "Content generation passes db + hubId to image/video providers"
    - "Hub context (hubId) is available throughout call chains"
    - "No process.env fallbacks remain in provider invocation paths"
  artifacts:
    - path: "src/intelligence/search/aggregate.ts"
      provides: "Search aggregator with hub context passing"
      changes: "Accepts db + hubId, passes to search providers"
    - path: "src/content/generate.ts"
      provides: "Content generation with hub context passing"
      changes: "Passes db + hubId to generateImage/generateVideo"
  key_links:
    - from: "src/intelligence/search/aggregate.ts"
      to: "src/intelligence/search/*.ts"
      via: "Function calls with db + hubId params"
      pattern: "searchPerplexity\\(query.*db.*hubId"
    - from: "src/content/generate.ts"
      to: "src/media/image-gen.ts"
      via: "generateImage() call with db + hubId"
      pattern: "generateImage\\(.*db.*hubId"
    - from: "src/content/generate.ts"
      to: "src/media/video-gen.ts"
      via: "generateVideo() call with db + hubId"
      pattern: "generateVideo\\(.*db.*hubId"
---

<objective>
Wire search and media generation calls to pass db + hubId context to providers. Ensures provider key lookups use hub-scoped keys throughout the call chain.

Purpose: Complete the data flow from CLI/Trigger tasks to providers with hub context.
Output: Updated call sites passing db + hubId to search and media generation
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/11-should-we-address-this-remaining-tech-debt-issues-config-04-search-providers-read-from-process-env-byok-stores-in-keys-env-works-via-trigger-dev-env-vars-img-vid-providers-not-imported-by-generate-ts-claude-invoked-pattern-by-design/11-CONTEXT.md
@.planning/phases/11-should-we-address-this-remaining-tech-debt-issues-config-04-search-providers-read-from-process-env-byok-stores-in-keys-env-works-via-trigger-dev-env-vars-img-vid-providers-not-imported-by-generate-ts-claude-invoked-pattern-by-design/11-02-SUMMARY.md
@.planning/phases/11-should-we-address-this-remaining-tech-debt-issues-config-04-search-providers-read-from-process-env-byok-stores-in-keys-env-works-via-trigger-dev-env-vars-img-vid-providers-not-imported-by-generate-ts-claude-invoked-pattern-by-design/11-03-SUMMARY.md
@src/intelligence/search/aggregate.ts
@src/content/generate.ts
</context>

<tasks>

<task type="auto">
  <name>Update search provider call sites with hub context</name>
  <files>src/intelligence/search/aggregate.ts</files>
  <action>
Update src/intelligence/search/aggregate.ts (or create if it doesn't exist):

1. Add imports if not present:
   import type { PostgresJsDatabase } from "drizzle-orm/postgres-js";
   import { searchPerplexity } from "./perplexity";
   import { searchBrave } from "./brave-search";
   import { searchTavily } from "./tavily";
   import { searchExa } from "./exa";

2. Update function signatures to accept db + hubId:
   export async function searchAll(
     query: string,
     db: PostgresJsDatabase,
     hubId: string,
   ): Promise<SearchResult[]>

   Or if individual functions exist, update each:
   export async function searchPerplexity(query, db, hubId) { ... }
   export async function searchBrave(query, db, hubId) { ... }

3. Pass db + hubId to all search provider calls:
   const [perplexityResults, braveResults, tavilyResults, exaResults] = await Promise.all([
     searchPerplexity(query, db, hubId),
     searchBrave(query, db, hubId),
     searchTavily(query, db, hubId),
     searchExa(query, db, hubId),
   ]);

4. Remove any process.env key reading that may exist in this file
  </action>
  <verify>
grep -n "searchPerplexity.*db.*hubId" src/intelligence/search/aggregate.ts returns 1
grep -n "searchBrave.*db.*hubId" src/intelligence/search/aggregate.ts returns 1
grep -n "searchTavily.*db.*hubId" src/intelligence/search/aggregate.ts returns 1
grep -n "searchExa.*db.*hubId" src/intelligence/search/aggregate.ts returns 1
grep -n "process\\.env" src/intelligence/search/aggregate.ts | wc -l returns 0
  </verify>
  <done>
Search aggregator accepts db + hubId parameters
All 4 search providers called with db + hubId
No process.env key reads in search call chain
  </done>
</task>

<task type="auto">
  <name>Update content generation with hub context passing</name>
  <files>src/content/generate.ts</files>
  <action>
Update src/content/generate.ts to pass db + hubId to media generation:

1. Ensure GeneratePostOptions interface has db + hubId:
   export interface GeneratePostOptions {
     topic?: string;
     platform: Platform;
     persona?: "personal" | "brand-operator" | "brand-ambassador";
     language?: "en" | "es" | "both";
     format?: PostFormat;
     variations?: number;
     mediaType?: "image" | "video" | "none";
     mediaHints?: string[];
     profilePath?: string;
     databaseUrl?: string;
     userId?: string;
     db?: PostgresJsDatabase;  // Add this
     hubId?: string;              // Add this
   }

2. Find all generateImage() calls and add db + hubId:
   Before: const result = await generateImage(prompt, { platform, ...options });
   After: const result = await generateImage(prompt, { platform, ...options }, db, hubId);

3. Find all generateVideo() calls and add db + hubId:
   Before: const result = await generateVideo({ prompt, ...options });
   After: const result = await generateVideo({ prompt, ...options }, db, hubId);

4. Ensure hubId is passed from CLI/Trigger task context:
   - In CLI commands (post, plan), hubId comes from hub.env or team_members lookup
   - In Trigger tasks, hubId comes from task input or posts.userId
   - Pass hubId down the call chain to generate()

5. Update image-gen.ts and video-gen.ts to accept db + hubId in generateImage/generateVideo functions:
   - These are top-level functions that call provider.generate()
   - They should pass db + hubId to provider.generate() calls
  </action>
  <verify>
grep -n "generateImage.*db.*hubId" src/content/generate.ts src/media/image-gen.ts | wc -l returns 2
grep -n "generateVideo.*db.*hubId" src/content/generate.ts src/media/video-gen.ts | wc -l returns 2
grep -n "hubId.*string" src/content/generate.ts returns 1
grep -n "db.*PostgresJsDatabase" src/content/generate.ts returns 1
  </verify>
  <done>
GeneratePostOptions includes db + hubId fields
generateImage() calls pass db + hubId
generateVideo() calls pass db + hubId
Hub context flows from CLI/Trigger tasks to providers
  </done>
</task>

</tasks>

<verification>
1. All search provider calls include db + hubId parameters
2. All media generation calls (image/video) include db + hubId parameters
3. db + hubId flow from CLI/Trigger task context to provider functions
4. No process.env key fallbacks in call chain
5. Hub context correctly identifies hub owner (user ID or hub ID for company hubs)
</verification>

<success_criteria>
Search and media generation call sites pass db + hubId to providers.
Hub context available throughout provider invocation chain.
CONFIG-04 and IMG/VID requirements satisfied for data flow.
</success_criteria>

<output>
After completion, create `.planning/phases/11-should-we-address-this-remaining-tech-debt-issues-config-04-search-providers-read-from-process-env-byok-stores-in-keys-env-works-via-trigger-dev-env-vars-img-vid-providers-not-imported-by-generate-ts-claude-invoked-pattern-by-design/11-06-SUMMARY.md`
</output>
