---
phase: 11-tech-debt-remediation
plan: 04
type: execute
wave: 2
depends_on:
  - 11-01
files_modified:
  - src/media/providers/kling.ts
  - src/media/providers/runway.ts
  - src/media/providers/pika.ts
autonomous: true
requirements:
  - VID-01
  - VID-02
  - VID-03
  - VID-04
  - VID-05

must_haves:
  truths:
    - "Video providers (Kling, Runway, Pika) accept db + hubId parameters (required)"
    - "All video providers use getApiKey() for key lookup"
    - "No process.env key reads in video provider files (DB-only, no fallbacks)"
    - "Provider interfaces updated to accept required db + hubId"
  artifacts:
    - path: "src/media/providers/kling.ts"
      provides: "Kling provider with DB key lookup"
      changes: "Added db + hubId params, uses getApiKey() for fal"
    - path: "src/media/providers/runway.ts"
      provides: "Runway provider with DB key lookup"
      changes: "Added db + hubId params, uses getApiKey() for runway"
    - path: "src/media/providers/pika.ts"
      provides: "Pika provider with DB key lookup"
      changes: "Added db + hubId params, uses getApiKey() for fal"
    - path: "src/media/video-gen.ts"
      provides: "Video provider interface updates"
      changes: "Updated VideoProvider.generate() signature to accept required db + hubId"
  key_links:
    - from: "src/media/providers/*.ts"
      to: "src/core/db/api-keys.ts"
      via: "import { getApiKey } from '../../core/db/api-keys'"
      pattern: "getApiKey\\(db.*hubId"
    - from: "src/media/video-gen.ts"
      to: "src/media/providers/*.ts"
      via: "VideoProvider.generate() interface"
      pattern: "generate\\(.*db.*hubId"
---

<objective>
Migrate all video providers (Kling, Runway, Pika) from process.env key reading to getApiKey() function calls. Provider interfaces will be updated to accept db and hubId parameters for hub-scoped key lookup.

Purpose: Complete VID-01 through VID-05 requirements by enabling per-hub video generation keys.
Output: Updated video provider files using DB keys instead of process.env
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/11-should-we-address-this-remaining-tech-debt-issues-config-04-search-providers-read-from-process-env-byok-stores-in-keys-env-works-via-trigger-dev-env-vars-img-vid-providers-not-imported-by-generate-ts-claude-invoked-pattern-by-design/11-CONTEXT.md
@.planning/phases/11-should-we-address-this-remaining-tech-debt-issues-config-04-search-providers-read-from-process-env-byok-stores-in-keys-env-works-via-trigger-dev-env-vars-img-vid-providers-not-imported-by-generate-ts-claude-invoked-pattern-by-design/11-01-SUMMARY.md
@src/media/video-gen.ts
@src/media/providers/kling.ts
@src/media/providers/runway.ts
@src/media/providers/pika.ts
</context>

<tasks>

<task type="auto">
  <name>Update video provider interfaces and implementations</name>
  <files>src/media/video-gen.ts, src/media/providers/kling.ts, src/media/providers/runway.ts, src/media/providers/pika.ts</files>
  <action>
Step 1: Update VideoProvider interface in src/media/video-gen.ts
- Add required db and hubId parameters to generate() method signature:
  generate(params: VideoGenParams, db: PostgresJsDatabase, hubId: string): Promise<GeneratedVideo>

Step 2: Update each video provider file:

For kling.ts:
- Add import: import { getApiKey } from "../../core/db/api-keys"; import type { PostgresJsDatabase } from "drizzle-orm/postgres-js";
- Update generate() signature to accept db, hubId (no optional)
- Replace: const falKey = process.env.FAL_KEY;
- With: const falKey = await getApiKey(db, hubId, "fal");
- Update error message to mention hubId when key not found

For runway.ts:
- Add imports for getApiKey and PostgresJsDatabase
- Update generate() signature to accept db, hubId (no optional)
- Replace: const apiSecret = process.env.RUNWAYML_API_SECRET;
- With: const apiSecret = await getApiKey(db, hubId, "runway");
- Update error message to mention hubId when key not found

For pika.ts:
- Add imports for getApiKey and PostgresJsDatabase
- Update generate() signature to accept db, hubId (no optional)
- Replace: const falKey = process.env.FAL_KEY;
- With: const falKey = await getApiKey(db, hubId, "fal");
- Update error message to mention hubId when key not found

Note: DB-only approach - no process.env fallbacks. All callers must provide db + hubId.
  </action>
  <verify>
grep -n "generate.*db.*hubId" src/media/providers/kling.ts returns 1
grep -n "generate.*db.*hubId" src/media/providers/runway.ts returns 1
grep -n "generate.*db.*hubId" src/media/providers/pika.ts returns 1
grep -n "getApiKey" src/media/providers/*.ts | wc -l returns 3
grep -n "process\\.env\\.(FAL|RUNWAYML)_API(_KEY|_SECRET)" src/media/providers/kling.ts src/media/providers/runway.ts src/media/providers/pika.ts | wc -l returns 0
  </verify>
  <done>
All 3 video providers (Kling, Runway, Pika) accept required db + hubId parameters
All API key lookups use getApiKey() with db + hubId
VideoProvider interface updated to accept required db + hubId
  </done>
</task>

</tasks>

<verification>
1. VideoProvider.generate() signature includes required db and hubId parameters
2. All video providers use getApiKey() with db + hubId
3. No process.env key reads in video provider files (DB-only)
4. Error messages mention hubId when key lookup fails
</verification>

<success_criteria>
Video providers (Kling, Runway, Pika) use getApiKey() for hub-scoped key retrieval.
Provider interfaces support db + hubId parameters.
VID-01 through VID-05 requirements satisfied for video generation.
</success_criteria>

<output>
After completion, create `.planning/phases/11-should-we-address-this-remaining-tech-debt-issues-config-04-search-providers-read-from-process-env-byok-stores-in-keys-env-works-via-trigger-dev-env-vars-img-vid-providers-not-imported-by-generate-ts-claude-invoked-pattern-by-design/11-04-SUMMARY.md`
</output>
