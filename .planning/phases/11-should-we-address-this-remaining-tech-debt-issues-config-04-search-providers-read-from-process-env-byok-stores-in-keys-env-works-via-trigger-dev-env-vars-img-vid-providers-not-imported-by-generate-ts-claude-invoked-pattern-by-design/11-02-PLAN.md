---
phase: 11-tech-debt-remediation
plan: 02
type: execute
wave: 2
depends_on:
  - 11-01
files_modified:
  - src/intelligence/search/perplexity.ts
  - src/intelligence/search/brave-search.ts
  - src/intelligence/search/tavily.ts
  - src/intelligence/search/exa.ts
autonomous: true
requirements:
  - CONFIG-04

must_haves:
  truths:
    - "All search providers (Perplexity, Brave, Tavily, Exa) call getApiKey() instead of process.env"
    - "Search functions accept db and hubId parameters for key lookup"
    - "No process.env.API_KEY reads remain in search provider files"
    - "Error messages reference hubId when key not found"
  artifacts:
    - path: "src/intelligence/search/perplexity.ts"
      provides: "Perplexity search with DB key lookup"
      changes: "Added db + hubId params, uses getApiKey()"
    - path: "src/intelligence/search/brave-search.ts"
      provides: "Brave search with DB key lookup"
      changes: "Added db + hubId params, uses getApiKey()"
    - path: "src/intelligence/search/tavily.ts"
      provides: "Tavily search with DB key lookup"
      changes: "Added db + hubId params, uses getApiKey()"
    - path: "src/intelligence/search/exa.ts"
      provides: "Exa search with DB key lookup"
      changes: "Added db + hubId params, uses getApiKey()"
  key_links:
    - from: "src/intelligence/search/*.ts"
      to: "src/core/db/api-keys.ts"
      via: "import { getApiKey } from '../../core/db/api-keys'"
      pattern: "getApiKey\\(db.*hubId"
    - from: "src/intelligence/search/*.ts"
      to: "api_keys table"
      via: "db query through getApiKey()"
      pattern: "await.*getApiKey"
---

<objective>
Migrate all search providers (Perplexity, Brave, Tavily, Exa) from process.env key reading to getApiKey() function calls. Search functions will require db and hubId parameters for hub-scoped key lookup.

Purpose: Complete CONFIG-04 requirement by enabling per-hub search provider keys for multi-tenant architecture.
Output: Updated search provider files using DB keys instead of process.env
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/11-should-we-address-this-remaining-tech-debt-issues-config-04-search-providers-read-from-process-env-byok-stores-in-keys-env-works-via-trigger-dev-env-vars-img-vid-providers-not-imported-by-generate-ts-claude-invoked-pattern-by-design/11-CONTEXT.md
@.planning/phases/11-should-we-address-this-remaining-tech-debt-issues-config-04-search-providers-read-from-process-env-byok-stores-in-keys-env-works-via-trigger-dev-env-vars-img-vid-providers-not-imported-by-generate-ts-claude-invoked-pattern-by-design/11-01-SUMMARY.md
@src/intelligence/search/perplexity.ts
@src/intelligence/search/brave-search.ts
@src/intelligence/search/tavily.ts
@src/intelligence/search/exa.ts
</context>

<tasks>

<task type="auto">
  <name>Update search provider signatures and implementations</name>
  <files>src/intelligence/search/perplexity.ts, src/intelligence/search/brave-search.ts, src/intelligence/search/tavily.ts, src/intelligence/search/exa.ts</files>
  <action>
For each search provider file (perplexity.ts, brave-search.ts, tavily.ts, exa.ts):

1. Add import:
   import { getApiKey } from "../../core/db/api-keys";
   import type { PostgresJsDatabase } from "drizzle-orm/postgres-js";

2. Update function signature to accept db and hubId:
   export async function searchPerplexity(
     query: string,
     db: PostgresJsDatabase,
     hubId: string,
   ): Promise<SearchResult[]>

3. Replace process.env key lookup with getApiKey():
   Before: const apiKey = process.env.PERPLEXITY_API_KEY;
   After: const apiKey = await getApiKey(db, hubId, "perplexity");

4. Update return behavior:
   Before: if (!apiKey) return [];
   After: if (!apiKey) throw new Error("API key lookup returned empty value");

5. Use consistent service names in getApiKey calls:
   - perplexity.ts: "perplexity"
   - brave-search.ts: "brave"
   - tavily.ts: "tavily"
   - exa.ts: "exa"

Remove all process.env references to API keys in these files.
  </action>
  <verify>
grep -n "process\.env\.\*API_KEY" src/intelligence/search/*.ts returns 0
grep -n "getApiKey" src/intelligence/search/*.ts | wc -l returns 4 (one per file)
grep -n "hubId: string" src/intelligence/search/*.ts | wc -l returns 4
grep -n "db: PostgresJsDatabase" src/intelligence/search/*.ts | wc -l returns 4
  </verify>
  <done>
All 4 search providers (Perplexity, Brave, Tavily, Exa) accept db + hubId parameters
All API key lookups use getApiKey() instead of process.env
No process.env.API_KEY references remain in search provider files
  </done>
</task>

</tasks>

<verification>
1. grep confirms zero process.env.API_KEY references in search provider files
2. All search functions have db: PostgresJsDatabase parameter
3. All search functions have hubId: string parameter
4. getApiKey() called with correct service name (perplexity, brave, tavily, exa)
5. Key lookup errors are thrown (not silent returns) for missing keys
</verification>

<success_criteria>
Search providers (Perplexity, Brave, Tavily, Exa) use getApiKey() for hub-scoped key retrieval.
No process.env key reads in search provider files.
CONFIG-04 requirement satisfied for search providers.
</success_criteria>

<output>
After completion, create `.planning/phases/11-should-we-address-this-remaining-tech-debt-issues-config-04-search-providers-read-from-process-env-byok-stores-in-keys-env-works-via-trigger-dev-env-vars-img-vid-providers-not-imported-by-generate-ts-claude-invoked-pattern-by-design/11-02-SUMMARY.md`
</output>
