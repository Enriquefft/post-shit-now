---
phase: 11-tech-debt-remediation
plan: 05
type: execute
wave: 2
depends_on:
  - 11-02
  - 11-03
  - 11-04
files_modified:
  - src/cli/setup-keys.ts
  - src/cli/setup.ts
autonomous: true
requirements:
  - CONFIG-04
  - IMG-01
  - IMG-02
  - IMG-03
  - IMG-04
  - IMG-05
  - VID-01
  - VID-02
  - VID-03
  - VID-04
  - VID-05

must_haves:
  truths:
    - "/psn:setup prompts user to input API keys for all providers"
    - "Keys are stored encrypted in api_keys table via setApiKey()"
    - "Provider key collection list includes: perplexity, brave, tavily, exa, openai, ideogram, fal, runway"
    - "User can add/update keys via /psn:setup keys subcommand"
  artifacts:
    - path: "src/cli/setup-keys.ts"
      provides: "API key collection wizard for all providers"
      changes: "Extended REQUIRED_KEYS_PHASE1 to full provider list, added prompt loop"
    - path: "src/cli/setup.ts"
      provides: "Setup command integration with key collection"
      changes: "Calls extended setupKeys() for provider key wizard"
  key_links:
    - from: "src/cli/setup-keys.ts"
      to: "src/core/db/api-keys.ts"
      via: "import { setApiKey } from '../core/db/api-keys'"
      pattern: "await setApiKey"
    - from: "src/cli/setup.ts"
      to: "src/cli/setup-keys.ts"
      via: "import { setupKeys, writeKey } from './setup-keys'"
      pattern: "setupKeys\\(\\)"
---

<objective>
Extend /psn:setup to collect and store all provider API keys in encrypted api_keys table. Setup wizard will prompt user for keys and store them hub-scoped via setApiKey().

Purpose: Enable users to configure provider keys during initial setup and via /psn:setup keys command.
Output: Updated setup-keys.ts with full provider collection, integrated into /psn:setup
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/11-should-we-address-this-remaining-tech-debt-issues-config-04-search-providers-read-from-process-env-byok-stores-in-keys-env-works-via-trigger-dev-env-vars-img-vid-providers-not-imported-by-generate-ts-claude-invoked-pattern-by-design/11-CONTEXT.md
@.planning/phases/11-should-we-address-this-remaining-tech-debt-issues-config-04-search-providers-read-from-process-env-byok-stores-in-keys-env-works-via-trigger-dev-env-vars-img-vid-providers-not-imported-by-generate-ts-claude-invoked-pattern-by-design/11-01-SUMMARY.md
@src/cli/setup-keys.ts
@src/cli/setup.ts
</context>

<tasks>

<task type="auto">
  <name>Extend setup-keys.ts for full provider collection</name>
  <files>src/cli/setup-keys.ts</files>
  <action>
Update src/cli/setup-keys.ts to collect all provider keys:

1. Add imports:
   import { createHubConnection } from "../core/db/connection";
   import { setApiKey } from "../core/db/api-keys";

2. Expand provider key definitions:
   const PROVIDER_KEYS = [
     { name: "perplexity", service: "Perplexity AI", source: "https://www.perplexity.ai/settings/api" },
     { name: "brave", service: "Brave Search", source: "https://api.search.brave.com" },
     { name: "tavily", service: "Tavily", source: "https://tavily.com/api" },
     { name: "exa", service: "Exa AI", source: "https://exa.ai/api" },
     { name: "openai", service: "OpenAI (GPT Image)", source: "https://platform.openai.com/api-keys" },
     { name: "ideogram", service: "Ideogram", source: "https://ideogram.ai/api" },
     { name: "fal", service: "fal.ai (Flux/Kling/Pika)", source: "https://fal.ai/dashboard" },
     { name: "runway", service: "Runway ML", source: "https://runwayml.com/console" },
   ];

3. Create setupProviderKeys() function:
   export async function setupProviderKeys(configDir = "config"): Promise<SetupResult | SetupResult[]> {
     const hubEnv = await loadHubEnv(configDir);
     if (!hubEnv.success) {
       return { step: "keys", status: "error", message: hubEnv.error };
     }
     const db = await createHubConnection(hubEnv.data.databaseUrl);
     const hubId = await getHubId(db); // Extract from users table or config

     const missingKeys: SetupResult[] = [];
     const existingKeys = await listKeys(db, hubId);
     const configuredServices = new Set(existingKeys.map(k => k.service));

     for (const provider of PROVIDER_KEYS) {
       if (configuredServices.has(provider.name)) continue;
       missingKeys.push({
         step: "keys",
         status: "need_input",
         message: `Provide ${provider.service} API key`,
         data: { key: provider.name, service: provider.service, source: provider.source },
       });
     }

     if (missingKeys.length > 0) return missingKeys;

     return {
       step: "keys",
       status: "success",
       message: "All provider API keys are configured",
       data: { configuredServices: Array.from(configuredServices) },
     };
   }

4. Create writeProviderKey() function:
   export async function writeProviderKey(
     hubId: string,
     service: string,
     value: string,
     configDir = "config",
   ): Promise<SetupResult> {
     const hubEnv = await loadHubEnv(configDir);
     const db = await createHubConnection(hubEnv.data.databaseUrl);

     await setApiKey(db, hubId, service, value);

     return {
       step: "keys",
       status: "success",
       message: `${service} key saved to database for hub ${hubId}`,
     };
   }

5. Preserve backward compatibility:
   - Keep setupKeys() and writeKey() for Phase 1 keys (NEON_API_KEY, TRIGGER_SECRET_KEY)
   - These still write to config/keys.env
   - New provider keys go to DB via setupProviderKeys() and writeProviderKey()
  </action>
  <verify>
grep -n "setupProviderKeys" src/cli/setup-keys.ts returns 1
grep -n "writeProviderKey" src/cli/setup-keys.ts returns 1
grep -n "setApiKey" src/cli/setup-keys.ts returns 2
grep -n "PROVIDER_KEYS" src/cli/setup-keys.ts returns 1
grep -n "perplexity.*brave.*tavily.*exa.*openai.*ideogram.*fal.*runway" src/cli/setup-keys.ts returns 1
  </verify>
  <done>
setupProviderKeys() collects keys for all 9 providers
writeProviderKey() stores individual provider keys to DB
Provider list includes: perplexity, brave, tavily, exa, openai, ideogram, fal, runway
Backward compatibility preserved for Phase 1 keys (keys.env)
  </done>
</task>

<task type="auto">
  <name>Integrate provider key wizard into /psn:setup</name>
  <files>src/cli/setup.ts</files>
  <action>
Update src/cli/setup.ts to integrate provider key collection:

1. Add import:
   import { setupProviderKeys, writeProviderKey } from "./setup-keys";

2. Add provider key collection step after Phase 1 key setup:
   - In the main setup flow, after validating NEON_API_KEY and TRIGGER_SECRET_KEY
   - Call setupProviderKeys(configDir)
   - If status is "need_input", return the missing keys list for user input
   - Handle user input via writeProviderKey(hubId, service, value)

3. Add keys subcommand support:
   - Parse argv for "keys" subcommand
   - If keys subcommand: run setupProviderKeys() and handle input/output
   - Show list of configured keys: listKeys(db, hubId)
   - Allow adding specific key: /psn:setup keys --service openai

4. Error handling:
   - Ensure db connection errors are caught and reported
   - Show helpful error when HUB_ENCRYPTION_KEY is missing
   - Validate hubId is available (from users table or hub config)
  </action>
  <verify>
grep -n "setupProviderKeys" src/cli/setup.ts returns 1
grep -n "writeProviderKey" src/cli/setup.ts returns 1
grep -n "keys.*subcommand" src/cli/setup.ts returns 1
  </verify>
  <done>
/psn:setup prompts for provider keys after Phase 1 keys
/psn:setup keys subcommand allows key management
Provider keys stored in DB via setApiKey()
Backward compatible with existing Phase 1 setup flow
  </done>
</task>

</tasks>

<verification>
1. setupProviderKeys() checks existing keys in DB before prompting
2. User input for provider keys stored via setApiKey()
3. Provider list includes all 9 services (4 search + 5 media)
4. /psn:setup calls provider key wizard after Phase 1 setup
5. Error messages guide user to fix missing HUB_ENCRYPTION_KEY or db issues
6. Backward compatibility: Phase 1 keys still go to keys.env
</verification>

<success_criteria>
Users can configure provider API keys via /psn:setup wizard.
Keys stored encrypted in api_keys table (not keys.env).
All 9 providers (perplexity, brave, tavily, exa, openai, ideogram, fal, runway) supported.
CONFIG-04 and IMG/VID requirements satisfied for key setup.
</success_criteria>

<output>
After completion, create `.planning/phases/11-should-we-address-this-remaining-tech-debt-issues-config-04-search-providers-read-from-process-env-byok-stores-in-keys-env-works-via-trigger-dev-env-vars-img-vid-providers-not-imported-by-generate-ts-claude-invoked-pattern-by-design/11-05-SUMMARY.md`
</output>
