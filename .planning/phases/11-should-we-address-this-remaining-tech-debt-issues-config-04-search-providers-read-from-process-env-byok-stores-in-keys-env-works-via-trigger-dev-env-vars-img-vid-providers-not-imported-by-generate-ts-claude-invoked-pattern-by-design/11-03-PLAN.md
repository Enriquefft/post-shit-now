---
phase: 11-tech-debt-remediation
plan: 03
type: execute
wave: 2
depends_on:
  - 11-01
files_modified:
  - src/media/providers/gpt-image.ts
  - src/media/providers/ideogram.ts
  - src/media/providers/flux.ts
autonomous: true
requirements:
  - IMG-01
  - IMG-02
  - IMG-03
  - IMG-04
  - IMG-05

must_haves:
  truths:
    - "Image providers (GPT Image, Ideogram, Flux) accept db + hubId parameters (required)"
    - "All image providers use getApiKey() for key lookup"
    - "No process.env key reads in image provider files (DB-only, no fallbacks)"
    - "Provider interfaces updated to accept required db + hubId"
  artifacts:
    - path: "src/media/providers/gpt-image.ts"
      provides: "GPT Image provider with DB key lookup"
      changes: "Added db + hubId params, uses getApiKey() for openai"
    - path: "src/media/providers/ideogram.ts"
      provides: "Ideogram provider with DB key lookup"
      changes: "Added db + hubId params, uses getApiKey() for ideogram/fal"
    - path: "src/media/providers/flux.ts"
      provides: "Flux provider with DB key lookup"
      changes: "Added db + hubId params, uses getApiKey() for fal"
    - path: "src/media/image-gen.ts"
      provides: "Image provider interface updates"
      changes: "Updated ImageProvider.generate() signature to accept required db + hubId"
  key_links:
    - from: "src/media/providers/*.ts"
      to: "src/core/db/api-keys.ts"
      via: "import { getApiKey } from '../../core/db/api-keys'"
      pattern: "getApiKey\\(db.*hubId"
    - from: "src/media/image-gen.ts"
      to: "src/media/providers/*.ts"
      via: "ImageProvider.generate() interface"
      pattern: "generate\\(.*db.*hubId"
---

<objective>
Migrate all image providers (GPT Image, Ideogram, Flux) from process.env key reading to getApiKey() function calls. Provider interfaces will be updated to accept db and hubId parameters for hub-scoped key lookup.

Purpose: Complete IMG-01 through IMG-05 requirements by enabling per-hub image generation keys.
Output: Updated image provider files using DB keys instead of process.env
</objective>

<execution_context>
@./.claude/get-shit-done/workflows/execute-plan.md
@./.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/phases/11-should-we-address-this-remaining-tech-debt-issues-config-04-search-providers-read-from-process-env-byok-stores-in-keys-env-works-via-trigger-dev-env-vars-img-vid-providers-not-imported-by-generate-ts-claude-invoked-pattern-by-design/11-CONTEXT.md
@.planning/phases/11-should-we-address-this-remaining-tech-debt-issues-config-04-search-providers-read-from-process-env-byok-stores-in-keys-env-works-via-trigger-dev-env-vars-img-vid-providers-not-imported-by-generate-ts-claude-invoked-pattern-by-design/11-01-SUMMARY.md
@src/media/image-gen.ts
@src/media/providers/gpt-image.ts
@src/media/providers/ideogram.ts
@src/media/providers/flux.ts
</context>

<tasks>

<task type="auto">
  <name>Update image provider interfaces and implementations</name>
  <files>src/media/image-gen.ts, src/media/providers/gpt-image.ts, src/media/providers/ideogram.ts, src/media/providers/flux.ts</files>
  <action>
Step 1: Update ImageProvider interface in src/media/image-gen.ts
- Add required db and hubId parameters to generate() method signature:
  generate(prompt: string, options: ImageGenOptions, db: PostgresJsDatabase, hubId: string): Promise<GeneratedImage>

Step 2: Update each image provider file:

For gpt-image.ts:
- Add import: import { getApiKey } from "../../core/db/api-keys"; import type { PostgresJsDatabase } from "drizzle-orm/postgres-js";
- Update generate() signature to accept db, hubId (no optional)
- Replace: const apiKey = process.env.OPENAI_API_KEY;
- With: const apiKey = await getApiKey(db, hubId, "openai");
- Update error message to mention hubId when key not found

For ideogram.ts:
- Add imports for getApiKey and PostgresJsDatabase
- Update generate() signature to accept db, hubId (no optional)
- Replace falKey lookup (both paths) with getApiKey() calls:
  - fal path: await getApiKey(db, hubId, "fal")
  - direct API path: await getApiKey(db, hubId, "ideogram")
- Remove any process.env.FAL_KEY or process.env.IDEOGRAM_API_KEY references

For flux.ts:
- Add imports for getApiKey and PostgresJsDatabase
- Update generate() signature to accept db, hubId (no optional)
- Replace: const falKey = process.env.FAL_KEY;
- With: const falKey = await getApiKey(db, hubId, "fal");
- Update error message to mention hubId when key not found

Note: DB-only approach - no process.env fallbacks. All callers must provide db + hubId.
  </action>
  <verify>
grep -n "generate.*db.*hubId" src/media/providers/gpt-image.ts returns 1
grep -n "generate.*db.*hubId" src/media/providers/ideogram.ts returns 1
grep -n "generate.*db.*hubId" src/media/providers/flux.ts returns 1
grep -n "getApiKey" src/media/providers/*.ts | wc -l returns 3
grep -n "process\\.env\\.(OPENAI|FAL|IDEOGRAM)_API_KEY" src/media/providers/gpt-image.ts src/media/providers/ideogram.ts src/media/providers/flux.ts | wc -l returns 0
  </verify>
  <done>
All 3 image providers (GPT Image, Ideogram, Flux) accept required db + hubId parameters
All API key lookups use getApiKey() with db + hubId
ImageProvider interface updated to accept required db + hubId
  </done>
</task>

</tasks>

<verification>
1. ImageProvider.generate() signature includes required db and hubId parameters
2. All image providers use getApiKey() with db + hubId
3. No process.env key reads in image provider files (DB-only)
4. Error messages mention hubId when key lookup fails
</verification>

<success_criteria>
Image providers (GPT Image, Ideogram, Flux) use getApiKey() for hub-scoped key retrieval.
Provider interfaces support db + hubId parameters.
IMG-01 through IMG-05 requirements satisfied for image generation.
</success_criteria>

<output>
After completion, create `.planning/phases/11-should-we-address-this-remaining-tech-debt-issues-config-04-search-providers-read-from-process-env-byok-stores-in-keys-env-works-via-trigger-dev-env-vars-img-vid-providers-not-imported-by-generate-ts-claude-invoked-pattern-by-design/11-03-SUMMARY.md`
</output>
