---
phase: 04-analytics-and-learning-loop
plan: 04
type: execute
wave: 3
depends_on: [04-02, 04-03]
files_modified:
  - src/analytics/review.ts
  - src/analytics/monthly.ts
  - src/trigger/monthly-analysis.ts
  - .claude/commands/psn/review.md
autonomous: true
requirements: [ANLYT-06, ANLYT-07, ANLYT-08, ANLYT-09]

must_haves:
  truths:
    - "User can run /psn:review and see a ranked post breakdown for the last 7 days"
    - "Top 3 and bottom 3 posts get full breakdown; remaining posts get compact score + one-line verdict"
    - "Recommendations cite specific posts as evidence"
    - "Review includes time comparison (this week vs last) AND cross-pillar breakdown"
    - "Weekly review triggers preference model update and shows changelog"
    - "Reports are saved to analytics/reports/ as markdown files"
    - "Monthly deep analysis runs automatically on the 1st and covers drift, audience signals, risk budget"
  artifacts:
    - path: "src/analytics/review.ts"
      provides: "Weekly review generation: rankings, breakdowns, recommendations, comparison"
      exports: ["generateWeeklyReview"]
    - path: "src/analytics/monthly.ts"
      provides: "Monthly deep analysis: voice drift, audience model, risk budget"
      exports: ["generateMonthlyAnalysis"]
    - path: "src/trigger/monthly-analysis.ts"
      provides: "Trigger.dev monthly cron task"
      contains: "schedules.task"
    - path: ".claude/commands/psn/review.md"
      provides: "/psn:review slash command"
      contains: "psn:review"
  key_links:
    - from: "src/analytics/review.ts"
      to: "src/core/db/schema.ts"
      via: "query postMetrics for scoring data"
      pattern: "postMetrics"
    - from: "src/analytics/review.ts"
      to: "src/learning/preference-model.ts"
      via: "trigger computeWeeklyUpdate during review"
      pattern: "computeWeeklyUpdate"
    - from: "src/analytics/review.ts"
      to: "src/learning/adjustments.ts"
      via: "compute and apply adjustments, get changelog"
      pattern: "computeAdjustments|getRecentChangelog"
    - from: "src/analytics/review.ts"
      to: "src/learning/feedback.ts"
      via: "detect feedback moments for key posts"
      pattern: "detectFeedbackMoments"
    - from: ".claude/commands/psn/review.md"
      to: "src/analytics/review.ts"
      via: "slash command invokes review CLI"
      pattern: "review"
---

<objective>
Build the /psn:review command and the monthly deep analysis task. The review is the primary user touchpoint for understanding what content is working and what the system has learned.

Purpose: The review command is how the user sees the learning loop in action. It surfaces performance data, triggers the weekly preference model update, applies autonomous adjustments, and saves reports. The monthly analysis catches longer-term trends.
Output: Weekly review generator, monthly analysis task, /psn:review slash command, saved reports.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-analytics-and-learning-loop/04-RESEARCH.md
@.planning/phases/04-analytics-and-learning-loop/04-01-SUMMARY.md
@.planning/phases/04-analytics-and-learning-loop/04-02-SUMMARY.md
@.planning/phases/04-analytics-and-learning-loop/04-03-SUMMARY.md
@src/analytics/scoring.ts
@src/analytics/collector.ts
@src/analytics/fatigue.ts
@src/learning/preference-model.ts
@src/learning/adjustments.ts
@src/learning/feedback.ts
@.claude/commands/psn/post.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Weekly review generator + report saving</name>
  <files>
    src/analytics/review.ts
  </files>
  <action>
Create `src/analytics/review.ts` — the core review engine.

**`generateWeeklyReview(db, userId, options?: { days?: number })`:**

The default time range is 7 days per user decision. Returns a structured `WeeklyReview` object (not markdown — Claude renders it in the slash command).

1. **Fetch data:**
   - Query postMetrics for posts published in the time range, joined with posts table for content/format/metadata context
   - Query postMetrics for the PREVIOUS period (same duration, one period back) for comparison
   - Get preferenceModel for follower history

2. **Rank posts by engagementScore descending.**

3. **Build post breakdown per user decision:**
   - Top 3 posts: full breakdown including content snippet, format, pillar, scores (both absolute and rate), what made it work (high saves? high shares?), time posted
   - Bottom 3 posts: full breakdown including what underperformed and why (low impressions? low engagement rate?)
   - Remaining posts: compact format — `{ title/snippet, score, rate, oneLineVerdict }` where verdict is auto-generated (e.g., "Solid thread, strong saves" or "Low reach, try different time")

4. **Time comparison (ANLYT-07):**
   - This period vs previous: total engagement score, avg score per post, total impressions, engagement rate
   - Delta with percentage change
   - Highlight biggest improvements and declines

5. **Cross-pillar breakdown:**
   - Group posts by pillar, compute avg score per pillar
   - Show which pillars are performing above/below average

6. **Recommendations (evidence-backed per user decision):**
   - Each recommendation MUST cite specific posts: "Threads outperformed singles by 2x — see posts #4, #7"
   - Recommendations derived from: format performance gaps, pillar performance gaps, time-of-day patterns, fatigue warnings
   - Call `detectTopicFatigue()` to include fatigue warnings

7. **Follower trend:**
   - Extract last 2 data points from followerHistory
   - Show trend direction and delta (DO NOT correlate with specific posts per user decision)

8. **Trigger learning loop:**
   - Call `computeWeeklyUpdate()` to update preference model
   - Call `computeAdjustments()` to generate strategy suggestions
   - Call `applyAutoAdjustments()` for auto-tier changes
   - Call `getRecentChangelog()` for the "what the brain changed" section
   - Call `detectFeedbackMoments()` for key posts requiring explicit feedback

9. **Save report (ANLYT-09):**
   - Generate markdown from the structured data
   - Write to `analytics/reports/weekly-YYYY-MM-DD.md`
   - Create directory if it doesn't exist

10. **Return `WeeklyReview`** with all sections as structured data:
    ```typescript
    interface WeeklyReview {
      period: { start: Date; end: Date };
      postBreakdown: { top: PostDetail[]; bottom: PostDetail[]; rest: PostCompact[] };
      comparison: { current: PeriodStats; previous: PeriodStats; deltas: Record<string, number> };
      pillarBreakdown: Array<{ pillar: string; avgScore: number; postCount: number }>;
      recommendations: Array<{ text: string; evidence: string[]; priority: "high" | "medium" | "low" }>;
      followerTrend: { current: number; previous: number; delta: number };
      changelog: StrategyAdjustment[];
      pendingApprovals: StrategyAdjustment[];
      feedbackMoments: FeedbackMoment[];
      fatiguedTopics: FatigueResult[];
      reportPath: string;
    }
    ```
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Verify the WeeklyReview interface covers all ANLYT-06, ANLYT-07 requirements.
  </verify>
  <done>
    Weekly review generates ranked post breakdown (top 3/bottom 3 full, rest compact). Time comparison and cross-pillar breakdown included. Recommendations cite evidence. Learning loop triggered. Report saved to analytics/reports/.
  </done>
</task>

<task type="auto">
  <name>Task 2: Monthly analysis + /psn:review slash command</name>
  <files>
    src/analytics/monthly.ts
    src/trigger/monthly-analysis.ts
    .claude/commands/psn/review.md
  </files>
  <action>
**Monthly deep analysis (src/analytics/monthly.ts):**

`generateMonthlyAnalysis(db, userId)`: Produces a comprehensive monthly report (ANLYT-08). Runs on 1st of each month, auto-escalated (not triggered by user).

1. **Voice drift detection:** Compare recent 30-day edit patterns from editHistory against baseline (first month or overall average). If average edit ratio has increased by >10 points, flag as "voice drift detected — calibration may be regressing."

2. **Audience signals:** Query postMetrics for last 30 days. Identify:
   - Topics with growing engagement (> 20% improvement over previous 30 days)
   - Topics with declining engagement
   - New formats that are outperforming historical averages
   - Format-specific audience response patterns

3. **Risk budget assessment:** Review strategyAdjustments from last 30 days:
   - How many auto-adjustments were made?
   - Did adjustments improve or degrade performance? (compare post-adjustment scores to pre-adjustment)
   - If adjustments are degrading performance, recommend reducing auto-apply scope

4. **Strategic recommendations:** Large-scale suggestions that need approval:
   - "Consider adding [topic] as a new pillar" (if consistently high engagement on off-pillar posts)
   - "Consider dropping [format]" (if a format consistently underperforms)
   - These become queued strategyAdjustments with tier="approval"

5. **Save report:** Write to `analytics/reports/monthly-YYYY-MM.md`.

**Trigger.dev task (src/trigger/monthly-analysis.ts):**

```typescript
export const monthlyAnalysis = schedules.task({
  id: "monthly-analysis",
  cron: "0 8 1 * *",  // 1st of each month at 8am UTC
  maxDuration: 600,
  run: async (payload) => {
    // Same env loading pattern as analytics-collector
    // Call generateMonthlyAnalysis(db, userId)
    // Log summary
  },
});
```

**Slash command (.claude/commands/psn/review.md):**

Create the /psn:review command following the same pattern as /psn:post.md. Structure:

```markdown
# /psn:review

Review content performance and update learning loop.

## Usage
`/psn:review` — default last 7 days
`/psn:review --days 14` — custom time range
`/psn:review --approve <id>` — approve a queued adjustment
`/psn:review --reject <id>` — reject a queued adjustment
`/psn:review --lock <field>` — permanently lock a setting
`/psn:review --unlock <field>` — unlock a setting

## Workflow

1. Load env from config/hub.env and config/keys.env
2. Call generateWeeklyReview() from src/analytics/review.ts
3. Present the review to the user in a clear, structured format:
   - Performance summary (this week vs last)
   - Top performers (full breakdown with what worked)
   - Underperformers (full breakdown with what went wrong)
   - Remaining posts (compact scores)
   - Cross-pillar analysis
   - Follower trend (context only, no per-post correlation)
   - Recommendations (with evidence citations)
   - Content fatigue warnings
   - "What the brain changed this week" (changelog)
   - Pending approvals (if any)
   - Feedback moments (ask about exceptional posts)
4. If there are pending approvals, present each with options to approve/reject
5. If there are feedback moments, ask the user about each
6. Report is already saved to analytics/reports/

## Notes
- The review feels like a social media manager's weekly briefing
- Recommendations always cite specific posts
- Fatigue warnings suggest alternatives
- Changelog is transparent — no hidden changes
```
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Confirm .claude/commands/psn/review.md exists.
    Confirm src/trigger/monthly-analysis.ts exports a valid schedules.task.
  </verify>
  <done>
    Monthly analysis auto-runs on 1st of month covering voice drift, audience signals, risk budget. /psn:review slash command provides weekly briefing with all sections per user decisions. Reports saved to analytics/reports/.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` compiles without errors
- /psn:review slash command exists at .claude/commands/psn/review.md
- Review output covers: ranked posts, time comparison, pillar breakdown, evidence-backed recommendations, changelog, feedback moments
- Monthly analysis covers: voice drift, audience signals, risk budget
- Reports saved to analytics/reports/ directory
</verification>

<success_criteria>
- /psn:review generates comprehensive weekly briefing matching all user decisions
- Top 3/bottom 3 get full breakdown; rest get compact scores
- Recommendations cite specific posts as evidence
- Time comparison (this vs last period) AND cross-pillar breakdown present
- Learning loop triggered during review (preference model update, adjustments, changelog)
- Monthly analysis auto-runs and covers drift + audience + risk
- Reports persisted to analytics/reports/
</success_criteria>

<output>
After completion, create `.planning/phases/04-analytics-and-learning-loop/04-04-SUMMARY.md`
</output>
