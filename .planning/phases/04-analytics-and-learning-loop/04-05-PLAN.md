---
phase: 04-analytics-and-learning-loop
plan: 05
type: execute
wave: 3
depends_on: [04-02, 04-03]
files_modified:
  - src/content/generate.ts
  - src/content/drafts.ts
  - src/cli/post-finish.ts
  - .claude/commands/psn/post.md
autonomous: true
requirements: [POST-13, SCHED-06]

must_haves:
  truths:
    - "Semi-automated formats save script + talking points as drafts with 'awaiting-recording' status"
    - "User can run /psn:post finish to attach recorded media and publish a semi-automated draft"
    - "Preference model learnings (fatigue warnings, top hooks, format preferences) are surfaced during post generation"
    - "Posts route to correct hub: personal posts to Personal Hub queue, company posts to Company Hub queue"
  artifacts:
    - path: "src/content/generate.ts"
      provides: "getPreferenceModelLearnings wired to real preference model (replaces stub)"
      contains: "getPreferenceModelLearnings"
    - path: "src/content/drafts.ts"
      provides: "awaiting-recording draft status support"
      contains: "awaiting-recording"
    - path: "src/cli/post-finish.ts"
      provides: "CLI for finishing semi-automated drafts with user-recorded media"
      exports: ["finishDraft"]
    - path: ".claude/commands/psn/post.md"
      provides: "Updated /psn:post with finish subcommand and fatigue warnings"
      contains: "finish"
  key_links:
    - from: "src/content/generate.ts"
      to: "src/learning/preference-model.ts"
      via: "real preference model query replacing stub"
      pattern: "getPreferenceModel"
    - from: "src/content/generate.ts"
      to: "src/analytics/fatigue.ts"
      via: "check fatigue before suggesting topic"
      pattern: "isTopicFatigued"
    - from: "src/cli/post-finish.ts"
      to: "src/content/drafts.ts"
      via: "load draft, attach media, update status"
      pattern: "loadDraft|updateDraft"
---

<objective>
Wire the learning loop into content generation, add semi-automated format support (POST-13), and implement hub routing (SCHED-06). This closes the feedback loop: analytics data now influences future content generation.

Purpose: The learning loop is useless if it does not feed back into content creation. This plan connects the preference model to generatePost, adds fatigue warnings during /psn:post, and handles the semi-automated workflow for video scripts.
Output: Connected learning loop, semi-automated draft finish flow, hub routing.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/04-analytics-and-learning-loop/04-RESEARCH.md
@.planning/phases/04-analytics-and-learning-loop/04-02-SUMMARY.md
@.planning/phases/04-analytics-and-learning-loop/04-03-SUMMARY.md
@src/content/generate.ts
@src/content/drafts.ts
@.claude/commands/psn/post.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Wire preference model into generatePost + fatigue warnings</name>
  <files>
    src/content/generate.ts
  </files>
  <action>
**Replace the Phase 4 stub in src/content/generate.ts:**

The current `getPreferenceModelLearnings()` function returns `null`. Replace it with a real implementation:

1. Import `getPreferenceModel` from `../learning/preference-model.ts`
2. Import `isTopicFatigued` from `../analytics/fatigue.ts`

New `getPreferenceModelLearnings(platform, options?: { databaseUrl?: string, userId?: string })`:
- If no databaseUrl provided, return null (graceful fallback — still works without DB)
- Query preferenceModel for userId
- If no model exists, return null
- Map model data to the existing `PreferenceLearnings` interface:
  - `hooks`: extract from hookPatterns (top 3)
  - `formats`: extract from topFormats (sorted by score, top 3 format names)
  - `fatiguedTopics`: extract from fatiguedTopics (active cooldowns only, filtered by `isTopicFatigued`)

**In the `generatePost` function:**

Update the existing call to pass databaseUrl and userId:
```typescript
const preferenceLearnings = await getPreferenceModelLearnings(options.platform, {
  databaseUrl: options.databaseUrl,
  userId: options.userId,
});
```

Add `databaseUrl` and `userId` as optional fields to `GeneratePostOptions`.

**Fatigue warning integration:**

After topic selection in generatePost, if a topic is selected (either from user input or suggestions), check `isTopicFatigued()`. If fatigued, add a `fatigueWarning` field to the `GeneratedDraft` return:
```typescript
fatigueWarning?: {
  topic: string;
  suggestion: string; // "This topic has been cooling -- consider [alternative pillar]"
};
```

The warning does NOT block posting (per user decision: deprioritize in suggestions, don't block). It just surfaces the warning for Claude to present in /psn:post.

Also update `suggestTopics` to filter out fatigued topics from suggestions (deprioritize, not block — move them to bottom of list with a "cooling" label).
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Verify getPreferenceModelLearnings no longer returns unconditional null.
  </verify>
  <done>
    Preference model learnings feed into content generation. Fatigued topics are deprioritized in suggestions and warned during generation. The stub is replaced with real DB queries. Graceful fallback when DB unavailable.
  </done>
</task>

<task type="auto">
  <name>Task 2: Semi-automated draft finish + hub routing + /psn:post update</name>
  <files>
    src/content/drafts.ts
    src/cli/post-finish.ts
    .claude/commands/psn/post.md
  </files>
  <action>
**Draft status extension (src/content/drafts.ts):**

Update the `DraftFrontmatter.status` type to include `"awaiting-recording"`:
```typescript
status: "draft" | "review" | "approved" | "published" | "awaiting-recording";
```

Add `hub` field to DraftFrontmatter: `hub?: "personal" | "company"`. Defaults to "personal".

**Post finish CLI (src/cli/post-finish.ts):**

Create `finishDraft(params: { draftId: string; mediaPath: string; databaseUrl?: string; userId?: string })`:

1. Load draft by ID from content/drafts/ using existing `loadDraft` or list+filter
2. Verify status is "awaiting-recording" — error if not
3. Verify mediaPath exists (the user-recorded video/audio file)
4. Copy media to content/media/ (or reference in place)
5. Update draft frontmatter: status -> "approved", add mediaPath to metadata
6. Return the updated draft for the slash command to proceed with scheduling

The draft content already has the script + talking points (generated during /psn:post for semi-automated formats like video-script or tiktok-stitch).

**Hub routing (SCHED-06):**

In the post CLI (or wherever posts are created in the DB), add routing logic:
- If persona is "personal" or "brand-ambassador" -> hub = "personal" (writes to user's Personal Hub)
- If persona is "brand-operator" -> hub = "company" (writes to Company Hub when it exists in Phase 7)

For now, add a `hub` column concept to the post metadata (not a schema change yet — use the existing `metadata` jsonb field with `hub: "personal" | "company"`). This routes the post conceptually without requiring Company Hub infrastructure (Phase 7).

Company posts get status "pending_approval" per research recommendation. Personal posts go straight to "scheduled" as before.

**Update /psn:post slash command (.claude/commands/psn/post.md):**

Add to the existing command:

1. **New `finish` subcommand:**
   ```
   /psn:post finish <draft-id> --media <path>
   ```
   - Loads the awaiting-recording draft
   - Attaches the user's recorded media
   - Proceeds with normal scheduling flow

2. **Fatigue warnings:**
   - After generating a draft, if `fatigueWarning` is present, display it prominently:
     "This topic has been cooling -- consider [alternative pillar]"
   - Suggest alternative topics but allow user to proceed

3. **Semi-automated format flow:**
   - When format is video-script, tiktok-stitch, or similar:
     - Generate script + talking points as draft content
     - Save with status "awaiting-recording"
     - Tell user: "Draft saved. Record your video, then run `/psn:post finish <id> --media <path>`"

4. **Hub routing display:**
   - Show which hub the post will route to
   - For company posts, note "This will require approval before publishing"
  </action>
  <verify>
    Run `npx tsc --noEmit` — no type errors.
    Verify .claude/commands/psn/post.md contains "finish" subcommand documentation.
    Verify DraftFrontmatter includes "awaiting-recording" status.
  </verify>
  <done>
    Semi-automated formats save with awaiting-recording status. /psn:post finish attaches media and schedules. Hub routing assigns personal/company based on persona. Fatigue warnings shown during post generation. /psn:post command updated with finish subcommand.
  </done>
</task>

</tasks>

<verification>
- `npx tsc --noEmit` compiles without errors
- getPreferenceModelLearnings returns real data when DB available, null gracefully otherwise
- DraftFrontmatter.status includes "awaiting-recording"
- /psn:post.md documents finish subcommand and fatigue warnings
- Hub routing logic present in post creation flow
</verification>

<success_criteria>
- Preference model learnings replace stub in content generation
- Fatigued topics deprioritized in suggestions, warned during generation
- Semi-automated formats save script as draft, user records, then runs finish
- Hub routing: personal posts to Personal Hub, company posts to Company Hub
- /psn:post command updated with finish subcommand and fatigue warning display
</success_criteria>

<output>
After completion, create `.planning/phases/04-analytics-and-learning-loop/04-05-SUMMARY.md`
</output>
