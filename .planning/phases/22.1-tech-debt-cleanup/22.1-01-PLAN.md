---
phase: 22.1-tech-debt-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/trigger/publish-helpers.ts
  - src/core/types/index.ts
  - CLAUDE.md
autonomous: true
requirements:
  - ARCH-01
  - ARCH-04
  - DOC-01
  - ARCH-07

must_haves:
  truths:
    - "publish-helpers.ts imports DbConnection and PostRow from @psn/core/types/publisher.ts — no local re-declarations on lines 8-9"
    - "PostSubStatus union in src/core/types/index.ts includes 'partial_failure' as a member"
    - "CLAUDE.md Module Map shows @psn/trigger/* (not bare @psn/trigger)"
    - "bun run typecheck error count is 24 (no new errors introduced)"
    - "bun run check:circular reports no circular dependencies"
  artifacts:
    - path: "src/trigger/publish-helpers.ts"
      provides: "Orchestration-layer DB helpers using canonical type imports"
      contains: "import type { DbConnection, PostRow } from \"@psn/core/types/publisher.ts\""
    - path: "src/core/types/index.ts"
      provides: "Complete PostSubStatus union type"
      contains: "\"partial_failure\""
    - path: "CLAUDE.md"
      provides: "Accurate module alias documentation"
      contains: "@psn/trigger/*"
  key_links:
    - from: "src/trigger/publish-helpers.ts"
      to: "src/core/types/publisher.ts"
      via: "import type { DbConnection, PostRow }"
      pattern: "import type.*DbConnection.*PostRow.*publisher"
---

<objective>
Close three audit-identified tech debt items from the v1.2 milestone: fix a type re-declaration in publish-helpers.ts that violates the single-source-of-truth principle (ARCH-01/ARCH-04), add a missing PostSubStatus union member that publish-post.ts already writes to the database, and correct an inaccurate module alias label in CLAUDE.md (DOC-01/ARCH-07).

Purpose: These three items are the only open gaps between Phase 22 completion and a clean v1.2 foundation before Phase 23 (Testing Infrastructure). None require new libraries or architectural changes — each is 1-3 lines.
Output: Three modified files. No new files created.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/22.1-tech-debt-cleanup/22.1-RESEARCH.md
</context>

<interfaces>
<!-- Canonical types the executor imports FROM. No exploration needed. -->

From src/core/types/publisher.ts (the import target):
```typescript
/**
 * Database connection type alias for platform handlers.
 * Uses the HTTP driver connection — suitable for Trigger.dev tasks and serverless.
 */
export type DbConnection = ReturnType<typeof createHubConnection>;

/**
 * Row type inferred directly from the posts schema table.
 * Single source of truth — kept in sync with schema changes automatically.
 */
export type PostRow = typeof posts.$inferSelect;
```

From src/core/types/index.ts (current PostSubStatus — missing "partial_failure"):
```typescript
export type PostSubStatus =
  | "retry_1"
  | "retry_2"
  | "retry_3"
  | "rate_limited"
  | "media_uploading"
  | "media_uploaded"
  | "thread_partial"
  | null;
```

From src/trigger/publish-helpers.ts lines 1-9 (current broken pattern):
```typescript
import { logger } from "@trigger.dev/sdk";
import { eq } from "drizzle-orm";
import { posts, preferenceModel } from "../core/db/schema.ts";
import type { PostMetadata } from "../core/db/schema.ts";
import { createHubConnection } from "../core/db/connection.ts";   // used ONLY for type derivation
import { recordEpisodePublished } from "../series/episodes.ts";

type DbConnection = ReturnType<typeof createHubConnection>;  // DELETE — local re-declaration
type PostRow = typeof posts.$inferSelect;                    // DELETE — local re-declaration
```

From CLAUDE.md line 21 (current inaccurate entry):
```
| `@psn/trigger` | `src/trigger/` | Trigger.dev scheduled tasks |
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Fix type imports in publish-helpers.ts and add partial_failure to PostSubStatus</name>
  <files>src/trigger/publish-helpers.ts, src/core/types/index.ts</files>
  <action>
    **Fix 1 — src/trigger/publish-helpers.ts:**

    Remove lines 5, 8, and 9 from the current file. Add a canonical type import in their place.

    BEFORE (lines 1–9):
    ```typescript
    import { logger } from "@trigger.dev/sdk";
    import { eq } from "drizzle-orm";
    import { posts, preferenceModel } from "../core/db/schema.ts";
    import type { PostMetadata } from "../core/db/schema.ts";
    import { createHubConnection } from "../core/db/connection.ts";
    import { recordEpisodePublished } from "../series/episodes.ts";

    type DbConnection = ReturnType<typeof createHubConnection>;
    type PostRow = typeof posts.$inferSelect;
    ```

    AFTER (lines 1–7):
    ```typescript
    import { logger } from "@trigger.dev/sdk";
    import { eq } from "drizzle-orm";
    import { posts, preferenceModel } from "../core/db/schema.ts";
    import type { PostMetadata } from "../core/db/schema.ts";
    import type { DbConnection, PostRow } from "@psn/core/types/publisher.ts";
    import { recordEpisodePublished } from "../series/episodes.ts";
    ```

    Critical notes:
    - Use `import type` (not `import`) — project has verbatimModuleSyntax: true
    - Remove the `createHubConnection` import (line 5) — it was only used to derive DbConnection
    - Remove both local type declarations (lines 8–9) — they are now provided by the canonical import
    - The `posts` import (line 3) stays — it is used in all three exported functions for DB queries
    - The rest of the file (lines 11–119) is unchanged

    **Fix 2 — src/core/types/index.ts:**

    Add `"partial_failure"` to the PostSubStatus union. The union starts at line 30. Insert the new member before `| null` (the last member):

    BEFORE:
    ```typescript
    export type PostSubStatus =
      | "retry_1"
      | "retry_2"
      | "retry_3"
      | "rate_limited"
      | "media_uploading"
      | "media_uploaded"
      | "thread_partial"
      | null;
    ```

    AFTER:
    ```typescript
    export type PostSubStatus =
      | "retry_1"
      | "retry_2"
      | "retry_3"
      | "rate_limited"
      | "media_uploading"
      | "media_uploaded"
      | "thread_partial"
      | "partial_failure"
      | null;
    ```

    No other changes to index.ts.

    After both edits, run verification commands below.
  </action>
  <verify>
    <automated>cd /home/hybridz/Projects/post-shit-now && bun run typecheck 2>&1 | grep -c "error TS"</automated>
    Expected output: 24 (unchanged from pre-existing errors in src/voice/interview.ts).
    Also run: bun run check:circular
    Expected output: "No circular dependency found!"
    Also run: biome check src/trigger/publish-helpers.ts src/core/types/index.ts
    Expected output: no errors or warnings.
  </verify>
  <done>
    publish-helpers.ts has no local DbConnection/PostRow type declarations and imports them from @psn/core/types/publisher.ts. PostSubStatus in src/core/types/index.ts includes "partial_failure". bun run typecheck still reports exactly 24 errors (all pre-existing in src/voice/interview.ts).
  </done>
</task>

<task type="auto">
  <name>Task 2: Correct @psn/trigger alias label in CLAUDE.md Module Map</name>
  <files>CLAUDE.md</files>
  <action>
    In CLAUDE.md line 21, change the Module Map entry for the trigger alias from `@psn/trigger` to `@psn/trigger/*`.

    BEFORE (line 21):
    ```
    | `@psn/trigger` | `src/trigger/` | Trigger.dev scheduled tasks |
    ```

    AFTER:
    ```
    | `@psn/trigger/*` | `src/trigger/` | Trigger.dev scheduled tasks |
    ```

    Only change the alias label cell. Path (`src/trigger/`) and responsibility description are correct and stay unchanged.

    This is a documentation-only fix. The tsconfig.json wildcard alias is correct as-is — do NOT touch tsconfig.json.

    Rationale (per STATE.md decision [22-02]): No bare @psn/trigger alias exists. src/trigger/index.ts barrel does not exist yet. A bare form would silently fail to resolve. Correct usage is `import from '@psn/trigger/publish-post'`.
  </action>
  <verify>
    <automated>cd /home/hybridz/Projects/post-shit-now && grep "@psn/trigger" CLAUDE.md</automated>
    Expected output: exactly one line containing `@psn/trigger/*` (no bare `@psn/trigger` form).
  </verify>
  <done>
    CLAUDE.md Module Map entry shows `@psn/trigger/*` (not bare `@psn/trigger`). No other lines in CLAUDE.md were changed.
  </done>
</task>

</tasks>

<verification>
After both tasks complete, run the full suite:

```bash
# 1. Typecheck — must stay at 24 errors (all pre-existing in src/voice/interview.ts)
cd /home/hybridz/Projects/post-shit-now && bun run typecheck 2>&1 | grep -c "error TS"

# 2. Circular dependency check — must report clean
bun run check:circular

# 3. Lint check on modified source files
biome check src/trigger/publish-helpers.ts src/core/types/index.ts

# 4. Verify canonical import in publish-helpers.ts
grep "import type.*DbConnection.*PostRow" src/trigger/publish-helpers.ts

# 5. Verify no local type re-declarations remain
grep "^type DbConnection\|^type PostRow" src/trigger/publish-helpers.ts

# 6. Verify partial_failure in PostSubStatus
grep "partial_failure" src/core/types/index.ts

# 7. Verify CLAUDE.md alias label
grep "@psn/trigger" CLAUDE.md
```

Expected results:
- Command 1: `24`
- Command 2: no cycles reported
- Command 3: no errors
- Command 4: matches line with `@psn/core/types/publisher.ts`
- Command 5: no output (declarations gone)
- Command 6: one line with `"partial_failure"`
- Command 7: one line containing `@psn/trigger/*`
</verification>

<success_criteria>
1. `publish-helpers.ts` imports `DbConnection` and `PostRow` from `@psn/core/types/publisher.ts` — no local re-declarations
2. `PostSubStatus` union in `src/core/types/index.ts` includes `"partial_failure"` member
3. CLAUDE.md Module Map shows `@psn/trigger/*` (not bare `@psn/trigger`)
4. `bun run typecheck` error count unchanged at 24
5. `bun run check:circular` reports no circular dependencies
6. All four phase 22.1 requirement IDs (ARCH-01, ARCH-04, DOC-01, ARCH-07) are closed
</success_criteria>

<output>
After completion, create `.planning/phases/22.1-tech-debt-cleanup/22.1-01-SUMMARY.md`
</output>
