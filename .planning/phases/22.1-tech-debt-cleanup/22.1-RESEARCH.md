# Phase 22.1: Tech Debt Cleanup - Research

**Researched:** 2026-02-27
**Domain:** TypeScript refactoring — type consolidation, documentation accuracy, union type completeness
**Confidence:** HIGH

<phase_requirements>
## Phase Requirements

| ID | Description | Research Support |
|----|-------------|-----------------|
| ARCH-01 | Extract PlatformPublisher interface with behavioral contracts | Fix publish-helpers.ts to import DbConnection/PostRow from src/core/types/publisher.ts (the canonical location established by ARCH-01) |
| ARCH-04 | Refactor orchestration layer to use interface-based handlers | publish-helpers.ts uses DbConnection and PostRow as orchestration-layer types; importing from canonical source honors the interface-based contract |
| DOC-01 | Create root CLAUDE.md (100-200 lines) for project guidance | Fix Module Map entry: `@psn/trigger` bare label → `@psn/trigger/*` to match tsconfig.json definition |
| ARCH-07 | Configure TypeScript path aliases (@psn/platforms, @psn/core) | The @psn/trigger alias is wildcard-only in tsconfig.json; CLAUDE.md must accurately reflect this to prevent agent/developer import errors |
</phase_requirements>

---

## Summary

Phase 22.1 is a gap-closure phase that resolves four tech debt items identified in the v1.2 milestone audit. All four items are small, surgical changes — no new libraries, no architectural shifts, no schema changes. The entire phase can be executed in a single wave of three targeted edits across three files.

The highest-value fix is the `publish-helpers.ts` type redeclaration. Lines 8–9 of that file locally re-declare `DbConnection` and `PostRow` using the same derivation expressions that already exist as exported type aliases in `src/core/types/publisher.ts`. These are not just similar types — they are structurally identical. The fix is to delete the two local declarations and add a single import from the canonical source. This closes the ARCH-01/ARCH-04 violation with zero runtime impact.

The other two fixes are equally contained. The `PostSubStatus` union in `src/core/types/index.ts` is missing `"partial_failure"` as a member — `publish-post.ts` already writes this value to the `subStatus` column at line 133, so the type surface is simply incomplete relative to real usage. Adding it has no runtime impact but makes the type contract accurate. The CLAUDE.md Module Map fix is a one-line label change: `@psn/trigger` → `@psn/trigger/*` to match the wildcard-only path alias in tsconfig.json.

**Primary recommendation:** Execute all three source-file changes in a single wave, run `bun run typecheck` after each change to confirm error count stays at 24, then verify success criteria by inspection.

---

## Standard Stack

No new libraries required. All changes are within the existing project stack.

### Core (already installed)
| Library | Version | Purpose | Why Standard |
|---------|---------|---------|--------------|
| TypeScript | ESNext/bundler | Type system | Already configured via tsconfig.json |
| Bun | runtime | Test and typecheck runner | Project mandates Bun exclusively — no npm/npx/yarn |

### Installation
No installation needed. All tools already present.

---

## Architecture Patterns

### Pattern 1: Single-Source-of-Truth Type Import

**What:** Import shared type aliases from their canonical module rather than re-deriving them locally.

**When to use:** Any time a file needs `DbConnection` or `PostRow` in a Trigger.dev task or orchestration layer.

**Current (broken) pattern in publish-helpers.ts lines 8–9:**
```typescript
// BAD — local re-derivation; duplicates src/core/types/publisher.ts
type DbConnection = ReturnType<typeof createHubConnection>;
type PostRow = typeof posts.$inferSelect;
```

**Target (correct) pattern:**
```typescript
// GOOD — import from canonical source (src/core/types/publisher.ts)
import type { DbConnection, PostRow } from "@psn/core/types/publisher.ts";
```

**Note on import path:** The `@psn/core/*` wildcard alias is defined in tsconfig.json. The correct import is `@psn/core/types/publisher.ts` (not bare `@psn/core`). After the import is added, the two local `type` declarations on lines 8–9 MUST be removed to eliminate the duplication.

**Side effect to watch:** `publish-helpers.ts` currently imports `createHubConnection` from `"../core/db/connection.ts"` only to derive `DbConnection`. Once `DbConnection` is imported directly, check whether `createHubConnection` is still needed for any other purpose in the file. If not, remove that import too to keep the file clean.

### Pattern 2: Union Type Completeness

**What:** A union type in the type definitions file should enumerate every value that production code actually writes to the database.

**Current (incomplete) PostSubStatus in src/core/types/index.ts:**
```typescript
export type PostSubStatus =
  | "retry_1"
  | "retry_2"
  | "retry_3"
  | "rate_limited"
  | "media_uploading"
  | "media_uploaded"
  | "thread_partial"
  | null;
```

**Target (complete) PostSubStatus — add `"partial_failure"`:**
```typescript
export type PostSubStatus =
  | "retry_1"
  | "retry_2"
  | "retry_3"
  | "rate_limited"
  | "media_uploading"
  | "media_uploaded"
  | "thread_partial"
  | "partial_failure"
  | null;
```

**Why no TypeScript error currently:** The `subStatus` column in `db/schema.ts` (line 150) is `text("sub_status")` with no enum constraint. Drizzle infers it as `string | null`, so assigning `"partial_failure"` does not produce a type error even though `PostSubStatus` does not include it. The fix makes the documented type match the actual runtime values.

### Pattern 3: Documentation Accuracy for Path Aliases

**What:** CLAUDE.md Module Map entries must match the actual alias forms defined in tsconfig.json.

**Current CLAUDE.md line 21 (inaccurate):**
```
| `@psn/trigger` | `src/trigger/` | Trigger.dev scheduled tasks |
```

**Target (accurate label):**
```
| `@psn/trigger/*` | `src/trigger/` | Trigger.dev scheduled tasks |
```

**Why this matters:** Agents and developers reading the Module Map will write imports based on what they see here. `import from '@psn/trigger'` fails silently at resolution time because tsconfig.json only defines `@psn/trigger/*` (wildcard), not a bare `@psn/trigger` form. The correct usage is `import from '@psn/trigger/publish-post'`.

**Context from STATE.md decision [22-02]:** "No bare @psn/trigger alias — src/trigger/index.ts barrel does not exist yet; bare alias would silently fail to resolve." This decision is already captured — the documentation just needs to reflect it.

### Anti-Patterns to Avoid

- **Touching publish-post.ts for this phase:** The `partial_failure` string literal at line 133 of publish-post.ts is correct and intentional. Do NOT change it. Only the type definition in `src/core/types/index.ts` needs updating.
- **Removing the `createHubConnection` import prematurely:** Verify it has no other uses in publish-helpers.ts before removing. The import is on line 5 and is currently used only for the `DbConnection` type derivation — but do a quick scan to confirm.
- **Changing `@psn/trigger` in tsconfig.json:** The tsconfig alias is deliberately wildcard-only. Do not add a bare form to tsconfig.json. The fix is documentation only.
- **Introducing new type errors:** The current error count is 24 (all pre-existing in `src/voice/interview.ts`). After each change, run `bun run typecheck` and confirm the count remains at 24.

---

## Don't Hand-Roll

| Problem | Don't Build | Use Instead | Why |
|---------|-------------|-------------|-----|
| Type alias for DB connection | Local re-derivation | Import from `@psn/core/types/publisher.ts` | The canonical alias already exists with JSDoc; re-deriving creates divergence risk |
| PostSubStatus validation | Runtime enum check | TypeScript union type | The DB column is `text()`; the union type is the sole type-level contract |

**Key insight:** All three fixes are removals or additions of 1–3 lines. No new abstractions needed.

---

## Common Pitfalls

### Pitfall 1: Circular Import via @psn/core/types/publisher.ts

**What goes wrong:** `publisher.ts` imports from `./index.ts` (via `import type { Platform, PlatformPublishResult } from "./index.ts"`). `index.ts` does not import from `publisher.ts`. `publish-helpers.ts` is in `src/trigger/`, not `src/core/`. So the import chain is: `src/trigger/publish-helpers.ts` → `src/core/types/publisher.ts` → `src/core/types/index.ts`. No cycle exists.

**Why it happens:** Developers worry about circular imports when adding cross-module imports.

**How to avoid:** This import path is safe. Run `bun run check:circular` after the change to confirm. Expected output remains "No circular dependency found!"

**Warning signs:** If `bun run check:circular` reports a cycle, something else was changed incorrectly.

### Pitfall 2: Import Style — `type` Keyword Required

**What goes wrong:** The project uses `verbatimModuleSyntax: true` in tsconfig.json. Importing types without the `type` keyword will cause a typecheck error.

**Why it happens:** Bun/bundler module mode with `verbatimModuleSyntax` enforces type-only imports for type aliases.

**How to avoid:** Use `import type { DbConnection, PostRow } from "@psn/core/types/publisher.ts"` — with the `type` keyword.

**Warning signs:** A new typecheck error about "import is not a type-only import" or similar.

### Pitfall 3: Leaving Unused Imports After Fix

**What goes wrong:** After replacing the local `DbConnection`/`PostRow` derivations with an import, the original imports that supplied the derivation (`createHubConnection` from connection.ts and `posts` from schema.ts) may become unused. With `noUnusedLocals: false` in tsconfig.json this won't cause a type error, but unused imports should be cleaned up to keep the file tidy.

**Why it happens:** Mechanical refactors often leave behind the imports that fed the deleted code.

**How to avoid:** After deleting lines 8–9 from publish-helpers.ts, scan lines 1–6 for any import that is no longer referenced. In the current file, `createHubConnection` (line 5) is only used for the type derivation. The `posts` table (line 3) is used in the DB queries throughout the file — keep it.

**Warning signs:** Biome lint warnings about unused imports (run `biome check src/` to catch these).

---

## Code Examples

### Fix 1: publish-helpers.ts — Remove local re-declarations, add canonical import

```typescript
// BEFORE (lines 1-9 of publish-helpers.ts)
import { logger } from "@trigger.dev/sdk";
import { eq } from "drizzle-orm";
import { posts, preferenceModel } from "../core/db/schema.ts";
import type { PostMetadata } from "../core/db/schema.ts";
import { createHubConnection } from "../core/db/connection.ts";   // ← only used for type derivation
import { recordEpisodePublished } from "../series/episodes.ts";

type DbConnection = ReturnType<typeof createHubConnection>;         // ← DELETE
type PostRow = typeof posts.$inferSelect;                           // ← DELETE

// AFTER (lines 1-8 of publish-helpers.ts)
import { logger } from "@trigger.dev/sdk";
import { eq } from "drizzle-orm";
import { posts, preferenceModel } from "../core/db/schema.ts";
import type { PostMetadata } from "../core/db/schema.ts";
import type { DbConnection, PostRow } from "@psn/core/types/publisher.ts";  // ← ADD
import { recordEpisodePublished } from "../series/episodes.ts";
// createHubConnection import removed — no longer needed
```

### Fix 2: src/core/types/index.ts — Add "partial_failure" to PostSubStatus

```typescript
// BEFORE (lines 30-38)
export type PostSubStatus =
  | "retry_1"
  | "retry_2"
  | "retry_3"
  | "rate_limited"
  | "media_uploading"
  | "media_uploaded"
  | "thread_partial"
  | null;

// AFTER — add "partial_failure" member
export type PostSubStatus =
  | "retry_1"
  | "retry_2"
  | "retry_3"
  | "rate_limited"
  | "media_uploading"
  | "media_uploaded"
  | "thread_partial"
  | "partial_failure"
  | null;
```

### Fix 3: CLAUDE.md — Correct the @psn/trigger Module Map label

```markdown
<!-- BEFORE (line 21) -->
| `@psn/trigger` | `src/trigger/` | Trigger.dev scheduled tasks |

<!-- AFTER -->
| `@psn/trigger/*` | `src/trigger/` | Trigger.dev scheduled tasks |
```

### Verification Commands (run after each fix)

```bash
# Confirm typecheck error count stays at 24 (all pre-existing in interview.ts)
bun run typecheck 2>&1 | grep -c "error TS"

# Confirm no circular dependencies introduced
bun run check:circular

# Confirm no new lint issues
biome check src/
```

---

## State of the Art

| Old Approach | Current Approach | When Changed | Impact |
|--------------|------------------|--------------|--------|
| Local `type DbConnection = ReturnType<typeof createHubConnection>` in each file | Single exported alias in `src/core/types/publisher.ts` | Phase 21 (ARCH-01) | publish-helpers.ts still uses the old approach — this phase fixes it |
| PostSubStatus missing `"partial_failure"` | PostSubStatus includes all written values | This phase | Type surface accurately reflects DB values |
| `@psn/trigger` bare label in CLAUDE.md | `@psn/trigger/*` wildcard label | This phase | Prevents agent/developer import errors |

**Deprecated/outdated:**
- Local type re-derivation in trigger files: replaced by importing from `@psn/core/types/publisher.ts`

---

## Open Questions

1. **Is `createHubConnection` used anywhere else in publish-helpers.ts?**
   - What we know: It appears on line 5, and the only identifiable use was the `DbConnection` type derivation on line 8.
   - What's unclear: There are no other obvious usages in the 119-line file, but the planner should verify before removing.
   - Recommendation: Run a quick search for `createHubConnection` in the file before removing the import. If it only appears on line 5, remove it.

2. **Does `PostSubStatus` need additional members beyond `"partial_failure"`?**
   - What we know: The comment on `db/schema.ts` line 150 lists: "retry_1, rate_limited, media_uploading, etc." All current values in publish-post.ts are already in the union except `"partial_failure"`.
   - What's unclear: Whether any other code paths write unlisted subStatus values.
   - Recommendation: Grep for `.subStatus` assignments in the src/ directory during execution to confirm no other values are missing. This phase only needs to add `"partial_failure"` per the success criteria.

---

## Sources

### Primary (HIGH confidence)
- Direct file inspection: `src/trigger/publish-helpers.ts` — lines 8–9 confirmed local type re-declarations
- Direct file inspection: `src/core/types/publisher.ts` — DbConnection and PostRow already exported with JSDoc
- Direct file inspection: `src/core/types/index.ts` — PostSubStatus union confirmed missing `"partial_failure"`
- Direct file inspection: `CLAUDE.md` line 21 — `@psn/trigger` bare alias confirmed
- Direct file inspection: `tsconfig.json` paths — `@psn/trigger/*` wildcard only, no bare form
- Direct file inspection: `src/core/db/schema.ts` line 150 — `subStatus` is `text()`, no enum constraint
- `bun run typecheck` output — 24 pre-existing errors, all in `src/voice/interview.ts`
- `.planning/v1.2-MILESTONE-AUDIT.md` — tech debt items documented with precise file/line references

### Secondary (MEDIUM confidence)
- `.planning/STATE.md` decision [22-02]: "No bare @psn/trigger alias — src/trigger/index.ts barrel does not exist yet" — confirms CLAUDE.md fix is documentation-only

### Tertiary (LOW confidence)
- None

---

## Metadata

**Confidence breakdown:**
- Standard stack: HIGH — no new libraries; all tools already installed and verified
- Architecture: HIGH — all three changes are surgical, verified against actual file contents
- Pitfalls: HIGH — derived from direct inspection of actual code paths and tsconfig settings

**Research date:** 2026-02-27
**Valid until:** 2026-03-28 (stable internal refactor — no external dependencies)
