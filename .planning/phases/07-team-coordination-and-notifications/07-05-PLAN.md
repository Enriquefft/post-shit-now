---
phase: 07-team-coordination-and-notifications
plan: 05
type: execute
wave: 5
depends_on: [07-02, 07-03, 07-04]
files_modified:
  - .claude/commands/psn/approve.md
  - .claude/commands/psn/calendar.md
  - .claude/commands/psn/setup.md
  - src/cli/setup.ts
autonomous: true
requirements: [TEAM-06, TEAM-08, CONFIG-05, CONFIG-06]

must_haves:
  truths:
    - "/psn:approve shows pending company posts with context and lets admin approve/reject/edit"
    - "/psn:calendar shows unified hub-grouped calendar with Personal + Company Hubs"
    - "/psn:setup hub creates a Company Hub with guided provisioning"
    - "/psn:setup join accepts invite bundle and connects to Company Hub"
    - "/psn:setup disconnect cleanly removes a Company Hub connection"
  artifacts:
    - path: ".claude/commands/psn/approve.md"
      provides: "Slash command for content approval workflow"
      exports: []
    - path: ".claude/commands/psn/calendar.md"
      provides: "Slash command for unified multi-hub calendar"
      exports: []
    - path: ".claude/commands/psn/setup.md"
      provides: "Updated setup command with hub/join/disconnect subcommands"
      exports: []
  key_links:
    - from: ".claude/commands/psn/approve.md"
      to: "src/approval/workflow.ts"
      via: "listPendingApprovals, approvePost, rejectPost"
      pattern: "approve.*reject"
    - from: ".claude/commands/psn/calendar.md"
      to: "src/approval/calendar.ts"
      via: "getUnifiedCalendar, claimSlot"
      pattern: "getUnifiedCalendar"
    - from: ".claude/commands/psn/setup.md"
      to: "src/cli/setup-company-hub.ts"
      via: "setupCompanyHub, setupJoinHub, setupDisconnect"
      pattern: "hub.*join.*disconnect"
---

<objective>
Create the slash commands that expose Phase 7 functionality: /psn:approve for content approval, /psn:calendar for unified calendar, and updated /psn:setup for Company Hub operations.

Purpose: Give users the command-line interface to interact with team coordination, approval workflows, and multi-hub calendar.
Output: Three slash command definition files that Claude Code uses to orchestrate the underlying modules.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-team-coordination-and-notifications/07-RESEARCH.md
@.planning/phases/07-team-coordination-and-notifications/07-CONTEXT.md
@.planning/phases/07-team-coordination-and-notifications/07-01-PLAN.md
@.planning/phases/07-team-coordination-and-notifications/07-02-PLAN.md
@.planning/phases/07-team-coordination-and-notifications/07-03-PLAN.md
@.planning/phases/07-team-coordination-and-notifications/07-04-PLAN.md

# Existing slash commands (pattern to follow)
@.claude/commands/psn/post.md
@.claude/commands/psn/review.md
@.claude/commands/psn/plan.md
@.claude/commands/psn/setup.md
@.claude/commands/psn/capture.md
@.claude/commands/psn/series.md

# Modules to orchestrate
@src/approval/workflow.ts
@src/approval/calendar.ts
@src/team/hub.ts
@src/team/invite.ts
@src/team/members.ts
@src/cli/setup.ts
@src/cli/setup-company-hub.ts
@src/cli/setup-join.ts
@src/cli/setup-disconnect.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: /psn:approve slash command</name>
  <files>
    .claude/commands/psn/approve.md
  </files>
  <action>
    Create `.claude/commands/psn/approve.md`:

    The command should follow the same pattern as existing slash commands (post.md, review.md).

    Command: `/psn:approve [action] [postId]`

    Actions:
    - (no action) or `list`: Show all pending approvals across connected Company Hubs
    - `view <postId>`: Show full post details with content, author, platform, scheduled time
    - `approve <postId> [comment]`: Approve a pending post with optional comment
    - `reject <postId> [reason]`: Reject a pending post with reason
    - `edit <postId>`: Open post content for editing, then approve the edited version
    - `stats`: Show approval statistics (pending, approved today, rejected today)

    Flow for `list` (default):
    1. Discover all Company Hubs from .hubs/ directory
    2. For each hub, call listPendingApprovals()
    3. Display grouped by hub:
       ```
       Company: Acme Corp (3 pending)
       ────────────────────────────
       1. [X] "5 AI tools every dev needs" by @john - scheduled 2:00 PM today
       2. [LinkedIn] "Q1 Retrospective" by @sarah - scheduled tomorrow 9:00 AM
       3. [X, LinkedIn] "New feature launch" by @mike - no schedule yet

       Company: StartupCo (1 pending)
       ────────────────────────────
       4. [X] "Hiring announcement" by @alex - scheduled Friday 10:00 AM
       ```
    4. Ask: "Enter a number to review, or an action (approve/reject #)"

    Flow for `approve`:
    1. Load post from Company Hub DB
    2. Show content preview and ask for confirmation
    3. Call approvePost() with reviewer = current user
    4. Trigger notification dispatch to author (approval.result event)
    5. Confirm: "Post approved. It will publish at {scheduledAt}."

    Flow for `reject`:
    1. Load post from Company Hub DB
    2. Show content preview
    3. Ask for rejection reason (required for good communication)
    4. Call rejectPost() with reviewer and comment
    5. Trigger notification dispatch to author
    6. Confirm: "Post rejected. Author will be notified."

    Flow for `edit`:
    1. Load post content from Company Hub DB
    2. Present content for editing (Claude assists with edits)
    3. Show diff between original and edited
    4. Call approvePost() with editedContent
    5. Track edit in edit_history (same Phase 3 pattern)
    6. Trigger notification to author showing edits
    7. Confirm: "Post edited and approved."

    Include the standard CLI patterns:
    - Read hub connections from .hubs/
    - Authenticate as current user
    - JSON output from CLI scripts interpreted by Claude
    - Error handling for no pending approvals, unauthorized access, etc.
  </action>
  <verify>
    Verify the command file follows the same markdown structure as existing commands (post.md, review.md). Verify all actions are documented.
  </verify>
  <done>
    /psn:approve command covers list, view, approve, reject, edit actions. Grouped by Company Hub. Notifications dispatched on approval/rejection.
  </done>
</task>

<task type="auto">
  <name>Task 2: /psn:calendar slash command</name>
  <files>
    .claude/commands/psn/calendar.md
  </files>
  <action>
    Create `.claude/commands/psn/calendar.md`:

    Command: `/psn:calendar [action] [options]`

    Actions:
    - (no action): Show this week's unified calendar
    - `week [date]`: Show a specific week's calendar
    - `claim <hubSlug> <datetime> <platform>`: Claim a time slot in a Company Hub
    - `release <postId>`: Release a claimed slot
    - `available <hubSlug>`: Show available slots for a Company Hub

    Flow for default (this week's calendar):
    1. Discover Personal Hub and all Company Hub connections
    2. Call getUnifiedCalendar() with this week's date range
    3. Display hub-grouped calendar:
       ```
       Personal Hub
       ═══════════════════════════════
       Mon 2/17  10:00 AM  [X]      "Thread about AI testing"     Published ✓
       Tue 2/18   2:00 PM  [X, LI]  "React patterns carousel"    Scheduled
       Thu 2/20   9:00 AM  [X]      "Quick tip: TypeScript 5.8"  Draft

       Acme Corp
       ═══════════════════════════════
       Mon 2/17  11:00 AM  [LI]     "Company Q1 update"          Published ✓
       Wed 2/19   3:00 PM  [X, LI]  "Product launch teaser"      [Pending Approval]
       Fri 2/21   9:00 AM  [X]      — Available slot —

       StartupCo
       ═══════════════════════════════
       Tue 2/18   1:00 PM  [X]      "Feature spotlight"          [Approved]
       ```
    4. Show summary: "12 posts this week: 5 published, 4 scheduled, 2 pending approval, 1 available slot"

    Flow for `claim`:
    1. Validate the hub slug, datetime, and platform
    2. Call claimSlot() with concurrency protection
    3. Confirm: "Slot claimed: {hub} - {datetime} - {platform}. Start drafting with /psn:post"

    Flow for `available`:
    1. Call getAvailableSlots() for the specified hub
    2. Show available times grouped by day
    3. Suggest: "Claim a slot with /psn:calendar claim {hub} {datetime} {platform}"

    Visual indicators:
    - Published: ✓
    - Scheduled: (no badge, implied by time being set)
    - Draft: (shown as "Draft")
    - Pending Approval: [Pending]
    - Approved: [Approved]
    - Rejected: [Rejected]
    - Available: "— Available slot —"

    Cross-hub overlap handling:
    - Per CONTEXT.md: allow overlap between hubs (different audiences)
    - Within same hub: show warning if two posts at same time/platform
  </action>
  <verify>
    Verify the command file follows existing slash command patterns. Verify all actions documented. Verify visual indicators match approval statuses.
  </verify>
  <done>
    /psn:calendar shows unified hub-grouped calendar with approval status badges. Slot claiming with available slot discovery. Cross-hub overlap allowed.
  </done>
</task>

<task type="auto">
  <name>Task 3: Update /psn:setup with hub/join/disconnect subcommands</name>
  <files>
    .claude/commands/psn/setup.md
    src/cli/setup.ts
  </files>
  <action>
    Update `.claude/commands/psn/setup.md`:

    Add new subcommands to the existing setup command:

    `/psn:setup` — existing personal hub setup (unchanged)
    `/psn:setup hub` — create a new Company Hub
    `/psn:setup join <invite_bundle>` — join a Company Hub with invite bundle
    `/psn:setup disconnect <slug>` — disconnect from a Company Hub
    `/psn:setup invite <slug>` — generate an invite code for a Company Hub (admin only)
    `/psn:setup team <slug>` — list team members of a Company Hub
    `/psn:setup promote <slug> <userId>` — promote a member to admin (admin only)
    `/psn:setup notifications` — configure WhatsApp notification preferences

    Flow for `hub`:
    1. Ask for company name and slug
    2. Verify Neon API key is available
    3. Call setupCompanyHub()
    4. Show: "Company Hub created: {name} ({slug})"
    5. Show: "Generate invite codes with /psn:setup invite {slug}"

    Flow for `join`:
    1. Receive invite bundle (base64 JSON string shared by admin)
    2. Decode and validate bundle
    3. Call setupJoinHub()
    4. Show: "Joined {hubName} as member. Connection saved to .hubs/company-{slug}.json"

    Flow for `disconnect`:
    1. Show connected Company Hubs
    2. Confirm disconnection
    3. Call setupDisconnect()
    4. Show: "Disconnected from {hubName}. Your published content is preserved."

    Flow for `invite`:
    1. Verify current user is admin of the hub
    2. Call generateInviteCode()
    3. Generate invite bundle (base64 encode connection details + code)
    4. Show: "Share this invite bundle with the team member:\n{base64_bundle}\nExpires in 48 hours. One-time use."

    Flow for `team`:
    1. Call listTeamMembers()
    2. Display: "@user (admin) - joined Feb 17" / "@user2 (member) - joined Feb 18"

    Flow for `notifications`:
    1. Ask for WhatsApp provider (WAHA or Twilio)
    2. Ask for phone number
    3. Configure provider settings (WAHA URL or Twilio credentials)
    4. Set notification preferences: push enabled, digest frequency, quiet hours
    5. Send test message to verify connection
    6. Save preferences to notification_preferences table and whatsapp_sessions table

    Update `src/cli/setup.ts`:
    - Add subcommand argument parsing
    - Route to appropriate setup function based on subcommand
    - Default (no subcommand) = existing personal hub setup
  </action>
  <verify>
    Verify setup.md documents all subcommands. Verify setup.ts routes subcommands correctly. Run `pnpm exec tsc --noEmit`.
  </verify>
  <done>
    /psn:setup extended with hub/join/disconnect/invite/team/promote/notifications subcommands. Full Company Hub lifecycle from creation through team management to notification configuration.
  </done>
</task>

</tasks>

<verification>
- [ ] /psn:approve lists pending approvals grouped by Company Hub
- [ ] /psn:approve approve/reject dispatches notifications to post author
- [ ] /psn:approve edit tracks edits in edit_history
- [ ] /psn:calendar shows hub-grouped unified calendar
- [ ] /psn:calendar claim uses concurrency-safe slot claiming
- [ ] /psn:setup hub creates Company Hub and generates connection file
- [ ] /psn:setup join redeems invite bundle and saves connection file
- [ ] /psn:setup disconnect soft-deletes member and removes connection file
- [ ] /psn:setup invite generates secure invite bundle (admin only)
- [ ] /psn:setup notifications configures WhatsApp provider and preferences
- [ ] All command files follow existing slash command markdown patterns
</verification>

<success_criteria>
- All Phase 7 functionality is accessible through slash commands
- Commands follow the same patterns as existing /psn: commands
- Approval workflow is complete: list, view, approve, reject, edit
- Calendar shows all hubs with approval status badges
- Setup supports full Company Hub lifecycle
- Notification configuration is guided and testable
</success_criteria>

<output>
After completion, create `.planning/phases/07-team-coordination-and-notifications/07-05-SUMMARY.md`
</output>
