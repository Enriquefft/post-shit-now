---
phase: 07-team-coordination-and-notifications
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/core/db/schema.ts
  - src/core/types/index.ts
  - src/team/types.ts
  - src/approval/types.ts
  - src/notifications/types.ts
autonomous: true
requirements: [TEAM-01, TEAM-02, TEAM-03, TEAM-04, NOTIF-06, NOTIF-07, LEARN-09, SERIES-07]

must_haves:
  truths:
    - "team_members table exists with userId, hubId, role (admin/member), joinedAt, and RLS policy"
    - "invite_codes table exists with one-time-use codes, 48h expiry, and redemption tracking"
    - "Posts table has approval columns (approvalStatus, reviewerId, reviewComment, reviewedAt) for company workflow"
    - "notification_preferences table stores per-user tier config, frequency, and quiet hours"
    - "notification_log table tracks sent notifications for fatigue prevention and dedup"
    - "whatsapp_sessions table stores per-user phone, provider, session state"
  artifacts:
    - path: "src/core/db/schema.ts"
      provides: "Extended schema with team_members, invite_codes, notification_preferences, notification_log, whatsapp_sessions tables"
      exports: ["teamMembers", "inviteCodes", "notificationPreferences", "notificationLog", "whatsappSessions"]
    - path: "src/team/types.ts"
      provides: "Team types: HubConnection, HubRole, InviteCode, TeamMember"
      exports: ["HubConnection", "HubRole", "TeamMember", "InviteCodeSchema"]
    - path: "src/approval/types.ts"
      provides: "Approval types: ApprovalStatus, ApprovalTransition, ApprovalAction"
      exports: ["ApprovalStatus", "APPROVAL_TRANSITIONS", "ApprovalAction"]
    - path: "src/notifications/types.ts"
      provides: "Notification types: NotificationTier, NotificationEvent, WhatsAppProvider interface"
      exports: ["NotificationTier", "NotificationEvent", "WhatsAppProvider", "NOTIFICATION_ROUTES"]
  key_links:
    - from: "src/core/db/schema.ts"
      to: "src/team/types.ts"
      via: "TeamMember and HubRole types align with team_members schema"
      pattern: "role.*admin.*member"
    - from: "src/core/db/schema.ts"
      to: "src/notifications/types.ts"
      via: "Notification tables align with tier/event types"
      pattern: "notification_preferences.*notification_log"
---

<objective>
Extend the database schema with all team coordination and notification tables, and define the foundational types for Phase 7 subsystems.

Purpose: Establish the data layer and type system that all subsequent Phase 7 plans depend on. Every table needs RLS policies for multi-tenant isolation.
Output: Schema extensions (team_members, invite_codes, notification tables), approval columns on posts, and typed interfaces for team/approval/notification domains.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-team-coordination-and-notifications/07-RESEARCH.md
@.planning/phases/07-team-coordination-and-notifications/07-CONTEXT.md

# Existing schema and types (patterns to extend)
@src/core/db/schema.ts
@src/core/types/index.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Team and notification type definitions</name>
  <files>
    src/team/types.ts
    src/approval/types.ts
    src/notifications/types.ts
  </files>
  <action>
    Create `src/team/types.ts`:
    - `HubRole` type: `'admin' | 'member'`
    - `HubConnection` interface: `{ hubId: string; slug: string; displayName: string; databaseUrl: string; triggerProjectId: string; role: HubRole; joinedAt: string; encryptionKey?: string }`
    - `HubConnectionSchema` Zod schema validating HubConnection for safe JSON parsing from connection files
    - `TeamMember` interface: `{ id: string; userId: string; hubId: string; role: HubRole; displayName?: string; email?: string; joinedAt: Date; leftAt?: Date }`
    - `InviteCode` interface: `{ id: string; hubId: string; code: string; createdBy: string; expiresAt: Date; usedBy?: string; usedAt?: Date }`

    Create `src/approval/types.ts`:
    - `ApprovalStatus` type: `'draft' | 'submitted' | 'approved' | 'rejected'`
    - `APPROVAL_TRANSITIONS` const object mapping each status to allowed next statuses:
      - draft -> ['submitted']
      - submitted -> ['approved', 'rejected']
      - approved -> ['scheduled', 'published'] (these are existing post statuses)
      - rejected -> ['draft'] (author can re-edit and re-submit)
    - `ApprovalAction` interface: `{ postId: string; action: 'submit' | 'approve' | 'reject'; reviewerId?: string; comment?: string; edits?: string }`
    - `isValidTransition(current: string, next: string): boolean` function using APPROVAL_TRANSITIONS

    Create `src/notifications/types.ts`:
    - `NotificationTier` type: `'push' | 'digest' | 'standard'`
    - `NotificationEventType` type union: `'approval.requested' | 'approval.result' | 'post.failed' | 'post.published' | 'post.viral' | 'token.expiring' | 'digest.daily' | 'digest.weekly' | 'schedule.reminder'`
    - `NOTIFICATION_ROUTES` const mapping each event type to its tier:
      - approval.requested -> push
      - post.failed -> push
      - token.expiring -> push
      - post.viral -> push
      - approval.result -> standard
      - post.published -> standard
      - schedule.reminder -> standard
      - digest.daily -> digest
      - digest.weekly -> digest
    - `NotificationEvent` interface: `{ type: NotificationEventType; userId: string; hubId?: string; payload: Record<string, unknown>; createdAt: Date }`
    - `WhatsAppProvider` interface:
      - `sendText(to: string, body: string): Promise<MessageResult>`
      - `sendButtons(to: string, body: string, buttons: Array<{ id: string; body: string }>): Promise<MessageResult>`
      - `sendList(to: string, body: string, sections: Array<{ title: string; rows: Array<{ id: string; title: string; description?: string }> }>): Promise<MessageResult>`
      - `sendImage(to: string, imageUrl: string, caption?: string): Promise<MessageResult>`
    - `MessageResult` interface: `{ success: boolean; messageId?: string; error?: string }`
    - `NotificationPreference` interface: `{ userId: string; provider: 'waha' | 'twilio'; pushEnabled: boolean; digestEnabled: boolean; digestFrequency: 'daily' | 'twice_daily' | 'weekly'; digestTime: string; quietHoursStart?: string; quietHoursEnd?: string; maxPushPerDay: number }`
    - `FATIGUE_LIMITS` const: `{ maxPushPerDay: 3, cooldownMinutes: 120, dedupWindowMinutes: 30, defaultQuietStart: '22:00', defaultQuietEnd: '08:00' }`
  </action>
  <verify>
    Run `pnpm exec tsc --noEmit` to verify all type files compile. Check no circular imports.
  </verify>
  <done>
    Team, approval, and notification type systems defined with Zod validation for connection files. APPROVAL_TRANSITIONS encodes the state machine. WhatsAppProvider interface abstracts WAHA/Twilio.
  </done>
</task>

<task type="auto">
  <name>Task 2: Schema extensions for team coordination tables</name>
  <files>
    src/core/db/schema.ts
    src/core/types/index.ts
  </files>
  <action>
    Extend `src/core/db/schema.ts` with the following tables:

    1. `teamMembers` table:
       - id: uuid primary key
       - userId: text not null (references the member's external user ID)
       - hubId: text not null (identifies which Company Hub)
       - role: text not null default 'member' (admin | member)
       - displayName: text (optional, for team visibility)
       - email: text (optional)
       - joinedAt: timestamp with timezone, default now
       - leftAt: timestamp with timezone (null = active member)
       - createdAt, updatedAt timestamps
       - RLS policy: `team_members_isolation` â€” user can see own record OR all records if they are a member of the same hubId:
         `userId = current_setting('app.current_user_id') OR hubId IN (SELECT hub_id FROM team_members WHERE user_id = current_setting('app.current_user_id') AND left_at IS NULL)`
       - Unique index on (userId, hubId) to prevent duplicate joins

    2. `inviteCodes` table:
       - id: uuid primary key
       - hubId: text not null
       - code: text not null unique
       - createdBy: text not null (admin who generated)
       - expiresAt: timestamp with timezone not null
       - usedBy: text (null until redeemed)
       - usedAt: timestamp with timezone (null until redeemed)
       - createdAt timestamp
       - NO RLS policy (invite codes are validated server-side, not user-scoped)

    3. Add approval columns to `posts` table:
       - approvalStatus: text (null for personal posts, 'draft' | 'submitted' | 'approved' | 'rejected' for company posts)
       - reviewerId: text (admin who approved/rejected)
       - reviewComment: text (rejection reason or approval note)
       - reviewedAt: timestamp with timezone
       - Note: These are NEW columns added to the existing posts table definition, NOT a separate table

    4. `notificationPreferences` table:
       - id: uuid primary key
       - userId: text not null unique
       - provider: text not null default 'waha' (waha | twilio)
       - pushEnabled: integer not null default 1 (boolean as int)
       - digestEnabled: integer not null default 1
       - digestFrequency: text not null default 'daily' (daily | twice_daily | weekly)
       - digestTime: text not null default '08:00' (HH:MM in user's timezone)
       - quietHoursStart: text (HH:MM, null = no quiet hours)
       - quietHoursEnd: text
       - maxPushPerDay: integer not null default 3
       - timezone: text not null default 'UTC'
       - createdAt, updatedAt timestamps
       - RLS policy: user_id isolation (same pattern as other tables)

    5. `notificationLog` table:
       - id: uuid primary key
       - userId: text not null
       - eventType: text not null
       - tier: text not null (push | digest | standard)
       - provider: text not null (waha | twilio)
       - recipient: text not null (phone number)
       - status: text not null default 'pending' (pending | sent | failed | skipped)
       - messageId: text (provider's message ID)
       - error: text
       - dedupKey: text (for dedup within window)
       - sentAt: timestamp with timezone
       - createdAt timestamp
       - RLS policy: user_id isolation

    6. `whatsappSessions` table:
       - id: uuid primary key
       - userId: text not null unique
       - phone: text not null
       - provider: text not null (waha | twilio)
       - sessionState: text not null default 'inactive' (inactive | active | expired)
       - conversationContext: jsonb (current active notification context for structured commands)
       - lastActivityAt: timestamp with timezone
       - createdAt, updatedAt timestamps
       - RLS policy: user_id isolation

    Update `src/core/types/index.ts`:
    - Export the new HubConnection type from team/types.ts
    - Export NotificationTier and WhatsAppProvider from notifications/types.ts
    - Export ApprovalStatus from approval/types.ts
  </action>
  <verify>
    Run `pnpm exec tsc --noEmit` to verify schema compiles. Verify all new tables have RLS policies (except inviteCodes). Verify posts table has new approval columns.
  </verify>
  <done>
    Schema extended with 5 new tables (teamMembers, inviteCodes, notificationPreferences, notificationLog, whatsappSessions) and 4 new columns on posts. All tables have RLS policies. Types re-exported from core.
  </done>
</task>

</tasks>

<verification>
- [ ] `pnpm exec tsc --noEmit` passes with all new schema tables and type files
- [ ] team_members table has unique index on (userId, hubId)
- [ ] invite_codes table has unique index on code
- [ ] Posts table has approvalStatus, reviewerId, reviewComment, reviewedAt columns
- [ ] All new tables (except inviteCodes) have RLS policies
- [ ] APPROVAL_TRANSITIONS correctly models the state machine
- [ ] WhatsAppProvider interface defines sendText, sendButtons, sendList, sendImage
- [ ] NOTIFICATION_ROUTES maps all event types to correct tiers
- [ ] FATIGUE_LIMITS defines caps for push, cooldown, and dedup
</verification>

<success_criteria>
- All team coordination tables compile and follow existing RLS patterns
- Posts table extended with approval workflow columns
- Type system covers team, approval, and notification domains
- No new dependencies required (all built-in types)
- Schema is backward compatible (new columns are nullable, new tables are additive)
</success_criteria>

<output>
After completion, create `.planning/phases/07-team-coordination-and-notifications/07-01-SUMMARY.md`
</output>
