---
phase: 07-team-coordination-and-notifications
plan: 03
type: execute
wave: 3
depends_on: [07-01, 07-02]
files_modified:
  - src/approval/workflow.ts
  - src/approval/calendar.ts
  - src/trigger/publish-post.ts
  - src/learning/feedback.ts
autonomous: true
requirements: [TEAM-05, TEAM-08, TEAM-09, LEARN-09, SERIES-07]

must_haves:
  truths:
    - "Company posts transition through approval states: draft -> submitted -> approved/rejected with guard conditions"
    - "Only admins can approve or reject submitted posts"
    - "Tentatively scheduled posts skip (not fail) if unapproved at scheduled time"
    - "Calendar merges Personal Hub and all connected Company Hubs into hub-grouped sections"
    - "Company Hub has a shared brand preference model for team-wide learning"
  artifacts:
    - path: "src/approval/workflow.ts"
      provides: "Approval state machine: submit, approve, reject, with admin authorization"
      exports: ["submitForApproval", "approvePost", "rejectPost", "getApprovalStatus", "listPendingApprovals"]
    - path: "src/approval/calendar.ts"
      provides: "Multi-hub calendar merging, slot claiming, conflict checking"
      exports: ["getUnifiedCalendar", "claimSlot", "releaseSlot", "getAvailableSlots"]
    - path: "src/trigger/publish-post.ts"
      provides: "Extended publish-post with approval check before publishing"
      exports: ["publishPost"]
  key_links:
    - from: "src/approval/workflow.ts"
      to: "src/team/members.ts"
      via: "isAdmin check for approve/reject authorization"
      pattern: "isAdmin"
    - from: "src/approval/workflow.ts"
      to: "src/core/db/schema.ts"
      via: "posts table approval columns"
      pattern: "approvalStatus.*reviewerId"
    - from: "src/trigger/publish-post.ts"
      to: "src/approval/workflow.ts"
      via: "Approval check before publish"
      pattern: "approvalStatus.*approved"
---

<objective>
Build the approval workflow engine, multi-hub calendar system, and extend publish-post with approval gates. Company posts go through admin review before publishing.

Purpose: Enable team coordination through structured content approval and unified calendar visibility across all connected hubs.
Output: Approval state machine, calendar merging with slot claiming, publish-post approval gate, company brand preference model.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/07-team-coordination-and-notifications/07-RESEARCH.md
@.planning/phases/07-team-coordination-and-notifications/07-CONTEXT.md
@.planning/phases/07-team-coordination-and-notifications/07-01-PLAN.md
@.planning/phases/07-team-coordination-and-notifications/07-02-PLAN.md

# Existing modules to extend
@src/trigger/publish-post.ts
@src/learning/feedback.ts
@src/core/db/schema.ts
@src/team/types.ts
@src/team/members.ts
@src/approval/types.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Approval workflow state machine</name>
  <files>
    src/approval/workflow.ts
  </files>
  <action>
    Create `src/approval/workflow.ts`:

    `submitForApproval(db, params: { postId: string; userId: string; hubId: string }): Promise<{ success: boolean; error?: string }>`:
    - Verify post exists and belongs to userId
    - Verify post is in 'draft' status (or approvalStatus is 'draft' or null)
    - Verify isValidTransition(current, 'submitted')
    - UPDATE posts SET approvalStatus = 'submitted', updatedAt = NOW() WHERE id = postId
    - Return { success: true }
    - Note: This function does NOT dispatch notifications — the caller (slash command) triggers notification dispatch separately

    `approvePost(db, params: { postId: string; reviewerId: string; hubId: string; comment?: string; editedContent?: string }): Promise<{ success: boolean; error?: string }>`:
    - Verify reviewer isAdmin(db, { userId: reviewerId, hubId })
    - Verify post approvalStatus = 'submitted' (can't approve a draft or already-approved post)
    - If editedContent provided:
      - Update posts.content = editedContent
      - Track the edit in edit_history table (same pattern as user edits in Phase 3)
    - UPDATE posts SET approvalStatus = 'approved', reviewerId, reviewComment = comment, reviewedAt = NOW()
    - If post has scheduledAt and scheduledAt > NOW(), post proceeds to scheduled status as normal
    - Return { success: true }

    `rejectPost(db, params: { postId: string; reviewerId: string; hubId: string; comment?: string }): Promise<{ success: boolean; error?: string }>`:
    - Verify reviewer isAdmin(db, { userId: reviewerId, hubId })
    - Verify post approvalStatus = 'submitted'
    - UPDATE posts SET approvalStatus = 'rejected', reviewerId, reviewComment = comment, reviewedAt = NOW()
    - Note: Author can edit and re-submit (rejected -> draft -> submitted)
    - Return { success: true }

    `resubmitPost(db, params: { postId: string; userId: string }): Promise<{ success: boolean; error?: string }>`:
    - Verify post belongs to userId and approvalStatus = 'rejected'
    - UPDATE posts SET approvalStatus = 'draft', reviewerId = NULL, reviewComment = NULL, reviewedAt = NULL
    - Author can then edit and call submitForApproval again

    `getApprovalStatus(db, postId: string): Promise<{ approvalStatus: string | null; reviewerId?: string; reviewComment?: string; reviewedAt?: Date } | null>`:
    - SELECT approval columns from posts WHERE id = postId
    - Returns null if post not found

    `listPendingApprovals(db, hubId: string): Promise<Array<{ postId: string; userId: string; content: string; platform: string; scheduledAt?: Date; submittedAt: Date }>>`:
    - SELECT from posts WHERE approvalStatus = 'submitted' AND metadata->>'hubId' = hubId
    - Order by scheduledAt ASC (most urgent first — approaching scheduled time)
    - Include content preview, author, platform, and scheduled time for admin review context

    `getApprovalStats(db, hubId: string): Promise<{ pending: number; approvedToday: number; rejectedToday: number }>`:
    - Count posts by approvalStatus for the hub, with today's approved/rejected counts
    - Used in calendar and digest views
  </action>
  <verify>
    Run `pnpm exec tsc --noEmit`. Verify all state transitions check isValidTransition. Verify approvePost checks isAdmin.
  </verify>
  <done>
    Approval workflow implements full state machine: submit -> approve/reject with admin authorization. Admins can edit-and-approve. Rejected posts return to draft for re-submission.
  </done>
</task>

<task type="auto">
  <name>Task 2: Multi-hub calendar and slot claiming</name>
  <files>
    src/approval/calendar.ts
  </files>
  <action>
    Create `src/approval/calendar.ts`:

    `getUnifiedCalendar(params: { personalDb: DrizzleClient; companyHubs: Array<{ connection: HubConnection; db: DrizzleClient }>; userId: string; startDate: Date; endDate: Date }): Promise<UnifiedCalendar>`:
    - Query Personal Hub for posts in date range (all statuses except failed)
    - Query each Company Hub for posts in date range (all team posts, not just user's)
    - Group by hub: { personal: CalendarEntry[], companies: Record<string, CalendarEntry[]> }
    - CalendarEntry: { postId, userId, displayName, platform, content (truncated), status, approvalStatus, scheduledAt, publishedAt }
    - Sort each group by scheduledAt ASC
    - Return: { personal: { entries, stats }, companies: { [slug]: { entries, stats, hubName } } }

    `getAvailableSlots(db, params: { hubId: string; startDate: Date; endDate: Date; platform?: string }): Promise<TimeSlot[]>`:
    - Determine "slots" based on the hub's strategy.yaml optimal posting times for each platform
    - A slot is "available" if no post is scheduled at that time for that platform
    - Return available TimeSlot[]: { dateTime: Date, platform: string, suggested: boolean }

    `claimSlot(db, params: { userId: string; hubId: string; dateTime: Date; platform: string }): Promise<{ success: boolean; error?: string }>`:
    - Check no existing scheduled post at that time for that platform in the hub
    - Create a placeholder post: { userId, platform, content: '', status: 'draft', scheduledAt: dateTime, metadata: { hubId, slotClaimed: true } }
    - Return { success: true }
    - Concurrency: use a SELECT FOR UPDATE on the time window to prevent double-claiming

    `releaseSlot(db, params: { postId: string; userId: string }): Promise<void>`:
    - Delete the placeholder post IF it's still a draft with slotClaimed metadata
    - Only the claimer or an admin can release

    `CalendarStats` interface: `{ totalScheduled: number; pendingApproval: number; published: number; drafts: number }`

    Helper: `formatCalendarForCli(calendar: UnifiedCalendar): string`:
    - Render hub-grouped calendar as structured text for Claude to present
    - Personal section first, then each company section
    - Each entry: `[TIME] [PLATFORM] [STATUS] "content preview..." (by @author)`
    - Company entries show approval status badge: [Pending], [Approved], [Rejected]
  </action>
  <verify>
    Run `pnpm exec tsc --noEmit`. Verify getUnifiedCalendar queries multiple hubs independently. Verify claimSlot uses SELECT FOR UPDATE for concurrency.
  </verify>
  <done>
    Unified calendar merges Personal Hub + Company Hubs with hub-grouped sections. Slot claiming with concurrency protection. Calendar formatted for CLI output.
  </done>
</task>

<task type="auto">
  <name>Task 3: Extend publish-post with approval gate and company brand preference model</name>
  <files>
    src/trigger/publish-post.ts
    src/learning/feedback.ts
  </files>
  <action>
    Extend `src/trigger/publish-post.ts`:

    1. Add approval check at the beginning of the publish flow:
       - If post has metadata.hubId (company post), check approvalStatus
       - If approvalStatus is not 'approved' and scheduledAt has arrived:
         - If approvalStatus is 'submitted': skip publish, update status to 'draft', add metadata.skippedReason = 'Unapproved at scheduled time'
         - Log: "Company post skipped: not approved by scheduled time"
         - This implements "tentative scheduling" per CONTEXT.md
       - If approvalStatus is 'approved': proceed with normal publish flow
       - If post has no hubId (personal post): proceed as before (no approval needed)

    2. After successful company post publish:
       - Update the company hub's brand preference model (if exists)
       - This is a lightweight extension: check if post has hubId, if so, connect to Company Hub DB and update the shared preference_model record

    Extend `src/learning/feedback.ts` (or create brand learning module):

    `updateBrandPreferenceModel(companyDb, params: { postId: string; platform: string; format: string; pillar: string })`:
    - Similar to personal preference model update but scoped to Company Hub
    - Brand preference model tracks: team-wide top formats, top pillars, best posting times
    - Shared across all team members — any member's successful post contributes
    - Uses the same preference_model table schema but in the Company Hub DB
    - If no preference_model record exists for the hub, create one with userId = hubId (company-level)

    Company-scoped series support:
    - Verify that series with hubId set route to Company Hub DB for state tracking
    - Series contributor rotation: series.metadata can include `contributors: string[]` and `nextContributor: number` for round-robin assignment
    - This is a lightweight extension to the existing series module
  </action>
  <verify>
    Run `pnpm exec tsc --noEmit`. Verify publish-post skips unapproved company posts (not fails them). Verify brand preference model writes to Company Hub DB.
  </verify>
  <done>
    Publish-post gates on approval status for company posts — tentatively scheduled posts skip if unapproved. Brand preference model in Company Hub DB shared across team members. Series support contributor rotation for company-scoped series.
  </done>
</task>

</tasks>

<verification>
- [ ] `pnpm exec tsc --noEmit` passes
- [ ] Approval transitions validated by isValidTransition before every state change
- [ ] Only admins can approve/reject (isAdmin check)
- [ ] Tentatively scheduled posts skip (not fail) if unapproved at scheduled time
- [ ] Calendar merges multiple hubs independently (one hub failure doesn't crash the view)
- [ ] Slot claiming uses SELECT FOR UPDATE for concurrency safety
- [ ] Brand preference model writes to Company Hub DB, not Personal Hub
- [ ] Company post publish updates brand preference model
</verification>

<success_criteria>
- Company posts flow through submit -> approve/reject cycle
- Admins can edit content during approval
- Calendar shows hub-grouped view with approval status badges
- Slot claiming prevents double-booking
- Publish-post respects approval status for company posts
- Brand preference model shared across team members
</success_criteria>

<output>
After completion, create `.planning/phases/07-team-coordination-and-notifications/07-03-SUMMARY.md`
</output>
