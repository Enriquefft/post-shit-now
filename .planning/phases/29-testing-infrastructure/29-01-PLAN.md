---
phase: 29-testing-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/platforms/__mocks__/clients.ts
  - src/platforms/__mocks__/fixtures.ts
  - src/core/utils/tweet-validator.test.ts
  - src/core/types/publisher.ts
autonomous: true
requirements: [TEST-01, TEST-02, DOC-03]

must_haves:
  truths:
    - "Mock client classes exist for X, LinkedIn, Instagram, and TikTok that match real client public APIs"
    - "API response fixtures use real X API v2 response shapes (not simplified stubs)"
    - "countTweetChars edge cases are tested (ASCII, emoji, ZWJ, URLs, CJK, mixed content)"
    - "PlatformPublisher interface has JSDoc behavioral contracts (preconditions, postconditions, @throws)"
  artifacts:
    - path: "src/platforms/__mocks__/clients.ts"
      provides: "MockXClient, MockLinkedInClient, MockInstagramClient, MockTikTokClient"
      min_lines: 80
    - path: "src/platforms/__mocks__/fixtures.ts"
      provides: "Real X API response shapes for test data"
      min_lines: 30
    - path: "src/core/utils/tweet-validator.test.ts"
      provides: "countTweetChars and validateTweet edge case tests"
      min_lines: 60
    - path: "src/core/types/publisher.ts"
      provides: "JSDoc behavioral contracts on PlatformPublisher interface"
      contains: "@precondition"
  key_links:
    - from: "src/platforms/__mocks__/clients.ts"
      to: "src/platforms/x/client.ts"
      via: "mirrors public API methods (createTweet, getTimeline)"
      pattern: "createTweet|getTimeline"
    - from: "src/core/utils/tweet-validator.test.ts"
      to: "src/core/utils/tweet-validator.ts"
      via: "imports countTweetChars, validateTweet"
      pattern: "import.*countTweetChars"
---

<objective>
Create mock infrastructure for platform API clients, unit tests for tweet validation, and JSDoc behavioral contracts on platform interfaces.

Purpose: Establish the test foundation (mocks, fixtures, pure-function tests, documentation contracts) that Plan 02 depends on for handler-level integration tests.
Output: Mock client classes, API response fixtures, tweet-validator tests, JSDoc on PlatformPublisher interface.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/29-testing-infrastructure/29-CONTEXT.md
@.planning/phases/29-testing-infrastructure/29-RESEARCH.md

@src/core/types/publisher.ts
@src/platforms/x/client.ts
@src/platforms/x/types.ts
@src/core/utils/tweet-validator.ts
@src/core/types/publisher.test.ts

<interfaces>
<!-- Key types and contracts the executor needs -->

From src/platforms/x/client.ts:
```typescript
export class XClient {
  constructor(accessToken: string)
  async createTweet(params: { text: string; replyToId?: string; mediaIds?: string[] }): Promise<{ id: string; text: string; rateLimit: RateLimitInfo }>
  async getTimeline(params?: { maxResults?: number }): Promise<TimelineResponse>
}
```

From src/platforms/x/types.ts:
```typescript
export interface RateLimitInfo { limit: number; remaining: number; resetAt: Date }
export class XApiError extends Error { statusCode: number; body: unknown }
export class RateLimitError extends XApiError { rateLimit: RateLimitInfo }
export type TimelineResponse = { data: Array<{ id: string; text: string; created_at?: string }>; meta?: { result_count: number; newest_id?: string; oldest_id?: string } }
```

From src/platforms/linkedin/client.ts:
```typescript
export class LinkedInClient { constructor(accessToken: string) }
```

From src/platforms/instagram/client.ts:
```typescript
export class InstagramClient { constructor(accessToken: string, userId: string) }
```

From src/platforms/tiktok/client.ts:
```typescript
export class TikTokClient { constructor(accessToken: string) }
```

From src/core/utils/tweet-validator.ts:
```typescript
export function countTweetChars(text: string): number
export function validateTweet(text: string): TweetValidation
export interface TweetValidation { valid: boolean; charCount: number; maxChars: number; errors: string[]; warnings: string[] }
```
</interfaces>
</context>

<tasks>

<task type="auto" tdd="true">
  <name>Task 1: Create mock client classes and API response fixtures</name>
  <files>src/platforms/__mocks__/clients.ts, src/platforms/__mocks__/fixtures.ts</files>
  <behavior>
    - MockXClient.createTweet returns incrementing tweet IDs with the provided text
    - MockXClient.getTimeline returns previously posted tweets
    - MockXClient.setFailure(error) causes next createTweet call to throw that error
    - MockXClient.clearFailure() restores normal behavior
    - MockXClient.reset() clears all state
    - MockLinkedInClient, MockInstagramClient, MockTikTokClient exist as minimal stubs (no publish logic to test yet)
    - Fixtures contain real X API v2 response shapes (tweet create, duplicate error 403, rate limit headers)
  </behavior>
  <action>
Create `src/platforms/__mocks__/fixtures.ts` with real X API v2 response shapes:
- `TWEET_RESPONSE`: `{ data: { id: "1849234567890123456", text: "Hello world" } }` shape
- `DUPLICATE_ERROR_RESPONSE`: `{ status: 403, detail: "You are not allowed to create a Tweet with duplicate content.", type: "about:blank", title: "Forbidden" }`
- `RATE_LIMIT_HEADERS`: `{ "x-rate-limit-limit": "300", "x-rate-limit-remaining": "0", "x-rate-limit-reset": "..." }`
- `DEFAULT_RATE_LIMIT`: `{ limit: 300, remaining: 299, resetAt: Date }` (for mock client responses)

Create `src/platforms/__mocks__/clients.ts` with:
- `MockXClient`: mirrors `XClient` public API. Tracks posted tweets in array, returns incrementing `tweet_N` IDs. Has `setFailure(error)`, `clearFailure()`, `getPostedTweets()`, `reset()` test helpers. `createTweet` returns `{ id, text, rateLimit }`. `getTimeline` returns posted tweets.
- `MockLinkedInClient`: minimal stub with constructor accepting accessToken. No methods need implementation beyond constructor (LinkedIn publish flow not in test scope per CONTEXT.md).
- `MockInstagramClient`: minimal stub with constructor(accessToken, userId).
- `MockTikTokClient`: minimal stub with constructor(accessToken).

Import `RateLimitInfo` type from `../x/types.ts` for mock client return types. Import fixture data from `./fixtures.ts`.

Do NOT mock at HTTP/fetch layer — mock at class boundary per user decision.
  </action>
  <verify>
    <automated>cd /home/hybridz/Projects/post-shit-now && npx vitest run --reporter=verbose 2>&1 | tail -5</automated>
  </verify>
  <done>MockXClient creates tweets with incrementing IDs, returns them via getTimeline, supports setFailure/clearFailure. All 4 mock client classes exported. Fixtures contain real X API shapes.</done>
</task>

<task type="auto" tdd="true">
  <name>Task 2: Create countTweetChars and validateTweet unit tests</name>
  <files>src/core/utils/tweet-validator.test.ts</files>
  <behavior>
    - countTweetChars("Hello") === 5 (plain ASCII)
    - countTweetChars("\u{1F600}") === 2 (single emoji)
    - countTweetChars("\u{1F468}\u200D\u{1F469}\u200D\u{1F467}") === 2 (ZWJ family emoji = 1 grapheme = 2 chars)
    - countTweetChars("https://example.com") === 23 (URL = 23 regardless of length)
    - countTweetChars("https://example.com/very/long/path") === 23 (long URL still 23)
    - countTweetChars("\u4F60\u597D") === 4 (CJK = 2 chars each)
    - countTweetChars("") === 0 (empty string)
    - countTweetChars("Hi https://example.com \u{1F600}") === 29 (mixed: 3 + 23 + 1 space + 2 emoji)
    - countTweetChars("example.com") === 23 (bare domain = URL)
    - validateTweet with 280 chars returns valid: true
    - validateTweet with 281 chars returns valid: false with error message
    - validateTweet with 11+ mentions returns valid: true with warning
    - validateTweet with 6+ hashtags returns valid: true with warning
  </behavior>
  <action>
Create `src/core/utils/tweet-validator.test.ts` with two describe blocks:

1. `describe("countTweetChars")` — edge cases per behavior list above. Use the exact test cases from the research RESEARCH.md code examples section. Also test:
   - Flag emoji (e.g., regional indicator sequences) = 2 chars
   - Text ending with URL followed by period (URL = 23, period = 1)
   - Multiple URLs in one tweet (each = 23)

2. `describe("validateTweet")` — test the structured validation result:
   - Valid tweet (under 280) returns `{ valid: true, errors: [], charCount }`
   - Oversized tweet returns `{ valid: false, errors: ["Tweet is N/280 characters"] }`
   - Tweet with 11 mentions returns `{ valid: true, warnings: [...] }`
   - Tweet with 6 hashtags returns `{ valid: true, warnings: [...] }`
   - Combined: oversized with excess mentions returns both error and warning

Import directly: `import { countTweetChars, validateTweet } from "./tweet-validator.ts";`
  </action>
  <verify>
    <automated>cd /home/hybridz/Projects/post-shit-now && npx vitest run src/core/utils/tweet-validator.test.ts --reporter=verbose 2>&1 | tail -20</automated>
  </verify>
  <done>All countTweetChars edge cases pass (ASCII, emoji, ZWJ, URL, CJK, bare domain, mixed, empty). All validateTweet tests pass (valid, oversized, mention warnings, hashtag warnings).</done>
</task>

<task type="auto">
  <name>Task 3: Add JSDoc behavioral contracts to PlatformPublisher interface</name>
  <files>src/core/types/publisher.ts</files>
  <action>
The PlatformPublisher interface in `src/core/types/publisher.ts` already has extensive JSDoc (lines 33-63 for the interface, lines 65-85 for publish()). Review and enhance with:

1. Add `@sideeffect` tags to `publish()`:
   - `@sideeffect Saves thread checkpoint to DB after each successful tweet in a thread`
   - `@sideeffect Sets post subStatus to "thread_partial" during thread posting`
   - `@sideeffect Sets post subStatus to "media_uploading"/"media_uploaded" during media upload`

2. Add `@throws {SkipRetryError}` to the interface-level JSDoc (not just implementation):
   - `@throws Implementations may throw SkipRetryError internally for duplicate detection (Error 187) -- callers see recovered tweet IDs, not the error`

3. Add `@postcondition` for partially_posted behavior:
   - `@postcondition On thread partial failure, checkpoint is persisted before throwing (enables resume on retry)`

4. Add behavioral contracts to `refreshCredentials()`:
   - Already has good JSDoc. Add: `@sideeffect Persists new access token (and rotated refresh token) to DB before returning`

5. Add to `validateCredentials()`:
   - `@sideeffect None -- read-only API call`

Keep existing JSDoc intact. Only ADD new tags. Per user decision: location is interface/type definitions only (single source of truth), implementations inherit the contract. Skip @throws for obvious errors (DB connection, network).

Also verify TEST-01 is satisfied by confirming existing `vitest.config.ts` reads tsconfig.json paths automatically (it does -- Vitest 4.x). No code changes needed for TEST-01.
  </action>
  <verify>
    <automated>cd /home/hybridz/Projects/post-shit-now && grep -c "@precondition\|@postcondition\|@throws\|@sideeffect" src/core/types/publisher.ts</automated>
  </verify>
  <done>PlatformPublisher interface has @precondition, @postcondition, @throws, and @sideeffect JSDoc tags on publish(), validateCredentials(), refreshCredentials(). Existing JSDoc preserved. At least 10 contract annotations present.</done>
</task>

</tasks>

<verification>
- `npx vitest run` passes all existing tests plus new tweet-validator tests
- `src/platforms/__mocks__/clients.ts` exports MockXClient, MockLinkedInClient, MockInstagramClient, MockTikTokClient
- `src/platforms/__mocks__/fixtures.ts` exports real X API response shapes
- `grep -c "@precondition\|@postcondition\|@throws\|@sideeffect" src/core/types/publisher.ts` returns 10+
- `bun run typecheck` passes (no type errors from new files)
</verification>

<success_criteria>
- Mock client classes exist for all 4 platforms with test helper methods on MockXClient
- Tweet validator has comprehensive edge case coverage (8+ test cases for countTweetChars, 4+ for validateTweet)
- PlatformPublisher interface JSDoc includes behavioral contracts per CONTEXT.md style decisions
- All tests pass: `npx vitest run` exits 0
</success_criteria>

<output>
After completion, create `.planning/phases/29-testing-infrastructure/29-01-SUMMARY.md`
</output>
