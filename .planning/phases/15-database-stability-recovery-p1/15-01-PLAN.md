---
phase: 15-database-stability-recovery-p1
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [src/core/db/migrate.ts]
autonomous: true
requirements: [M1]

must_haves:
  truths:
    - "Migrations retry up to 3 times on transient failures"
    - "Migration attempts show detailed progress (attempt count, delay, table, failure reason)"
    - "After successful migration, all required tables are verified to exist"
    - "Permanent errors (permission, syntax) stop retry immediately without delay"
    - "Non-retriable errors show 'permanent' status in error messages"
  artifacts:
    - path: "src/core/db/migrate.ts"
      provides: "Migration retry logic with table verification"
      exports: ["runMigrationsWithRetry"]
      min_lines: 50
  key_links:
    - from: "src/cli/setup-db.ts"
      to: "src/core/db/migrate.ts"
      via: "function call"
      pattern: "runMigrations\\(connectionUri\\)"
    - from: "src/team/hub.ts"
      to: "src/core/db/migrate.ts"
      via: "function call"
      pattern: "runMigrations\\(databaseUrl\\)"
---

<objective>
Add retry logic with table verification to database migrations. Drizzle's migrate() function has no built-in retry, causing infinite loops on transient failures. This plan wraps migrate() with 3-attempt retry, 2-second fixed delay, detailed user feedback, and table existence verification. Distinguishes between retriable (connection, timeout, network) and permanent (permission, syntax) errors.

Purpose: Handle transient network failures during migrations gracefully without manual intervention.
Output: Enhanced runMigrationsWithRetry() function with retry loop, table verification, and detailed error feedback.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-database-stability-recovery-p1/15-CONTEXT.md
@.planning/phases/15-database-stability-recovery-p1/15-RESEARCH.md

@/home/hybridz/Projects/post-shit-now/src/core/db/migrate.ts
@/home/hybridz/Projects/post-shit-now/src/core/db/schema.ts
@/home/hybridz/Projects/post-shit-now/src/cli/setup-db.ts
@/home/hybridz/Projects/post-shit-now/src/team/hub.ts
</context>

<tasks>

<task type="auto">
  <name>Implement migration retry wrapper with table verification</name>
  <files>src/core/db/migrate.ts</files>
  <action>
    In src/core/db/migrate.ts, add migration retry logic following this structure:

    1. Define REQUIRED_TABLES constant listing all tables from schema.ts:
       - users, oauth_tokens, posts, api_keys, entities
       - team_members, invite_codes, preference_model
       - ideas, trends, post_metrics, series
       - plan_slots, series_templates, notification_log

    2. Create verifyTablesExist(db) function:
       - For each table in REQUIRED_TABLES, try SELECT 1 FROM table LIMIT 1
       - Return false if any table fails (returns false on error, true if all pass)
       - Use sql.identifier() for safe table name interpolation

    3. Create isRetryableError(error: string) function:
       - Return true for patterns: /connection/i, /timeout/i, /network/i, /temporary/i, /could not connect/i
       - Return false for patterns: /permission denied/i, /syntax error/i, /duplicate column/i, /relation.*already exists/i
       - Check non-retriable patterns first (block them), then check retriable patterns

    4. Create extractTableInfo(error: string) function:
       - Parse error for table name using regex: /relation "([^"]+)" does not exist/i
       - Fallback: /table "([^"]+)"/i
       - Return extracted table name or null

    5. Rename existing runMigrations() to runMigrationsOnce()
       - Keep original implementation for single-attempt usage if needed
       - Or refactor to internal _runMigrations()

    6. Create new runMigrationsWithRetry() function:
       - Accepts: databaseUrl, migrationsFolder = "./drizzle/migrations"
       - Returns: { success: boolean, error?: string, attemptCount?: number, tablesVerified?: boolean }

       Loop implementation:
       ```
       for (let attempt = 1; attempt <= 3; attempt++) {
         try {
           console.log(`[Migration attempt ${attempt}/3] Running migrations...`);
           const db = drizzle(databaseUrl);
           await migrate(db, { migrationsFolder });

           console.log(`[Migration attempt ${attempt}/3] Verifying tables...`);
           const tablesExist = await verifyTablesExist(db);
           if (!tablesExist) {
             throw new Error("Migration completed but required tables missing");
           }

           console.log(`[Migration attempt ${attempt}/3] Success - ${REQUIRED_TABLES.length} tables verified`);
           return { success: true, attemptCount: attempt, tablesVerified: true };
         } catch (err) {
           const error = err instanceof Error ? err.message : String(err);
           const isRetriable = isRetryableError(error);
           const tableInfo = extractTableInfo(error);

           console.log(`[Migration attempt ${attempt}/3] Failed: ${error}`);
           if (tableInfo) {
             console.log(`[Migration attempt ${attempt}/3] Table context: ${tableInfo}`);
           }

           if (!isRetriable) {
             console.log(`[Migration attempt ${attempt}/3] Error is permanent - not retrying`);
             return { success: false, error, attemptCount: attempt };
           }

           if (attempt < 3) {
             console.log(`[Migration attempt ${attempt}/3] Retrying in 2 seconds...`);
             await new Promise(resolve => setTimeout(resolve, 2000));
           } else {
             console.log(`[Migration attempt ${attempt}/3] Max retries reached`);
             return { success: false, error, attemptCount: attempt };
           }
         }
       }
       ```

    7. Update exports to include both runMigrationsWithRetry and runMigrationsOnce

    Key decisions per CONTEXT.md:
    - Fixed 2-second delay (not exponential backoff) — simpler for network hiccups
    - Keep partial migration state on failure (user can run /psn:setup reset --db to clean)
    - Retry limit: 3 attempts with detailed progress feedback
  </action>
  <verify>
    1. Check src/core/db/migrate.ts exports runMigrationsWithRetry function
    2. Verify REQUIRED_TABLES constant contains all 14 table names from schema.ts
    3. Run: bun run lint — should pass without errors
    4. Verify TypeScript compiles: bun run type-check (or bunx tsc --noEmit)
  </verify>
  <done>
    runMigrationsWithRetry() function implements 3-attempt retry with 2s delay, table verification, and detailed progress logging. Distinguishes retriable vs permanent errors.
  </done>
</task>

</tasks>

<verification>
1. RunMigrationsWithRetry exported from migrate.ts
2. REQUIRED_TABLES contains all tables from schema.ts (14 tables)
3. Retry loop stops immediately on non-retriable errors (permission, syntax)
4. Table verification confirms all tables exist after migration
5. Console output shows attempt count, delay, table name, and failure reason
</verification>

<success_criteria>
1. runMigrationsWithRetry() returns { success: true, tablesVerified: true } after successful migration with all tables verified
2. Transient errors trigger retry with 2-second delay (up to 3 attempts)
3. Permanent errors return immediately with "permanent" status message
4. Detailed console logging shows attempt progress and failure context
5. setup-db.ts and hub.ts use runMigrationsWithRetry() instead of runMigrations()
</success_criteria>

<output>
After completion, create `.planning/phases/15-database-stability-recovery-p1/15-01-SUMMARY.md`
</output>
