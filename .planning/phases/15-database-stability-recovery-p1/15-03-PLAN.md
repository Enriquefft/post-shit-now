---
phase: 15-database-stability-recovery-p1
plan: 03
type: execute
wave: 2
depends_on: [15-01]
files_modified: [src/team/hub.ts, src/cli/setup.ts]
autonomous: true
requirements: [M5, C11]

must_haves:
  truths:
    - "Empty .hubs/ directory errors immediately with setup prompt"
    - "Corrupted hub connection files fail-fast with detailed error messages"
    - "All .hubs/*.json files (personal.json and company-*.json) loaded by discovery"
    - "Strict validation requires hubId, name, and connection fields"
    - "Error messages include file path, parse error location, and expected format"
  artifacts:
    - path: "src/team/hub.ts"
      provides: "Unified hub discovery for Personal and Company hubs"
      exports: ["discoverAllHubs", "discoverCompanyHubs"]
      min_lines: 60
  key_links:
    - from: "src/cli/setup.ts"
      to: "src/team/hub.ts"
      via: "function import"
      pattern: "import.*discoverCompanyHubs.*from.*hub"
    - from: "src/team/hub.ts"
      to: "src/team/types.ts"
      via: "schema validation"
      pattern: "HubConnectionSchema\\.parse"
    - from: "src/team/hub.ts"
      to: "src/cli/setup.ts"
      via: "function export"
      pattern: "export.*discoverAllHubs"
---

<objective>
Unify hub discovery for both Personal and Company hubs with strict validation. discoverCompanyHubs() currently returns empty array on empty .hubs/ (graceful degradation). This plan adds discoverAllHubs() function that errors immediately on empty directory, loads all .hubs/*.json files (personal.json + company-*.json), and validates strictly with detailed error messages including file path, parse location, and expected format.

Purpose: Provide consistent error messaging and prevent silent failures with corrupted hub files.
Output: discoverAllHubs() function with strict validation, detailed error messages, and fail-fast behavior.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/15-database-stability-recovery-p1/15-CONTEXT.md
@.planning/phases/15-database-stability-recovery-p1/15-RESEARCH.md

@/home/hybridz/Projects/post-shit-now/src/team/hub.ts
@/home/hybridz/Projects/post-shit-now/src/team/types.ts
@/home/hybridz/Projects/post-shit-now/src/cli/setup.ts
</context>

<tasks>

<task type="auto">
  <name>Create unified hub discovery with strict validation</name>
  <files>src/team/hub.ts</files>
  <action>
    In src/team/hub.ts, create discoverAllHubs() function with strict validation:

    1. Add discoverAllHubs() function after discoverCompanyHubs():

       ```
       export async function discoverAllHubs(
         projectRoot = ".",
       ): Promise<{ hubs: HubConnection[]; error?: { file: string; reason: string } }> {

         const hubsDir = join(projectRoot, ".hubs");

         // Check directory exists
         let entries: string[];
         try {
           entries = await readdir(hubsDir);
         } catch {
           // Empty .hubs/ directory — error immediately (user decision)
           return {
             hubs: [],
             error: {
               file: ".hubs/",
               reason: "Hub directory not found. Run /psn:setup to configure your Personal Hub."
             }
           };
         }

         if (entries.length === 0) {
           return {
             hubs: [],
             error: {
               file: ".hubs/",
               reason: "No hub connection files found. Run /psn:setup to configure your Personal Hub."
             }
           };
         }

         const hubs: HubConnection[] = [];

         for (const entry of entries) {
           if (!entry.endsWith(".json")) continue;

           const filePath = join(hubsDir, entry);

           try {
             const content = await readFile(filePath, "utf-8");
             const parsed = JSON.parse(content);

             // Strict Zod validation - fails fast on first error
             const validated = HubConnectionSchema.parse(parsed);

             // Check required fields (user decision: strict validation)
             if (!validated.hubId || !validated.slug || !validated.databaseUrl) {
               throw new Error(`Missing required field: hubId, slug, or databaseUrl`);
             }

             hubs.push(validated);
           } catch (err) {
             // Fail-fast on corrupted files (user decision)
             const reason = err instanceof Error ? err.message : String(err);
             const parseLocation = extractParseLocation(reason);

             return {
               hubs: [],
               error: {
                 file: entry,
                 reason: `Invalid hub connection file at ${filePath}: ${reason}\n` +
                         `Location: ${parseLocation}\n` +
                         `Expected format: { "hubId": "...", "slug": "...", "displayName": "...", "databaseUrl": "...", ... }`
               }
             };
           }
         }

         return { hubs, error: undefined };
       }
       ```

    2. Add extractParseLocation() helper function:

       ```
       function extractParseLocation(error: string): string {
         // Parse Zod error for line/column info
         const match = error.match(/at "(.+)" \((\d+):(\d+)\)/);
         if (match) {
           return `Line ${match[2]}, column ${match[3]}`;
         }
         // Parse JSON.parse errors
         const jsonMatch = error.match(/position (\d+)/);
         if (jsonMatch) {
           return `Position ${jsonMatch[1]}`;
         }
         return "Unknown location";
       }
       ```

    3. Update discoverCompanyHubs() to call discoverAllHubs() for consistency:

       Keep discoverCompanyHubs() for backward compatibility, but update to use discoverAllHubs() internally:

       ```
       export async function discoverCompanyHubs(projectRoot = "."): Promise<HubConnection[]> {
         const result = await discoverAllHubs(projectRoot);
         return result.hubs;
       }
       ```

    Key decisions per CONTEXT.md:
    - Empty .hubs/ directory errors immediately with setup prompt
    - Corrupted files fail-fast on first error (not graceful degradation)
    - Strict validation requires hubId, name, and connection fields
    - Error messages include file path, parse error location, and expected format
  </action>
  <verify>
    1. Check discoverAllHubs() exists and returns { hubs: HubConnection[], error?: {...} }
    2. Verify error on empty .hubs/: delete .hubs/, run discovery, check error reason
    3. Verify fail-fast on corrupted JSON: create invalid .hubs/test.json, run discovery, check detailed error
    4. Verify all .hubs/*.json files loaded: create personal.json and company-*.json, run discovery, check both in result.hubs
  </verify>
  <done>
    discoverAllHubs() function loads all .hubs/*.json files with strict Zod validation, errors immediately on empty directory, and provides detailed error messages with file path, parse location, and expected format.
  </done>
</task>

<task type="auto">
  <name>Update setup.ts to use discoverAllHubs</name>
  <files>src/cli/setup.ts</files>
  <action>
    In src/cli/setup.ts, update imports and function calls to use discoverAllHubs:

    1. Add import at top:
       ```
       import { getHubConnection, getHubDb, discoverAllHubs } from "../team/hub.ts";
       ```

    2. Find all occurrences of discoverCompanyHubs() and check if error handling needed:

       - setup.ts: getHubConnection() calls discoverCompanyHubs() internally
       - getHubConnection() should use discoverAllHubs() for better error messages

    3. Since getHubConnection() is in hub.ts and calls discoverCompanyHubs(), and we updated discoverCompanyHubs() to use discoverAllHubs() internally, setup.ts gets the benefit automatically. No changes needed in setup.ts if hub.ts exports are used correctly.

    4. Verify all subcommands that need hub discovery use getHubConnection() which now has better error reporting.

    No action needed if discoverCompanyHubs() delegates to discoverAllHubs(). This task is verification-only.
  </action>
  <verify>
    1. Check setup.ts imports discoverAllHubs (or confirm not needed due to delegation)
    2. Run: bun run lint — should pass
    3. Verify TypeScript compiles
  </verify>
  <done>
    setup.ts uses discoverAllHubs() through hub.ts delegation, benefiting from strict validation and detailed error messages.
  </done>
</task>

</tasks>

<verification>
1. discoverAllHubs() function exists and exports from src/team/hub.ts
2. Empty .hubs/ directory returns error with setup prompt
3. Corrupted hub files fail-fast with detailed error including file path, parse location, and expected format
4. All .hubs/*.json files loaded (personal.json and company-*.json)
5. discoverCompanyHubs() delegates to discoverAllHubs() for backward compatibility
</verification>

<success_criteria>
1. Empty .hubs/ directory errors immediately instead of returning empty array
2. Corrupted hub files fail-fast with detailed error messages
3. Error messages include file path, parse error location, and expected format
4. All .hubs/*.json files (personal.json + company-*.json) loaded successfully
5. setup.ts uses discoverAllHubs() or delegating function
</success_criteria>

<output>
After completion, create `.planning/phases/15-database-stability-recovery-p1/15-03-SUMMARY.md`
</output>
