---
phase: 20-health-checks-and-validation-p3
plan: 02
type: execute
wave: 1
depends_on: [20-01]
files_modified:
  - src/cli/setup-trigger.ts
  - src/cli/validate.ts
  - src/cli/setup.ts
autonomous: true
requirements: [m5]
user_setup: []

must_haves:
  truths:
    - "Trigger project ref is detected from config file"
    - "Trigger project ref is detected from secret key format"
    - "Trigger project ref is verified against Trigger.dev API"
    - "Mismatch errors show clear suggested actions"
    - "CLI command /psn:setup trigger --verify checks project connectivity"
    - "Setup validation includes Trigger project verification"
  artifacts:
    - path: "src/cli/setup-trigger.ts"
      provides: "Enhanced Trigger.dev setup with project verification"
      exports: ["verifyTriggerProject", "detectProjectRef"]
    - path: "src/cli/validate.ts"
      provides: "Updated validation with Trigger project verification"
      contains: "checkTrigger with project ref verification"
    - path: "src/cli/setup.ts"
      provides: "CLI subcommand routing for trigger verification"
      contains: "case \"trigger\" with --verify flag handling"
  key_links:
    - from: "src/cli/setup-trigger.ts"
      to: "trigger.config.ts"
      via: "read project ref from config file"
      pattern: "readFileSync.*trigger.config.ts"
    - from: "src/cli/setup-trigger.ts"
      to: "config/keys.env"
      via: "read TRIGGER_SECRET_KEY to extract project ref"
      pattern: "loadKeysEnv|TRIGGER_SECRET_KEY"
    - from: "src/cli/setup-trigger.ts"
      to: "Trigger.dev CLI"
      via: "run bunx trigger.dev@latest whoami to verify project"
      pattern: "trigger.dev.*whoami"
    - from: "src/cli/validate.ts"
      to: "src/cli/setup-trigger.ts"
      via: "import verifyTriggerProject for enhanced validation"
      pattern: "import.*verifyTriggerProject"
    - from: "src/cli/setup.ts"
      to: "src/cli/setup-trigger.ts"
      via: "route --verify flag to trigger verification function"
      pattern: "case \"trigger\":.*verify"
---

<objective>
Add Trigger project auto-detection (m5)

Purpose: Enhance Trigger.dev error messages with auto-detection hints and provide a CLI command to verify Trigger.dev project connectivity. This addresses users seeing generic "project not found" errors without guidance.

Output: Enhanced Trigger.dev setup with project ref detection, API verification, and `/psn:setup trigger --verify` command.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-health-checks-and-validation-p3/CONTEXT.md

# Relevant existing patterns
@src/cli/setup-trigger.ts
@src/cli/validate.ts
@src/cli/setup.ts
@src/core/utils/env.ts
@src/cli/utils/masking.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add project ref detection and verification to setup-trigger.ts</name>
  <files>src/cli/setup-trigger.ts</files>
  <action>
Update src/cli/setup-trigger.ts to add project detection and verification:

1. Define interface for detected project ref:
   ```typescript
   interface DetectedProjectRef {
       source: "config" | "secret-key" | "env" | "none";
       projectRef?: string;
       environment?: "dev" | "prod";
   }
   ```

2. Implement detectProjectRef(keysResult: KeysResult): DetectedProjectRef:
   - Check keysResult.data.TRIGGER_PROJECT_REF first (env source)
   - If found, return { source: "env", projectRef, environment: dev|prod based on TRIGGER_SECRET_KEY prefix }
   - If not found, extract from TRIGGER_SECRET_KEY format:
     * Match pattern /^tr_(dev|prod)_([a-zA-Z0-9]+)_/
     * If match found, return { source: "secret-key", projectRef: match[1], environment: match[0] }
   - If no secret key or invalid format, return { source: "none" }

3. Implement verifyTriggerProject(projectRef: string, secretKey: string): Promise<{ valid: boolean; error?: string; suggestedAction?: string }>:
   - Run Trigger.dev CLI command: bunx trigger.dev@latest whoami --api-key <secretKey>
   - Parse output to verify project ref is accessible
   - If CLI succeeds and project ref matches or is found:
     * Return { valid: true }
   - If CLI fails with authentication error:
     * Return { valid: false, error: "Invalid TRIGGER_SECRET_KEY or insufficient permissions", suggestedAction: "Check your Trigger.dev secret key in keys.env" }
   - If CLI succeeds but project ref mismatch:
     * Return { valid: false, error: "Configured project ref does not match Trigger.dev project", suggestedAction: "Update trigger.config.ts with the correct project ref or run /psn:setup trigger to reconfigure" }
   - If CLI fails with network/connectivity error:
     * Return { valid: false, error: "Cannot connect to Trigger.dev", suggestedAction: "Check your internet connection" }
   - If CLI fails with unknown error:
     * Return { valid: false, error: "Trigger.dev verification failed", suggestedAction: "Run /psn:setup trigger to reconfigure" }
   - Mask secret key in CLI command output using maskApiKey()

4. Update setupTrigger() function to use enhanced detection:
   - Replace manual secret key parsing with detectProjectRef()
   - If detected project ref is "none", keep existing behavior (run trigger.dev init)
   - If detected project ref exists, verify it with verifyTriggerProject()
   - If verification fails, return SetupResult with error and suggestedAction
   - If verification succeeds, proceed with updating trigger.config.ts

5. Add verify flag handling to setup-trigger.ts:
   - Export function verifyTriggerSetup(configDir = "config"): Promise<SetupResult>
   - Load keys via loadKeysEnv()
   - Detect project ref via detectProjectRef()
   - If no project ref, return error with suggestion to run setup
   - Verify project via verifyTriggerProject()
   - Return SetupResult with detailed status and suggestions
</action>
  <verify>
Run the following checks:
1. Interface check: grep -q "interface DetectedProjectRef" src/cli/setup-trigger.ts
2. Function check: grep -q "export.*detectProjectRef" src/cli/setup-trigger.ts
3. Function check: grep -q "export.*verifyTriggerProject" src/cli/setup-trigger.ts
4. Function check: grep -q "export.*verifyTriggerSetup" src/cli/setup-trigger.ts
5. CLI command check: grep -q "trigger.dev.*whoami" src/cli/setup-trigger.ts
6. Masking check: grep -q "maskApiKey" src/cli/setup-trigger.ts
7. Syntax check: bun build src/cli/setup-trigger.ts --outdir /tmp 2>&1 | head -20
</verify>
  <done>
setup-trigger.ts updated with detectProjectRef(), verifyTriggerProject(), and verifyTriggerSetup() functions with CLI verification
</done>
</task>

<task type="auto">
  <name>Task 2: Update validate.ts to use Trigger project verification</name>
  <files>src/cli/validate.ts</files>
  <action>
Update src/cli/validate.ts to enhance Trigger validation:

1. Add import:
   ```typescript
   import { verifyTriggerProject } from "./setup-trigger.ts";
   ```

2. Update checkTrigger() function:
   - Keep existing checks (TRIGGER_SECRET_KEY exists, trigger.config.ts has real ref)
   - After existing checks, extract project ref from trigger.config.ts
   - Load TRIGGER_SECRET_KEY via loadKeysEnv()
   - If project ref and secret key found, call verifyTriggerProject(projectRef, secretKey)
   - If verification fails:
     * Return ValidationResult with status "fail"
     * Include error message with suggestedAction from verification result
   - If verification succeeds:
     * Return ValidationResult with status "pass" and message "Trigger.dev configured and verified"
   - Mask secret key in any error messages using maskApiKey() (import from cli/utils/masking.ts)

3. Update validateAll() function:
   - No changes needed, checkTrigger() already called
</action>
  <verify>
Run the following checks:
1. Import check: grep -q "import.*verifyTriggerProject.*from.*setup-trigger" src/cli/validate.ts
2. Function call check: grep -q "verifyTriggerProject" src/cli/validate.ts
3. Masking import: grep -q "import.*maskApiKey.*from.*masking" src/cli/validate.ts
4. Syntax check: bun build src/cli/validate.ts --outdir /tmp 2>&1 | head -20
</verify>
  <done>
validate.ts updated with Trigger project verification using verifyTriggerProject()
</done>
</task>

<task type="auto">
  <name>Task 3: Add trigger verify subcommand to setup.ts</name>
  <files>src/cli/setup.ts</files>
  <action>
Update src/cli/setup.ts to add trigger verification subcommand:

1. Add import at top:
   ```typescript
   import { verifyTriggerSetup } from "./setup-trigger.ts";
   ```

2. Add new case in runSetupSubcommand() switch statement for trigger with verify flag:
   ```typescript
   case "trigger": {
       if (params.verify === "true") {
           const result = await verifyTriggerSetup(configDir);
           return {
               steps: [result],
               validation: null,
               completed: result.status === "success"
           };
       }
       // Fall through to default trigger setup if not verify
       return null;
   }
   ```

3. Add --verify flag handling in parseCliArgs():
   - Check for flagArgs.includes("--verify") and set params.verify = "true"
   - Place this in the flagArgs parsing loop (around line 746-749)

4. Update CLI argument parsing to support:
   - /psn:setup trigger --verify (verify Trigger.dev project connectivity)
</action>
  <verify>
Run the following checks:
1. Import check: grep -q 'import.*verifyTriggerSetup.*from.*setup-trigger' src/cli/setup.ts
2. Routing check: grep -q 'case "trigger":.*verify.*true' src/cli/setup.ts
3. Flag check: grep -q 'params.verify.*true' src/cli/setup.ts
4. Syntax check: bun build src/cli/setup.ts --outdir /tmp 2>&1 | head -20
</verify>
  <done>
Trigger verify subcommand added to setup.ts with --verify flag support
</done>
</task>

</tasks>

<verification>
Overall phase verification:

1. Test project ref detection:
   ```bash
   bun run src/cli/setup.ts trigger --verify
   ```
   Expected output: Detected project ref, verification status, and error messages with suggested actions

2. Test with invalid secret key:
   - Temporarily set invalid TRIGGER_SECRET_KEY
   - Run /psn:setup trigger --verify
   - Expected: Error message "Invalid TRIGGER_SECRET_KEY" with suggestion to check keys.env

3. Test with project ref mismatch:
   - Set valid TRIGGER_SECRET_KEY but wrong project ref in trigger.config.ts
   - Run /psn:setup trigger --verify
   - Expected: Error message with project ref mismatch and suggestion to update or reconfigure

4. Test verifyAll() integration:
   ```bash
   bun run src/cli/validate.ts
   ```
   Expected: Trigger check includes project verification and returns clear error/success messages

5. Test masked output:
   - Run with secret key that causes error
   - Expected: Secret key masked in error messages (tr_***xyz format)
</verification>

<success_criteria>
1. /psn:setup trigger --verify command runs successfully
2. Project ref detected from config file, secret key format, or env var
3. Trigger.dev CLI verification executes (whoami command)
4. Mismatch errors include clear suggested actions
5. validateAll() includes Trigger project verification
6. Secret keys masked in all error messages
7. Verification returns valid/invalid status with actionable guidance
</success_criteria>

<output>
After completion, create `.planning/phases/20-health-checks-and-validation-p3/20-02-SUMMARY.md`
</output>
