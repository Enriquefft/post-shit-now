---
phase: 20-health-checks-and-validation-p3
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/setup-health.ts
  - src/cli/setup.ts
autonomous: true
requirements: [m9]
user_setup: []

must_haves:
  truths:
    - "User can run health checks via CLI command"
    - "Health check covers database connectivity"
    - "Health check covers Trigger.dev project"
    - "Health check covers hub connections"
    - "Health check covers provider keys"
    - "Results display in human-readable format with color coding"
    - "Results can be output as JSON for programmatic consumption"
  artifacts:
    - path: "src/cli/setup-health.ts"
      provides: "Health check implementation functions"
      exports: ["checkDatabaseHealth", "checkTriggerHealth", "checkHubHealth", "checkProviderKeysHealth", "runHealthCheck"]
    - path: "src/cli/setup.ts"
      provides: "CLI subcommand routing for health check"
      contains: "case \"health\":"
  key_links:
    - from: "src/cli/setup.ts"
      to: "src/cli/setup-health.ts"
      via: "import runHealthCheck function and route to health subcommand"
      pattern: "import.*setup-health|case \"health\":"
    - from: "src/cli/setup-health.ts"
      to: "src/cli/validate.ts"
      via: "reuse validateAll() patterns for database/trigger checks"
      pattern: "validateAll|ValidationResult"
    - from: "src/cli/setup-health.ts"
      to: "src/team/hub.ts"
      via: "use discoverAllHubs() and getHubDb() for hub connection verification"
      pattern: "discoverAllHubs|getHubDb"
    - from: "src/cli/setup-health.ts"
      to: "src/core/db/api-keys"
      via: "use listKeys() for provider key verification"
      pattern: "listKeys"
---

<objective>
Implement setup health check command (m9)

Purpose: Provide users with a comprehensive health check tool to verify all system components are functioning correctly. This addresses the need for on-demand validation beyond the Trigger.dev health check task.

Output: CLI command `/psn:setup health` that runs comprehensive health checks with human-readable and JSON output formats.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/20-health-checks-and-validation-p3/CONTEXT.md

# Relevant existing patterns
@src/cli/validate.ts
@src/cli/setup.ts
@src/cli/setup-keys.ts
@src/team/hub.ts
@src/trigger/health.ts
@src/core/types/index.ts
@src/cli/utils/masking.ts
@src/cli/utils/progress.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create setup-health.ts with health check functions</name>
  <files>src/cli/setup-health.ts</files>
  <action>
Create new file src/cli/setup-health.ts with the following structure:

1. Import existing patterns:
   - ValidationResult, ValidationSummary from core/types
   - createHubConnection from core/db/connection
   - loadHubEnv, loadKeysEnv from core/utils/env
   - listKeys from core/db/api-keys
   - discoverAllHubs, getHubDb from team/hub
   - maskDatabaseUrl, maskApiKey from cli/utils/masking
   - createProgressStep, runStep from cli/utils/progress

2. Define HealthCheckResult interface:
   - check: string (e.g., "database", "trigger", "hub", "provider-keys")
   - status: "pass" | "fail" | "warning"
   - message: string
   - details?: Record<string, unknown>

3. Define HealthCheckSummary interface:
   - allPassed: boolean
   - timestamp: string
   - results: HealthCheckResult[]

4. Implement checkDatabaseHealth():
   - Load hub.env via loadHubEnv()
   - Create DB connection via createHubConnection()
   - Execute "SELECT 1 as health_check" query
   - Return HealthCheckResult with status "pass"/"fail"
   - On failure, mask database URL in error message using maskDatabaseUrl()

5. Implement checkTriggerHealth():
   - Load keys.env via loadKeysEnv()
   - Verify TRIGGER_SECRET_KEY exists and has valid format (tr_dev_ or tr_prod_ prefix)
   - Read trigger.config.ts and check it has a real project ref (not <your-project-ref>)
   - Return HealthCheckResult with status "pass"/"fail"/"warning"
   - Mask secret key in details using maskApiKey()

6. Implement checkHubHealth():
   - Call discoverAllHubs() to find all hub connections
   - For each hub: create DB connection via getHubDb() and execute "SELECT 1"
   - Return HealthCheckResult listing all hubs and their status
   - On failure, return "warning" if some hubs fail but at least one succeeds
   - Mask database URLs in error messages

7. Implement checkProviderKeysHealth():
   - Load hub.env via loadHubEnv() to get database URL
   - Create DB connection and call listKeys(db, hubId)
   - Check which provider keys are configured (perplexity, openai, ideogram, fal, runway, etc.)
   - Return HealthCheckResult with list of configured/missing providers
   - Use "warning" status if no keys configured (not critical for basic operation)

8. Implement runHealthCheck(configDir = "config", jsonOutput = false):
   - Create progress step list upfront: ["Database", "Trigger.dev", "Hub connections", "Provider keys"]
   - Run all checks in parallel (no dependencies between checks)
   - Collect all HealthCheckResult[] into summary
   - If jsonOutput is true: console.log(JSON.stringify(summary, null, 2))
   - If jsonOutput is false: display human-readable format with:
     * Green checkmark (✓) for "pass" status
     * Red X (✗) for "fail" status
     * Yellow warning (⚠) for "warning" status
     * Timestamp and overall status at top
     * Detailed error messages only for failed checks
   - Return HealthCheckSummary
   - Use runStep() for each check to show progress spinner and timing

9. Export all functions for use in setup.ts
</action>
  <verify>
Run the following checks:
1. File exists: test -f src/cli/setup-health.ts
2. Syntax check: bun build src/cli/setup-health.ts --outdir /tmp 2>&1 | head -20
3. Import check: grep -q "export.*checkDatabaseHealth" src/cli/setup-health.ts
4. Import check: grep -q "export.*runHealthCheck" src/cli/setup-health.ts
5. Pattern check: grep -q "maskDatabaseUrl" src/cli/setup-health.ts
6. Pattern check: grep -q "createProgressStep" src/cli/setup-health.ts
</verify>
  <done>
setup-health.ts created with all health check functions (database, trigger, hub, provider keys), human-readable output with color coding, and JSON output support
</done>
</task>

<task type="auto">
  <name>Task 2: Add health subcommand routing to setup.ts</name>
  <files>src/cli/setup.ts</files>
  <action>
Update src/cli/setup.ts to add health subcommand:

1. Add import statement at top:
   ```typescript
   import { runHealthCheck } from "./setup-health.ts";
   ```

2. Add new case in runSetupSubcommand() switch statement:
   ```typescript
   case "health": {
       const jsonOutput = params.json === "true";
       const result = await runHealthCheck(configDir, jsonOutput);
       return {
           steps: [{
               step: "health",
               status: result.allPassed ? "success" : "error",
               message: result.allPassed ? "All health checks passed" : `${result.results.filter(r => r.status !== "pass").length} checks failed`,
               data: result
           }],
           validation: null,
           completed: result.allPassed
       };
   }
   ```

3. Add --json flag handling in parseCliArgs():
   - Check for flagArgs.includes("--json") and set params.json = "true"

4. Update CLI argument parsing to support:
   - /psn:setup health (human-readable output)
   - /psn:setup health --json (JSON output for automation)
</action>
  <verify>
Run the following checks:
1. Import check: grep -q 'import.*runHealthCheck.*from.*setup-health' src/cli/setup.ts
2. Routing check: grep -q 'case "health":' src/cli/setup.ts
3. Flag check: grep -q 'params.json.*true' src/cli/setup.ts
4. Syntax check: bun build src/cli/setup.ts --outdir /tmp 2>&1 | head -20
</verify>
  <done>
Health subcommand added to setup.ts with --json flag support and proper result handling
</done>
</task>

</tasks>

<verification>
Overall phase verification:

1. Manual verification of health check command:
   ```bash
   bun run src/cli/setup.ts health
   ```
   Expected output: Human-readable health report with color coding (✓/✗/⚠) for all checks

2. JSON output verification:
   ```bash
   bun run src/cli/setup.ts health --json
   ```
   Expected output: Valid JSON with allPassed boolean, timestamp, and results array

3. Check database failure handling:
   - Temporarily set invalid DATABASE_URL and run health check
   - Expected: Error message with masked database URL

4. Check Trigger.dev validation:
   - Test with missing TRIGGER_SECRET_KEY
   - Expected: Fail status with clear error message

5. Check hub connection verification:
   - Test with valid and invalid hub connections
   - Expected: Each hub shows individual pass/fail status

6. Check provider key detection:
   - Run with configured and unconfigured provider keys
   - Expected: Warning status if no keys configured, pass if keys present
</verification>

<success_criteria>
1. /psn:setup health command runs successfully
2. All four checks execute (database, Trigger.dev, hub, provider keys)
3. Results display with color coding (✓ for pass, ✗ for fail, ⚠ for warning)
4. Sensitive data (database URLs, API keys) is masked in error messages
5. --json flag produces valid JSON output
6. Failed checks show clear error messages with actionable guidance
7. Progress indicators show during health check execution
</success_criteria>

<output>
After completion, create `.planning/phases/20-health-checks-and-validation-p3/20-01-SUMMARY.md`
</output>
