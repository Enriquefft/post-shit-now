---
phase: 08-instagram-tiktok-and-engagement
plan: 05
type: execute
wave: 3
depends_on: ["08-03", "08-04"]
files_modified:
  - src/engagement/drafting.ts
  - src/engagement/session.ts
  - src/engagement/tracker.ts
  - .claude/commands/psn/engage.md
  - src/cli/engage.ts
autonomous: true
requirements: [ENGAGE-03, ENGAGE-04, ENGAGE-05, ENGAGE-07]

must_haves:
  truths:
    - "Scores 60+: draft 2-3 reply options using voice profile; 70+: push notify; 60-69: digest"
    - "User can run /psn:engage for triage-then-draft engagement sessions"
    - "Human approves every reply — never auto-post"
    - "After engagement session, Claude bridges to content creation with idea bank capture"
    - "Full spectrum engagement: comments, quote posts, reposts, duets, stitches across platforms"
    - "Voice matching: context-adaptive to thread tone while keeping user's voice recognizable"
    - "Engagement outcomes tracked and fed back into opportunity scoring model"
  artifacts:
    - path: "src/engagement/drafting.ts"
      provides: "Voice-matched reply drafting with 2-3 options per opportunity"
      exports: ["draftReplies", "draftQuotePost", "draftRepostCommentary"]
    - path: "src/engagement/session.ts"
      provides: "Triage-then-draft session logic for /psn:engage"
      exports: ["createEngagementSession", "triageOpportunities", "draftForApproved", "bridgeToContentCreation"]
    - path: "src/engagement/tracker.ts"
      provides: "Engagement outcome tracking and scoring feedback loop"
      exports: ["trackEngagementOutcome", "updateScoringWeights", "getEngagementStats"]
    - path: ".claude/commands/psn/engage.md"
      provides: "/psn:engage slash command for proactive engagement sessions"
    - path: "src/cli/engage.ts"
      provides: "CLI entry point for engagement operations"
      exports: ["runEngagementSession", "listOpportunities", "engagementStats"]
  key_links:
    - from: "src/engagement/drafting.ts"
      to: "src/content/brain.ts"
      via: "voice profile context for reply generation"
      pattern: "generatePost|loadProfile|VoiceProfile"
    - from: "src/engagement/session.ts"
      to: "src/engagement/scoring.ts"
      via: "opportunity scoring and sorting"
      pattern: "scoreOpportunity|compositeScore"
    - from: "src/engagement/session.ts"
      to: "src/engagement/config.ts"
      via: "cap and cooldown checks before engagement"
      pattern: "checkDailyCap|checkCooldown"
    - from: "src/engagement/tracker.ts"
      to: "src/learning/feedback.ts"
      via: "feedback loop integration"
      pattern: "recordFeedback|updatePreferenceModel"
    - from: "src/engagement/session.ts"
      to: "src/ideas/capture.ts"
      via: "bridge to content creation via idea capture"
      pattern: "captureIdea"
---

<objective>
Build the interactive engagement session: voice-matched reply drafting, triage-then-draft UX flow, human approval gates, outcome tracking with feedback loop, and the /psn:engage slash command.

Purpose: Enable users to proactively engage with trending content in their niche through guided sessions with human approval on every reply. Engagement outcomes feed back into the scoring model for continuous improvement.
Output: Reply drafting engine, session logic, outcome tracker, /psn:engage command, and CLI entry point.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-instagram-tiktok-and-engagement/08-RESEARCH.md
@.planning/phases/08-instagram-tiktok-and-engagement/08-03-SUMMARY.md
@.planning/phases/08-instagram-tiktok-and-engagement/08-04-SUMMARY.md

# Patterns to follow
@src/content/brain.ts
@src/voice/profile.ts
@src/learning/feedback.ts
@src/ideas/bank.ts
@.claude/commands/psn/post.md
@src/cli/capture.ts
@src/engagement/types.ts
@src/engagement/scoring.ts
@src/engagement/config.ts
@src/engagement/monitor.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Reply drafting engine and engagement outcome tracker</name>
  <files>
    src/engagement/drafting.ts
    src/engagement/tracker.ts
  </files>
  <action>
    Create `src/engagement/drafting.ts`:
    - `draftReplies(params: { opportunity: EngagementOpportunity, voiceProfile: VoiceProfile, count?: number })` — Generate 2-3 reply options (default 3) for a given opportunity. Returns Array<{ content, tone, engagementType }>
      - Load voice profile's reply_style section (from platform persona)
      - Context-adaptive voice matching: analyze thread tone (formal/casual/technical/humorous), adapt user's voice to match while keeping recognizable
      - Each reply option varies in approach: one direct/concise, one conversational/expanded, one with a unique angle or question
      - Platform-specific formatting: X replies within 280 chars, LinkedIn comments can be longer, Instagram comments concise, TikTok comments brief
    - `draftQuotePost(params: { opportunity, voiceProfile })` — Generate a quote post/repost-with-commentary. Add user's perspective on the original content. Longer form than reply. Returns { content, commentary }
    - `draftRepostCommentary(params: { opportunity, voiceProfile })` — Generate commentary for repost/share. Brief take on why the content matters. Returns { commentary }
    - `draftDuetStitch(params: { opportunity, voiceProfile, type: "duet"|"stitch" })` — Generate script for TikTok duet/stitch. Hook that references original, user's take, CTA. Returns { script, hookLine }
    - All drafting functions return structured data for Claude to present to user (Claude renders, user reviews — never auto-post per ENGAGE-05)
    - Content assembled using the content brain pattern: load voice context, build prompt, return structured data

    Create `src/engagement/tracker.ts`:
    - `trackEngagementOutcome(db, engagementLogId: string, outcome: { impressions?, likes?, replies? })` — Update engagement_log row with outcome metrics
    - `updateScoringWeights(db, userId: string)` — Analyze engagement_log outcomes vs opportunity scores. If high-scored opportunities consistently underperform, suggest weight adjustments. Uses same learning loop pattern from Phase 4 preference model.
      - Track: for each engagement, compare actual outcome (impressions, likes) vs predicted score
      - If relevance-high opportunities underperform: reduce relevance weight
      - If recency-high opportunities outperform: increase recency weight
      - Weight adjustments are suggestions, not auto-applied (same approval-tier pattern as Phase 4 strategy adjustments)
    - `getEngagementStats(db, userId: string, period?: "day"|"week"|"month")` — Return summary: total engagements, by platform, by type, average outcome metrics, top performing engagement
    - `getEngagementHistory(db, userId: string, limit?: number)` — Recent engagement log entries for review
    - Feedback loop integration: after engagement outcomes are tracked, feed signal into preference model via existing learning loop (import from src/learning/feedback.ts)
  </action>
  <verify>
    `npx tsc --noEmit` passes. `grep "draftReplies\|draftQuotePost\|draftDuetStitch" src/engagement/drafting.ts` shows all drafting functions. `grep "trackEngagementOutcome\|updateScoringWeights" src/engagement/tracker.ts` shows tracking and feedback.
  </verify>
  <done>
    Reply drafting generates 2-3 voice-matched options per opportunity with context-adaptive tone. Full spectrum: replies, quote posts, repost commentary, duets, stitches. Outcome tracker feeds engagement results back into scoring model via Phase 4 learning loop pattern.
  </done>
</task>

<task type="auto">
  <name>Task 2: Engagement session logic, slash command, and content bridge</name>
  <files>
    src/engagement/session.ts
    .claude/commands/psn/engage.md
    src/cli/engage.ts
  </files>
  <action>
    Create `src/engagement/session.ts`:
    - `createEngagementSession(db, userId: string)` — Load pending opportunities (score >= 60, not expired, not already triaged), sort by composite score descending. Check daily caps for each platform. Returns { opportunities, capsRemaining, sessionId }
    - `triageOpportunities(db, opportunityIds: string[], decisions: Array<{ id, decision: "yes"|"no"|"skip" }>)` — Batch update opportunity statuses: yes -> triaged_yes, no -> triaged_no, skip -> unchanged. Returns approved opportunity IDs.
    - `draftForApproved(db, userId: string, approvedIds: string[], voiceProfilePath: string)` — For each approved opportunity: load opportunity data, call draftReplies/draftQuotePost based on suggestedType. Returns Array<{ opportunityId, drafts, opportunity }>
    - `executeEngagement(db, userId: string, engagements: Array<{ opportunityId, content, type, platform }>)` — For each engagement: check daily cap, check cooldown, check not blocked. If all pass: post reply via platform client (X reply, LinkedIn comment, Instagram comment, TikTok comment). Record in engagement_log. Update opportunity status to 'engaged'. Return results with per-engagement success/failure.
    - **CRITICAL: executeEngagement is called ONLY after human approval per ENGAGE-05. Never auto-post.**
    - `bridgeToContentCreation(opportunities: EngagementOpportunity[], userId: string)` — Analyze engaged opportunities for content creation potential. Returns Array<{ topic, angle, sourceOpportunity }> of suggested post ideas. If user approves, capture into idea bank via existing captureIdea function from src/ideas/capture.ts.

    Create `.claude/commands/psn/engage.md`:
    - Follow existing slash command pattern (see psn/post.md, psn/capture.md)
    - Flow:
      1. Load engagement session: `bun run src/cli/engage.ts session`
      2. **Pass 1 (Triage):** Present opportunities in summary form — post snippet (50 chars), author handle, platform badge, composite score, suggested engagement type. Batch of 10-20. Claude presents, user gives quick yes/no/skip on each.
      3. Call `bun run src/cli/engage.ts triage --decisions '...'` with user's choices
      4. **Pass 2 (Draft):** For approved opportunities (typically 3-5), Claude drafts 2-3 reply options each using voice profile. Present each with the original post context. User reviews, edits, approves each reply.
      5. Call `bun run src/cli/engage.ts execute --engagements '...'` with approved replies
      6. **Post-Session Bridge:** Claude analyzes conversations and asks "Any of these conversations spark a post idea?" If yes, capture via `/psn:capture` flow.
    - Enforce: NEVER auto-post. Every reply requires explicit human approval.
    - Show remaining daily caps per platform during session
    - Session target: ~15 minutes (per ENGAGE-04)

    Create `src/cli/engage.ts`:
    - Subcommands: session, triage, execute, stats, history
    - `session` — createEngagementSession, output JSON with opportunities for Claude to render
    - `triage --decisions <json>` — triageOpportunities with user decisions, then draftForApproved, output drafts as JSON
    - `execute --engagements <json>` — executeEngagement with approved replies, output results as JSON
    - `stats [--period day|week|month]` — getEngagementStats, output summary
    - `history [--limit N]` — getEngagementHistory, output recent entries
    - CLI pattern: import.meta.main entry point with argv dispatch, JSON output for Claude interpretation
  </action>
  <verify>
    `npx tsc --noEmit` passes. `.claude/commands/psn/engage.md` exists with triage-then-draft flow. `grep "createEngagementSession\|triageOpportunities\|executeEngagement\|bridgeToContentCreation" src/engagement/session.ts` shows all session functions. `grep "captureIdea\|idea" src/engagement/session.ts` shows content bridge.
  </verify>
  <done>
    /psn:engage slash command implements triage-then-draft flow: batch triage (yes/no/skip), voice-matched drafting (2-3 options), human approval on every reply, platform posting, and post-session content bridge to idea bank. CLI provides session/triage/execute/stats/history subcommands. Daily caps and cooldowns enforced before every engagement.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — all files compile
2. `ls .claude/commands/psn/engage.md` — slash command exists
3. `grep "never.*auto" .claude/commands/psn/engage.md` — human approval enforced (ENGAGE-05)
4. `grep "bridgeToContentCreation\|spark.*post.*idea" src/engagement/session.ts .claude/commands/psn/engage.md` — content bridge exists (ENGAGE-07)
5. `grep "draftReplies\|draftQuotePost\|draftDuetStitch" src/engagement/drafting.ts` — full spectrum drafting
6. `grep "trackEngagementOutcome" src/engagement/tracker.ts` — outcome tracking for feedback loop
7. `grep "checkDailyCap\|checkCooldown" src/engagement/session.ts` — enforcement in session
</verification>

<success_criteria>
- Reply drafting generates 2-3 voice-matched options per opportunity with context-adaptive tone
- Full spectrum engagement: replies, quote posts, repost commentary, duets, stitches
- /psn:engage implements triage-then-draft: batch triage, then draft and review, then post
- Human approves EVERY reply — no auto-posting (ENGAGE-05)
- Daily caps and cooldowns enforced per platform (ENGAGE-06 from 08-04)
- Post-session bridge asks "Any of these conversations spark a post idea?" and captures to idea bank (ENGAGE-07)
- Engagement outcomes tracked and fed into scoring model feedback loop
- CLI supports session, triage, execute, stats, history subcommands
</success_criteria>

<output>
After completion, create `.planning/phases/08-instagram-tiktok-and-engagement/08-05-SUMMARY.md`
</output>
