---
phase: 08-instagram-tiktok-and-engagement
plan: 04
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - src/core/db/schema.ts
  - src/engagement/types.ts
  - src/engagement/scoring.ts
  - src/engagement/monitor.ts
  - src/engagement/config.ts
  - src/trigger/engagement-monitor.ts
autonomous: true
requirements: [ENGAGE-01, ENGAGE-02, ENGAGE-06]

must_haves:
  truths:
    - "Engagement opportunities, config, and log tables exist with RLS isolation"
    - "Opportunity scoring uses composite formula: relevance 40%, recency 30%, reach 20%, potential 10%"
    - "Scores stored in basis points per existing DB pattern"
    - "Engagement monitor discovers trending content across enabled platforms every 2-4 hours"
    - "Daily caps, cooldowns, and blocklists are enforced per platform"
    - "Niche keywords derived from voice profile pillars plus manual overrides"
    - "Per-platform toggle allows disabling engagement monitoring independently"
  artifacts:
    - path: "src/core/db/schema.ts"
      provides: "engagement_opportunities, engagement_config, engagement_log tables with RLS"
      contains: "engagementOpportunities|engagementConfig|engagementLog"
    - path: "src/engagement/types.ts"
      provides: "Engagement types, Zod schemas, scoring interfaces"
      exports: ["EngagementOpportunity", "EngagementConfig", "EngagementLog", "OpportunityScore"]
    - path: "src/engagement/scoring.ts"
      provides: "Composite opportunity scoring engine"
      exports: ["scoreOpportunity", "computeRelevanceScore", "computeRecencyScore", "computeReachScore", "computePotentialScore"]
    - path: "src/engagement/monitor.ts"
      provides: "Cross-platform engagement opportunity discovery"
      exports: ["discoverOpportunities", "searchPlatformTrending"]
    - path: "src/engagement/config.ts"
      provides: "Per-platform caps, cooldowns, blocklists management"
      exports: ["loadEngagementConfig", "checkDailyCap", "checkCooldown", "isBlocked", "recordEngagement"]
    - path: "src/trigger/engagement-monitor.ts"
      provides: "Scheduled Trigger.dev task for engagement monitoring"
      exports: ["engagementMonitor"]
  key_links:
    - from: "src/engagement/monitor.ts"
      to: "src/platforms/x/client.ts"
      via: "X search API for trending posts"
      pattern: "XClient|searchTweets"
    - from: "src/engagement/monitor.ts"
      to: "src/platforms/instagram/client.ts"
      via: "Instagram hashtag search for trending posts"
      pattern: "InstagramClient|getHashtagRecentMedia"
    - from: "src/engagement/monitor.ts"
      to: "src/platforms/tiktok/creative-center.ts"
      via: "TikTok Creative Center for trending content"
      pattern: "getTrendingTopics|getTrendingVideos"
    - from: "src/engagement/scoring.ts"
      to: "src/engagement/types.ts"
      via: "scoring interfaces and basis points conversion"
      pattern: "OpportunityScore|scoreBps"
    - from: "src/trigger/engagement-monitor.ts"
      to: "src/engagement/monitor.ts"
      via: "scheduled discovery orchestration"
      pattern: "discoverOpportunities"
---

<objective>
Build the engagement engine foundation: DB tables, opportunity scoring, cross-platform monitoring, and per-platform enforcement (caps, cooldowns, blocklists).

Purpose: Enable proactive discovery and scoring of engagement opportunities across all enabled platforms. This is the foundation Plan 08-05 builds the interactive engagement session on.
Output: Engagement DB schema, scoring engine, cross-platform monitor, config management, and scheduled Trigger.dev task.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-instagram-tiktok-and-engagement/08-RESEARCH.md
@.planning/phases/08-instagram-tiktok-and-engagement/08-01-SUMMARY.md
@.planning/phases/08-instagram-tiktok-and-engagement/08-02-SUMMARY.md

# Patterns to follow
@src/core/db/schema.ts
@src/analytics/scoring.ts
@src/trigger/trend-poller.ts
@src/intelligence/collector.ts
@src/voice/profile.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Engagement DB schema, types, and config management</name>
  <files>
    src/core/db/schema.ts
    src/engagement/types.ts
    src/engagement/config.ts
  </files>
  <action>
    Extend `src/core/db/schema.ts`:
    - Add `engagementOpportunities` table following research DB schema exactly:
      - id (uuid, defaultRandom, PK), userId (text, notNull), platform (text, notNull), externalPostId (text, notNull), authorHandle (text, notNull), authorFollowerCount (integer), postSnippet (text, notNull), postUrl (text), postedAt (timestamp with tz), compositeScoreBps (integer, notNull), relevanceScoreBps, recencyScoreBps, reachScoreBps, potentialScoreBps (all integer, notNull), status (text, default 'pending' — pending|triaged_yes|triaged_no|drafted|engaged|expired), suggestedType (text — reply|quote|repost|duet|stitch|comment), draftContent (text), engagedAt (timestamp), detectedAt (timestamp, defaultNow), createdAt (timestamp, defaultNow)
      - RLS policy using current_setting('app.current_user_id') pattern
    - Add `engagementConfig` table:
      - id (uuid, PK), userId (text, notNull, unique), nicheKeywords (jsonb string[]), platformToggles (jsonb Record<string,boolean>), dailyCaps (jsonb Record<string,number>), cooldownMinutes (jsonb Record<string,number>), blocklist (jsonb string[]), updatedAt (timestamp, defaultNow)
      - RLS policy
    - Add `engagementLog` table:
      - id (uuid, PK), userId (text, notNull), opportunityId (uuid, notNull), platform (text, notNull), engagementType (text, notNull), content (text, notNull), externalReplyId (text), outcome (jsonb with impressions/likes/replies), engagedAt (timestamp, defaultNow), createdAt (timestamp, defaultNow)
      - RLS policy
    - Generate migration: `npx drizzle-kit generate`

    Create `src/engagement/types.ts`:
    - Zod schemas for all DB table types
    - EngagementOpportunity interface (with composite and individual scores as 0-100, not bps)
    - OpportunityScore interface: { relevance, recency, reach, potential, composite } (all 0-100)
    - EngagementConfig interface matching DB table shape
    - OpportunityStatus union: "pending" | "triaged_yes" | "triaged_no" | "drafted" | "engaged" | "expired"
    - SuggestedEngagement union: "reply" | "quote" | "repost" | "duet" | "stitch" | "comment"
    - Platform-specific engagement types: X supports reply/quote/repost; LinkedIn supports comment/repost; Instagram supports comment; TikTok supports comment/duet/stitch

    Create `src/engagement/config.ts`:
    - `loadEngagementConfig(db, userId: string)` — Load config from DB, return defaults if no row exists. Default daily caps: { x: 20, linkedin: 10, instagram: 15, tiktok: 10 }. Default cooldown: 5 minutes between engagements on same platform.
    - `saveEngagementConfig(db, userId: string, config: Partial<EngagementConfig>)` — Upsert config
    - `deriveNicheKeywords(voiceProfilePath: string)` — Load voice profile YAML, extract pillar keywords as baseline niche terms. Returns string[] of keywords.
    - `checkDailyCap(db, userId: string, platform: string)` — Count today's engagements in engagement_log for platform. Return { allowed: boolean, remaining: number, cap: number }
    - `checkCooldown(db, userId: string, platform: string)` — Check last engagement timestamp for platform. Return { allowed: boolean, waitMinutes: number }
    - `isBlocked(config: EngagementConfig, authorHandle: string)` — Check if handle is in blocklist
    - `recordEngagement(db, userId: string, opportunityId: string, platform: string, type: string, content: string)` — Insert into engagement_log
    - `isPlatformMonitoringEnabled(config: EngagementConfig, platform: string)` — Check platformToggles, default true if not set
  </action>
  <verify>
    `npx tsc --noEmit` passes. `npx drizzle-kit generate` creates migration. `grep "engagementOpportunities\|engagementConfig\|engagementLog" src/core/db/schema.ts` shows all 3 tables.
  </verify>
  <done>
    Three engagement tables (opportunities, config, log) with RLS. Config management handles daily caps, cooldowns, blocklists. Niche keywords derived from voice profile pillars. All types defined with Zod schemas.
  </done>
</task>

<task type="auto">
  <name>Task 2: Opportunity scoring engine and cross-platform monitor</name>
  <files>
    src/engagement/scoring.ts
    src/engagement/monitor.ts
    src/trigger/engagement-monitor.ts
  </files>
  <action>
    Create `src/engagement/scoring.ts`:
    - `computeRelevanceScore(postContent: string, nicheKeywords: string[])` — Count keyword matches, normalize to 0-100. Higher score = more keyword overlap with user's niche.
    - `computeRecencyScore(postedAt: Date)` — Exponential decay: 100 for < 1 hour ago, 80 for 1-3 hours, 60 for 3-6 hours, 40 for 6-12 hours, 20 for 12-24 hours, 0 for > 24 hours.
    - `computeReachScore(followerCount: number)` — Log scale: 100 for 100K+, 80 for 10K-100K, 60 for 1K-10K, 40 for 100-1K, 20 for < 100.
    - `computePotentialScore(metrics: { likes, comments, shares, views?, postedAt })` — Engagement velocity: interactions per hour since posting. Normalize to 0-100 based on platform averages.
    - `scoreOpportunity(raw: { relevance, recency, reach, potential })` — Weighted composite: relevance * 0.4 + recency * 0.3 + reach * 0.2 + potential * 0.1. Returns integer 0-100.
    - `toBasisPoints(score: number)` — score * 100 for DB storage
    - `fromBasisPoints(bps: number)` — bps / 100 for display
    - `suggestEngagementType(platform: string, score: number, postContext: string)` — Based on platform capabilities and post type, suggest best engagement type. X: reply for conversations, quote for hot takes; LinkedIn: comment for thought leadership; Instagram: comment; TikTok: duet for visual responses, stitch for educational, comment otherwise.

    Create `src/engagement/monitor.ts`:
    - `discoverOpportunities(params: { db, userId, nicheKeywords, enabledPlatforms, platformClients })` — Orchestrates discovery across all enabled platforms. Returns EngagementOpportunity[].
    - `searchXTrending(client: XClient, keywords: string[])` — Use X search/recent API to find trending posts matching niche keywords. Return raw post data with metrics.
    - `searchInstagramTrending(client: InstagramClient, keywords: string[])` — Use hashtag search API for keyword-derived hashtags, then get recent media. Budget-aware: skip if hashtag search budget exhausted for the week.
    - `searchTikTokTrending(keywords: string[])` — Use Creative Center (free tier) to find trending content matching keywords. Graceful degradation if scraping fails.
    - `searchLinkedInTrending(client: LinkedInClient, keywords: string[])` — LinkedIn has NO content discovery API (walled garden per project notes). Return empty array with info log. Engagement on LinkedIn is manual-only discovery.
    - Each platform search returns normalized opportunity objects scored by the scoring engine
    - Store discovered opportunities in engagementOpportunities table (upsert by externalPostId + platform to avoid duplicates)
    - Filter out: already-triaged opportunities, blocked authors, posts older than 24 hours, platforms where monitoring is toggled off

    Create `src/trigger/engagement-monitor.ts`:
    - `engagementMonitor = schedules.task({ id: "engagement-monitor", cron: "0 */3 * * *", maxDuration: 300 })`
    - Every 3 hours (within 2-4 hour range per locked decision)
    - Load env (DATABASE_URL, HUB_ENCRYPTION_KEY)
    - Load engagement config for user
    - Derive niche keywords (from config or voice profile fallback)
    - Create platform clients for enabled platforms (check oauth_tokens)
    - Call discoverOpportunities
    - For scores >= 70: trigger push notification via existing notification system (from Phase 7)
    - For scores 60-69: batch into digest for next notification cycle
    - Log discovery summary: { platform: count } per platform
    - Per-platform error isolation: if X search fails, continue with other platforms
    - Expire old opportunities (> 48 hours, status still pending) by setting status='expired'
  </action>
  <verify>
    `npx tsc --noEmit` passes. `grep "scoreOpportunity\|computeRelevanceScore" src/engagement/scoring.ts` shows scoring functions. `grep "discoverOpportunities" src/engagement/monitor.ts src/trigger/engagement-monitor.ts` shows monitor wired to trigger task.
  </verify>
  <done>
    Scoring engine computes composite scores (relevance 40%, recency 30%, reach 20%, potential 10%) and suggests engagement type per platform. Monitor discovers trending content across X (search API), Instagram (hashtag search), TikTok (Creative Center), stores scored opportunities, and triggers notifications for high-scoring ones. Runs every 3 hours via Trigger.dev cron with per-platform error isolation.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — all files compile
2. `npx drizzle-kit generate` — migration for engagement tables created
3. `grep "engagementOpportunities\|engagementConfig\|engagementLog" src/core/db/schema.ts` — 3 tables with RLS
4. `grep "0\\.4.*0\\.3.*0\\.2.*0\\.1" src/engagement/scoring.ts` — correct composite weights
5. `grep "engagement-monitor" src/trigger/engagement-monitor.ts` — scheduled task registered
6. `grep "checkDailyCap\|checkCooldown\|isBlocked" src/engagement/config.ts` — enforcement functions exist
</verification>

<success_criteria>
- Three engagement tables with RLS (opportunities, config, log)
- Composite scoring: relevance 40%, recency 30%, reach 20%, potential 10%
- Cross-platform monitoring: X search, Instagram hashtag search, TikTok Creative Center
- LinkedIn returns empty (no discovery API — walled garden)
- Scheduled Trigger.dev task runs every 3 hours
- Daily caps, cooldowns, blocklists enforced
- Niche keywords from voice profile pillars
- High-score notifications (70+) and digest batching (60-69)
</success_criteria>

<output>
After completion, create `.planning/phases/08-instagram-tiktok-and-engagement/08-04-SUMMARY.md`
</output>
