---
phase: 08-instagram-tiktok-and-engagement
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/platforms/instagram/oauth.ts
  - src/platforms/instagram/types.ts
  - src/platforms/instagram/client.ts
  - src/platforms/instagram/media.ts
  - src/platforms/instagram/hashtags.ts
  - src/cli/setup-instagram-oauth.ts
  - src/cli/setup.ts
  - src/trigger/token-refresher.ts
autonomous: true
requirements: [AUTH-03, PLAT-03]
user_setup:
  - service: instagram
    why: "Instagram Platform API access for posting and analytics"
    env_vars:
      - name: INSTAGRAM_APP_ID
        source: "Meta Developer Portal -> My Apps -> Your App -> App Dashboard -> App ID"
      - name: INSTAGRAM_APP_SECRET
        source: "Meta Developer Portal -> My Apps -> Your App -> App Dashboard -> App Secret"
    dashboard_config:
      - task: "Create Meta App with Instagram Platform API product"
        location: "https://developers.facebook.com/apps -> Create App -> Other -> Consumer"
      - task: "Add Instagram Platform API product and configure scopes: instagram_business_basic, instagram_business_content_publish"
        location: "Meta Developer Portal -> Products -> Instagram -> Settings"
      - task: "Set OAuth redirect URL to https://example.com/callback"
        location: "Meta Developer Portal -> Products -> Instagram -> Settings -> Redirect URIs"

must_haves:
  truths:
    - "User can authenticate with Instagram via direct login OAuth flow and receive encrypted tokens stored in Hub DB"
    - "Instagram tokens auto-refresh before 60-day expiry via existing token-refresher cron"
    - "User can create feed image posts, carousel posts (up to 10 images), and Reels on Instagram via container-based API"
    - "Container processing is polled until FINISHED before publishing"
    - "Hashtag pool is cached and refreshed weekly within 30-search/week budget"
  artifacts:
    - path: "src/platforms/instagram/oauth.ts"
      provides: "Instagram Platform API direct login OAuth flow (raw fetch, no Arctic)"
      exports: ["generateInstagramAuthUrl", "exchangeInstagramCode", "refreshInstagramToken"]
    - path: "src/platforms/instagram/client.ts"
      provides: "Typed Instagram Graph API client with container workflow and rate limit tracking"
      exports: ["InstagramClient"]
    - path: "src/platforms/instagram/media.ts"
      provides: "Container creation for feed images, carousels, and Reels with polling"
      exports: ["createImageContainer", "createReelsContainer", "createCarouselContainers", "publishContainer", "waitForContainerReady"]
    - path: "src/platforms/instagram/hashtags.ts"
      provides: "Hashtag pool management with 30-search/week budget tracking"
      exports: ["searchHashtags", "getHashtagPool", "refreshHashtagPool"]
    - path: "src/platforms/instagram/types.ts"
      provides: "Instagram API types, Zod schemas, error classes"
      exports: ["InstagramApiError", "InstagramRateLimitError", "InstagramContainerSchema", "InstagramMediaSchema"]
  key_links:
    - from: "src/platforms/instagram/oauth.ts"
      to: "https://api.instagram.com"
      via: "raw fetch for direct login OAuth"
      pattern: "api\\.instagram\\.com/oauth"
    - from: "src/platforms/instagram/client.ts"
      to: "https://graph.instagram.com"
      via: "fetch with access_token params"
      pattern: "graph\\.instagram\\.com"
    - from: "src/platforms/instagram/media.ts"
      to: "src/platforms/instagram/client.ts"
      via: "container creation and publishing"
      pattern: "InstagramClient|createImageContainer"
    - from: "src/trigger/token-refresher.ts"
      to: "src/platforms/instagram/oauth.ts"
      via: "Instagram token refresh path"
      pattern: "platform.*instagram"
---

<objective>
Build the Instagram platform module: OAuth direct login flow, typed Graph API client, container-based media publishing (feed images, carousels, Reels), hashtag pool management, and token-refresher extension.

Purpose: Establish the complete Instagram API integration layer that Plan 08-03 will use for multi-platform dispatch, content generation, and analytics collection.
Output: Instagram OAuth flow, InstagramClient class, container-based media helpers, hashtag pool manager, and token-refresher extension.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-instagram-tiktok-and-engagement/08-RESEARCH.md

# Prior patterns to follow
@src/platforms/linkedin/oauth.ts
@src/platforms/linkedin/client.ts
@src/platforms/linkedin/media.ts
@src/platforms/linkedin/types.ts
@src/platforms/x/client.ts
@src/platforms/x/types.ts
@src/trigger/token-refresher.ts
@src/cli/setup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Instagram OAuth, types, and setup CLI</name>
  <files>
    src/platforms/instagram/oauth.ts
    src/platforms/instagram/types.ts
    src/cli/setup-instagram-oauth.ts
    src/cli/setup.ts
  </files>
  <action>
    Create `src/platforms/instagram/types.ts`:
    - InstagramApiError and InstagramRateLimitError error classes following LinkedInApiError/LinkedInRateLimitError pattern
    - Zod schemas: InstagramContainerSchema (id, status_code), InstagramMediaSchema (id, media_type, caption, timestamp, permalink), InstagramInsightsSchema (data array with name/values), InstagramTokenSchema (access_token, user_id, expires_in)
    - Export Platform-specific constants: GRAPH_BASE_URL = "https://graph.instagram.com", IG_AUTH_BASE = "https://api.instagram.com"
    - Rate limit constants: MAX_REQUESTS_PER_HOUR = 200, MAX_POSTS_PER_DAY = 25, MAX_HASHTAG_SEARCHES_PER_WEEK = 30

    Create `src/platforms/instagram/oauth.ts`:
    - Arctic does NOT have a native Instagram provider — implement manually using raw fetch (per research recommendation)
    - `generateInstagramAuthUrl(config: { appId, redirectUri, state })` — builds URL to `https://api.instagram.com/oauth/authorize` with scopes: `instagram_business_basic,instagram_business_content_publish`
    - `exchangeInstagramCode(config: { appId, appSecret, redirectUri, code })` — POST to `https://api.instagram.com/oauth/access_token` (form-urlencoded) for short-lived token, then GET `https://graph.instagram.com/access_token?grant_type=ig_exchange_token&client_secret=...&access_token=...` for long-lived 60-day token. Returns { accessToken, userId, expiresIn }
    - `refreshInstagramToken(accessToken: string)` — GET `https://graph.instagram.com/refresh_access_token?grant_type=ig_refresh_token&access_token=...`. Returns { accessToken, expiresIn }
    - All responses validated with Zod schemas. Errors throw InstagramApiError.

    Create `src/cli/setup-instagram-oauth.ts`:
    - Follow `src/cli/setup-linkedin-oauth.ts` pattern exactly
    - Check for INSTAGRAM_APP_ID and INSTAGRAM_APP_SECRET in env
    - Check for existing valid Instagram token in oauth_tokens table
    - Generate auth URL, prompt user to visit, exchange callback code for tokens
    - Store encrypted tokens in oauth_tokens with platform='instagram', metadata includes userId and expiresAt
    - Output JSON for Claude interpretation

    Update `src/cli/setup.ts`:
    - Add Instagram setup step after LinkedIn step (same optional pattern — skip gracefully if no credentials)
    - Import and call setupInstagramOAuth

    Update `src/trigger/token-refresher.ts`:
    - Add Instagram token refresh path alongside existing X and LinkedIn paths
    - Instagram tokens expire in 60 days — use same 7-day warning window as LinkedIn
    - Import refreshInstagramToken from instagram/oauth.ts
    - On refresh: store new encrypted access token, update expiresAt in metadata
  </action>
  <verify>
    `npx tsc --noEmit` passes. `grep -r "instagram" src/platforms/instagram/oauth.ts src/platforms/instagram/types.ts src/cli/setup-instagram-oauth.ts` shows all files exist with expected exports. Token refresher has Instagram case.
  </verify>
  <done>
    Instagram OAuth direct login flow works: auth URL generation, code exchange for long-lived token, token refresh. Setup CLI step integrates into /psn:setup. Token refresher handles Instagram 60-day lifecycle.
  </done>
</task>

<task type="auto">
  <name>Task 2: Instagram client, media containers, and hashtag pool</name>
  <files>
    src/platforms/instagram/client.ts
    src/platforms/instagram/media.ts
    src/platforms/instagram/hashtags.ts
  </files>
  <action>
    Create `src/platforms/instagram/client.ts`:
    - Follow XClient/LinkedInClient pattern: raw fetch, Zod response validation, rate limit tracking via response headers
    - Constructor: `InstagramClient(accessToken: string, accountId: string)`
    - Rate limit tracking: track requests per hour window (200 req/hr minimum)
    - Methods:
      - `getMe()` — GET `/{accountId}?fields=id,username,followers_count,media_count` for profile info
      - `getMediaInsights(mediaId: string)` — GET `/{mediaId}/insights?metric=impressions,reach,likes,comments,shares,saved` returns Record<string, number>
      - `getAccountInsights(period: "day"|"week"|"days_28", metrics: string[])` — GET `/{accountId}/insights` for account-level metrics
      - `getRecentMedia(limit?: number)` — GET `/{accountId}/media?fields=id,caption,media_type,timestamp,permalink,like_count,comments_count` for recent posts list
      - `searchHashtags(query: string)` — GET `/ig_hashtag_search?q={query}` returns hashtag IDs
      - `getHashtagRecentMedia(hashtagId: string)` — GET `/{hashtagId}/recent_media?fields=id,caption,like_count,comments_count,timestamp,permalink` for trending content in niche
      - `postComment(mediaId: string, message: string)` — POST `/{mediaId}/comments?message={message}` for engagement replies
    - All responses validated through Zod schemas from types.ts
    - Throw InstagramRateLimitError when rate limit exceeded

    Create `src/platforms/instagram/media.ts`:
    - Container-based publishing workflow following research Pattern 1, 2:
    - `createImageContainer(client: InstagramClient, imageUrl: string, caption: string)` — POST `/{accountId}/media` with image_url and caption params
    - `createReelsContainer(client: InstagramClient, videoUrl: string, caption: string)` — POST `/{accountId}/media` with media_type=REELS, video_url, caption, share_to_feed=true
    - `createCarouselContainers(client: InstagramClient, imageUrls: string[], caption: string)` — Create child containers (is_carousel_item=true) for each image, wait for each to be ready, then create parent with media_type=CAROUSEL and children IDs
    - `waitForContainerReady(client: InstagramClient, containerId: string, maxAttempts?: number)` — Poll GET `/{containerId}?fields=status_code` every 5 seconds until FINISHED or ERROR. Max 60 attempts (5 min). Following waitForMediaReady pattern from LinkedIn media.ts.
    - `publishContainer(client: InstagramClient, containerId: string)` — POST `/{accountId}/media_publish` with creation_id
    - Carousel validation: 2-10 images required

    Create `src/platforms/instagram/hashtags.ts`:
    - `getHashtagPool(client: InstagramClient, pillars: string[])` — Returns cached hashtag pool from local file (content/cache/hashtag-pool.json)
    - `refreshHashtagPool(client: InstagramClient, pillars: string[], maxSearches?: number)` — Search Instagram Hashtag API for each pillar keyword, store results in cache file with timestamp. Default maxSearches=10 per refresh to stay within 30/week budget.
    - `pickHashtags(pool: HashtagPoolEntry[], count?: number)` — Select dynamic hashtags per post from pool, default count=15 (Instagram allows 30 per post, use half for safety)
    - Cache format: { lastRefreshed: ISO date, searchesUsedThisWeek: number, weekStartDate: ISO date, hashtags: Array<{ tag, id, mediaCount, relevantPillar }> }
    - Budget tracking: refuse to search if searchesUsedThisWeek >= 30 and still within same 7-day rolling window
  </action>
  <verify>
    `npx tsc --noEmit` passes. All 3 files export their functions. InstagramClient has all listed methods. Media module has container workflow functions. Hashtag pool has budget tracking.
  </verify>
  <done>
    InstagramClient class provides typed Graph API access with rate limit tracking. Container-based publishing supports feed images, carousels (2-10), and Reels with polling. Hashtag pool manages 30-search/week budget with local caching.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — all files compile without errors
2. `ls src/platforms/instagram/` shows: oauth.ts, types.ts, client.ts, media.ts, hashtags.ts
3. `grep -c "export" src/platforms/instagram/*.ts` — each file has expected exports
4. `grep "instagram" src/trigger/token-refresher.ts` — refresher handles Instagram tokens
5. `grep "instagram" src/cli/setup.ts` — setup includes Instagram step
</verification>

<success_criteria>
- Instagram OAuth direct login flow (auth URL, code exchange, token refresh) is implemented
- InstagramClient provides typed access to Graph API with rate limit tracking
- Container-based publishing supports feed images, carousels (2-10 items), and Reels
- Hashtag pool caches searches and enforces 30/week budget
- Token refresher handles Instagram 60-day token lifecycle
- Setup CLI includes Instagram OAuth step
</success_criteria>

<output>
After completion, create `.planning/phases/08-instagram-tiktok-and-engagement/08-01-SUMMARY.md`
</output>
