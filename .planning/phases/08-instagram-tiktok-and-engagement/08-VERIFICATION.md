---
phase: 08-instagram-tiktok-and-engagement
verified: 2026-02-19T17:00:00Z
status: complete
score: 5/5 success criteria verified
gaps: []
gap_closure:
  - truth: "Engagement monitor surfaces trending posts in user's niche with scored opportunities and draft reply options"
    resolution: "REQUIREMENTS.md ENGAGE-01 text updated to reflect locked decision (2-4 hours). Implementation at 3 hours is correct."
    plan: "08-06-PLAN.md"
  - truth: "Engagement outcomes tracked and fed back into opportunity scoring model"
    resolution: "tracker.ts now imports detectFeedbackMoments from learning/feedback.ts. trackEngagementOutcome calls feedEngagementToLearningLoop after recording outcome. Cross-phase wire complete."
    plan: "08-06-PLAN.md"
human_verification:
  - test: "Run /psn:engage and complete a full triage-then-draft session"
    expected: "Opportunities presented in batches, user approves/rejects, 2-3 voice-matched drafts appear per approved item, posting requires explicit confirmation, post-session bridge asks about content ideas"
    why_human: "Full session UX flow, voice quality, and human approval gates cannot be verified programmatically"
  - test: "Verify Instagram container workflow posts successfully"
    expected: "createImageContainer -> waitForContainerReady (polls until FINISHED) -> publishContainer completes and returns media ID"
    why_human: "Requires live Instagram credentials and API access"
  - test: "Verify TikTok chunked upload works end-to-end"
    expected: "initVideoUpload -> uploadVideoChunks (Content-Range headers) -> checkPublishStatus succeeds"
    why_human: "Requires TikTok API credentials and audit approval"
---

# Phase 8: Instagram, TikTok, and Engagement Verification Report

**Phase Goal:** User can post to all 4 platforms and proactively engage with trending content in their niche
**Verified:** 2026-02-19
**Status:** gaps_found
**Re-verification:** No — initial verification

## Goal Achievement

### Observable Truths (from Success Criteria)

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | User can authenticate with Instagram (via Facebook OAuth) and TikTok, with tokens managed automatically | VERIFIED | `src/platforms/instagram/oauth.ts` implements direct login OAuth (auth URL, code exchange, 60-day token refresh via ig_refresh_token); `src/platforms/tiktok/oauth.ts` uses Arctic TikTok with PKCE; `src/trigger/token-refresher.ts` handles both (lines 73-74, 149-188) |
| 2 | User can generate and post Instagram content (feed images, carousels, Reels) within the 200 req/hr rate limit budget | VERIFIED | `src/platforms/instagram/media.ts` implements container workflow for images, carousels (2-10 validated), Reels with polling; `InstagramClient` tracks 200 req/hr; `src/trigger/publish-post.ts` dispatches to `publishToInstagram` (line 255, 659+) |
| 3 | User can generate and post TikTok content (video, photos) with chunked upload support | VERIFIED | `src/platforms/tiktok/media.ts` implements chunked video upload with Content-Range headers (5MB-64MB chunks) and photo URL posting; `src/trigger/publish-post.ts` dispatches to `publishToTikTok` (line 257, 845+) |
| 4 | Engagement monitor surfaces trending posts in user's niche with scored opportunities and draft reply options | VERIFIED | Monitor, scoring engine, and drafting all implemented and wired. Runs every 3 hours per locked decision (ENGAGE-01 text aligned in 08-06 gap closure). Draft options (2-3 per opportunity) generated by `src/engagement/drafting.ts`. |
| 5 | User can run `/psn:engage` for proactive engagement sessions with human approval on every reply and daily caps enforced | VERIFIED | `.claude/commands/psn/engage.md` implements full triage-then-draft flow; `src/engagement/session.ts` enforces caps/cooldowns before each engagement; `/engage.md` explicitly states "NEVER auto-post. Every single reply... requires explicit human approval." |

**Score:** 5/5 success criteria fully verified

---

## Required Artifacts

### Plan 08-01: Instagram Platform Module

| Artifact | Status | Details |
|----------|--------|---------|
| `src/platforms/instagram/oauth.ts` | VERIFIED | Implements `generateInstagramAuthUrl`, `exchangeInstagramCode`, `refreshInstagramToken` with two-step token exchange (short -> long-lived). Real API calls to api.instagram.com and graph.instagram.com. |
| `src/platforms/instagram/client.ts` | VERIFIED | `InstagramClient` class with all required methods: `getMe`, `getMediaInsights`, `getAccountInsights`, `getRecentMedia`, `searchHashtags`, `getHashtagRecentMedia`, `postComment`. Rate limit tracking at 200/hr. |
| `src/platforms/instagram/media.ts` | VERIFIED | `createImageContainer`, `createReelsContainer`, `createCarouselContainers` (2-10 validated), `waitForContainerReady` (60 attempts, 5s), `publishContainer` all implemented with real API calls. |
| `src/platforms/instagram/hashtags.ts` | VERIFIED | `getHashtagPool`, `refreshHashtagPool`, `pickHashtags` implemented. 30-search/week budget with 7-day rolling window tracked in `content/cache/hashtag-pool.json`. |
| `src/platforms/instagram/types.ts` | VERIFIED | Zod schemas, error classes, rate limit constants all present. |

### Plan 08-02: TikTok Platform Module

| Artifact | Status | Details |
|----------|--------|---------|
| `src/platforms/tiktok/oauth.ts` | VERIFIED | Uses `arctic` TikTok provider with PKCE. Implements `createTikTokOAuthClient`, `generateTikTokAuthUrl`, `exchangeTikTokCode`, `refreshTikTokToken` with rotation. |
| `src/platforms/tiktok/client.ts` | VERIFIED | `TikTokClient` class with all methods. SELF_ONLY enforced for unaudited apps. |
| `src/platforms/tiktok/media.ts` | VERIFIED | `initVideoUpload`, `uploadVideoChunks` (sequential PUT with Content-Range), `postPhotos` (max 35), `checkPublishStatus` (polling) all implemented. |
| `src/platforms/tiktok/creative-center.ts` | VERIFIED | `getTrendingTopics`, `getTrendingVideos` with graceful degradation (return `[]` on failure, never crash). |
| `src/platforms/tiktok/types.ts` | VERIFIED | Zod schemas, error classes, privacy levels, audit status type all present. |

### Plan 08-03: Multi-Platform Pipeline Integration

| Artifact | Status | Details |
|----------|--------|---------|
| `src/analytics/collector.ts` | VERIFIED | `collectInstagramAnalytics` (line 473) and `collectTikTokAnalytics` (line 656) exported with tiered cadence and engagement scoring. |
| `src/trigger/analytics-collector.ts` | VERIFIED | Both functions imported and called in dedicated task blocks with per-platform error isolation (lines 88, 101). |
| `src/trigger/publish-post.ts` | VERIFIED | `publishToInstagram` (line 659) and `publishToTikTok` (line 845) implemented and wired into multi-platform dispatch (lines 255-257). Container workflow and chunked upload fully used. |

### Plan 08-04: Engagement Engine Foundation

| Artifact | Status | Details |
|----------|--------|---------|
| `src/core/db/schema.ts` | VERIFIED | `engagementOpportunities` (line 594), `engagementConfig` (line 632), `engagementLog` (line 657) all present with RLS. Migration at `drizzle/migrations/0001_wet_mach_iv.sql`. |
| `src/engagement/types.ts` | VERIFIED | Zod schemas, interfaces, platform-specific engagement type mappings all present. |
| `src/engagement/scoring.ts` | VERIFIED | All scoring functions present. Composite weights: `relevance * 0.4 + recency * 0.3 + reach * 0.2 + potential * 0.1` (line 95-96). |
| `src/engagement/monitor.ts` | VERIFIED | `discoverOpportunities`, `searchXTrending`, `searchInstagramTrending`, `searchTikTokTrending` all implemented and wired. LinkedIn correctly returns empty with info log. |
| `src/engagement/config.ts` | VERIFIED | `loadEngagementConfig`, `checkDailyCap`, `checkCooldown`, `isBlocked`, `recordEngagement`, `isPlatformMonitoringEnabled` all exported. |
| `src/trigger/engagement-monitor.ts` | VERIFIED | Scheduled task with `id: "engagement-monitor"`, `cron: "0 */3 * * *"`. Calls `discoverOpportunities` and routes notifications by score threshold. |

### Plan 08-05: Engagement Session

| Artifact | Status | Details |
|----------|--------|---------|
| `src/engagement/drafting.ts` | VERIFIED | `draftReplies`, `draftQuotePost`, `draftRepostCommentary`, `draftDuetStitch` all exported. Uses VoiceProfile for context-adaptive tone. Returns context blocks for Claude to render (content brain pattern). |
| `src/engagement/session.ts` | VERIFIED | `createEngagementSession`, `triageOpportunities`, `draftForApproved`, `executeEngagement`, `bridgeToContentCreation` all exported. Cap and cooldown checks enforced before each engagement. |
| `src/engagement/tracker.ts` | VERIFIED | `trackEngagementOutcome`, `updateScoringWeights`, `getEngagementStats`, `getEngagementHistory` all exported. Scoring weight analysis implemented. |
| `.claude/commands/psn/engage.md` | VERIFIED | Full triage-then-draft flow documented. Human approval enforced. Post-session content bridge to `/psn:capture` documented (ENGAGE-07). |
| `src/cli/engage.ts` | VERIFIED | `session`, `triage`, `execute`, `stats`, `history` subcommands. JSON output for Claude interpretation. |

---

## Key Link Verification

| From | To | Via | Status | Details |
|------|----|----|--------|---------|
| `src/platforms/instagram/oauth.ts` | `api.instagram.com` | raw fetch for direct login | WIRED | `${IG_AUTH_BASE}/oauth/authorize`, `${IG_AUTH_BASE}/oauth/access_token` |
| `src/platforms/instagram/client.ts` | `graph.instagram.com` | fetch with access_token param | WIRED | `GRAPH_BASE_URL` used in all requests |
| `src/platforms/instagram/media.ts` | `src/platforms/instagram/client.ts` | container creation and publishing | WIRED | `client.post(...)` and `client.request(...)` called throughout |
| `src/trigger/token-refresher.ts` | `src/platforms/instagram/oauth.ts` | Instagram token refresh | WIRED | `import { refreshInstagramToken }` line 5, platform='instagram' case at line 171 |
| `src/platforms/tiktok/oauth.ts` | `arctic` | Arctic TikTok with PKCE | WIRED | `import { TikTok, ... } from "arctic"`, `new TikTok(...)` |
| `src/platforms/tiktok/client.ts` | `open.tiktokapis.com` | fetch with Bearer token | WIRED | `TIKTOK_BASE_URL = "https://open.tiktokapis.com"` used in requests |
| `src/trigger/token-refresher.ts` | `src/platforms/tiktok/oauth.ts` | TikTok token refresh with rotation | WIRED | `import { createTikTokOAuthClient, refreshTikTokToken }` line 11, platform='tiktok' case at line 149 |
| `src/trigger/publish-post.ts` | `src/platforms/instagram/media.ts` | container workflow | WIRED | `createImageContainer`, `createReelsContainer`, `createCarouselContainers` imported and called (lines 10-12, 777-815) |
| `src/trigger/publish-post.ts` | `src/platforms/tiktok/media.ts` | chunked upload / photo posting | WIRED | `initVideoUpload`, `uploadVideoChunks`, `postPhotos` imported and called (lines 34-36, 957-985) |
| `src/trigger/analytics-collector.ts` | `src/analytics/collector.ts` | Instagram and TikTok collection | WIRED | `collectInstagramAnalytics`, `collectTikTokAnalytics` imported and called |
| `src/engagement/monitor.ts` | `src/platforms/x/client.ts` | X search for trending posts | WIRED | `import type { XClient }`, `client.searchRecent(...)` at line 226 |
| `src/engagement/monitor.ts` | `src/platforms/instagram/client.ts` | Instagram hashtag search | WIRED | `import type { InstagramClient }`, `client.getHashtagRecentMedia(...)` at line 301 |
| `src/engagement/monitor.ts` | `src/platforms/tiktok/creative-center.ts` | TikTok Creative Center | WIRED | `import { getTrendingTopics, getTrendingVideos }` line 5, called at lines 341, 349 |
| `src/engagement/scoring.ts` | `src/engagement/types.ts` | scoring interfaces and basis points | WIRED | `OpportunityScore` type used, `toBasisPoints`/`fromBasisPoints` exported |
| `src/trigger/engagement-monitor.ts` | `src/engagement/monitor.ts` | scheduled discovery orchestration | WIRED | `import { discoverOpportunities }` line 7, called at line 113 |
| `src/engagement/drafting.ts` | `src/content/brain.ts` | voice profile context for reply generation | PARTIAL | Drafting imports `VoiceProfile` type from `voice/types.ts` and uses it for context assembly. Does NOT import from `content/brain.ts`. Uses content brain pattern (assemble context, Claude generates) without calling `generatePost` or `loadProfile` from brain. Session.ts does import `loadProfile` from `voice/profile.ts`. Goal is achieved via the slash command rendering context. |
| `src/engagement/session.ts` | `src/engagement/scoring.ts` | scoring and sorting | WIRED | `fromBasisPoints` imported; opportunities sorted by composite score |
| `src/engagement/session.ts` | `src/engagement/config.ts` | cap and cooldown checks | WIRED | `checkDailyCap`, `checkCooldown`, `isBlocked` imported and called in `executeEngagement` |
| `src/engagement/tracker.ts` | `src/learning/feedback.ts` | feedback loop integration | WIRED | `tracker.ts` imports `detectFeedbackMoments` from `learning/feedback.ts`. `trackEngagementOutcome` calls `feedEngagementToLearningLoop` after recording outcome. Fixed in 08-06 gap closure. |
| `src/engagement/session.ts` | `src/ideas/capture.ts` | content bridge via idea capture | NOT WIRED | `bridgeToContentCreation` returns suggestions only; does not import or call `captureIdea`. The slash command handles this by calling `bun run src/cli/capture.ts capture "..."` — the goal (ENGAGE-07) is met at the user-facing level through the command, not programmatically. |

---

## Requirements Coverage

| Requirement | Source Plan | Description | Status | Evidence |
|-------------|------------|-------------|--------|----------|
| AUTH-03 | 08-01 | User can authenticate with Instagram via Facebook OAuth | SATISFIED | `src/platforms/instagram/oauth.ts` — direct login flow; `src/cli/setup-instagram-oauth.ts`; `src/cli/setup.ts` wired |
| AUTH-04 | 08-02 | User can authenticate with TikTok via OAuth 2.0 | SATISFIED | `src/platforms/tiktok/oauth.ts` — Arctic PKCE; `src/cli/setup-tiktok-oauth.ts`; `src/cli/setup.ts` wired |
| PLAT-03 | 08-01 | Instagram posting: feed images, carousels, Reels | SATISFIED | `src/platforms/instagram/media.ts` — all three container types; wired in `src/trigger/publish-post.ts` |
| PLAT-04 | 08-02 | TikTok posting: video, photos | SATISFIED | `src/platforms/tiktok/media.ts` — chunked video and photo URL posting; wired in `src/trigger/publish-post.ts` |
| ANLYT-03 | 08-03 | Analytics from Instagram API daily (200 req/hr budget) | SATISFIED | `collectInstagramAnalytics` budgets 50 req/hr; tiered cadence; wired in `analytics-collector.ts` |
| ANLYT-04 | 08-03 | Analytics from TikTok API daily | SATISFIED | `collectTikTokAnalytics` via video.list inline metrics; wired in `analytics-collector.ts` |
| POST-03 | 08-03 | Generate Instagram post in user's voice via `/psn:post` | SATISFIED | `src/content/generate.ts` — `INSTAGRAM_CONTENT_GUIDANCE` constants; `format-picker.ts` — Instagram format keywords and Reels bias |
| POST-04 | 08-03 | Generate TikTok post in user's voice via `/psn:post` | SATISFIED | `src/content/generate.ts` — `TIKTOK_CONTENT_GUIDANCE` constants with video script format; `format-picker.ts` — TikTok video/photo formats |
| ENGAGE-01 | 08-04 | Engagement monitor runs every 2-4 hours (locked decision) | SATISFIED | Monitor runs every 3 hours per locked decision. REQUIREMENTS.md text aligned in 08-06 gap closure. |
| ENGAGE-02 | 08-04 | Opportunities scored: relevance x author influence x post velocity x time window | SATISFIED | `src/engagement/scoring.ts` — composite formula with relevance 40%, recency 30%, reach 20%, potential 10%. Basis points stored in DB. |
| ENGAGE-03 | 08-05 | Scores 60+: draft 2-3 reply options; 70+: push notify; 60-69: digest | SATISFIED | `createEngagementSession` filters score >= 60; `draftReplies` returns 2-3 options; `engagement-monitor.ts` routes notifications by threshold |
| ENGAGE-04 | 08-05 | User can run `/psn:engage` for 15-minute sessions | SATISFIED | `.claude/commands/psn/engage.md` — full triage-then-draft flow with 15-minute target |
| ENGAGE-05 | 08-05 | Human approves every reply — never auto-post | SATISFIED | `executeEngagement` is never called automatically; slash command requires explicit user approval; "NEVER auto-post" stated in engage.md |
| ENGAGE-06 | 08-04 | Daily caps, cooldowns, blocklists enforced per platform | SATISFIED | `src/engagement/config.ts` — `checkDailyCap`, `checkCooldown`, `isBlocked`; called in `executeEngagement` before every post |
| ENGAGE-07 | 08-05 | After session, bridge to content creation | SATISFIED | `bridgeToContentCreation` returns suggestions; slash command prompts "Any of these conversations spark a post idea?" and calls `/psn:capture` |

**Requirement coverage: 15/15 fully satisfied.**

---

## Anti-Patterns Found

| File | Pattern | Severity | Notes |
|------|---------|----------|-------|
| `src/platforms/tiktok/creative-center.ts` | `return []` on failure | INFO | Intentional graceful degradation as specified in the plan. Not a stub. |
| `src/engagement/tracker.ts` | ~~Missing import from `src/learning/feedback.ts`~~ | RESOLVED | Fixed in 08-06 gap closure. Tracker now imports and calls `detectFeedbackMoments`. |

---

## Human Verification Required

### 1. Instagram container workflow end-to-end

**Test:** With valid Instagram credentials, call `/psn:post` to post a feed image, a carousel (3 images), and a Reel.
**Expected:** Each container is created, polled until FINISHED, then published. Media IDs stored in `post.metadata.platformPostIds.instagram`.
**Why human:** Requires live Instagram API credentials and public image/video URLs.

### 2. TikTok chunked video upload end-to-end

**Test:** With valid TikTok credentials (or unaudited draft mode), call `/psn:post` with a video file.
**Expected:** Video is chunked at 10MB, uploaded sequentially with Content-Range headers, publish status polled to PUBLISH_COMPLETE. Unaudited app sets SELF_ONLY visibility.
**Why human:** Requires TikTok API credentials and video file.

### 3. Full `/psn:engage` session UX

**Test:** Run `/psn:engage` after the engagement monitor has populated opportunities.
**Expected:** Triage batch presented (10-20 items), quick yes/no/skip decisions accepted, 2-3 voice-matched drafts generated per approved item, explicit confirmation required before each post, post-session bridge asks about content ideas.
**Why human:** UX flow, voice quality, and approval gate behavior cannot be verified programmatically.

### 4. Engagement monitor discovery

**Test:** Trigger engagement monitor manually with niche keywords set in config.
**Expected:** X search finds relevant posts, Instagram hashtag search finds recent media (limited to 2 searches per run), TikTok Creative Center returns trending topics (or gracefully returns empty if unavailable). Opportunities scored and stored in DB.
**Why human:** Requires live platform credentials and platform connectivity.

---

## Gaps Summary

**All gaps resolved via 08-06-PLAN.md (gap closure).**

**Gap 1: ENGAGE-01 frequency deviation** — RESOLVED. REQUIREMENTS.md ENGAGE-01 text updated to "every 2-4 hours" to match locked decision from phase discussion. Implementation at 3 hours is correct.

**Gap 2: Engagement-to-preference-model feedback loop absent** — RESOLVED. `src/engagement/tracker.ts` now imports `detectFeedbackMoments` from `src/learning/feedback.ts`. `trackEngagementOutcome` calls `feedEngagementToLearningLoop` after recording each outcome. Cross-phase wire complete.

**Non-blocking observations:**

- The content bridge (`bridgeToContentCreation`) returns suggestions without calling `captureIdea` directly. The slash command bridges this by invoking the CLI. The user-facing goal (ENGAGE-07) is achieved; the gap is at the programmatic key-link level only.
- The drafting engine uses `VoiceProfile` from `voice/types.ts` rather than importing from `content/brain.ts`. This is an alternate valid implementation of the content brain pattern (context blocks, Claude renders) — the goal of voice-matched drafts is fully achieved.

---

_Verified: 2026-02-19_
_Verifier: Claude (gsd-verifier)_
