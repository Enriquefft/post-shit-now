---
phase: 08-instagram-tiktok-and-engagement
plan: 03
type: execute
wave: 2
depends_on: ["08-01", "08-02"]
files_modified:
  - src/analytics/collector.ts
  - src/trigger/analytics-collector.ts
  - src/trigger/publish-post.ts
  - src/content/brain.ts
  - src/content/format-picker.ts
autonomous: true
requirements: [ANLYT-03, ANLYT-04, POST-03, POST-04]

must_haves:
  truths:
    - "Analytics collector pulls Instagram metrics daily within 200 req/hr budget"
    - "Analytics collector pulls TikTok video metrics daily via video.list API"
    - "Multi-platform dispatch publishes to Instagram and TikTok alongside X and LinkedIn"
    - "Content brain generates Instagram-optimized posts with 2200-char caption and hashtags from pool"
    - "Content brain generates TikTok-optimized posts with video scripts and 4000-char descriptions"
    - "Format picker auto-suggests Instagram formats (feed image, carousel, Reel) and TikTok formats (video, photo)"
  artifacts:
    - path: "src/analytics/collector.ts"
      provides: "Instagram and TikTok analytics collection functions"
      exports: ["collectInstagramAnalytics", "collectTikTokAnalytics"]
    - path: "src/trigger/analytics-collector.ts"
      provides: "Extended daily cron with Instagram and TikTok collection"
      contains: "collectInstagramAnalytics|collectTikTokAnalytics"
    - path: "src/trigger/publish-post.ts"
      provides: "Instagram and TikTok publishing paths in multi-platform dispatch"
      contains: "publishToInstagram|publishToTikTok"
  key_links:
    - from: "src/trigger/publish-post.ts"
      to: "src/platforms/instagram/media.ts"
      via: "container workflow for Instagram publishing"
      pattern: "createImageContainer|createReelsContainer|createCarouselContainers"
    - from: "src/trigger/publish-post.ts"
      to: "src/platforms/tiktok/media.ts"
      via: "chunked upload or photo posting for TikTok publishing"
      pattern: "initVideoUpload|uploadVideoChunks|postPhotos"
    - from: "src/trigger/analytics-collector.ts"
      to: "src/analytics/collector.ts"
      via: "Instagram and TikTok analytics collection"
      pattern: "collectInstagramAnalytics|collectTikTokAnalytics"
---

<objective>
Wire Instagram and TikTok into the multi-platform dispatch, analytics collection, and content generation pipelines.

Purpose: Make Instagram and TikTok first-class platforms in the existing posting, analytics, and content generation workflows. Users can generate, post, and track content on all 4 platforms.
Output: Extended analytics collector, publish-post dispatch, content brain, and format picker with Instagram/TikTok support.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-instagram-tiktok-and-engagement/08-RESEARCH.md
@.planning/phases/08-instagram-tiktok-and-engagement/08-01-SUMMARY.md
@.planning/phases/08-instagram-tiktok-and-engagement/08-02-SUMMARY.md

# Files to extend
@src/analytics/collector.ts
@src/trigger/analytics-collector.ts
@src/trigger/publish-post.ts
@src/content/brain.ts
@src/content/format-picker.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Instagram and TikTok analytics collection</name>
  <files>
    src/analytics/collector.ts
    src/trigger/analytics-collector.ts
  </files>
  <action>
    Extend `src/analytics/collector.ts`:
    - Add `collectInstagramAnalytics(client: InstagramClient, db, userId: string)`:
      - Query published Instagram posts from posts table (platform='instagram' or metadata.platformStatus.instagram='published')
      - For each post, call client.getMediaInsights(mediaId) to get impressions, reach, likes, comments, shares, saved
      - Upsert into postMetrics table following existing X/LinkedIn pattern (basis points for engagement rate)
      - Apply same tiered cadence: 0-7 day posts every run, 8-30 day posts if not collected in 3 days
      - Rate limit budget: reserve ~50 req/hr for analytics (conservative allocation from 200/hr total)
      - Per-post error isolation: catch, log, continue (same as X/LinkedIn pattern)
      - Return CollectionSummary
    - Add `collectTikTokAnalytics(client: TikTokClient, db, userId: string)`:
      - Call client.getVideoList() to get all recent videos with metrics (views, likes, comments, shares)
      - Match videos to posts table entries by platform post ID stored in metadata.platformPostIds
      - Upsert metrics into postMetrics table
      - TikTok video.list returns metrics inline — no separate insights call needed (more efficient)
      - Apply same tiered cadence and per-post error isolation
      - Return CollectionSummary

    Extend `src/trigger/analytics-collector.ts`:
    - Add Instagram collection block alongside existing X and LinkedIn blocks
    - Check for Instagram token in oauth_tokens, decrypt, create InstagramClient
    - Call collectInstagramAnalytics with try/catch isolation (Instagram failure does NOT crash other platforms)
    - Add TikTok collection block alongside Instagram
    - Check for TikTok token, decrypt, create TikTokClient
    - Call collectTikTokAnalytics with try/catch isolation
    - Import InstagramClient from platforms/instagram/client.ts and TikTokClient from platforms/tiktok/client.ts
    - Log per-platform summary counts
  </action>
  <verify>
    `npx tsc --noEmit` passes. `grep "collectInstagramAnalytics\|collectTikTokAnalytics" src/analytics/collector.ts src/trigger/analytics-collector.ts` shows functions defined and called.
  </verify>
  <done>
    Daily analytics collector pulls Instagram metrics (impressions, reach, likes, comments, shares, saved) and TikTok metrics (views, likes, comments, shares) with per-platform error isolation and tiered cadence.
  </done>
</task>

<task type="auto">
  <name>Task 2: Multi-platform publish dispatch and content generation for Instagram/TikTok</name>
  <files>
    src/trigger/publish-post.ts
    src/content/brain.ts
    src/content/format-picker.ts
  </files>
  <action>
    Extend `src/trigger/publish-post.ts`:
    - Add `publishToInstagram(post, instagramToken, encryptionKey)` function:
      - Create InstagramClient with decrypted token and accountId from token metadata
      - Based on post format (from metadata or content analysis):
        - feed image: createImageContainer -> waitForContainerReady -> publishContainer
        - carousel: createCarouselContainers (handles children + parent) -> waitForContainerReady -> publishContainer
        - reel: createReelsContainer -> waitForContainerReady -> publishContainer
      - Media URLs must be publicly accessible (Instagram fetches from URL)
      - Store published media ID in post.metadata.platformPostIds.instagram
      - Handle InstagramRateLimitError with Trigger.dev wait.until() (same as X/LinkedIn pattern)
      - Check daily post count (25 max) before attempting publish
    - Add `publishToTikTok(post, tiktokToken, encryptionKey)` function:
      - Create TikTokClient with decrypted token and audit status from token metadata
      - Based on post format:
        - video: initVideoUpload -> uploadVideoChunks (from local file buffer) -> checkPublishStatus
        - photo: postPhotos with public image URLs
      - If unaudited: force SELF_ONLY privacy, save as draft with note for manual posting
      - Store publishId in post.metadata.platformPostIds.tiktok
      - Handle TikTokRateLimitError with wait.until()
    - Wire both into existing multi-platform dispatch loop (same pattern as X/LinkedIn: try/catch per platform, partial failure with platformStatus tracking)

    Extend `src/content/brain.ts` (generatePost context assembler):
    - Add Instagram-specific context when platform includes instagram:
      - Caption constraint: 2200 chars max
      - Hashtag injection: call pickHashtags from hashtag pool, append to caption
      - Format hint in voice prompt: "Instagram favors visual storytelling, Reels get 30.81% reach rate"
      - Carousel prompt hint: "Each slide should tell part of a story or list item"
    - Add TikTok-specific context when platform includes tiktok:
      - Title constraint: 90 chars max
      - Description constraint: 4000 chars max
      - Video script format: hook (first 3 seconds), body, CTA
      - Format hint: "TikTok algorithm favors video — default to video content"
      - If unaudited: note in context that content will be draft-only for manual posting

    Extend `src/content/format-picker.ts` (pickFormat):
    - Instagram format selection (per locked decision: Claude auto-picks, user can override):
      - Reel: content about tutorials, how-to, behind-scenes, storytelling, trending audio
      - Carousel: content about lists, steps, frameworks, comparisons, educational
      - Feed image: content about quotes, announcements, single visual concepts
      - Bias toward Reels when content could go either way (30.81% reach rate)
    - TikTok format selection (per locked decision: video-first):
      - Video: default for most content (TikTok strongly favors video)
      - Photo: content that is purely visual gallery (rare — most content should be video)
    - Add keyword sets for Instagram and TikTok format detection, following existing pattern from X/LinkedIn keyword matching
  </action>
  <verify>
    `npx tsc --noEmit` passes. `grep "publishToInstagram\|publishToTikTok" src/trigger/publish-post.ts` shows both functions. `grep "instagram\|tiktok" src/content/brain.ts src/content/format-picker.ts` shows platform-specific context and format selection.
  </verify>
  <done>
    Multi-platform dispatch publishes to Instagram (container workflow) and TikTok (chunked upload/photos) with partial failure isolation. Content brain adds Instagram caption/hashtag constraints and TikTok video script format. Format picker auto-suggests Instagram (Reel/carousel/feed) and TikTok (video/photo) based on content analysis.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — all modified files compile
2. `grep -c "instagram\|tiktok" src/trigger/publish-post.ts` — both platforms wired into dispatch
3. `grep -c "instagram\|tiktok" src/trigger/analytics-collector.ts` — both platforms in analytics
4. `grep "pickHashtags\|hashtag" src/content/brain.ts` — hashtag injection for Instagram
5. `grep "instagram\|tiktok" src/content/format-picker.ts` — format selection for both platforms
</verification>

<success_criteria>
- Analytics collector pulls Instagram and TikTok metrics daily with per-platform isolation
- Publish-post dispatches to Instagram (container workflow) and TikTok (chunked upload/photos)
- Instagram enforces 25-post daily limit and 200 req/hr rate budget
- TikTok enforces SELF_ONLY for unaudited clients
- Content brain generates platform-optimized content (Instagram captions+hashtags, TikTok video scripts)
- Format picker auto-suggests formats for both platforms with content analysis
</success_criteria>

<output>
After completion, create `.planning/phases/08-instagram-tiktok-and-engagement/08-03-SUMMARY.md`
</output>
