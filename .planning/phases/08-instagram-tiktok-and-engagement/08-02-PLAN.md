---
phase: 08-instagram-tiktok-and-engagement
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/platforms/tiktok/oauth.ts
  - src/platforms/tiktok/types.ts
  - src/platforms/tiktok/client.ts
  - src/platforms/tiktok/media.ts
  - src/platforms/tiktok/creative-center.ts
  - src/cli/setup-tiktok-oauth.ts
  - src/cli/setup.ts
  - src/trigger/token-refresher.ts
autonomous: true
requirements: [AUTH-04, PLAT-04]
user_setup:
  - service: tiktok
    why: "TikTok Content Posting API access"
    env_vars:
      - name: TIKTOK_CLIENT_KEY
        source: "TikTok Developer Portal -> Manage Apps -> Your App -> App Key"
      - name: TIKTOK_CLIENT_SECRET
        source: "TikTok Developer Portal -> Manage Apps -> Your App -> App Secret"
    dashboard_config:
      - task: "Create TikTok Developer App"
        location: "https://developers.tiktok.com -> Manage Apps -> Create"
      - task: "Enable scopes: user.info.basic, video.list, video.publish, video.upload"
        location: "TikTok Developer Portal -> Products -> Content Posting API"
      - task: "Set OAuth redirect URL to https://example.com/callback"
        location: "TikTok Developer Portal -> Manage Apps -> Configuration -> Redirect URI"
      - task: "Submit for API audit (optional — draft-only mode works without audit)"
        location: "TikTok Developer Portal -> Submit for review"

must_haves:
  truths:
    - "User can authenticate with TikTok via Arctic TikTok provider with PKCE"
    - "TikTok tokens auto-refresh via existing token-refresher cron"
    - "User can upload videos via chunked upload (5MB-64MB chunks, sequential)"
    - "User can post photos via URL pull (up to 35 images)"
    - "Unaudited clients default to SELF_ONLY visibility (draft-only mode) with clear user communication"
    - "Creative Center provides free trending content discovery"
  artifacts:
    - path: "src/platforms/tiktok/oauth.ts"
      provides: "TikTok OAuth via Arctic TikTok provider with PKCE"
      exports: ["createTikTokOAuthClient", "generateTikTokAuthUrl", "exchangeTikTokCode", "refreshTikTokToken"]
    - path: "src/platforms/tiktok/client.ts"
      provides: "Typed TikTok Content Posting API client"
      exports: ["TikTokClient"]
    - path: "src/platforms/tiktok/media.ts"
      provides: "Chunked video upload and photo URL posting"
      exports: ["initVideoUpload", "uploadVideoChunks", "postPhotos", "checkPublishStatus"]
    - path: "src/platforms/tiktok/creative-center.ts"
      provides: "Free trending content discovery via TikTok Creative Center"
      exports: ["getTrendingTopics", "getTrendingVideos"]
    - path: "src/platforms/tiktok/types.ts"
      provides: "TikTok API types, Zod schemas, error classes, audit status tracking"
      exports: ["TikTokApiError", "TikTokRateLimitError", "TikTokPublishSchema", "TikTokVideoListSchema"]
  key_links:
    - from: "src/platforms/tiktok/oauth.ts"
      to: "arctic"
      via: "TikTok provider constructor with PKCE"
      pattern: "new TikTok\\("
    - from: "src/platforms/tiktok/client.ts"
      to: "https://open.tiktokapis.com"
      via: "fetch with Bearer token"
      pattern: "open\\.tiktokapis\\.com"
    - from: "src/platforms/tiktok/media.ts"
      to: "src/platforms/tiktok/client.ts"
      via: "video upload initialization and chunk upload"
      pattern: "TikTokClient|initVideoUpload"
    - from: "src/trigger/token-refresher.ts"
      to: "src/platforms/tiktok/oauth.ts"
      via: "TikTok token refresh path"
      pattern: "platform.*tiktok"
---

<objective>
Build the TikTok platform module: OAuth via Arctic with PKCE, typed Content Posting API client, chunked video upload, photo posting, Creative Center trend discovery, and token-refresher extension.

Purpose: Establish the complete TikTok API integration layer with draft-only mode for unaudited clients. Plan 08-03 will wire this into multi-platform dispatch and analytics.
Output: TikTok OAuth flow, TikTokClient class, chunked video upload, photo posting, Creative Center scraper, and token-refresher extension.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/08-instagram-tiktok-and-engagement/08-RESEARCH.md

# Prior patterns to follow
@src/platforms/linkedin/oauth.ts
@src/platforms/linkedin/client.ts
@src/platforms/linkedin/media.ts
@src/platforms/linkedin/types.ts
@src/platforms/x/client.ts
@src/platforms/x/types.ts
@src/trigger/token-refresher.ts
@src/cli/setup.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: TikTok OAuth, types, and setup CLI</name>
  <files>
    src/platforms/tiktok/oauth.ts
    src/platforms/tiktok/types.ts
    src/cli/setup-tiktok-oauth.ts
    src/cli/setup.ts
  </files>
  <action>
    Create `src/platforms/tiktok/types.ts`:
    - TikTokApiError and TikTokRateLimitError error classes following existing XApiError/LinkedInApiError pattern
    - Zod schemas: TikTokPublishSchema (publish_id), TikTokVideoListSchema (videos array with id, title, create_time, like_count, comment_count, share_count, view_count + cursor + has_more), TikTokUserInfoSchema (open_id, display_name, avatar_url, follower_count)
    - Export constants: TIKTOK_BASE_URL = "https://open.tiktokapis.com"
    - Audit status type: `type TikTokAuditStatus = "unaudited" | "audited"` — stored in token metadata
    - Privacy level constants: SELF_ONLY (unaudited default), PUBLIC_TO_EVERYONE, MUTUAL_FOLLOW_FRIENDS, FOLLOWER_OF_CREATOR
    - Content limits: MAX_TITLE_LENGTH = 90, MAX_DESCRIPTION_LENGTH = 4000, MAX_PHOTOS_PER_POST = 35, MIN_CHUNK_SIZE = 5 * 1024 * 1024, MAX_CHUNK_SIZE = 64 * 1024 * 1024

    Create `src/platforms/tiktok/oauth.ts`:
    - Use Arctic TikTok provider with PKCE (Arctic has native support per research)
    - `createTikTokOAuthClient(config: { clientKey, clientSecret, callbackUrl })` — returns new TikTok(clientKey, clientSecret, callbackUrl)
    - `generateTikTokAuthUrl(client: TikTok)` — generates state + codeVerifier via Arctic helpers, calls client.createAuthorizationURL with scopes: ["user.info.basic", "video.list", "video.publish", "video.upload"]. Returns { url, state, codeVerifier }
    - `exchangeTikTokCode(client: TikTok, code: string, codeVerifier: string)` — calls client.validateAuthorizationCode(code, codeVerifier). Returns { accessToken, refreshToken, expiresAt }
    - `refreshTikTokToken(client: TikTok, refreshToken: string)` — calls client.refreshAccessToken(refreshToken). Returns { accessToken, refreshToken, expiresAt }

    Create `src/cli/setup-tiktok-oauth.ts`:
    - Follow setup-linkedin-oauth.ts pattern exactly
    - Check for TIKTOK_CLIENT_KEY and TIKTOK_CLIENT_SECRET in env
    - Check for existing valid TikTok token in oauth_tokens table
    - Generate auth URL with PKCE, prompt user to visit, exchange callback code for tokens
    - Store encrypted tokens in oauth_tokens with platform='tiktok', metadata includes openId, expiresAt, refreshToken (encrypted), and auditStatus='unaudited' (default)
    - Output JSON for Claude interpretation, include note about unaudited draft-only mode

    Update `src/cli/setup.ts`:
    - Add TikTok setup step after Instagram step (same optional pattern — skip gracefully if no credentials)
    - Import and call setupTikTokOAuth

    Update `src/trigger/token-refresher.ts`:
    - Add TikTok token refresh path alongside existing X, LinkedIn, and Instagram paths
    - TikTok tokens: use Arctic refreshAccessToken. Store both new accessToken and new refreshToken (TikTok rotates refresh tokens)
    - Use same expiry check window as other platforms
  </action>
  <verify>
    `npx tsc --noEmit` passes. `grep -r "TikTok" src/platforms/tiktok/oauth.ts` shows Arctic TikTok provider usage. Token refresher has TikTok case. Setup CLI has TikTok step.
  </verify>
  <done>
    TikTok OAuth via Arctic with PKCE works: auth URL, code exchange, token refresh with rotation. Setup CLI integrates into /psn:setup with unaudited mode warning. Token refresher handles TikTok lifecycle.
  </done>
</task>

<task type="auto">
  <name>Task 2: TikTok client, chunked upload, photo posting, and Creative Center</name>
  <files>
    src/platforms/tiktok/client.ts
    src/platforms/tiktok/media.ts
    src/platforms/tiktok/creative-center.ts
  </files>
  <action>
    Create `src/platforms/tiktok/client.ts`:
    - Follow XClient/LinkedInClient pattern: raw fetch, Zod response validation
    - Constructor: `TikTokClient(accessToken: string, options?: { auditStatus?: TikTokAuditStatus })`
    - Default auditStatus to "unaudited" — all privacy levels forced to SELF_ONLY when unaudited
    - Methods:
      - `getUserInfo()` — GET `/v2/user/info/` with fields=open_id,display_name,follower_count,avatar_url
      - `getVideoList(cursor?: number, maxCount?: number)` — POST `/v2/video/list/` returns paginated video list with metrics (views, likes, comments, shares)
      - `initVideoUpload(videoSize: number, chunkSize: number)` — POST `/v2/post/publish/inbox/video/init/` returns { publishId, uploadUrl }. chunkSize validated between 5MB-64MB.
      - `postPhotos(params: { title, description, photoUrls, privacyLevel? })` — POST `/v2/post/publish/content/init/` with PULL_FROM_URL source. Auto-clamp title to 90 chars, description to 4000 chars. Force SELF_ONLY if unaudited.
      - `postComment(videoId: string, text: string)` — POST `/v2/comment/` for engagement replies
      - `getPublishStatus(publishId: string)` — GET `/v2/post/publish/status/fetch/` to check upload completion
    - All requests use Authorization: Bearer header
    - Zod validation on all responses

    Create `src/platforms/tiktok/media.ts`:
    - `initVideoUpload(client: TikTokClient, videoSize: number, chunkSize?: number)` — Calculates optimal chunk size (default 10MB, min 5MB, max 64MB), calls client.initVideoUpload. Returns { publishId, uploadUrl, totalChunks, chunkSize }
    - `uploadVideoChunks(uploadUrl: string, videoBuffer: Buffer, chunkSize: number)` — Sequential PUT requests with Content-Range headers. Each chunk: `bytes {start}-{end}/{total}`. Validates upload URL validity (warn if estimated upload time > 45 minutes). Returns { success: boolean, chunksUploaded: number }
    - `postPhotos(client: TikTokClient, params: { title, description, photoUrls })` — Validates <= 35 photos. Calls client.postPhotos. Returns publishId.
    - `checkPublishStatus(client: TikTokClient, publishId: string, maxAttempts?: number)` — Poll status every 5 seconds until complete. Max 60 attempts. Returns { status, publishId }
    - Error handling: if upload URL expires (403/410), throw specific error suggesting re-initialization

    Create `src/platforms/tiktok/creative-center.ts`:
    - Free tier trending content discovery via TikTok Creative Center public data
    - `getTrendingTopics(options?: { country?: string })` — Fetch from TikTok Creative Center trending topics page. Parse response for topic names, view counts, trend direction. Returns Array<{ topic, viewCount, trending: "up"|"down"|"stable" }>
    - `getTrendingVideos(keyword: string, options?: { country?: string, limit?: number })` — Search Creative Center for keyword-relevant trending videos. Returns Array<{ videoId, description, authorHandle, viewCount, likeCount, commentCount }>
    - Graceful degradation: if Creative Center scraping fails, return empty array with warning log (not crash). This is the free fallback; EnsembleData is the paid upgrade path.
    - Simple fetch-based scraping with error isolation (try/catch per request)
  </action>
  <verify>
    `npx tsc --noEmit` passes. All 3 files export their functions. TikTokClient has all listed methods. Media module has chunked upload with Content-Range. Creative Center has graceful degradation.
  </verify>
  <done>
    TikTokClient provides typed Content Posting API access. Chunked video upload supports sequential 5MB-64MB chunks with Content-Range headers. Photo posting via URL pull with 35-image limit. Unaudited clients forced to SELF_ONLY. Creative Center provides free trending content discovery with graceful failure.
  </done>
</task>

</tasks>

<verification>
1. `npx tsc --noEmit` — all files compile without errors
2. `ls src/platforms/tiktok/` shows: oauth.ts, types.ts, client.ts, media.ts, creative-center.ts
3. `grep -c "export" src/platforms/tiktok/*.ts` — each file has expected exports
4. `grep "tiktok" src/trigger/token-refresher.ts` — refresher handles TikTok tokens
5. `grep "tiktok" src/cli/setup.ts` — setup includes TikTok step
6. `grep "SELF_ONLY" src/platforms/tiktok/client.ts` — unaudited mode enforced
</verification>

<success_criteria>
- TikTok OAuth via Arctic with PKCE (auth URL, code exchange, token refresh with rotation)
- TikTokClient provides typed access to Content Posting API
- Chunked video upload with sequential PUT, Content-Range headers, 5MB-64MB chunks
- Photo posting via URL pull with 35-image limit
- Unaudited clients forced to SELF_ONLY visibility with clear messaging
- Creative Center scraper provides free trending content with graceful degradation
- Token refresher handles TikTok token lifecycle
- Setup CLI includes TikTok OAuth step with audit status warning
</success_criteria>

<output>
After completion, create `.planning/phases/08-instagram-tiktok-and-engagement/08-02-SUMMARY.md`
</output>
