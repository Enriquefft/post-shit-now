---
phase: 01-foundation-infrastructure
plan: 02
type: execute
wave: 2
depends_on: [01-01]
files_modified:
  - src/cli/setup.ts
  - src/cli/setup-db.ts
  - src/cli/setup-trigger.ts
  - src/cli/setup-keys.ts
  - src/cli/validate.ts
  - .claude/commands/psn/setup.md
autonomous: false
requirements:
  - INFRA-03
  - INFRA-04
  - CONFIG-01
  - CONFIG-04
  - CONFIG-07

user_setup:
  - service: neon
    why: "Database hosting for Personal Hub"
    env_vars:
      - name: NEON_API_KEY
        source: "Neon Console -> Settings -> API Keys -> Generate new key (or via neonctl auth)"

  - service: trigger.dev
    why: "Task automation platform"
    env_vars:
      - name: TRIGGER_SECRET_KEY
        source: "Trigger.dev Dashboard -> Project Settings -> API Keys"

must_haves:
  truths:
    - "User can run /psn:setup and get a working Personal Hub"
    - "Setup creates Neon DB via neonctl CLI without opening a browser"
    - "Setup initializes Trigger.dev project via trigger CLI"
    - "Drizzle migrations run automatically during setup"
    - "Setup resumes from failure — skips completed steps on re-run"
    - "Validation checklist shows pass/fail for each connection"
    - "All API keys stored in config/keys.env, DB creds in config/hub.env"
  artifacts:
    - path: "src/cli/setup.ts"
      provides: "Main setup orchestrator"
      exports: ["runSetup"]
    - path: "src/cli/setup-db.ts"
      provides: "Neon DB provisioning"
      exports: ["setupDatabase"]
    - path: "src/cli/setup-trigger.ts"
      provides: "Trigger.dev project setup"
      exports: ["setupTrigger"]
    - path: "src/cli/setup-keys.ts"
      provides: "API key collection and storage"
      exports: ["setupKeys"]
    - path: "src/cli/validate.ts"
      provides: "Connection validation"
      exports: ["validateAll"]
    - path: ".claude/commands/psn/setup.md"
      provides: "Slash command entry point"
  key_links:
    - from: "src/cli/setup.ts"
      to: "src/cli/setup-db.ts"
      via: "step orchestration"
      pattern: "setupDatabase"
    - from: "src/cli/setup-db.ts"
      to: "src/core/db/migrate.ts"
      via: "auto-migration after DB creation"
      pattern: "runMigrations"
    - from: "src/cli/validate.ts"
      to: "src/core/db/connection.ts"
      via: "test DB connection"
      pattern: "createHubConnection"
    - from: ".claude/commands/psn/setup.md"
      to: "src/cli/setup.ts"
      via: "slash command invokes CLI script"
      pattern: "bun run src/cli/setup.ts"
---

<objective>
Build the `/psn:setup` wizard that provisions a Personal Hub: creates Neon DB via neonctl, sets up Trigger.dev project, collects API keys, runs migrations, and validates all connections.

Purpose: This is the onboarding experience. A user cloning the repo runs `/psn:setup` and gets a fully working Personal Hub. Per user decision: step-by-step wizard, CLI-only (no browser), resume from failure, JSON output for Claude to interpret.
Output: Working setup flow that provisions and validates a complete Personal Hub.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md
@.planning/phases/01-foundation-infrastructure/01-CONTEXT.md
@.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Hub provisioning CLI scripts (DB, Trigger.dev, keys)</name>
  <files>
    src/cli/setup.ts
    src/cli/setup-db.ts
    src/cli/setup-trigger.ts
    src/cli/setup-keys.ts
    src/cli/validate.ts
  </files>
  <action>
    All CLI scripts output JSON to stdout per user decision. Claude interprets and presents to user. Use the SetupResult type from src/core/types/index.ts.

    Create `src/cli/setup-db.ts`:
    - Export `setupDatabase()`: provisions Neon DB via neonctl CLI
    - Step 1: Check if config/hub.env exists with DATABASE_URL — if so, skip (resume from failure)
    - Step 2: Run `neonctl projects create --name "psn-hub-{random-suffix}" --output json` using Bun.spawn
    - Use `--api-key` flag with NEON_API_KEY from config/keys.env (not neonctl auth which opens browser)
    - Step 3: Extract connection string from neonctl output
    - Step 4: Generate encryption key via generateEncryptionKey() from crypto utils
    - Step 5: Write config/hub.env with DATABASE_URL and HUB_ENCRYPTION_KEY
    - Step 6: Run migrations via runMigrations(databaseUrl)
    - Output JSON: { step: "database", status: "success"|"error", message: "...", data: { projectName, databaseUrl (masked) } }
    - Error handling: if neonctl not installed, output actionable error "Install neonctl: npm i -g neonctl"

    Create `src/cli/setup-trigger.ts`:
    - Export `setupTrigger()`: initializes Trigger.dev project
    - Step 1: Check if trigger.config.ts already has a real project ref (not placeholder) — if so, skip
    - Step 2: Run `bunx trigger.dev@latest init` via Bun.spawn
    - OR if project ref already known: update trigger.config.ts project field
    - Step 3: Run `bunx trigger.dev@latest dev` briefly to verify connection, then kill
    - Output JSON: { step: "trigger", status: "success"|"error", message: "..." }
    - Use TRIGGER_SECRET_KEY from config/keys.env

    Create `src/cli/setup-keys.ts`:
    - Export `setupKeys()`: collects and validates API keys
    - Step 1: Check if config/keys.env exists — if so, read existing keys
    - Step 2: Check which keys are missing (NEON_API_KEY, TRIGGER_SECRET_KEY required for Phase 1)
    - Step 3: For each missing key, output JSON requesting the key: { step: "keys", status: "need_input", message: "Provide NEON_API_KEY", data: { key: "NEON_API_KEY", source: "Neon Console -> Settings -> API Keys" } }
    - Step 4: Write/update config/keys.env with collected keys
    - Future phases will add platform API keys here

    Create `src/cli/validate.ts`:
    - Export `validateAll()`: tests every connection
    - Test 1: DB connection — createHubConnection(url), run simple query (SELECT 1)
    - Test 2: Trigger.dev — check TRIGGER_SECRET_KEY exists and trigger.config.ts has real project ref
    - Test 3: Check config directory structure exists
    - Output JSON array of results: [{ check: "database", status: "pass"|"fail", message: "..." }, ...]
    - Final summary: { allPassed: boolean, results: [...] }

    Create `src/cli/setup.ts`:
    - Export `runSetup()`: main orchestrator
    - Step-by-step flow per user decision:
      1. [1/5] Collecting API keys (setupKeys)
      2. [2/5] Creating database (setupDatabase)
      3. [3/5] Running migrations (auto in setupDatabase)
      4. [4/5] Setting up Trigger.dev (setupTrigger)
      5. [5/5] Validating connections (validateAll)
    - Resume-from-failure: each step checks if already done before executing
    - If any step fails: output error with actionable next step, stop
    - Final output: validation checklist
    - Entry point: `if (import.meta.main) { runSetup().then(r => console.log(JSON.stringify(r))); }`
  </action>
  <verify>
    Run `bun run typecheck` — all CLI scripts compile.
    Run `bun run lint` — passes.
    Verify setup.ts imports and orchestrates all setup-*.ts modules.
    Verify each module checks for existing config before re-running (resume logic).
    Verify all output is JSON to stdout.
  </verify>
  <done>
    CLI scripts exist for each setup step. Each outputs JSON. Resume-from-failure logic skips completed steps. Error messages are actionable. Main orchestrator runs steps in order with progress indicators.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Create /psn:setup slash command and verify setup flow</name>
  <files>
    .claude/commands/psn/setup.md
  </files>
  <action>
    Create `.claude/commands/psn/setup.md` slash command that:
    1. Reads config state to determine what's already set up
    2. Guides user through each step with progress indicators [1/5], [2/5], etc.
    3. Runs CLI scripts via `bun run src/cli/setup.ts`
    4. Interprets JSON output and presents results to user
    5. Shows validation checklist at end with checkmarks/X marks

    The slash command should instruct Claude to:
    - Check existing config files to determine setup state
    - Run each setup step sequentially
    - Present JSON results in human-readable format
    - Show final validation checklist with pass/fail checkmarks
  </action>
  <verify>
    1. Review `.claude/commands/psn/setup.md` — should describe the setup wizard flow
    2. Run `bun run src/cli/setup.ts --help` or review the code to verify:
       - Each step has resume-from-failure logic
       - All output is JSON
       - Errors include actionable instructions
       - Progress uses [N/5] format
    3. Verify config directory structure exists:
       - config/voice-profiles/
       - config/series/
       - config/connections/
       - config/company/
    4. (Optional) If you have Neon API key and Trigger.dev secret key, test actual provisioning
  </verify>
  <done>
    Slash command file exists. Setup flow provisions Hub end-to-end. User can verify the setup wizard works for their environment.
  </done>
</task>

</tasks>

<verification>
- `bun run typecheck` passes with all CLI scripts
- Setup orchestrator imports and runs all step modules
- Each step module outputs JSON to stdout
- Resume-from-failure: running setup twice does not duplicate resources
- Validation checks DB connection, Trigger.dev config, and directory structure
- Slash command file exists at .claude/commands/psn/setup.md
- Config directory matches PRD: config/strategy.yaml, config/hub.env, config/keys.env, config/voice-profiles/, config/series/, config/connections/, config/company/
</verification>

<success_criteria>
- /psn:setup slash command exists and describes the wizard flow
- Setup creates Neon DB via neonctl (CLI only, no browser)
- Setup configures Trigger.dev project
- Migrations run automatically during setup
- API keys collected and stored in config/keys.env
- DB credentials stored in config/hub.env
- Validation checklist tests all connections
- Re-running setup skips completed steps
- All CLI output is structured JSON
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-02-SUMMARY.md`
</output>
