---
phase: 01-foundation-infrastructure
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - tsconfig.json
  - biome.json
  - vitest.config.ts
  - drizzle.config.ts
  - trigger.config.ts
  - .gitignore
  - src/core/db/schema.ts
  - src/core/db/connection.ts
  - src/core/db/migrate.ts
  - src/core/utils/crypto.ts
  - src/core/utils/env.ts
  - src/core/types/index.ts
  - config/.gitkeep
  - drizzle/migrations/.gitkeep
autonomous: true
requirements:
  - INFRA-01
  - INFRA-02
  - INFRA-05
  - INFRA-07

must_haves:
  truths:
    - "Project builds with zero errors using bun"
    - "Biome lint and format pass on all source files"
    - "Vitest runs and passes with at least one test"
    - "Drizzle schema defines tables with RLS policies"
    - "drizzle-kit generate produces migration files"
    - "All secrets paths are gitignored"
  artifacts:
    - path: "package.json"
      provides: "Project manifest with all dependencies"
      contains: "drizzle-orm"
    - path: "src/core/db/schema.ts"
      provides: "Drizzle schema with RLS policies"
      contains: "pgPolicy"
    - path: "src/core/db/connection.ts"
      provides: "Hub connection factory"
      exports: ["createHubConnection"]
    - path: "src/core/db/migrate.ts"
      provides: "Migration runner"
      exports: ["runMigrations"]
    - path: "src/core/utils/crypto.ts"
      provides: "AES-256-GCM token encryption"
      exports: ["encrypt", "decrypt"]
    - path: "biome.json"
      provides: "Biome linter/formatter config"
    - path: "drizzle.config.ts"
      provides: "Drizzle Kit migration config"
  key_links:
    - from: "src/core/db/connection.ts"
      to: "src/core/db/schema.ts"
      via: "schema import for typed queries"
      pattern: "import.*schema"
    - from: "src/core/db/migrate.ts"
      to: "drizzle/migrations"
      via: "migrationsFolder path"
      pattern: "migrationsFolder"
    - from: "drizzle.config.ts"
      to: "src/core/db/schema.ts"
      via: "schema path for generation"
      pattern: "schema.*src/core/db/schema"
---

<objective>
Scaffold the project foundation: Bun-based TypeScript project with Drizzle ORM schemas (including RLS), connection factory, migration infrastructure, encryption utilities, and developer tooling (Biome, Vitest).

Purpose: Establish the codebase structure and shared core that all future phases build on. This is the @psn/core equivalent as a flat package.
Output: Working project that builds, lints, tests, and can generate DB migrations.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md
@.planning/phases/01-foundation-infrastructure/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize Bun project with all dependencies and tooling configs</name>
  <files>
    package.json
    tsconfig.json
    biome.json
    vitest.config.ts
    .gitignore
    config/.gitkeep
    drizzle/migrations/.gitkeep
  </files>
  <action>
    Initialize project with `bun init` (accept defaults).

    Install production dependencies:
    ```
    bun add drizzle-orm @neondatabase/serverless @trigger.dev/sdk zod yaml ws
    ```

    Install dev dependencies (pin exact versions with --exact):
    ```
    bun add -d --exact drizzle-kit @biomejs/biome vitest typescript @types/ws
    ```

    Create `tsconfig.json`:
    - target: "ES2022", module: "ESNext", moduleResolution: "bundler"
    - strict: true, skipLibCheck: true
    - paths: { "@psn/*": ["./src/*"] } for import aliasing
    - include: ["src/**/*", "*.config.ts", "trigger.config.ts"]

    Create `biome.json`:
    - $schema for Biome 2.0
    - formatter: enabled, indentStyle "tab", lineWidth 100
    - linter: enabled, rules recommended
    - javascript: quoteStyle "double", semicolons "always"
    - organizeImports: enabled

    Create `vitest.config.ts`:
    - import defineConfig from vitest/config
    - test.globals: true
    - test.include: ["src/**/*.test.ts"]

    Update `package.json` scripts:
    - "dev": "bunx trigger.dev@latest dev"
    - "build": "bun run typecheck"
    - "typecheck": "tsc --noEmit"
    - "lint": "biome check ."
    - "lint:fix": "biome check --write ."
    - "format": "biome format --write ."
    - "test": "vitest run"
    - "test:watch": "vitest"
    - "db:generate": "drizzle-kit generate"
    - "db:migrate": "drizzle-kit migrate"
    - "db:studio": "drizzle-kit studio"

    Create `.gitignore` with entries for:
    - node_modules/
    - config/hub.env
    - config/keys.env
    - config/connections/
    - .env, .env.local, .env.*.local
    - dist/
    - .trigger/

    Create directory structure:
    - `config/` with `.gitkeep` (and subdirs: voice-profiles, series, connections, company)
    - `drizzle/migrations/` with `.gitkeep`
    - `src/core/`, `src/cli/`, `src/trigger/`
    - `.claude/commands/psn/` for slash commands

    Config directory MUST match PRD exactly per user decision:
    config/strategy.yaml, config/hub.env, config/keys.env, config/voice-profiles/, config/series/, config/connections/, config/company/
  </action>
  <verify>
    Run `bun run typecheck` — exits 0 (once source files exist from Task 2).
    Run `bun run lint` — exits 0 on all files.
    Verify `.gitignore` contains config/hub.env and config/keys.env.
    Verify config directory structure matches PRD.
  </verify>
  <done>
    Project has all dependencies installed, TypeScript compiles, Biome passes, directory structure matches PRD config layout, secrets paths are gitignored.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create Drizzle schema with RLS, connection factory, migration runner, and crypto utils</name>
  <files>
    src/core/db/schema.ts
    src/core/db/connection.ts
    src/core/db/migrate.ts
    src/core/utils/crypto.ts
    src/core/utils/env.ts
    src/core/types/index.ts
    drizzle.config.ts
    trigger.config.ts
    src/core/db/schema.test.ts
  </files>
  <action>
    Create `src/core/types/index.ts`:
    - Export shared types: HubConfig (databaseUrl, triggerProjectRef, apiKeys), SetupResult ({ step, status, message, data? }), Platform enum ("x" | "linkedin" | "instagram" | "tiktok")

    Create `src/core/utils/env.ts`:
    - loadHubEnv(): reads config/hub.env, returns { databaseUrl, triggerProjectRef }
    - loadKeysEnv(): reads config/keys.env, returns record of API keys
    - Use Bun.file() API for reading, parse KEY=VALUE format
    - Return clear error messages if files missing

    Create `src/core/db/schema.ts`:
    - Import pgTable, pgPolicy, pgRole, text, timestamp, uuid, boolean, integer, jsonb from drizzle-orm/pg-core
    - Define `hubUser` role as pgRole("hub_user").existing()
    - Table `users`: id (uuid PK), externalId (text unique), displayName (text), email (text), createdAt (timestamp), updatedAt (timestamp)
    - Table `oauth_tokens`: id (uuid PK), userId (text, references users.externalId), platform (text — x/linkedin/instagram/tiktok), accessToken (text — encrypted), refreshToken (text — encrypted), expiresAt (timestamp), scopes (text), createdAt, updatedAt. Add RLS policy: user can only read/write own tokens (using: `user_id = current_setting('app.current_user_id')`)
    - Table `posts`: id (uuid PK), userId (text), platform (text), content (text), mediaUrls (jsonb), status (text — draft/scheduled/publishing/published/failed), scheduledAt (timestamp), publishedAt (timestamp), externalPostId (text), metadata (jsonb), createdAt, updatedAt. Add RLS policy for user isolation.
    - Table `api_keys`: id (uuid PK), userId (text), service (text), keyName (text), encryptedValue (text), createdAt. Add RLS policy.

    CRITICAL: Use `pgPolicy()` within each table definition for RLS. Do NOT use `pgTable.withRLS()` alone — define explicit policies. The RLS using clause should be: `sql\`user_id = current_setting('app.current_user_id')\``

    Create `src/core/db/connection.ts`:
    - Export `createHubConnection(databaseUrl: string)` using neon HTTP driver:
      ```
      import { neon } from "@neondatabase/serverless";
      import { drizzle } from "drizzle-orm/neon-http";
      import * as schema from "./schema";
      ```
    - Export `createHubConnectionWs(databaseUrl: string)` using WebSocket driver for long-running processes:
      ```
      import { Pool, neonConfig } from "@neondatabase/serverless";
      import { drizzle } from "drizzle-orm/neon-serverless";
      import ws from "ws";
      neonConfig.webSocketConstructor = ws;
      ```
    - Both return typed Drizzle instance with schema

    Create `src/core/db/migrate.ts`:
    - Export `runMigrations(databaseUrl: string)`:
      - Uses neon HTTP driver
      - Calls `migrate(db, { migrationsFolder: "./drizzle/migrations" })`
      - Returns { success: boolean, error?: string }
    - Import migrate from "drizzle-orm/neon-http/migrator"

    Create `src/core/utils/crypto.ts`:
    - Use Node.js crypto (available in Bun) with AES-256-GCM
    - Export `encrypt(plaintext: string, key: Buffer): string` — generates random 12-byte IV, encrypts, returns base64(iv + authTag + ciphertext)
    - Export `decrypt(ciphertext: string, key: Buffer): string` — parses base64, extracts IV (0-12), authTag (12-28), ciphertext (28+), decrypts
    - Export `generateEncryptionKey(): Buffer` — returns randomBytes(32)
    - Export `deriveKeyFromEnv(): Buffer` — reads HUB_ENCRYPTION_KEY from config/hub.env, returns as Buffer

    Create `drizzle.config.ts`:
    - schema: "./src/core/db/schema.ts"
    - out: "./drizzle/migrations"
    - dialect: "postgresql"
    - dbCredentials: { url: process.env.DATABASE_URL! }

    Create `trigger.config.ts`:
    - runtime: "bun"
    - project: placeholder "<your-project-ref>" (replaced during /psn:setup)
    - dirs: ["./src/trigger"]
    - retries: { enabledInDev: false, default: { maxAttempts: 3, minTimeoutInMs: 1000, maxTimeoutInMs: 10000, factor: 2, randomize: true } }
    - maxDuration: 300

    Create `src/core/db/schema.test.ts`:
    - Basic test: verify schema exports exist (tables, policies)
    - Test crypto: encrypt then decrypt returns original plaintext
    - Test env loader: returns error when files missing
  </action>
  <verify>
    Run `bun run typecheck` — exits 0.
    Run `bun run test` — all tests pass.
    Run `bun run lint` — exits 0.
    Verify schema.ts contains pgPolicy definitions.
    Run `bun run db:generate` with a dummy DATABASE_URL — generates migration SQL containing CREATE POLICY statements (requires actual DB for full test, but generation should work).
  </verify>
  <done>
    Drizzle schema defines users, oauth_tokens, posts, api_keys tables with RLS policies. Connection factory creates typed HTTP and WebSocket Drizzle instances. Migration runner can apply migrations. Crypto utils encrypt/decrypt with AES-256-GCM. All TypeScript compiles and tests pass.
  </done>
</task>

</tasks>

<verification>
- `bun run typecheck` passes
- `bun run lint` passes
- `bun run test` passes
- Schema file contains pgPolicy definitions for all user-data tables
- Connection factory exports createHubConnection and createHubConnectionWs
- Migration runner exports runMigrations
- Crypto utils round-trip encrypt/decrypt correctly
- Config directory matches PRD structure exactly
- .gitignore covers all secret paths
</verification>

<success_criteria>
- Project builds, lints, and tests with zero errors
- Drizzle schema has RLS policies on oauth_tokens, posts, and api_keys tables
- drizzle.config.ts correctly references schema for migration generation
- trigger.config.ts configured for Bun runtime
- All secret paths (hub.env, keys.env, connections/) are gitignored
- Shared core (db, types, utils) is importable from src/core/
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md`
</output>
