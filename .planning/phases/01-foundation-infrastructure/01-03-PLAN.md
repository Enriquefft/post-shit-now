---
phase: 01-foundation-infrastructure
plan: 03
type: execute
wave: 2
depends_on: [01-01]
files_modified:
  - src/trigger/watchdog.ts
  - src/trigger/health.ts
  - src/trigger/watchdog.test.ts
autonomous: true
requirements:
  - INFRA-06

must_haves:
  truths:
    - "Post watchdog task detects posts scheduled in the past that were never published"
    - "Watchdog re-triggers stuck posts for publishing"
    - "Watchdog runs on a recurring cron schedule"
    - "Health check task verifies DB connectivity from Trigger.dev runtime"
  artifacts:
    - path: "src/trigger/watchdog.ts"
      provides: "Post watchdog scheduled task"
      exports: ["postWatchdog"]
    - path: "src/trigger/health.ts"
      provides: "Health check task"
      exports: ["healthCheck"]
  key_links:
    - from: "src/trigger/watchdog.ts"
      to: "src/core/db/connection.ts"
      via: "creates DB connection to query stuck posts"
      pattern: "createHubConnection"
    - from: "src/trigger/watchdog.ts"
      to: "src/core/db/schema.ts"
      via: "queries posts table for stuck items"
      pattern: "schema.posts"
    - from: "src/trigger/health.ts"
      to: "src/core/db/connection.ts"
      via: "tests DB connectivity"
      pattern: "createHubConnection"
---

<objective>
Create the Trigger.dev tasks that run on the Hub: post watchdog (detects and re-triggers stuck scheduled posts) and health check (verifies DB connectivity). These are the first Trigger.dev tasks and establish the task pattern for all future phases.

Purpose: The post watchdog ensures reliability — if a scheduled post misses its window (Trigger.dev run stuck/failed), the watchdog catches it and re-triggers. The health check validates the Hub is operational.
Output: Two Trigger.dev tasks ready to deploy — watchdog cron and health check.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md
@.planning/phases/01-foundation-infrastructure/01-CONTEXT.md
@.planning/phases/01-foundation-infrastructure/01-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create post watchdog cron task</name>
  <files>
    src/trigger/watchdog.ts
  </files>
  <action>
    Create `src/trigger/watchdog.ts` using Trigger.dev v4 scheduled task API:

    ```typescript
    import { schedules, logger } from "@trigger.dev/sdk";
    ```

    Define `postWatchdog` as a schedules.task:
    - id: "post-watchdog"
    - cron: "*/15 * * * *" (every 15 minutes)
    - maxDuration: 60 (seconds)

    In the run function:
    1. Load DATABASE_URL from environment (Trigger.dev env vars set during deployment)
    2. Create hub connection via createHubConnection(databaseUrl)
    3. Query posts table for stuck posts:
       - status = "scheduled" AND scheduledAt < NOW() - interval '5 minutes'
       - These are posts that should have been published but weren't
    4. For each stuck post:
       - Log warning with post ID and scheduled time
       - Update status to "retry" (or "publishing" for re-trigger)
       - In Phase 2, this will trigger the actual publishing task
       - For now, log the post ID and mark it — the publishing task doesn't exist yet
    5. Query for posts with status = "publishing" for > 10 minutes (truly stuck)
       - Mark as "failed" with metadata: { failReason: "watchdog_timeout" }
    6. Return summary: { checked: N, stuck: N, retried: N, failed: N }

    Use Trigger.dev logger for all logging (not console.log).

    Important: Use `eq`, `and`, `lt`, `sql` from drizzle-orm for the query builder:
    ```typescript
    import { eq, and, lt, sql } from "drizzle-orm";
    import { posts } from "../core/db/schema";
    ```

    Note: The actual post publishing task will be created in Phase 2. The watchdog just identifies stuck posts and updates their status.
  </action>
  <verify>
    Run `bun run typecheck` — watchdog.ts compiles.
    Run `bun run lint` — passes.
    Verify watchdog uses schedules.task with cron property.
    Verify watchdog queries posts table using Drizzle query builder.
    Verify watchdog imports createHubConnection from core.
  </verify>
  <done>
    Post watchdog scheduled task exists, runs every 15 minutes, detects posts stuck in "scheduled" or "publishing" status, and updates their status. Uses Drizzle query builder and Trigger.dev logger.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create health check task and watchdog unit test</name>
  <files>
    src/trigger/health.ts
    src/trigger/watchdog.test.ts
  </files>
  <action>
    Create `src/trigger/health.ts`:
    - Import { task, logger } from "@trigger.dev/sdk"
    - Define `healthCheck` as a regular task (not cron — triggered on demand):
      - id: "health-check"
      - maxDuration: 30
    - In the run function:
      1. Test DB connection: createHubConnection(env.DATABASE_URL), run SELECT 1
      2. Check critical env vars exist: DATABASE_URL, TRIGGER_SECRET_KEY
      3. Return health report: { database: "ok"|"error", env: "ok"|"error", timestamp: ISO string }
    - This task is triggered manually or during setup validation to confirm the Hub works

    Create `src/trigger/watchdog.test.ts`:
    - Test the watchdog's query logic (not the full Trigger.dev runtime):
    - Mock the database connection to return test data
    - Test case 1: No stuck posts — returns { checked: 0, stuck: 0, retried: 0, failed: 0 }
    - Test case 2: Post with status "scheduled" and scheduledAt 10 minutes ago — detected as stuck
    - Test case 3: Post with status "publishing" for 15 minutes — marked as failed
    - Use vitest mocking to mock createHubConnection
    - Focus on testing the detection logic, not Trigger.dev runtime behavior
  </action>
  <verify>
    Run `bun run typecheck` — health.ts and watchdog.test.ts compile.
    Run `bun run test` — watchdog tests pass.
    Run `bun run lint` — passes.
    Verify health check tests DB connectivity and env vars.
    Verify watchdog test covers stuck post detection logic.
  </verify>
  <done>
    Health check task can validate Hub connectivity. Watchdog has unit tests covering stuck post detection for both "scheduled" and "publishing" states. Both tasks compile and lint cleanly.
  </done>
</task>

</tasks>

<verification>
- `bun run typecheck` passes with all trigger tasks
- `bun run test` passes — watchdog unit tests verify detection logic
- `bun run lint` passes
- Watchdog uses schedules.task with 15-minute cron
- Health check uses regular task (triggered on demand)
- Both tasks import from src/core/ (connection, schema)
- trigger.config.ts dirs includes "./src/trigger"
</verification>

<success_criteria>
- Post watchdog detects stuck "scheduled" posts (past due > 5 min) and marks for retry
- Post watchdog detects stuck "publishing" posts (> 10 min) and marks as failed
- Health check verifies DB connectivity and env var presence
- Watchdog unit tests pass with mocked DB
- Both tasks are discoverable by Trigger.dev CLI (in src/trigger/ directory)
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md`
</output>
