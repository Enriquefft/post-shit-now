---
phase: 01-foundation-infrastructure
plan: 03
type: execute
wave: 2
depends_on: [01-01, 01-02]
files_modified:
  - src/team/hub.ts
  - src/cli/setup-db.ts
  - src/core/utils/env.ts
autonomous: true
requirements: [C1]

must_haves:
  truths:
    - "Personal Hub connection is loaded from .hubs/personal.json"
    - "getHubConnection('personal') returns Personal Hub connection"
    - "Old config/hub.env is migrated to .hubs/personal.json on first run"
    - "All hubs (Personal and Company) use same storage format and API"
  artifacts:
    - path: "src/team/hub.ts"
      provides: "getHubConnection function that loads both personal and company hubs"
      exports: ["getHubConnection", "discoverCompanyHubs"]
      min_lines: 200
    - path: "src/cli/setup-db.ts"
      provides: "Database setup that writes to .hubs/personal.json"
      contains: ".hubs/personal.json"
    - path: "src/core/utils/env.ts"
      provides: "Personal Hub migration utility"
      exports: ["migratePersonalHubToHubsDir"]
      min_lines: 30
  key_links:
    - from: "src/cli/setup.ts"
      to: "src/team/hub.ts"
      via: "getHubConnection('personal')"
      pattern: "getHubConnection.*personal"
    - from: "src/cli/setup-db.ts"
      to: ".hubs/personal.json"
      via: "Bun.write() to hub file"
      pattern: "write.*personal\\.json"
    - from: "src/cli/setup.ts"
      to: ".hubs/personal.json"
      via: "getHubConnection() migration check"
      pattern: "migratePersonalHubToHubsDir"
---

<objective>
Unify hub storage by moving Personal Hub from config/hub.env to .hubs/personal.json and updating getHubConnection() to handle both Personal and Company hubs. This resolves C1 (setup wizard hub detection bug).

Purpose: Personal Hub is stored in config/hub.env but getHubConnection() only looks in .hubs/*.json for Company hubs, causing "Personal Hub not configured" errors. Unify to .hubs/personal.json for consistent access.

Output: Updated getHubConnection() to load personal.json, migration script in env.ts, setup-db.ts writes to .hubs/ instead of config/hub.env.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/01-foundation-infrastructure/01-CONTEXT.md
@.planning/phases/01-foundation-infrastructure/01-RESEARCH.md
@src/cli/setup.ts
@src/team/hub.ts
@src/cli/setup-db.ts
@src/core/utils/env.ts
@src/core/types.ts
</context>

<tasks>

<task type="auto">
  <name>Add Personal Hub migration utility to env.ts</name>
  <files>src/core/utils/env.ts</files>
  <action>
Add migratePersonalHubToHubsDir function to src/core/utils/env.ts that migrates config/hub.env to .hubs/personal.json:

```typescript
import { mkdir, readFile, rm } from "node:fs/promises";
import { join } from "node:path";
import type { HubConnection } from "../../team/types.ts";
import { HubConnectionSchema } from "../../team/types.ts";

/**
 * Migrate Personal Hub from config/hub.env to .hubs/personal.json.
 * One-time migration: if hub.env exists and personal.json doesn't, migrate automatically.
 */
export async function migratePersonalHubToHubsDir(
  configDir = "config",
  projectRoot = "."
): Promise<{ success: boolean; migrated?: boolean; error?: string }> {
  const hubEnvPath = join(projectRoot, configDir, "hub.env");
  const hubsDir = join(projectRoot, ".hubs");
  const personalHubPath = join(hubsDir, "personal.json");

  // Check if migration is needed
  try {
    await readFile(personalHubPath);
    // personal.json exists, already migrated
    return { success: true, migrated: false };
  } catch {
    // personal.json doesn't exist, check if hub.env exists
  }

  try {
    await readFile(hubEnvPath);
  } catch {
    // Neither file exists, no migration needed
    return { success: true, migrated: false };
  }

  // Migrate: read hub.env, parse, write personal.json
  try {
    const hubEnvContent = await readFile(hubEnvPath, "utf-8");
    const env = parseEnvFile(hubEnvContent);

    const hubConnection: HubConnection = {
      hubId: env.HUB_ID || `hub_${crypto.randomUUID().slice(0, 12)}`,
      slug: "personal",
      displayName: "Personal Hub",
      databaseUrl: env.DATABASE_URL || "",
      triggerProjectId: env.TRIGGER_PROJECT_REF || "",
      encryptionKey: env.HUB_ENCRYPTION_KEY || "",
      role: "admin",
      joinedAt: new Date().toISOString(),
    };

    // Validate with schema
    const validated = HubConnectionSchema.parse(hubConnection);

    // Ensure .hubs directory exists
    await mkdir(hubsDir, { recursive: true });

    // Write personal.json
    await Bun.write(personalHubPath, JSON.stringify(validated, null, 2));

    // Delete old hub.env
    await rm(hubEnvPath);

    return { success: true, migrated: true };
  } catch (err) {
    const message = err instanceof Error ? err.message : String(err);
    return {
      success: false,
      error: `Failed to migrate Personal Hub: ${message}`,
    };
  }
}
```

This follows CONTEXT.md decision: "Unify storage to .hubs/*.json" and "No backward compatibility needed".
</action>
  <verify>
Run: `grep -A 40 "export async function migratePersonalHubToHubsDir" src/core/utils/env.ts` to verify function exists.
</verify>
  <done>
migratePersonalHubToHubsDir function exists in src/core/utils/env.ts that migrates hub.env to .hubs/personal.json.
</done>
</task>

<task type="auto">
  <name>Update getHubConnection() to handle Personal Hub</name>
  <files>src/team/hub.ts</files>
  <action>
Update getHubConnection() in src/team/hub.ts to handle "personal" slug by loading from .hubs/personal.json:

```typescript
import { join } from "node:path";
import { readFile } from "node:fs/promises";
import { createHubConnection } from "../core/db/connection.ts";
import type { HubConnection, HubConnectionSchema } from "./types.ts";

// ─── Hub Discovery ─────────────────────────────────────────────────────────

/**
 * Scan .hubs/ directory for all hub connection files.
 * Returns Personal Hub (personal.json) and Company Hubs (company-*.json).
 * Returns empty array if .hubs/ doesn't exist (graceful degradation).
 */
export async function discoverCompanyHubs(projectRoot = "."): Promise<HubConnection[]> {
  const hubsDir = join(projectRoot, ".hubs");

  let entries: string[];
  try {
    entries = await readdir(hubsDir);
  } catch {
    return []; // .hubs/ doesn't exist — graceful degradation
  }

  const connections: HubConnection[] = [];

  for (const entry of entries) {
    if (!entry.endsWith(".json")) continue; // Skip non-JSON files

    try {
      const content = await readFile(join(hubsDir, entry), "utf-8");
      const parsed = JSON.parse(content);
      const validated = HubConnectionSchema.parse(parsed);
      connections.push(validated);
    } catch {
      // Skip invalid connection files
    }
  }

  return connections;
}

// ─── Connection Management ─────────────────────────────────────────────────

/**
 * Find a specific hub connection by slug or hubId.
 * Returns null if not found.
 * Handles both "personal" (personal.json) and Company Hubs (company-*.json).
 */
export async function getHubConnection(
  projectRoot: string,
  slugOrId: string,
): Promise<HubConnection | null> {
  const hubs = await discoverCompanyHubs(projectRoot);
  return hubs.find((h) => h.slug === slugOrId || h.hubId === slugOrId) ?? null;
}

// Note: discoverCompanyHubs now loads ALL hubs (personal + company)
// because personal.json is now in same directory structure
```

Update discoverCompanyHubs to read ALL .json files in .hubs/, not just company-*.json, so it includes personal.json.
</action>
  <verify>
Run: `grep -A 15 "export async function discoverCompanyHubs" src/team/hub.ts` to verify it loads all JSON files, not just company-*.json.
</verify>
  <done>
getHubConnection() loads Personal Hub from .hubs/personal.json and Company Hubs from .hubs/company-*.json using unified API.
</done>
</task>

<task type="auto">
  <name>Update setup-db.ts to write .hubs/personal.json</name>
  <files>src/cli/setup-db.ts</files>
  <action>
Update setup-db.ts to write Personal Hub connection to .hubs/personal.json instead of config/hub.env:

```typescript
import { join } from "node:path";
import { mkdir } from "node:fs/promises";
import { runMigrations } from "../core/db/migrate.ts";
import type { SetupResult } from "../core/types/index.ts";
import { generateEncryptionKey } from "../core/utils/crypto.ts";
import { loadKeysEnv, migratePersonalHubToHubsDir } from "../core/utils/env.ts";

export async function setupDatabase(configDir = "config", projectRoot = "."): Promise<SetupResult> {
  const hubsDir = join(projectRoot, ".hubs");
  const personalHubPath = join(hubsDir, "personal.json");

  // Migration check: migrate config/hub.env to .hubs/personal.json if needed
  const migrateResult = await migratePersonalHubToHubsDir(configDir, projectRoot);
  if (!migrateResult.success) {
    return {
      step: "database",
      status: "error",
      message: migrateResult.error,
    };
  }

  // Resume check: skip if already configured
  try {
    const personalHubFile = Bun.file(personalHubPath);
    if (await personalHubFile.exists()) {
      const content = await personalHubFile.text();
      const parsed = JSON.parse(content);
      if (parsed.databaseUrl) {
        return {
          step: "database",
          status: "skipped",
          message: "Database already configured",
          data: { databaseUrl: maskUrl(parsed.databaseUrl) },
        };
      }
    }
  } catch {
    // Continue with setup
  }

  // ... existing code for loading API key, validating, creating Neon project ...

  // Generate hub ID
  const hubId = `hub_${crypto.randomUUID().slice(0, 12)}`;

  // Create connection object
  const connection = {
    hubId,
    slug: "personal",
    displayName: "Personal Hub",
    databaseUrl: connectionUri,
    triggerProjectId: "", // Will be set by setup-trigger.ts
    encryptionKey: encKey,
    role: "admin" as const,
    joinedAt: new Date().toISOString(),
  };

  // Write to .hubs/personal.json (not config/hub.env)
  await mkdir(hubsDir, { recursive: true });
  await Bun.write(personalHubPath, JSON.stringify(connection, null, 2));

  // Run migrations
  const migrateResult = await runMigrations(connectionUri);
  // ... existing error handling ...

  return {
    step: "database",
    status: "success",
    message: `Database "${projectName}" created, migrations applied`,
    data: { projectName, databaseUrl: maskUrl(connectionUri) },
  };
}
```

Remove old hub.env writing code and replace with .hubs/personal.json writing.
</action>
  <verify>
Run: `grep "personal.json" src/cli/setup-db.ts` to verify writes to .hubs/personal.json.
</verify>
  <done>
setup-db.ts writes Personal Hub connection to .hubs/personal.json, not config/hub.env.
</done>
</task>

</tasks>

<verification>
After completing all tasks, verify:
1. migratePersonalHubToHubsDir exists in env.ts and migrates hub.env to personal.json
2. discoverCompanyHubs loads all JSON files from .hubs/ (not just company-*.json)
3. getHubConnection("personal") returns Personal Hub from .hubs/personal.json
4. setup-db.ts writes to .hubs/personal.json instead of config/hub.env
5. setup.ts voice/entity subcommands work with Personal Hub connection
</verification>

<success_criteria>
- Personal Hub stored in .hubs/personal.json (same format as Company Hubs)
- getHubConnection() handles both personal and company hubs
- Old config/hub.env automatically migrated to new location
- setup.ts voice/entity subcommands work with Personal Hub
- Unified hub storage eliminates dual-API confusion
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-infrastructure/01-03-SUMMARY.md`
</output>
