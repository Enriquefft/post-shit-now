---
phase: 25-trigger-env-var-delivery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - trigger.config.ts
  - src/trigger/env-validation.ts
  - package.json
autonomous: true
requirements:
  - DEPLOY-01
  - DEPLOY-03

must_haves:
  truths:
    - "Running `bunx trigger.dev deploy` syncs DATABASE_URL, HUB_ENCRYPTION_KEY, and platform credentials to Trigger.dev Cloud"
    - "Missing critical env vars (DATABASE_URL, HUB_ENCRYPTION_KEY) abort deploy with actionable error"
    - "syncEnvVars reads from process.env (populated by Bun .env loading) -- no manual .env hacking required"
  artifacts:
    - path: "src/trigger/env-validation.ts"
      provides: "Shared requireEnvVars() utility and env var group constants"
      exports: ["requireEnvVars", "CORE_ENV_VARS", "CRYPTO_ENV_VARS", "X_ENV_VARS", "LINKEDIN_ENV_VARS", "INSTAGRAM_ENV_VARS", "TIKTOK_ENV_VARS"]
    - path: "trigger.config.ts"
      provides: "syncEnvVars build extension configuration"
      contains: "syncEnvVars"
  key_links:
    - from: "trigger.config.ts"
      to: "process.env"
      via: "syncEnvVars callback reads process.env at deploy time"
      pattern: "syncEnvVars.*process\\.env"
    - from: "src/trigger/env-validation.ts"
      to: "@trigger.dev/sdk"
      via: "logger for structured error output"
      pattern: "import.*logger.*@trigger.dev/sdk"
---

<objective>
Install @trigger.dev/build, create the shared env var validation utility, and wire syncEnvVars into trigger.config.ts so that `bunx trigger.dev deploy` pushes all required credentials to Trigger.dev Cloud.

Purpose: Trigger.dev Cloud workers currently start with zero env vars and crash immediately. This plan delivers the deploy-time credential sync that unblocks ALL deployed task execution.
Output: Working syncEnvVars extension + reusable requireEnvVars() utility for Plan 02.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-trigger-env-var-delivery/25-RESEARCH.md

@trigger.config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Install @trigger.dev/build and create env-validation.ts</name>
  <files>package.json, src/trigger/env-validation.ts</files>
  <action>
1. Install `@trigger.dev/build@^4.3.3` (MUST match SDK major version -- trial session hit version mismatch with @4.4.1 against SDK @4.3.3):
   ```bash
   bun add @trigger.dev/build@^4.3.3
   ```

2. Create `src/trigger/env-validation.ts` with:
   - Env var group constants as `readonly string[]` tuples:
     - `CORE_ENV_VARS = ["DATABASE_URL"]` (all tasks)
     - `CRYPTO_ENV_VARS = [...CORE_ENV_VARS, "HUB_ENCRYPTION_KEY"]` (tasks that decrypt tokens)
     - `X_ENV_VARS = ["X_CLIENT_ID", "X_CLIENT_SECRET"]`
     - `LINKEDIN_ENV_VARS = ["LINKEDIN_CLIENT_ID", "LINKEDIN_CLIENT_SECRET"]`
     - `INSTAGRAM_ENV_VARS = ["INSTAGRAM_APP_ID", "INSTAGRAM_APP_SECRET"]`
     - `TIKTOK_ENV_VARS = ["TIKTOK_CLIENT_KEY", "TIKTOK_CLIENT_SECRET"]`
   - `SYNC_ENV_VAR_NAMES` array: all 16 env vars that workers need (union of all groups + WAHA_BASE_URL, WAHA_API_KEY, WAHA_SESSION, TWILIO_ACCOUNT_SID, TWILIO_AUTH_TOKEN, TWILIO_FROM_NUMBER). Export this for trigger.config.ts.
   - `requireEnvVars<T extends readonly string[]>(varNames: T, taskId: string): Record<T[number], string>` function:
     - Collects ALL missing var names (not just first)
     - Throws with actionable message listing every missing var + fix instructions ("redeploy with `bunx trigger.dev deploy`" or "set in Trigger.dev dashboard")
     - Uses `logger` from `@trigger.dev/sdk` for structured error output before throwing
   - Do NOT include TRIGGER_SECRET_KEY in any list (Trigger.dev Cloud sets this automatically; overwriting it causes task-to-task auth failures)
  </action>
  <verify>bun run typecheck 2>&1 | tail -5</verify>
  <done>@trigger.dev/build installed at ^4.3.3, env-validation.ts exports requireEnvVars and all env var group constants</done>
</task>

<task type="auto">
  <name>Task 2: Wire syncEnvVars into trigger.config.ts</name>
  <files>trigger.config.ts</files>
  <action>
Modify `trigger.config.ts` to add the syncEnvVars build extension:

1. Add imports:
   ```typescript
   import { syncEnvVars } from "@trigger.dev/build/extensions/core";
   import { SYNC_ENV_VAR_NAMES } from "./src/trigger/env-validation.ts";
   ```

2. Add `build.extensions` array to the defineConfig object with `syncEnvVars(async (ctx) => { ... })`:
   - Iterate SYNC_ENV_VAR_NAMES, collect vars where `process.env[name]` has a value
   - Track missing var names separately
   - Log synced var count and names (names only, NEVER values) to console: `Syncing N env vars to Trigger.dev Cloud (environment)`
   - Log skipped/unset vars as info (platform not configured -- this is expected for disabled platforms)
   - Validate critical vars: if DATABASE_URL or HUB_ENCRYPTION_KEY is missing, `console.error` with actionable message ("Run /psn:setup to configure your hub before deploying") and `throw new Error(...)` to abort deploy
   - Return `{ name, value }[]` array format (NOT object format -- array is unambiguously documented)

3. Keep all existing config (runtime, project, dirs, retries, maxDuration) unchanged.
  </action>
  <verify>bun run typecheck 2>&1 | tail -5</verify>
  <done>trigger.config.ts has syncEnvVars extension that reads process.env at deploy time, logs synced vars, validates critical vars, and aborts on missing DATABASE_URL or HUB_ENCRYPTION_KEY</done>
</task>

</tasks>

<verification>
- `bun run typecheck` passes (no new type errors)
- `grep -c "syncEnvVars" trigger.config.ts` returns 1+
- `grep -c "requireEnvVars" src/trigger/env-validation.ts` returns 1+
- `grep -c "TRIGGER_SECRET_KEY" src/trigger/env-validation.ts trigger.config.ts` returns 0 (never synced)
</verification>

<success_criteria>
- @trigger.dev/build installed at ^4.3.3 matching SDK version
- trigger.config.ts has syncEnvVars build extension that syncs 16 env vars from process.env
- Critical vars (DATABASE_URL, HUB_ENCRYPTION_KEY) abort deploy if missing
- env-validation.ts exports requireEnvVars() utility ready for Plan 02 task adoption
- No type errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/25-trigger-env-var-delivery/25-01-SUMMARY.md`
</output>
