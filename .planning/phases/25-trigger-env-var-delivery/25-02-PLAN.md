---
phase: 25-trigger-env-var-delivery
plan: 02
type: execute
wave: 2
depends_on:
  - 25-01
files_modified:
  - src/trigger/publish-post.ts
  - src/trigger/analytics-collector.ts
  - src/trigger/token-refresher.ts
  - src/trigger/health.ts
  - src/trigger/trend-poller.ts
  - src/trigger/trend-collector.ts
  - src/trigger/engagement-monitor.ts
  - src/trigger/notification-dispatcher.ts
  - src/trigger/digest-compiler.ts
  - src/trigger/monthly-analysis.ts
  - src/trigger/idea-expiry.ts
  - src/trigger/watchdog.ts
autonomous: true
requirements:
  - DEPLOY-02

must_haves:
  truths:
    - "Every trigger task validates ALL required env vars at the start of its run() function"
    - "Missing env vars produce a single error listing every missing variable by name with fix instructions"
    - "All 12 trigger tasks use the shared requireEnvVars() utility (no ad-hoc process.env checks)"
  artifacts:
    - path: "src/trigger/publish-post.ts"
      provides: "Publish task using requireEnvVars"
      contains: "requireEnvVars"
    - path: "src/trigger/analytics-collector.ts"
      provides: "Analytics task using requireEnvVars"
      contains: "requireEnvVars"
    - path: "src/trigger/token-refresher.ts"
      provides: "Token refresh task using requireEnvVars"
      contains: "requireEnvVars"
  key_links:
    - from: "src/trigger/*.ts (all 12 tasks)"
      to: "src/trigger/env-validation.ts"
      via: "import requireEnvVars"
      pattern: 'import.*requireEnvVars.*env-validation'
---

<objective>
Update all 12 trigger tasks to use the shared requireEnvVars() utility from Plan 01, replacing inconsistent ad-hoc process.env checks with a single standardized validation call at the start of each task's run() function.

Purpose: Currently tasks use 3+ different patterns for env var validation -- some throw with partial lists, some return early with `{ status: "error" }`, some only check 1-2 vars. This produces confusing one-at-a-time error discovery. After this plan, every task validates ALL its required vars upfront with a single actionable error message.
Output: All 12 trigger tasks using requireEnvVars() with consistent, actionable error handling.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/25-trigger-env-var-delivery/25-RESEARCH.md
@.planning/phases/25-trigger-env-var-delivery/25-01-SUMMARY.md

@src/trigger/env-validation.ts
</context>

<interfaces>
<!-- From Plan 01 output: env-validation.ts exports -->
```typescript
// src/trigger/env-validation.ts
export const CORE_ENV_VARS: readonly string[];      // ["DATABASE_URL"]
export const CRYPTO_ENV_VARS: readonly string[];     // ["DATABASE_URL", "HUB_ENCRYPTION_KEY"]
export const X_ENV_VARS: readonly string[];          // ["X_CLIENT_ID", "X_CLIENT_SECRET"]
export const LINKEDIN_ENV_VARS: readonly string[];   // ["LINKEDIN_CLIENT_ID", "LINKEDIN_CLIENT_SECRET"]
export const INSTAGRAM_ENV_VARS: readonly string[];  // ["INSTAGRAM_APP_ID", "INSTAGRAM_APP_SECRET"]
export const TIKTOK_ENV_VARS: readonly string[];     // ["TIKTOK_CLIENT_KEY", "TIKTOK_CLIENT_SECRET"]

export function requireEnvVars<T extends readonly string[]>(
  varNames: T,
  taskId: string,
): Record<T[number], string>;
```
</interfaces>

<tasks>

<task type="auto">
  <name>Task 1: Update core tasks to use requireEnvVars</name>
  <files>src/trigger/publish-post.ts, src/trigger/health.ts, src/trigger/engagement-monitor.ts, src/trigger/trend-poller.ts, src/trigger/trend-collector.ts, src/trigger/watchdog.ts</files>
  <action>
For each of these 6 tasks, apply the same mechanical transformation:

1. Add import: `import { requireEnvVars, CRYPTO_ENV_VARS } from "./env-validation.ts";`
   (use CORE_ENV_VARS for tasks that only need DATABASE_URL: health.ts, watchdog.ts)
   (use CRYPTO_ENV_VARS for tasks that also need HUB_ENCRYPTION_KEY: publish-post.ts, engagement-monitor.ts, trend-poller.ts, trend-collector.ts)

2. Replace the ad-hoc `process.env.DATABASE_URL` / `process.env.HUB_ENCRYPTION_KEY` checks at the top of `run()` with a single call:
   ```typescript
   const env = requireEnvVars(CRYPTO_ENV_VARS, "task-id-here");
   ```
   Then use `env.DATABASE_URL` and `env.HUB_ENCRYPTION_KEY` instead of the raw `process.env` reads.

3. Remove the old if-check blocks (the ones that throw or return on missing vars). The requireEnvVars() call handles this.

4. Keep all other task logic unchanged. Do NOT modify any business logic -- only the env var acquisition at the top of run().

**Per-task env var groups:**
- `publish-post.ts`: CRYPTO_ENV_VARS (DATABASE_URL + HUB_ENCRYPTION_KEY)
- `health.ts`: CORE_ENV_VARS (DATABASE_URL only)
- `engagement-monitor.ts`: CRYPTO_ENV_VARS
- `trend-poller.ts`: CRYPTO_ENV_VARS
- `trend-collector.ts`: CRYPTO_ENV_VARS
- `watchdog.ts`: CORE_ENV_VARS
  </action>
  <verify>bun run typecheck 2>&1 | tail -5</verify>
  <done>All 6 core tasks use requireEnvVars() with appropriate env var group, no raw process.env checks for DATABASE_URL or HUB_ENCRYPTION_KEY remain</done>
</task>

<task type="auto">
  <name>Task 2: Update platform and notification tasks to use requireEnvVars</name>
  <files>src/trigger/analytics-collector.ts, src/trigger/token-refresher.ts, src/trigger/notification-dispatcher.ts, src/trigger/digest-compiler.ts, src/trigger/monthly-analysis.ts, src/trigger/idea-expiry.ts</files>
  <action>
For each of these 6 tasks, apply the same mechanical transformation as Task 1, but with platform-specific env var groups:

**analytics-collector.ts:** This task has platform-specific sections (X, LinkedIn, Instagram, TikTok). The core env vars (DATABASE_URL, HUB_ENCRYPTION_KEY) should use requireEnvVars() at the top of run(). For platform-specific vars (X_CLIENT_ID, etc.), these are checked per-platform inside the task -- keep the per-platform checks but use requireEnvVars() with the appropriate platform group constant (X_ENV_VARS, LINKEDIN_ENV_VARS, etc.) instead of raw process.env reads. If a platform section has its own env var check, replace it with `requireEnvVars([...CRYPTO_ENV_VARS, ...X_ENV_VARS], "analytics-collector/x")`.

**token-refresher.ts:** Same pattern as analytics-collector -- core vars at top, platform vars per-section. Replace per-platform checks with requireEnvVars() using combined arrays.

**notification-dispatcher.ts:** Uses DATABASE_URL + notification vars (WAHA_*, TWILIO_*). For the core check at top, use `requireEnvVars(CORE_ENV_VARS, "notification-dispatcher")`. For notification provider sections, the WAHA/Twilio vars are optional (only needed when that provider is configured) -- keep the existing conditional checks for these (do NOT throw if WAHA vars are missing when user uses Twilio, and vice versa). Only wrap the core DATABASE_URL check with requireEnvVars().

**digest-compiler.ts:** Same pattern as notification-dispatcher -- core vars required, notification vars conditionally checked.

**monthly-analysis.ts:** CORE_ENV_VARS only (DATABASE_URL).

**idea-expiry.ts:** CORE_ENV_VARS only (DATABASE_URL).

**Important:** For notification tasks (notification-dispatcher, digest-compiler), do NOT force-require WAHA or Twilio vars. These are optional based on which notification provider the user configured. Only require DATABASE_URL via requireEnvVars().
  </action>
  <verify>bun run typecheck 2>&1 | tail -5</verify>
  <done>All 6 platform/notification tasks use requireEnvVars() for core env vars, platform-specific vars use requireEnvVars() with appropriate group constants where they were previously checked, notification vars remain conditionally checked</done>
</task>

</tasks>

<verification>
- `bun run typecheck` passes (no new type errors)
- `bun test` passes (existing tests still work)
- `grep -r "requireEnvVars" src/trigger/ --include="*.ts" | grep -v "env-validation.ts" | grep -v ".test.ts" | wc -l` returns 12+ (each task file imports and calls it)
- `grep -rn "process\.env\.DATABASE_URL" src/trigger/ --include="*.ts" | grep -v "env-validation.ts" | grep -v ".test.ts" | wc -l` returns 0 (no more raw DATABASE_URL reads outside the utility)
</verification>

<success_criteria>
- All 12 trigger tasks import and use requireEnvVars() from env-validation.ts
- No raw process.env.DATABASE_URL or process.env.HUB_ENCRYPTION_KEY checks remain in task files (except test files)
- Missing env vars produce a single error listing ALL missing variables with fix instructions
- Existing tests still pass
- No type errors introduced
</success_criteria>

<output>
After completion, create `.planning/phases/25-trigger-env-var-delivery/25-02-SUMMARY.md`
</output>
