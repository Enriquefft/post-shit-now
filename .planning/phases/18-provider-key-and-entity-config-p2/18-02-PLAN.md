---
phase: 18-provider-key-and-entity-config-p2
plan: 02
type: execute
wave: 2
depends_on:
  - 18-01
files_modified:
  - src/cli/setup-voice.ts
autonomous: true
requirements:
  - M7
must_haves:
  truths:
    - "Setup status detects voice interview completion (not just entity existence)"
    - "/psn:setup status shows accurate completion progress"
    - "Voice profile with pillars indicates completion, not just entity record"
  artifacts:
    - path: "src/cli/setup-voice.ts"
      provides: "Setup status detection with interview completion check"
      exports: ["getSetupStatus"]
  key_links:
    - from: "src/cli/setup-voice.ts"
      to: "src/core/db/schema.ts"
      via: "voice_profiles table query"
      pattern: "profileData.*identity.*pillars"
---

<objective>
Extend `getSetupStatus()` to detect voice interview completion by checking for pillars in voice profile data, not just entity record existence.

Purpose: Issue M7 - Missing setup completion validation. Currently, `getSetupStatus()` checks if entities exist but doesn't verify if voice interview is completed. This plan adds interview completion detection by checking for identity.pillars in profileData.

Output: Setup status accurately reflects whether voice interview is complete, not just whether an entity record exists.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-provider-key-and-entity-config-p2/18-RESEARCH.md

@src/cli/setup-voice.ts (lines 46-124 - getSetupStatus function)
@src/core/db/schema.ts (voice_profiles table definition)
@src/voice/types.ts (VoiceProfile type with profileData structure)
</context>

<tasks>

<task type="auto">
  <name>Add interview completion check to getSetupStatus</name>
  <files>src/cli/setup-voice.ts</files>
  <action>
    In getSetupStatus() around lines 70-78, extend the entity existence check to also verify interview completion:

    1. Query the first entity's profileData to check for interview completion
    2. Check if profileData has identity.pillars array with length > 0 (indicates interview completion)
    3. Update hasVoiceProfile based on interview completion, not just entity count

    Replace:
    ```typescript
    if (db && userId) {
      // Query voice_profiles count -> entityCount, hasEntities
      const entityResults = await db
        .select({ count: count() })
        .from(voiceProfiles)
        .where(eq(voiceProfiles.userId, userId));

      status.entityCount = entityResults[0]?.count ?? 0;
      status.hasEntities = status.entityCount > 0;
      status.hasVoiceProfile = hasLegacyProfile || status.hasEntities;
      // ... rest of existing logic
    }
    ```

    With:
    ```typescript
    if (db && userId) {
      // Query voice_profiles count -> entityCount, hasEntities
      const entityResults = await db
        .select({ count: count() })
        .from(voiceProfiles)
        .where(eq(voiceProfiles.userId, userId));

      status.entityCount = entityResults[0]?.count ?? 0;
      status.hasEntities = status.entityCount > 0;

      // Check interview completion by querying profileData for pillars
      let hasCompletedInterview = hasLegacyProfile;
      if (status.entityCount > 0) {
        const firstEntity = await db
          .select({ profileData: voiceProfiles.profileData })
          .from(voiceProfiles)
          .where(eq(voiceProfiles.userId, userId))
          .limit(1);

        // Interview is complete if profile has identity pillars defined
        hasCompletedInterview =
          firstEntity[0]?.profileData?.identity?.pillars?.length > 0;
      }

      status.hasVoiceProfile = hasCompletedInterview;
      // ... rest of existing logic
    }
    ```

    This ensures hasVoiceProfile reflects actual interview completion, not just entity record existence.
  </action>
  <verify>
    Run `bun run src/cli/setup.ts status` and verify:
    1. Before interview: shows "voice" as incomplete step
    2. After interview: shows all steps complete or only platforms remaining
  </verify>
  <done>
    Setup status accurately detects voice interview completion by checking for identity.pillars in profileData.
  </done>
</task>

</tasks>

<verification>
Overall phase verification:
1. Status command shows "voice" incomplete when entity exists but interview not done
2. Status command shows "voice" complete when interview has pillars defined
3. IncompleteSteps array correctly reflects actual setup state
4. RecommendedAction points to next logical step
</verification>

<success_criteria>
Setup status accurately reflects voice interview completion status. Users see correct progress indication.
</success_criteria>

<output>
After completion, create `.planning/phases/18-provider-key-and-entity-config-p2/18-02-SUMMARY.md`
</output>
