---
phase: 18-provider-key-and-entity-config-p2
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/setup.ts
autonomous: true
requirements:
  - M8
must_haves:
  truths:
    - "Main setup flow collects provider keys interactively when missing"
    - "Provider key step no longer returns early on 'need_input' status"
    - "Users can complete provider key setup within main /psn:setup command"
  artifacts:
    - path: "src/cli/setup.ts"
      provides: "Main setup orchestrator with provider key collection"
      contains: "collectKeysInteractively"
  key_links:
    - from: "src/cli/setup.ts"
      to: "src/cli/setup-keys.ts"
      via: "collectKeysInteractively function call"
      pattern: "collectKeysInteractively"
---

<objective>
Wire provider key collection into main setup flow so users can configure provider keys interactively during initial setup.

Purpose: Issue M8 - Provider key configuration flow unclear. Currently, `setupProviderKeys()` returns "need_input" results but main setup returns early instead of prompting for keys. This plan integrates the existing `collectKeysInteractively()` function into the main setup flow.

Output: Users can complete provider key setup through `/psn:setup` without separate key management commands.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/18-provider-key-and-entity-config-p2/18-RESEARCH.md

@src/cli/setup.ts (lines 592-602 - provider key check)
@src/cli/setup-keys.ts (lines 113-225 - collectKeysInteractively)
</context>

<tasks>

<task type="auto">
  <name>Integrate provider key collection into main setup flow</name>
  <files>src/cli/setup.ts</files>
  <action>
    In setup.ts, around lines 592-602, replace the early return pattern for provider keys with interactive collection:

    1. Keep the existing `setupProviderKeys(configDir)` call
    2. When it returns an array (meaning keys are missing), call `collectKeysInteractively(configDir)` instead of returning early
    3. Push the result to steps array and check for errors before continuing

    Replace:
    ```typescript
    const providerKeysResult = await setupProviderKeys(configDir);
    if (Array.isArray(providerKeysResult)) {
      return {
        steps: [...steps, ...providerKeysResult],
        validation: null,
        completed: false,
      };
    }
    steps.push(providerKeysResult);
    ```

    With:
    ```typescript
    const providerKeysResult = await setupProviderKeys(configDir);
    if (Array.isArray(providerKeysResult)) {
      // Keys missing - collect interactively
      console.log("Provider keys required:");
      const collectResult = await collectKeysInteractively(configDir);
      steps.push(collectResult);
      if (collectResult.status === "error") {
        return { steps, validation: null, completed: false };
      }
    } else {
      steps.push(providerKeysResult);
    }
    ```

    Import `collectKeysInteractively` from setup-keys.ts if not already imported.
  </action>
  <verify>
    Run `bun run src/cli/setup.ts` and verify provider key collection prompts appear when keys are missing. Check that setup completes without early return.
  </verify>
  <done>
    Provider keys are collected interactively during main setup flow, and setup proceeds to database step after keys are saved.
  </done>
</task>

</tasks>

<verification>
Overall phase verification:
1. Run setup with missing provider keys - should prompt interactively
2. Setup completes without early return on provider key step
3. Keys are saved to database api_keys table
4. Setup continues to database and Trigger.dev setup steps
</verification>

<success_criteria>
Users can complete provider key configuration within the main `/psn:setup` command flow. No separate key management command required.
</success_criteria>

<output>
After completion, create `.planning/phases/18-provider-key-and-entity-config-p2/18-01-SUMMARY.md`
</output>
