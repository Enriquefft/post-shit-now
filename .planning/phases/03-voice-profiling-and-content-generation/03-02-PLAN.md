---
phase: 03-voice-profiling-and-content-generation
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/media/providers/gpt-image.ts
  - src/media/providers/ideogram.ts
  - src/media/providers/flux.ts
  - src/media/image-gen.ts
  - src/media/processor.ts
  - src/media/platform-specs.ts
  - src/media/processor.test.ts
autonomous: true
requirements:
  - IMG-01
  - IMG-02
  - IMG-03
  - IMG-04
  - IMG-05

must_haves:
  truths:
    - "User can generate images using GPT Image (OpenAI SDK) with configurable model and size"
    - "User can generate images using Ideogram 3 with best-in-class text rendering"
    - "User can generate images using Flux 2 via fal.ai for photorealistic output"
    - "Claude can auto-select the best image provider based on content type (text overlay, photorealism, versatile)"
    - "Generated images are processed via sharp to meet platform-specific format and size requirements"
  artifacts:
    - path: "src/media/providers/gpt-image.ts"
      provides: "GPT Image provider using OpenAI SDK"
      exports: ["gptImageProvider"]
    - path: "src/media/providers/ideogram.ts"
      provides: "Ideogram 3 provider via fal.ai or direct API"
      exports: ["ideogramProvider"]
    - path: "src/media/providers/flux.ts"
      provides: "Flux 2 provider via fal.ai"
      exports: ["fluxProvider"]
    - path: "src/media/image-gen.ts"
      provides: "Image generation orchestrator with provider selection"
      exports: ["generateImage", "selectImageProvider"]
    - path: "src/media/processor.ts"
      provides: "sharp-based image processing for platform compliance"
      exports: ["processImageForPlatform", "getImageMetadata"]
    - path: "src/media/platform-specs.ts"
      provides: "Platform media requirements lookup table"
      exports: ["PLATFORM_IMAGE_SPECS", "PLATFORM_VIDEO_SPECS"]
  key_links:
    - from: "src/media/image-gen.ts"
      to: "src/media/providers/*.ts"
      via: "Provider interface implementation"
      pattern: "ImageProvider"
    - from: "src/media/image-gen.ts"
      to: "src/media/processor.ts"
      via: "Post-generation processing"
      pattern: "processImageForPlatform"
---

<objective>
Build the image generation subsystem with three providers (GPT Image, Ideogram 3, Flux 2), smart provider selection, and platform-specific image processing.

Purpose: Media generation is a major feature of Phase 3. Images enhance post engagement significantly. This plan creates the provider abstraction layer so Claude can pick the best tool for each content type.

Output: Three image provider implementations, a provider selection orchestrator, sharp-based image processor, and platform specification lookup.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-voice-profiling-and-content-generation/03-RESEARCH.md
@src/core/types/index.ts
@src/core/utils/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Platform specs, image processor, and provider interface</name>
  <files>src/media/platform-specs.ts, src/media/processor.ts, src/media/processor.test.ts</files>
  <action>
**src/media/platform-specs.ts** — Platform media specifications:

Define and export `PLATFORM_IMAGE_SPECS` as a Record keyed by Platform:
```
x: { maxSizeBytes: 5_242_880, formats: ["jpeg", "png", "webp", "gif"], recommendedAspectRatios: ["16:9", "1:1"], recommendedDimensions: { landscape: { w: 1200, h: 675 }, square: { w: 1080, h: 1080 } } }
linkedin: { maxSizeBytes: 10_485_760, formats: ["jpeg", "png"], recommendedAspectRatios: ["1.91:1", "1:1", "4:5"], recommendedDimensions: { landscape: { w: 1200, h: 627 }, square: { w: 1080, h: 1080 }, portrait: { w: 1080, h: 1350 } } }
instagram: { maxSizeBytes: 8_388_608, formats: ["jpeg"], recommendedAspectRatios: ["1:1", "4:5", "9:16"], recommendedDimensions: { square: { w: 1080, h: 1080 }, portrait: { w: 1080, h: 1350 }, story: { w: 1080, h: 1920 } } }
tiktok: { maxSizeBytes: 10_485_760, formats: ["jpeg", "png"], recommendedAspectRatios: ["9:16"], recommendedDimensions: { vertical: { w: 1080, h: 1920 } } }
```

Define and export `PLATFORM_VIDEO_SPECS`:
```
x: { maxDuration: 140, optimalDuration: 15, formats: ["mp4"], codec: "h264" }
linkedin: { maxDuration: 600, optimalDuration: 60, formats: ["mp4"], codec: "h264" }
instagram: { maxDuration: 90, optimalDuration: 25, formats: ["mp4"], codec: "h264" }
tiktok: { maxDuration: 600, optimalDuration: 60, formats: ["mp4"], codec: "h264" }
```

Export TypeScript types for both spec shapes.

**src/media/processor.ts** — Image processing with sharp:

1. `processImageForPlatform(imageBuffer: Buffer, platform: Platform, options?: { aspectRatio?: string; quality?: number }): Promise<ProcessedImage>` — Resize to platform's recommended dimensions for the given aspect ratio. Convert format if needed (Instagram always JPEG). Compress to fit within maxSizeBytes. Return `{ buffer, mimeType, width, height, sizeBytes }`.

2. `getImageMetadata(buffer: Buffer): Promise<ImageMetadata>` — Return `{ width, height, format, sizeBytes, hasAlpha }` using sharp metadata.

3. `ensureSizeLimit(buffer: Buffer, maxBytes: number, format: "jpeg" | "png" | "webp"): Promise<Buffer>` — If buffer exceeds maxBytes, reduce quality iteratively (start 85, step down by 10) until under limit. Throw if can't get under limit even at quality 10.

Import sharp. Import PLATFORM_IMAGE_SPECS from platform-specs.

**src/media/processor.test.ts** — Tests:
- Test processImageForPlatform resizes to correct dimensions for each platform
- Test processImageForPlatform converts PNG to JPEG for Instagram
- Test getImageMetadata returns correct format/dimensions
- Test ensureSizeLimit reduces quality to meet size constraint
- Create test images using sharp itself (e.g., `sharp({ create: { width: 100, height: 100, channels: 3, background: 'red' } })`)
  </action>
  <verify>Run `bun run test -- src/media/processor.test.ts` — all tests pass. Run `bun run typecheck`.</verify>
  <done>Platform specs defined for all 4 platforms. Image processor resizes, converts format, and enforces size limits using sharp.</done>
</task>

<task type="auto">
  <name>Task 2: Image providers and generation orchestrator</name>
  <files>src/media/providers/gpt-image.ts, src/media/providers/ideogram.ts, src/media/providers/flux.ts, src/media/image-gen.ts</files>
  <action>
**Define ImageProvider interface** in `src/media/image-gen.ts`:
```typescript
interface ImageProvider {
  name: string;
  strengths: string[];
  generate(prompt: string, options: ImageGenOptions): Promise<GeneratedImage>;
}

interface ImageGenOptions {
  aspectRatio?: string;
  style?: string;
  negativePrompt?: string;
  size?: { width: number; height: number };
}

interface GeneratedImage {
  buffer: Buffer;
  mimeType: string;
  width: number;
  height: number;
  provider: string;
}
```

**src/media/providers/gpt-image.ts** — GPT Image provider:
- Implements ImageProvider interface
- Uses `openai` SDK: `new OpenAI()` (reads OPENAI_API_KEY from env)
- Calls `openai.images.generate({ model: "gpt-image-1", prompt, size, n: 1 })`
- Decodes base64 response to Buffer
- `strengths: ["versatile", "general-purpose", "editing", "style-variety"]`
- Maps aspectRatio to size strings: "1:1" -> "1024x1024", "16:9" -> "1536x1024", "9:16" -> "1024x1536"
- Handles OpenAI API errors gracefully with descriptive messages

**src/media/providers/ideogram.ts** — Ideogram 3 provider:
- Implements ImageProvider
- Primary path: Use `@fal-ai/client` with model `fal-ai/ideogram/v3` (no minimum usage)
- Fallback: If `IDEOGRAM_API_KEY` env var exists, use direct API at `https://api.ideogram.ai/v1/ideogram-v3/generate`
- For fal.ai path: `fal.subscribe("fal-ai/ideogram/v3", { input: { prompt, aspect_ratio, rendering_speed: "DEFAULT", magic_prompt: "AUTO", style_type } })`
- For direct path: POST with Api-Key header, JSON body with prompt, aspect_ratio, rendering_speed, magic_prompt
- Download image from URL to Buffer in both cases
- `strengths: ["text-rendering", "typography", "logos", "posters", "design"]`

**src/media/providers/flux.ts** — Flux 2 provider:
- Implements ImageProvider
- Uses `@fal-ai/client` with model `fal-ai/flux-2-pro`
- `fal.subscribe("fal-ai/flux-2-pro", { input: { prompt, image_size, output_format: "jpeg" } })`
- Map aspectRatio to image_size: "1:1" -> "square", "16:9" -> "landscape_16_9", "4:3" -> "landscape_4_3", "9:16" -> "portrait_9_16"
- Download image from URL to Buffer
- `strengths: ["photorealistic", "high-resolution", "product-shots", "nature", "portraits"]`

**src/media/image-gen.ts** — Orchestrator:

1. `selectImageProvider(contentHints: string[], userPreference?: string): ImageProvider` — Selection logic:
   - If userPreference matches a provider name, use it (respect user choice)
   - If contentHints include "text", "typography", "logo", "poster", "infographic" -> Ideogram
   - If contentHints include "photo", "realistic", "product", "portrait", "nature" -> Flux
   - Default -> GPT Image (versatile)
   - Return selected provider with `suggestion` field if a different provider would be better

2. `generateImage(prompt: string, options: { platform: Platform; contentHints?: string[]; userPreference?: string; aspectRatio?: string }): Promise<GeneratedImage>` — Select provider, call generate, process for platform via processImageForPlatform, return processed image.

3. Export all provider instances and the interface types.

For fal.ai providers: configure credentials via `fal.config({ credentials: process.env.FAL_KEY })` at module level. Wrap in check for FAL_KEY existence.
For OpenAI: relies on OPENAI_API_KEY env var (standard OpenAI SDK behavior).
  </action>
  <verify>Run `bun run typecheck` — no errors. Run `bun run lint` — passes. Verify all three providers export correctly and implement the ImageProvider interface.</verify>
  <done>Three image providers implemented behind a unified interface. Provider selection logic picks best tool based on content type. Images are auto-processed for platform compliance.</done>
</task>

</tasks>

<verification>
- `bun run typecheck` passes
- `bun run test -- src/media/processor.test.ts` passes
- `bun run lint` passes
- All three providers implement the same ImageProvider interface
- Provider selection returns Ideogram for text-heavy content, Flux for photorealism, GPT Image for general
</verification>

<success_criteria>
- GPT Image provider uses OpenAI SDK with gpt-image-1 model
- Ideogram provider uses fal.ai by default (no 1M/month minimum), falls back to direct API if IDEOGRAM_API_KEY set
- Flux 2 provider uses fal.ai with flux-2-pro model
- Claude can auto-select provider based on content analysis
- All generated images pass through sharp processing for platform compliance
- Platform specs cover all 4 platforms (X, LinkedIn, Instagram, TikTok)
</success_criteria>

<output>
After completion, create `.planning/phases/03-voice-profiling-and-content-generation/03-02-SUMMARY.md`
</output>
