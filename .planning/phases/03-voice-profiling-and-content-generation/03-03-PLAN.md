---
phase: 03-voice-profiling-and-content-generation
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/media/providers/kling.ts
  - src/media/providers/runway.ts
  - src/media/providers/pika.ts
  - src/media/video-gen.ts
autonomous: true
requirements:
  - VID-01
  - VID-02
  - VID-03
  - VID-04
  - VID-05

must_haves:
  truths:
    - "User can generate video clips using Kling via fal.ai (realistic motion, product demos, audio-visual)"
    - "User can generate video clips using Runway via official SDK (stylized, image-to-video)"
    - "User can generate video clips using Pika via fal.ai (animated clips, text-to-video)"
    - "Claude can auto-select the best video provider based on content type"
    - "Generated videos meet platform-specific format and length requirements"
    - "Animated text/quote videos can be generated fully automated (VID-01)"
    - "B-roll with voiceover using TTS can be generated fully automated (VID-02)"
  artifacts:
    - path: "src/media/providers/kling.ts"
      provides: "Kling video provider via fal.ai"
      exports: ["klingProvider"]
    - path: "src/media/providers/runway.ts"
      provides: "Runway video provider via official SDK"
      exports: ["runwayProvider"]
    - path: "src/media/providers/pika.ts"
      provides: "Pika video provider via fal.ai"
      exports: ["pikaProvider"]
    - path: "src/media/video-gen.ts"
      provides: "Video generation orchestrator with provider selection"
      exports: ["generateVideo", "selectVideoProvider"]
  key_links:
    - from: "src/media/video-gen.ts"
      to: "src/media/providers/*.ts"
      via: "VideoProvider interface implementation"
      pattern: "VideoProvider"
    - from: "src/media/video-gen.ts"
      to: "src/media/platform-specs.ts"
      via: "Platform video specs for duration/format validation"
      pattern: "PLATFORM_VIDEO_SPECS"
---

<objective>
Build the video generation subsystem with three providers (Kling, Runway, Pika), smart provider selection, and platform-aware duration/format constraints.

Purpose: Video content drives the highest engagement on modern social platforms. This plan creates the video generation abstraction layer parallel to the image generation layer.

Output: Three video provider implementations, a provider selection orchestrator, and platform-specific video validation.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-voice-profiling-and-content-generation/03-RESEARCH.md
@src/core/types/index.ts
@src/core/utils/env.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Video providers (Kling, Runway, Pika)</name>
  <files>src/media/providers/kling.ts, src/media/providers/runway.ts, src/media/providers/pika.ts</files>
  <action>
**Define VideoProvider interface** (export from each provider file, consolidated in video-gen.ts):
```typescript
interface VideoProvider {
  name: string;
  strengths: string[];
  supportedModes: ("text-to-video" | "image-to-video")[];
  generate(params: VideoGenParams): Promise<GeneratedVideo>;
}

interface VideoGenParams {
  prompt: string;
  mode: "text-to-video" | "image-to-video";
  sourceImage?: string; // URL or base64 for image-to-video
  duration: number; // seconds
  aspectRatio?: string;
  withAudio?: boolean;
}

interface GeneratedVideo {
  url: string; // download URL
  buffer?: Buffer; // if already downloaded
  mimeType: string;
  duration: number;
  provider: string;
  hasAudio: boolean;
}
```

**src/media/providers/kling.ts** — Kling provider via fal.ai:
- Uses `@fal-ai/client`
- Text-to-video: `fal.subscribe("fal-ai/kling-video/v2.6/pro/text-to-video", { input: { prompt, duration, aspect_ratio, generate_audio, cfg_scale: 0.5 } })`
- Image-to-video: `fal.subscribe("fal-ai/kling-video/v2.6/pro/image-to-video", { input: { prompt, image_url: sourceImage, duration, aspect_ratio } })`
- `strengths: ["realistic-motion", "product-demos", "audio-visual", "b-roll", "voiceover"]`
- `supportedModes: ["text-to-video", "image-to-video"]`
- Map duration to valid values (5 or 10 seconds for Kling)
- Map aspectRatio to valid values ("16:9", "9:16", "1:1")
- Set reasonable timeout (5 minutes) for fal.subscribe polling
- VID-02 support: When `withAudio: true`, use `generate_audio: true` for Kling 2.6's simultaneous audio-visual generation

**src/media/providers/runway.ts** — Runway provider via official SDK:
- Uses `@runwayml/sdk`: `new RunwayML()` (reads RUNWAYML_API_SECRET from env)
- Image-to-video only (Gen-4 Turbo's primary mode): `client.imageToVideo.create({ model: "gen4_turbo", promptImage, promptText: prompt, duration }).waitForTaskOutput()`
- Text-to-video: `client.textToVideo.create({ model: "gen4.5", promptText: prompt, ratio, duration }).waitForTaskOutput()`
- `strengths: ["stylized", "cinematic", "image-to-video", "consistent-characters"]`
- `supportedModes: ["text-to-video", "image-to-video"]`
- Map duration to valid range (2-10 seconds)
- Map aspectRatio to ratio format ("1280:720", "720:1280")
- Set `X-Runway-Version: 2024-11-06` header if needed by SDK

**src/media/providers/pika.ts** — Pika provider via fal.ai:
- Uses `@fal-ai/client`
- Text-to-video: `fal.subscribe("fal-ai/pika/v2.2/text-to-video", { input: { prompt, duration, aspect_ratio } })`
- Image-to-video: `fal.subscribe("fal-ai/pika/v2.2/image-to-video", { input: { prompt, image_url: sourceImage, duration } })`
- `strengths: ["animated-clips", "text-animation", "quote-videos", "creative-effects"]`
- `supportedModes: ["text-to-video", "image-to-video"]`
- VID-01 support: Pika excels at animated text/quote videos

All providers: configure fal.ai credentials via `fal.config({ credentials: process.env.FAL_KEY })`. Wrap API calls in try/catch with descriptive error messages. Download video from returned URL to Buffer using fetch.
  </action>
  <verify>Run `bun run typecheck` — no errors. Run `bun run lint` — passes.</verify>
  <done>Three video providers implemented with text-to-video and image-to-video support where available. Each provider declares its strengths and supported modes.</done>
</task>

<task type="auto">
  <name>Task 2: Video generation orchestrator with provider selection</name>
  <files>src/media/video-gen.ts</files>
  <action>
**src/media/video-gen.ts** — Video generation orchestrator:

1. `selectVideoProvider(contentHints: string[], mode: "text-to-video" | "image-to-video", userPreference?: string): VideoProvider` — Selection logic:
   - If userPreference matches a provider name AND that provider supports the mode, use it
   - If mode is "image-to-video" AND contentHints include "cinematic", "stylized" -> Runway
   - If contentHints include "text-animation", "quote", "animated-text" -> Pika (VID-01)
   - If contentHints include "b-roll", "voiceover", "product-demo", "realistic" -> Kling (VID-02)
   - If contentHints include "audio", "sound" -> Kling (has native audio generation)
   - Default for text-to-video -> Kling (most versatile)
   - Default for image-to-video -> Runway (best quality)
   - If selected provider doesn't support the mode, fall back to one that does

2. `generateVideo(params: { prompt: string; mode: "text-to-video" | "image-to-video"; platform: Platform; contentHints?: string[]; userPreference?: string; sourceImage?: string; withAudio?: boolean }): Promise<GeneratedVideo>` — Select provider, determine optimal duration from PLATFORM_VIDEO_SPECS (use optimalDuration if not specified), set aspectRatio from platform specs, call provider.generate(), validate output duration against platform maxDuration.

3. `validateVideoForPlatform(video: GeneratedVideo, platform: Platform): { valid: boolean; issues: string[] }` — Check duration within platform max, check format is mp4, return issues if any. Note: actual video transcoding with ffmpeg is deferred unless needed (per research open question).

Import PLATFORM_VIDEO_SPECS from platform-specs.ts. Import all three providers. Export all types (VideoProvider, VideoGenParams, GeneratedVideo) and functions.
  </action>
  <verify>Run `bun run typecheck` — no errors. Run `bun run lint` — passes.</verify>
  <done>Video generation orchestrator selects optimal provider per content type and platform. Platform specs enforce duration and format constraints. Kling handles audio-visual (VID-02), Pika handles text animation (VID-01).</done>
</task>

</tasks>

<verification>
- `bun run typecheck` passes
- `bun run lint` passes
- All three video providers implement VideoProvider interface
- Provider selection returns Kling for b-roll/voiceover, Pika for text animation, Runway for stylized/cinematic
- Duration and aspect ratio are validated against platform specs
</verification>

<success_criteria>
- VID-01 (animated text/quote videos): Pika provider handles text-animation content type
- VID-02 (b-roll with voiceover): Kling 2.6 handles with generate_audio=true
- VID-03 (short clips from any provider): All three providers available
- VID-04 (Claude picks best tool): selectVideoProvider implements content-aware selection
- VID-05 (platform-specific format/length): validateVideoForPlatform checks against PLATFORM_VIDEO_SPECS
</success_criteria>

<output>
After completion, create `.planning/phases/03-voice-profiling-and-content-generation/03-03-SUMMARY.md`
</output>
