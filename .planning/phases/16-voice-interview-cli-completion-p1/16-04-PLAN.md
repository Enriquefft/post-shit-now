---
phase: 16-voice-interview-cli-completion-p1
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/voice-interview.ts
  - src/voice/interview.ts
autonomous: true
requirements: [M6, m6]

must_haves:
  truths:
    - Content directories created automatically on interview start
    - Directories: content/voice/profiles/, content/voice/strategies/
    - Created with system default permissions (typically 755)
    - Error handling for permission issues with clear messages
  artifacts:
    - path: "content/voice/profiles/"
      provides: "Entity voice profiles storage"
      optional: true
    - path: "content/voice/strategies/"
      provides: "Entity strategy configs storage"
      optional: true
    - path: "src/voice/interview.ts"
      provides: "Directory creation function"
      exports: ["ensureVoiceDirectories"]
      min_lines: 50
  key_links:
    - from: "src/voice/interview.ts"
      to: "content/voice/profiles/ content/voice/strategies/"
      via: "mkdir with recursive: true"
      pattern: "mkdir.*recursive"
    - from: "src/cli/voice-interview.ts"
      to: "src/voice/interview.ts"
      via: "Call ensureVoiceDirectories on interview start"
      pattern: "ensureVoiceDirectories"
---

<objective>
Add automatic directory structure creation for voice profiles and strategies.

Purpose: Ensure required directories exist before saving profiles/strategies, eliminating manual setup requirements.

Output: Directory creation function called on interview start.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Locked decisions from CONTEXT.md
- Auto-create: Yes, create directories automatically
- When created: On interview start (before collecting answers)
- Structure: Organized with subdirs (e.g., `content/voice/profiles/`, `content/voice/strategies/`)
- Permissions: System default (typically 755)

@src/voice/interview.ts
@src/voice/profile.ts
@src/cli/voice-interview.ts
@src/content/drafts.ts (mkdir pattern reference)

# Research findings
- Use mkdir({ recursive: true }) for automatic parent directory creation
- Reference existing pattern from src/content/drafts.ts:79
</context>

<tasks>

<task type="auto">
  <name>Add directory creation function</name>
  <files>src/voice/interview.ts</files>
  <action>
Add ensureVoiceDirectories() function to src/voice/interview.ts:

```typescript
import { mkdir } from "node:fs/promises";

/**
 * Ensure voice profile and strategy directories exist.
 * Creates directories with recursive: true to handle missing parent dirs.
 *
 * Directories created:
 * - content/voice/profiles/ - Entity-scoped voice profiles
 * - content/voice/strategies/ - Entity-scoped strategy configs
 *
 * Permissions: System default (typically 755)
 *
 * @throws Error if directories cannot be created (e.g., permission denied)
 */
export async function ensureVoiceDirectories(): Promise<void> {
  const directories = [
    "content/voice/profiles",
    "content/voice/strategies",
  ];

  for (const dir of directories) {
    try {
      await mkdir(dir, { recursive: true });
    } catch (err) {
      if (err instanceof Error) {
        throw new Error(
          `Failed to create interview directory: ${dir}\n${err.message}\n\n` +
          `Please check that you have write permissions for the content/ directory.`
        );
      }
      throw err;
    }
  }
}
```

Import mkdir from node:fs/promises at the top of the file.

Reference existing mkdir pattern from @src/content/drafts.ts:79:
```typescript
await mkdir(DRAFTS_DIR, { recursive: true });
```

The function:
- Creates both directories (profiles and strategies)
- Uses recursive: true to create parent dirs if missing
- Wraps in try/catch for clear error messages
- Throws with actionable error if creation fails (e.g., permission denied)

Note: content/voice/ directory is assumed to exist (created by project structure). If it doesn't exist, recursive: true will create it.
  </action>
  <verify>Run TypeScript check: `bun run tsc --noEmit` on src/voice/interview.ts</verify>
  <done>ensureVoiceDirectories() creates content/voice/profiles/ and content/voice/strategies/ directories</done>
</task>

<task type="auto">
  <name>Call directory creation on interview start</name>
  <files>src/cli/voice-interview.ts</files>
  <action>
Update startInterview() function in src/cli/voice-interview.ts:

1. Import ensureVoiceDirectories from src/voice/interview.ts:
   ```typescript
   import {
     ensureVoiceDirectories,
     createInterviewState,
     generateQuestions,
     // ... other imports
   } from "../voice/interview.ts";
   ```

2. Call ensureVoiceDirectories() before creating state:
   ```typescript
   export async function startInterview(options?: {
     recalibration?: boolean;
     profilePath?: string;
   }): Promise<{ state: InterviewState; questions: InterviewQuestion[] }> {
     // Ensure directories exist before collecting answers
     await ensureVoiceDirectories();

     let existingProfile: VoiceProfile | undefined;
     // ... rest of function
   ```

3. Also call ensureVoiceDirectories() in the "start" CLI command entry point:
   ```typescript
   case "start": {
     await ensureVoiceDirectories(); // Ensure dirs before starting interview
     const recalibration = args.includes("--recalibrate");
     const result = await startInterview({ recalibration });
     console.log(JSON.stringify({
       phase: result.state.phase,
       questions: result.questions,
       isBlankSlate: result.state.isBlankSlate,
     }));
     break;
   }
   ```

4. Optionally call ensureVoiceDirectories() before saving profile in completeInterview():
   ```typescript
   export async function completeInterview(
     state: InterviewState,
     options?: { profilePath?: string; strategyPath?: string },
   ): Promise<{...}> {
     // Ensure directories exist before saving
     await ensureVoiceDirectories();

     const profile = finalizeProfile(state);
     // ... rest of function
   ```

The directories will be created before any interview operation that might save files.

Error handling:
- ensureVoiceDirectories() throws with clear error on permission issues
- This error propagates to CLI and is shown to user
- Example error: "Failed to create interview directory: content/voice/profiles\nPermission denied..."

Note: This is defensive â€” directories should already exist or be created early. But calling it before save operations ensures they exist even if interview was interrupted.
  </action>
  <verify>Delete content/voice/profiles/ and content/voice/strategies/ then run interview start command and verify dirs are recreated</verify>
  <done>Directories created automatically on interview start, no manual setup required</done>
</task>

</tasks>

<verification>
- ensureVoiceDirectories() creates content/voice/profiles/ directory
- ensureVoiceDirectories() creates content/voice/strategies/ directory
- Called automatically on interview start (before collecting answers)
- Directory creation uses recursive: true for parent dirs
- Clear error message if creation fails (permission issues)
</verification>

<success_criteria>
Users can start voice interview without manually creating directories; directories are created automatically.
</success_criteria>

<output>
After completion, create `.planning/phases/16-voice-interview-cli-completion-p1/16-04-SUMMARY.md`
</output>
