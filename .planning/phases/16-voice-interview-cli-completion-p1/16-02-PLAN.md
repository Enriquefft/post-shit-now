---
phase: 16-voice-interview-cli-completion-p1
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/voice/interview.ts
  - src/cli/voice-interview.ts
autonomous: true
requirements: [M9]

must_haves:
  truths:
    - Interview state persists between CLI invocations
    - Multiple concurrent interviews supported with timestamp-based filenames
    - Old interview files cleaned up after 7 days
    - Corrupted state files detected with clear error messages
    - Auto-save after every answer submission
  artifacts:
    - path: "src/voice/interview.ts"
      provides: "State persistence functions"
      exports: ["loadInterviewState", "saveInterviewState", "generateInterviewId", "cleanupOldInterviews"]
      min_lines: 200
    - path: "content/voice/.interview.json"
      provides: "Active interview state storage"
      optional: true
  key_links:
    - from: "src/voice/interview.ts"
      to: "content/voice/.interview.json"
      via: "Atomic write with temp file + rename"
      pattern: "writeFile.*tmp|rename.*tmp"
    - from: "src/cli/voice-interview.ts"
      to: "src/voice/interview.ts"
      via: "Load/save state on submit/complete"
      pattern: "loadInterviewState|saveInterviewState"
---

<objective>
Implement interview state persistence with JSON files, atomic writes, and automatic cleanup.

Purpose: Enable users to resume interviews after interrupting CLI sessions, with support for concurrent interviews and cleanup of old files.

Output: State persistence functions in interview.ts, integration with CLI commands.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Locked decisions from CONTEXT.md
- Location: `content/voice/.interview.json` (easy to find, alongside YAML profiles)
- Cleanup: Delete state after 7 days
- Concurrent: Support multiple interviews with auto-generated filenames like `.interview-{timestamp}.json`
- Save data: Full state object from `interview.ts` (InterviewState)
- Validation: Strict validation — throw error if corrupted, user must restart
- Security: Plain text storage (no encryption or obfuscation)
- Auto-save: Save state after every answer submission

@src/voice/interview.ts
@src/voice/profile.ts (atomic write pattern reference)
@src/cli/voice-interview.ts

# Research findings
- bun.lock is binary, not human-readable → use JSON instead
- Atomic write pattern: writeFile to .tmp, then rename (POSIX guarantee)
- Zod schema for InterviewState validation
</context>

<tasks>

<task type="auto">
  <name>Add state persistence functions</name>
  <files>src/voice/interview.ts</files>
  <action>
Add the following functions to src/voice/interview.ts for state persistence:

1. generateInterviewId(): string
   - Returns timestamp-based ID: Date.now().toString(36)
   - Example: "lw8f9j2k"

2. getInterviewStatePath(interviewId?: string): string
   - Returns `content/voice/.interview.json` if no ID provided (default/active interview)
   - Returns `content/voice/.interview-{id}.json` if ID provided (concurrent interviews)

3. saveInterviewState(state: InterviewState, interviewId?: string): Promise<void>
   - Converts InterviewState to JSON (handle Map serialization: answers: Map -> Object.fromEntries)
   - Uses atomic write pattern:
     a. Write to {path}.tmp
     b. Rename tmp to path (POSIX atomic rename)
   - Reference existing atomic write pattern from @src/voice/profile.ts:87-92
   - Validation: Validate state with Zod schema before writing (reuse InterviewState type validation)
   - Error handling: Throw clear error on validation failure

4. loadInterviewState(interviewId?: string): Promise<InterviewState | null>
   - Loads JSON from interview state file
   - Validates with Zod schema (InterviewState)
   - On validation error: Throw error with message:
     "Corrupted interview state at [path]\nValidation errors: [errors]\n\nTo fix: Delete the file and restart the interview.\nCommand: rm [path]"
   - Returns null if file doesn't exist (ENOENT)
   - On other errors: Re-throw

5. cleanupOldInterviews(maxAgeMs: number = 7 * 24 * 60 * 60 * 1000): Promise<void>
   - Lists all .interview-*.json files in content/voice/
   - For each file: checks mtime, deletes if older than maxAgeMs
   - Logs: "Cleaned up old interview: [filename]"
   - Uses readdir, stat, rm from node:fs/promises

6. listInterviews(): Promise<{ id: string; path: string; ageMs: number }[]>
   - Lists all .interview-*.json files with metadata
   - Returns array of { id, path, ageMs }
   - Used for selecting which interview to complete when multiple exist

Note on Map serialization:
- InterviewState.answers is a Map<string, string>
- For JSON: convert to Object.fromEntries(state.answers)
- For loading: convert Object to Map(new Map(Object.entries(parsed.answers)))

Import required modules from node:fs/promises: readFile, writeFile, rename, readdir, stat, rm
  </action>
  <verify>Run `bun test` (if tests exist) or manually verify functions with TypeScript check</verify>
  <done>State can be saved to JSON with atomic write, loaded with Zod validation, and old files cleaned up</done>
</task>

<task type="auto">
  <name>Integrate state persistence into CLI</name>
  <files>src/cli/voice-interview.ts</files>
  <action>
Update src/cli/voice-interview.ts to use state persistence:

1. Update startInterview function:
   - After creating state, call saveInterviewState() to persist initial state
   - Return interviewId along with state and questions

2. Update "start" CLI command:
   - Generate interviewId via generateInterviewId()
   - Save initial state via saveInterviewState()
   - Output interviewId in JSON for CLI integration

3. Update "submit" CLI command:
   - Load existing state via loadInterviewState() (or create fresh if null)
   - Prompt for answers (from 16-01)
   - Process answers with processAnswer()
   - Save updated state via saveInterviewState() after each submission
   - Output new questions or completion status

4. Update "complete" CLI command:
   - If multiple interviews exist (listInterviews().length > 1):
     - List interviews with IDs and ages
     - Prompt: "Which interview to complete? [id or number]:"
     - Load selected interview via loadInterviewState(id)
   - If only .interview.json exists (default), load it
   - Save profile, delete interview state file via rm()

5. Add "cleanup" CLI command:
   - Calls cleanupOldInterviews() to remove old state files
   - Output: "Cleaned up N old interview files"

6. Add "list" CLI command:
   - Calls listInterviews()
   - Output: human-readable table of interviews with IDs, paths, ages

Import the new functions from src/voice/interview.ts:
- loadInterviewState
- saveInterviewState
- generateInterviewId
- cleanupOldInterviews
- listInterviews

All CLI output should remain human-readable, not JSON-only (except "start" which needs interviewId for integration).
  </action>
  <verify>Run `bun run src/cli/voice-interview.ts start` → `submit` → interrupt → resume → verify state persists</verify>
  <done>Interview state saved after each answer, resumes after interrupt, old files cleaned up automatically</done>
</task>

</tasks>

<verification>
- State saved to content/voice/.interview.json with atomic write (tmp + rename)
- Multiple concurrent interviews supported with .interview-{timestamp}.json filenames
- Old interview files (>7 days) deleted by cleanup command
- Corrupted state detected with Zod validation and clear error message
- CLI loads and saves state on submit/complete commands
</verification>

<success_criteria>
Users can interrupt interview, resume later, and state persists correctly across CLI invocations.
</success_criteria>

<output>
After completion, create `.planning/phases/16-voice-interview-cli-completion-p1/16-02-SUMMARY.md`
</output>
