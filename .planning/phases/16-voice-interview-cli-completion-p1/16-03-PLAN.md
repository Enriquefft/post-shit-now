---
phase: 16-voice-interview-cli-completion-p1
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - src/cli/setup-keys.ts
  - package.json
autonomous: true
requirements: [C6]

must_haves:
  truths:
    - API keys can be entered via stdin prompts with character masking
    - Typed characters are hidden (displayed as asterisks like password prompts)
    - No confirmation required (keys saved immediately)
    - Keys validated with format check + minimal API test
  artifacts:
    - path: "src/cli/setup-keys.ts"
      provides: "Masked stdin input for API keys"
      functions: ["promptForKey"]
      min_lines: 280
    - path: "package.json"
      provides: "readline-sync dependency for password masking"
      contains: "readline-sync"
  key_links:
    - from: "src/cli/setup-keys.ts"
      to: "src/core/utils/env.ts"
      via: "validateProviderKey for key validation"
      pattern: "validateProviderKey"
---

<objective>
Add masked stdin input for API key entry in setup-keys.ts.

Purpose: Enable secure password prompts where typed characters are hidden, improving security when entering API keys via CLI.

Output: Masked stdin prompts using readline-sync library.
</objective>

<execution_context>
@/home/hybridz/.claude/get-shit-done/workflows/execute-plan.md
@/home/hybridz/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md

# Locked decisions from CONTEXT.md
- Input: Stdin prompt only (not CLI flags)
- Masking: Always masked (hide typed characters with asterisks like password prompts)
- Confirmation: No confirmation required (save immediately, trust user input)
- Validation: Format check + minimal test with CLI or API of said key

@src/cli/setup-keys.ts
@src/core/utils/env.ts

# Research findings
- readline-sync is lightweight, works with Bun
- validateProviderKey() exists in env.ts and does prefix checks + minimal API calls
</context>

<tasks>

<task type="auto">
  <name>Add readline-sync dependency</name>
  <files>package.json</files>
  <action>
Add readline-sync to package.json dependencies:

```bash
bun add readline-sync
bun add -D @types/readline-sync
```

This provides password masking functionality with hideEchoBack: true and mask: "*" options.

Do NOT use inquirer.js or @clack/prompts (research recommends avoiding heavy dependencies).
  </action>
  <verify>Check package.json contains readline-sync and @types/readline-sync</verify>
  <done>readline-sync dependency installed</done>
</task>

<task type="auto">
  <name>Implement masked stdin key prompt</name>
  <files>src/cli/setup-keys.ts</files>
  <action>
Add a new function promptForKey() to src/cli/setup-keys.ts:

```typescript
import readlineSync from "readline-sync";
import { validateProviderKey } from "../core/utils/env.ts";

/**
 * Prompt for API key with masked input.
 * Validates key format and makes minimal API test before accepting.
 *
 * @param keyName - Name of the key (e.g., "perplexity", "openai")
 * @param service - Display name of service (e.g., "Perplexity AI")
 * @returns The validated API key, or null if user cancels
 */
export async function promptForKey(
  keyName: string,
  service: string
): Promise<string | null> {
  // Display source info if available
  const PROVIDER_SOURCE_MAP: Record<string, string> = {
    perplexity: "https://www.perplexity.ai/settings/api",
    brave: "https://api.search.brave.com",
    tavily: "https://tavily.com/api",
    exa: "https://exa.ai/api",
    openai: "https://platform.openai.com/api-keys",
    ideogram: "https://ideogram.ai/api",
    fal: "https://fal.ai/dashboard",
    runway: "https://runwayml.com/console",
  };

  const source = PROVIDER_SOURCE_MAP[keyName];
  if (source) {
    console.log(`\nGet your API key from: ${source}`);
  }

  // Prompt with masked input
  const apiKey = readlineSync.question(
    `\nEnter ${service} API key (input will be hidden): `,
    {
      hideEchoBack: true,  // Hide typed characters
      mask: "*",           // Show asterisks instead of nothing
    }
  );

  // Allow user to cancel
  if (!apiKey || apiKey.trim() === "") {
    console.log("Cancelled (no key provided).");
    return null;
  }

  // Validate key with format check + minimal API test
  console.log("Validating API key...");
  const validation = await validateProviderKey(keyName, apiKey);

  if (!validation.valid) {
    console.error(`❌ Invalid ${service} API key: ${validation.error}`);
    if (validation.suggestion) {
      console.log(`   Hint: ${validation.suggestion}`);
    }

    // Reprompt once on validation failure
    const retry = readlineSync.question("\nTry again? (y/n): ");
    if (retry.toLowerCase() === "y") {
      return promptForKey(keyName, service); // Recursive retry
    }
    return null;
  }

  if (validation.warning) {
    console.log(`⚠️  Warning: ${validation.warning}`);
  }

  console.log(`✅ ${service} API key validated.`);

  return apiKey;
}
```

Update the CLI entry point (if exists) to use promptForKey() instead of requiring key input via flags.

Note: The current setup-keys.ts returns "need_input" status for Claude to prompt. This function can be called by Claude when it detects need_input for keys.

Import validateProviderKey from @src/core/utils/env.ts for key validation (prefix check + minimal API test).
  </action>
  <verify>Run `node -e "import('./src/cli/setup-keys.ts').then(m => m.promptForKey('openai', 'OpenAI'))"` and verify masked input</verify>
  <done>promptForKey() hides typed characters, validates key, and reprompts on failure</done>
</task>

<task type="auto">
  <name>Integrate masked prompt into setup flow</name>
  <files>src/cli/setup-keys.ts</files>
  <action>
Update setup-keys.ts to support interactive stdin prompting:

1. Add a new function collectKeysInteractively() that:
   - Loops through REQUIRED_KEYS_PHASE1 and PROVIDER_KEYS
   - For each missing key, calls promptForKey()
   - Calls writeKey() or writeProviderKey() to save each validated key
   - Returns SetupResult with success/error status

2. Add a CLI command "interactive" to the entry point (if not exists):
   ```typescript
   case "interactive": {
     const result = await collectKeysInteractively();
     console.log(JSON.stringify(result));
     break;
   }
   ```

3. Ensure the function can be called programmatically (not just via CLI) for integration with /psn:setup.

The function should handle:
- Phase 1 keys (NEON_API_KEY, TRIGGER_SECRET_KEY) via writeKey()
- Provider keys (perplexity, openai, etc.) via writeProviderKey()
- Error handling for validation failures and save failures
- Clear console output showing progress and validation results

All validation is handled by validateProviderKey() from @src/core/utils/env.ts (prefix check + minimal API test).
  </action>
  <verify>Run interactive key collection and verify keys are masked, validated, and saved</verify>
  <done>Keys collected via masked stdin prompts, validated, and saved to config/keys.env or database</done>
</task>

</tasks>

<verification>
- readline-sync dependency added to package.json
- promptForKey() function hides typed characters with asterisks
- Keys validated with format check and minimal API test
- No confirmation required (keys saved immediately after validation)
- Reprompt on validation failure with helpful error messages
</verification>

<success_criteria>
Users can enter API keys via CLI with masked input, keys are validated, and saved without requiring confirmation.
</success_criteria>

<output>
After completion, create `.planning/phases/16-voice-interview-cli-completion-p1/16-03-SUMMARY.md`
</output>
